<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Budget Pro">
<meta name="theme-color" content="#0A0C0F">
<title>Budget Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root,[data-theme="dark"]{
  --bg:#0A0C0F;--bg2:#0E1016;--bg3:#131519;--border:#1E2028;--border2:#2A2D38;
  --text:#E8E0D4;--dim:#888;--muted:#40444E;
  --gold:#C8A97E;--green:#7EC8A9;--pink:#C87EA9;--blue:#7EA9C8;--red:#C85555;--purple:#A97EC8;
  --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
  --font:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  --mono:ui-monospace,'SF Mono',Consolas,monospace;
  --R:16px;--Rs:10px;--Rx:6px;
}
/* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
[data-theme="light"]{
  --bg:#F0F4F8;--bg2:#FFFFFF;--bg3:#E4EAF2;--border:rgba(0,0,0,.09);--border2:rgba(0,0,0,.16);
  --text:#1A1D23;--dim:#6B7280;--muted:#9CA3AF;
  --gold:#7C3AED;--green:#059669;--pink:#DB2777;--blue:#2563EB;--red:#DC2626;--purple:#7C3AED;
}
[data-theme="light"] body{background:#F0F4F8}
[data-theme="light"] .hdr{background:#F0F4F8;box-shadow:0 1px 8px rgba(0,0,0,.06)}
[data-theme="light"] .card{background:#fff;border-color:rgba(0,0,0,.07);box-shadow:0 1px 6px rgba(0,0,0,.06)}
[data-theme="light"] .pill{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}
[data-theme="light"] .pill.on{background:rgba(124,58,237,.1);border-color:#7C3AED}
[data-theme="light"] .litem{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.08)}
[data-theme="light"] .sub-card{border-bottom:1px solid rgba(0,0,0,.06)}
[data-theme="light"] .goal-card{border-bottom:1px solid rgba(0,0,0,.06)}
[data-theme="light"] .asset-row{border-bottom:1px solid rgba(0,0,0,.06)}
[data-theme="light"] .fc-row{border-bottom:1px solid rgba(0,0,0,.06)}
[data-theme="light"] .alert-row{border-bottom:1px solid rgba(0,0,0,.04)}
[data-theme="light"] .sim-result{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.08)}
[data-theme="light"] .imp-stat{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.07)}
[data-theme="light"] .cal-day.has-event{border-color:rgba(0,0,0,.1);background:rgba(0,0,0,.03)}
[data-theme="light"] .logo-search{background:rgba(0,0,0,.05);border-color:rgba(0,0,0,.1)}
[data-theme="light"] .bnav{background:rgba(255,255,255,.95);border-top:1px solid rgba(0,0,0,.08)}
[data-theme="light"] .sheet-box{background:#fff;border-top:1px solid rgba(0,0,0,.08)}
[data-theme="light"] .sheet-title{color:#1A1D23}
[data-theme="light"] .fi,[data-theme="light"] .fi:focus,[data-theme="light"] .fs,[data-theme="light"] .logo-search{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1);color:#1A1D23}
[data-theme="light"] .fi::placeholder,[data-theme="light"] .fs::placeholder{color:#9CA3AF}
[data-theme="light"] .h-title{color:#1A1D23}
[data-theme="light"] .submit{color:#fff}
[data-theme="light"] .toast{background:#1A1D23;color:#F0F4F8}
[data-theme="light"] .sub-nm,.sub-pr,[data-theme="light"] .asset-nm{color:#1A1D23}
[data-theme="light"] .hdr-avatar{color:#fff}
/* ‚îÄ‚îÄ HELLO KITTY THEME ‚îÄ‚îÄ */
[data-theme="kitty"]{
  --bg:#FFF0F5;--bg2:#FFF5F8;--bg3:#FFE4EE;--border:rgba(255,105,180,.2);--border2:rgba(255,105,180,.38);
  --text:#4A1535;--dim:#9B5D7A;--muted:#C090B0;
  --gold:#FF69B4;--green:#FF85C2;--pink:#E91E8C;--blue:#9B59B6;--red:#CC0066;--purple:#7C3AED;
}
[data-theme="kitty"] body{background:#FFF0F5}
[data-theme="kitty"] .hdr{background:linear-gradient(135deg,#FFE4EE,#FFF0F5);border-bottom:1px solid rgba(255,105,180,.15)}
[data-theme="kitty"] .card{background:rgba(255,255,255,.88);border-color:rgba(255,105,180,.2);border-radius:20px;box-shadow:0 4px 16px rgba(255,105,180,.1)}
[data-theme="kitty"] .pill{background:rgba(255,105,180,.08);border-color:rgba(255,105,180,.2)}
[data-theme="kitty"] .pill.on{background:rgba(255,105,180,.2);border-color:#FF69B4;color:#FF69B4}
[data-theme="kitty"] .litem{background:rgba(255,255,255,.7);border-color:rgba(255,105,180,.2)}
[data-theme="kitty"] .sub-card{border-bottom:1px solid rgba(255,105,180,.12)}
[data-theme="kitty"] .goal-card{border-bottom:1px solid rgba(255,105,180,.12)}
[data-theme="kitty"] .asset-row{border-bottom:1px solid rgba(255,105,180,.12)}
[data-theme="kitty"] .fc-row{border-bottom:1px solid rgba(255,105,180,.1)}
[data-theme="kitty"] .alert-row{border-bottom:1px solid rgba(255,105,180,.1)}
[data-theme="kitty"] .sim-result{background:rgba(255,105,180,.07);border-color:rgba(255,105,180,.2)}
[data-theme="kitty"] .imp-stat{background:rgba(255,105,180,.05);border-color:rgba(255,105,180,.15)}
[data-theme="kitty"] .cal-day.has-event{border-color:rgba(255,105,180,.3);background:rgba(255,105,180,.05)}
[data-theme="kitty"] .logo-search{background:rgba(255,255,255,.6);border-color:rgba(255,105,180,.25)}
[data-theme="kitty"] .bnav{background:rgba(255,240,245,.95);border-top:1px solid rgba(255,105,180,.2)}
[data-theme="kitty"] .sheet-box{background:#FFF5F8;border-top:1px solid rgba(255,105,180,.15)}
[data-theme="kitty"] .sheet-title{color:#4A1535}
[data-theme="kitty"] .fi,[data-theme="kitty"] .fs,[data-theme="kitty"] .logo-search{background:rgba(255,255,255,.8);border-color:rgba(255,105,180,.25);color:#4A1535}
[data-theme="kitty"] .submit{color:#fff}
[data-theme="kitty"] .toast{background:#FF69B4;color:#fff}
[data-theme="kitty"] .h-title{font-weight:800;color:#CC0066;text-shadow:0 1px 3px rgba(204,0,102,.12)}
[data-theme="kitty"] .h-title::after{content:' üéÄ'}
[data-theme="kitty"] .eyebrow{color:#FF69B4}
[data-theme="kitty"] .card-t::before{content:'‚ú® ';letter-spacing:0}
[data-theme="kitty"] .hdr-avatar{color:#fff}
[data-theme="kitty"] .sub-nm,[data-theme="kitty"] .asset-nm{color:#4A1535}
[data-theme="kitty"] .fi::placeholder,[data-theme="kitty"] .fs::placeholder{color:#C090B0}
[data-theme="kitty"] .fi:focus,[data-theme="kitty"] .fs:focus{border-color:#FF69B4;box-shadow:0 0 0 3px rgba(255,105,180,.15);color:#2D0A1E}
[data-theme="kitty"] .kpi-v{color:#4A1535}
[data-theme="kitty"] .tx-lb{color:#4A1535}
[data-theme="kitty"] .sub-pr{color:#4A1535}
/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes vIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.view-in{animation:vIn .22s cubic-bezier(.4,0,.2,1) both}
html.theme-fx,html.theme-fx *,html.theme-fx *::before,html.theme-fx *::after{
  transition:background-color .32s ease,color .22s ease,border-color .28s ease,box-shadow .28s ease !important}
/* ‚îÄ‚îÄ THEME SELECTOR ‚îÄ‚îÄ */
.theme-row{display:flex;gap:8px;margin-top:6px}
.theme-btn{flex:1;padding:10px 6px;border-radius:14px;border:2px solid var(--border2);cursor:pointer;font-family:var(--mono);font-size:9px;text-align:center;transition:all .2s;background:var(--bg3);color:var(--dim);letter-spacing:.5px}
.theme-btn.on{border-color:var(--gold);color:var(--gold)}
.th-swatches{display:flex;gap:3px;justify-content:center;margin-bottom:6px}
.th-swatches span{width:9px;height:9px;border-radius:50%;display:inline-block}
/* ‚îÄ‚îÄ PROFILE PHOTO ‚îÄ‚îÄ */
.prof-photo-wrap{position:relative;width:80px;height:80px;border-radius:50%;margin:0 auto 10px;cursor:pointer}
.prof-photo-img{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#E8C9A0);display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:700;color:var(--bg);overflow:hidden;border:3px solid rgba(200,169,126,.3)}
.prof-photo-img img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.prof-photo-overlay{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;font-size:20px;opacity:0;transition:opacity .2s;pointer-events:none}
.prof-photo-wrap:hover .prof-photo-overlay{opacity:1}
/* ‚îÄ‚îÄ FILE FORMAT TABS ‚îÄ‚îÄ */
.file-tab-row{display:flex;gap:8px;margin-bottom:12px}
.file-tab{flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-family:var(--mono);font-size:10px;color:var(--muted);transition:all .15s;letter-spacing:.5px}
.file-tab.on{border-color:var(--gold);color:var(--gold);background:rgba(200,169,126,.08)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overscroll-behavior:none}
.app{display:flex;flex-direction:column;min-height:100vh;padding-top:var(--safe-top)}
.hdr{padding:16px 16px 8px;flex-shrink:0}
.hdr-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.hdr-left{display:flex;align-items:center;gap:11px}
.hdr-avatar{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#E8C9A0);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--bg);cursor:pointer;flex-shrink:0;border:1px solid rgba(200,169,126,.3);box-shadow:0 2px 12px rgba(200,169,126,.25)}
.hdr-avatar.empty{background:var(--border);color:var(--dim);box-shadow:none;border-color:var(--border2)}
.eyebrow{font-size:10px;letter-spacing:2px;color:var(--gold);font-family:var(--mono);text-transform:uppercase;margin-bottom:2px;opacity:.8}
.h-title{font-size:22px;font-weight:600;color:#F0E8DC;letter-spacing:-.5px}
.mnav{display:flex;align-items:center;gap:6px}
.mbtn{background:var(--border);border:1px solid var(--border2);color:var(--dim);width:32px;height:32px;border-radius:8px;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s}
.mbtn:active{background:var(--border2)}
.mlbl{font-family:var(--mono);font-size:11px;color:var(--dim);min-width:68px;text-align:center;font-weight:500}
.main{flex:1;padding:8px 14px calc(76px + var(--safe-bottom));overflow-y:auto;-webkit-overflow-scrolling:touch}
/* Bottom Nav */
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,12,15,.96);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--border);display:flex;padding-bottom:var(--safe-bottom);z-index:100;overflow-x:auto;scrollbar-width:none}
.bnav::-webkit-scrollbar{display:none}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 0 8px;border:none;background:none;color:var(--muted);cursor:pointer;flex:1;min-width:60px;transition:color .18s}
.bnav-btn.on{color:var(--gold)}
.bnav-ic{font-size:18px;line-height:1}
.bnav-lb{font-family:var(--font);font-size:9px;font-weight:500;letter-spacing:.3px;white-space:nowrap}
/* Cards */
.card{background:linear-gradient(145deg,rgba(22,25,31,.95),rgba(14,16,20,.95));border:1px solid rgba(255,255,255,.07);border-radius:var(--R);padding:16px;margin-bottom:12px;box-shadow:0 4px 24px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
.card-t{font-family:var(--mono);font-size:9px;letter-spacing:2.5px;color:var(--muted);text-transform:uppercase;margin-bottom:14px;font-weight:500}
/* KPIs */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.kpi{background:linear-gradient(145deg,rgba(22,25,31,.9),rgba(14,16,20,.9));border:1px solid rgba(255,255,255,.07);border-radius:var(--Rs);padding:14px;box-shadow:0 2px 12px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.03)}
.kpi.w3{grid-column:1/-1}
.kpi-l{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.kpi-v{font-size:20px;font-weight:600;letter-spacing:-.5px;color:#F0E8DC}
.kpi-s{font-family:var(--mono);font-size:11px;margin-right:1px}
/* TX */
.tx{display:flex;align-items:center;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.04);gap:10px}
.tx:last-child{border-bottom:none}
.tx-logo{width:32px;height:32px;border-radius:9px;object-fit:contain;background:#111;flex-shrink:0}
.tx-fb{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;font-family:var(--mono);flex-shrink:0}
.tx-inf{flex:1;min-width:0}
.tx-lb{font-size:13px;font-weight:500;color:#D4CCC0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-mt{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:2px}
.tx-am{font-family:var(--mono);font-size:13px;font-weight:600;flex-shrink:0}
.tx-del{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 0 2px 6px;line-height:1;flex-shrink:0}
.g{color:var(--green)}.p{color:var(--pink)}.b{color:var(--blue)}.r{color:var(--red)}.gold{color:var(--gold)}
/* Forms */
.fg{display:flex;flex-direction:column;gap:13px}
.fl{display:flex;flex-direction:column;gap:6px;font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;font-weight:500}
.fi,.fs{background:rgba(0,0,0,.4);border:1px solid var(--border);color:var(--text);padding:12px 13px;font-family:var(--mono);font-size:14px;border-radius:var(--Rs);outline:none;width:100%;-webkit-appearance:none;appearance:none;transition:border-color .2s}
.fi:focus,.fs:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(200,169,126,.1)}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
/* Pills */
.pill-row{display:flex;gap:6px;flex-wrap:wrap}
.pill{background:rgba(0,0,0,.3);border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:8px 12px;cursor:pointer;text-transform:uppercase;border-radius:20px;transition:all .15s;font-weight:500}
.pill.on{border-color:var(--gold);color:var(--gold);background:rgba(200,169,126,.1)}
.pill.on-g{border-color:var(--green);color:var(--green);background:rgba(126,200,169,.1)}
.pill.on-p{border-color:var(--pink);color:var(--pink);background:rgba(200,126,169,.1)}
.submit{background:linear-gradient(135deg,var(--gold),#D4B88C);color:var(--bg);border:none;padding:15px;font-family:var(--font);font-size:14px;font-weight:700;letter-spacing:.5px;cursor:pointer;border-radius:var(--Rs);width:100%;margin-top:4px;box-shadow:0 4px 16px rgba(200,169,126,.3);transition:opacity .15s}
.submit:active{opacity:.85}
/* Bars */
.bar-bg{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.bar-fill{height:5px;border-radius:3px;transition:width .6s}
.bar-bg.thin{height:3px}.bar-fill.thin{height:3px}
/* Misc */
.empty{font-family:var(--mono);font-size:11px;color:var(--muted);text-align:center;padding:24px 0}
.row-between{display:flex;justify-content:space-between;align-items:center}
.mono{font-family:var(--mono)}.sm{font-size:11px}.xs{font-size:10px}.xxs{font-size:9px}
/* Toast */
.toast{position:fixed;top:calc(var(--safe-top)+12px);left:50%;transform:translateX(-50%);background:var(--gold);color:var(--bg);padding:10px 22px;border-radius:24px;font-family:var(--font);font-size:13px;font-weight:700;z-index:9999;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.6);opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
/* Alerts */
.alert{border:1px solid;padding:12px 14px;margin-bottom:12px;border-radius:var(--Rs)}
.alert.urg{background:rgba(200,85,85,.08);border-color:rgba(200,85,85,.3)}
.alert.soon{background:rgba(255,170,68,.06);border-color:rgba(255,170,68,.25)}
.alert-t{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.alert-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.alert-row:last-child{border-bottom:none}
.badge{font-family:var(--mono);font-size:10px;padding:3px 9px;border-radius:12px;font-weight:700}
.badge.urg{background:rgba(200,85,85,.25);color:#ff7070}
.badge.soon{background:rgba(255,170,68,.2);color:#ffaa44}
.badge.ok{background:rgba(126,200,169,.15);color:var(--green)}
/* Subs */
.sub-card{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04);gap:10px}
.sub-card:last-child{border-bottom:none}
.sub-logo{width:34px;height:34px;border-radius:9px;object-fit:contain;background:#111;flex-shrink:0}
.sub-fb{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;font-family:var(--mono);flex-shrink:0}
.sub-inf{flex:1;min-width:0;cursor:pointer}
.sub-nm{font-size:14px;font-weight:500;color:#D4CCC0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub-mt{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:2px}
.sub-rt{text-align:right;flex-shrink:0}
.sub-pr{font-family:var(--mono);font-size:13px;font-weight:600;color:#D4CCC0}
.sub-due{font-family:var(--mono);font-size:10px;margin-top:2px}
.sub-acts{display:flex;gap:4px;flex-shrink:0}
.sab{background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:9px;padding:5px 7px;cursor:pointer;border-radius:6px;transition:all .15s}
.sab.rn{border-color:rgba(126,200,169,.3);color:var(--green)}
.sab.ed{border-color:rgba(126,169,200,.3);color:var(--blue)}
.sab.dl{border-color:rgba(200,85,85,.3);color:var(--red)}
/* Logo picker */
.logo-search{background:rgba(0,0,0,.4);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:var(--mono);font-size:13px;border-radius:var(--Rx);outline:none;width:100%;margin-bottom:8px}
.logo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:240px;overflow-y:auto;padding-right:2px}
.logo-grid::-webkit-scrollbar{width:2px}.logo-grid::-webkit-scrollbar-thumb{background:#333;border-radius:1px}
.litem{display:flex;flex-direction:column;align-items:center;gap:4px;padding:9px 4px;border:1px solid var(--border);border-radius:9px;cursor:pointer;background:rgba(0,0,0,.3);transition:all .15s}
.litem.sel{border-color:var(--gold);background:rgba(200,169,126,.1)}
.limg{width:32px;height:32px;border-radius:8px;object-fit:contain;background:#111}
.lfb{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;font-family:var(--mono)}
.llbl{font-family:var(--mono);font-size:8px;color:var(--muted);text-align:center;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:54px}
/* Goals */
.goal-card{padding:13px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.goal-card:last-child{border-bottom:none}
/* Assets */
.asset-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.asset-row:last-child{border-bottom:none}
.asset-nm{font-size:13px;font-weight:500;color:#D4CCC0}
.asset-cat{font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:2px}
/* Forecast */
.fc-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.fc-row:last-child{border-bottom:none}
.fc-date{font-family:var(--mono);font-size:11px;color:var(--dim);flex-shrink:0;min-width:36px}
.fc-label{font-size:12px;color:#D4CCC0;flex:1;margin:0 10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
/* Rules */
.rule-row{margin-bottom:13px}
.rule-top{display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;margin-bottom:6px}
/* Calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:10px}
.cal-day-hdr{font-family:var(--mono);font-size:9px;color:var(--muted);text-align:center;padding:4px 0}
.cal-day{min-height:38px;border:1px solid transparent;border-radius:6px;padding:4px;font-family:var(--mono);font-size:10px;color:var(--muted);cursor:pointer}
.cal-day.has-event{border-color:rgba(255,255,255,.08);background:rgba(255,255,255,.03)}
.cal-day.today{border-color:var(--gold)!important;color:var(--gold)}
.cal-day-num{font-size:9px;margin-bottom:2px}
.cal-dot-wrap{display:flex;flex-wrap:wrap;gap:2px}
.cal-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
/* Sim */
.sim-result{background:rgba(0,0,0,.3);border:1px solid var(--border2);padding:16px;border-radius:var(--Rs);margin-top:12px}
.sim-big{font-size:30px;font-weight:600;letter-spacing:-1px;color:var(--gold)}
/* Import */
.imp-table{width:100%;border-collapse:collapse;font-size:12px}
.imp-table th{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;padding:7px 5px;border-bottom:1px solid var(--border);text-align:left}
.imp-table td{padding:7px 5px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle}
.imp-table tr:last-child td{border-bottom:none}
.imp-table tr.dup-row td{opacity:.3}
.cat-sel{background:rgba(0,0,0,.4);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:10px;padding:3px 5px;border-radius:4px;width:100%;-webkit-appearance:none;appearance:none}
.ai-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(126,200,169,.12);border:1px solid rgba(126,200,169,.3);color:var(--green);font-family:var(--mono);font-size:8px;padding:2px 6px;border-radius:8px;vertical-align:middle}
.imp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px}
.imp-stat{background:rgba(0,0,0,.3);border:1px solid var(--border);padding:10px;text-align:center;border-radius:var(--Rx)}
.imp-stat-v{font-family:var(--mono);font-size:15px;font-weight:700;margin-bottom:2px}
.imp-stat-l{font-family:var(--mono);font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.det-sub-card{background:rgba(126,200,169,.05);border:1px solid rgba(126,200,169,.2);border-radius:var(--Rx);padding:12px;margin-bottom:8px}
.dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:#ffaa44;margin-left:3px;vertical-align:middle;margin-top:-2px}
/* Sheet */
.sheet{position:fixed;inset:0;z-index:500;display:none;align-items:flex-end}
.sheet.open{display:flex}
.sheet-bg{position:absolute;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.sheet-box{position:relative;width:100%;background:var(--bg2);border-radius:20px 20px 0 0;padding:0 0 calc(20px + var(--safe-bottom));max-height:92vh;overflow-y:auto;box-shadow:0 -8px 48px rgba(0,0,0,.6);border-top:1px solid rgba(255,255,255,.08)}
.sheet-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:12px auto 0}
.sheet-title{font-size:17px;font-weight:600;color:#F0E8DC;padding:16px 20px 4px}
.sheet-body{padding:4px 20px 16px}
/* Profile */
.profile-avatar-big{width:84px;height:84px;border-radius:42px;background:linear-gradient(135deg,var(--gold),#E8C9A0);display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:700;color:var(--bg);box-shadow:0 8px 32px rgba(200,169,126,.35);border:2px solid rgba(200,169,126,.2)}
/* Mobile */
@media(max-width:640px){
  .mbtn{width:36px;height:36px;font-size:18px}
  .submit{padding:17px;font-size:15px}
  .fi,.fs{padding:14px 13px;font-size:16px}
  .sab{padding:7px 9px;font-size:9px}
  .pill{padding:9px 13px;font-size:9px}
  .tx-del{padding-left:10px;font-size:20px}
  .tx-lb,.tx-am{font-size:14px}
  .kpi-v{font-size:22px}
  .sub-nm,.sub-pr{font-size:14px}
  .card-t,.kpi-l,.imp-table th{font-size:9px;letter-spacing:2px}
  .imp-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .imp-table{min-width:520px}
  .cal-day{min-height:44px}
  .toast{font-size:13px;padding:11px 22px}
  .kpis{gap:6px}
  .main{padding:8px 12px calc(76px + var(--safe-bottom))}
  .hdr{padding:14px 14px 6px}
  .goal-card{padding:14px 0}.asset-row{padding:12px 0}
  .fr3{grid-template-columns:1fr 1fr}
  .logo-grid{grid-template-columns:repeat(3,1fr)}
  .litem{padding:12px 4px}.lfb,.limg{width:36px;height:36px}
}
@media(max-width:380px){.fr2,.fr3{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}.kpi.w3{grid-column:auto}.h-title{font-size:19px}}
button,a,[onclick]{touch-action:manipulation}
.main,.logo-grid{-webkit-overflow-scrolling:touch}
/* Savings section */
.savings-card{position:relative;overflow:hidden}
.savings-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--green),var(--gold))}
.rav-big{font-size:26px;font-weight:700;letter-spacing:-1px;margin:4px 0 2px}
.rav-detail{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.rav-detail:last-child{border-bottom:none}
/* Calendar icons */
.cal-icon{width:14px;height:14px;border-radius:3px;display:inline-block;vertical-align:middle;flex-shrink:0}
.cal-arrow{font-size:11px;line-height:14px;display:inline-block;font-weight:700}
.cal-icons-wrap{display:flex;flex-wrap:wrap;gap:2px;align-items:center}
/* KPI editor checkbox styling */
.kpi-chk,.kpi-chk-sheet{width:18px;height:18px;accent-color:var(--gold);cursor:pointer;flex-shrink:0}
[data-theme="kitty"] .kpi-chk,[data-theme="kitty"] .kpi-chk-sheet{accent-color:#FF69B4}
[data-theme="light"] .kpi-chk,[data-theme="light"] .kpi-chk-sheet{accent-color:#7C3AED}
/* OCR image preview */
#ocrImgPreview{display:none;max-width:100%;max-height:180px;border-radius:10px;margin-bottom:10px;object-fit:contain;border:1px solid var(--border)}
/* Logo custom dans sheet edit */
.logo-edit-preview{width:40px;height:40px;border-radius:10px;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-edit-preview img{width:100%;height:100%;object-fit:cover}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="hdr-row">
      <div class="hdr-left">
        <div class="hdr-avatar empty" id="hdrAvatar" onclick="navTo('profile')">?</div>
        <div>
          <div class="eyebrow" id="hdrEyebrow">Finances Personnelles</div>
          <div class="h-title">Budget Pro</div>
        </div>
      </div>
      <div class="mnav">
        <button class="mbtn" onclick="changeMonth(-1)">‚Äπ</button>
        <div class="mlbl" id="mLabel"></div>
        <button class="mbtn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
    </div>
  </div>
  <div class="main" id="main"></div>
  <nav class="bnav" id="bnav">
    <button class="bnav-btn on" data-v="dashboard" onclick="nav(this)"><span class="bnav-ic">‚åÇ</span><span class="bnav-lb">Bord</span></button>
    <button class="bnav-btn" data-v="add" onclick="nav(this)"><span class="bnav-ic">Ôºã</span><span class="bnav-lb">Ajout</span></button>
    <button class="bnav-btn" data-v="import" onclick="nav(this)" id="tabImport"><span class="bnav-ic">‚á™</span><span class="bnav-lb" id="tabImportLbl">Import</span></button>
    <button class="bnav-btn" data-v="subs" onclick="nav(this)" id="tabSubs"><span class="bnav-ic">‚Ü∫</span><span class="bnav-lb" id="tabSubsLbl">Abos</span></button>
    <button class="bnav-btn" data-v="goals" onclick="nav(this)"><span class="bnav-ic">‚óé</span><span class="bnav-lb">Objectifs</span></button>
    <button class="bnav-btn" data-v="patrimoine" onclick="nav(this)"><span class="bnav-ic">‚ñ≤</span><span class="bnav-lb">Patrimoine</span></button>
    <button class="bnav-btn" data-v="calendar" onclick="nav(this)"><span class="bnav-ic">‚ñ¶</span><span class="bnav-lb">Calendrier</span></button>
    <button class="bnav-btn" data-v="history" onclick="nav(this)"><span class="bnav-ic">‚â°</span><span class="bnav-lb">Historique</span></button>
    <button class="bnav-btn" data-v="settings" onclick="nav(this)"><span class="bnav-ic">‚öô</span><span class="bnav-lb">Budgets</span></button>
    <button class="bnav-btn" data-v="profile" onclick="nav(this)"><span class="bnav-ic">‚óè</span><span class="bnav-lb">Profil</span></button>
  </nav>
</div>
<div class="sheet" id="sheet"><div class="sheet-bg" onclick="closeSheet()"></div><div class="sheet-box" id="sheetBox"><div class="sheet-handle"></div><div class="sheet-title" id="sheetTitle"></div><div class="sheet-body" id="sheetBody"></div><div style="padding:12px 20px 20px;display:flex;gap:10px"><button onclick="closeSheet()" style="flex:1;background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:11px;letter-spacing:1px;padding:12px;cursor:pointer;border-radius:10px;text-transform:uppercase">Annuler</button><button onclick="sheetSave()" style="flex:2;background:var(--gold);border:none;color:var(--bg);font-family:var(--mono);font-size:12px;font-weight:700;letter-spacing:1px;padding:12px;cursor:pointer;border-radius:10px;text-transform:uppercase">Sauvegarder ‚Üí</button></div></div></div>
<div class="toast" id="toast"></div>
<input type="file" id="csvInput" accept=".csv,.txt,.ofx,.qif" style="display:none">
<input type="file" id="pdfInput" accept=".pdf,application/pdf" style="display:none">
<input type="file" id="photoInput" accept="image/*" style="display:none">
<input type="file" id="imageOcrInput" accept="image/jpeg,image/png,image/webp,image/gif" style="display:none">
<input type="file" id="logoInput" accept="image/*" style="display:none">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MSH=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
const CATS=[
  {name:'Salaire',icon:'üí∞',color:'#4CAF50',type:'income'},
  {name:'Logement',icon:'‚åÇ',color:'#C8A97E',type:'needs'},
  {name:'Alimentation',icon:'‚óà',color:'#7EC8A9',type:'needs'},
  {name:'Transport',icon:'‚óâ',color:'#7EA9C8',type:'needs'},
  {name:'Sant√©',icon:'‚ú¶',color:'#C87EA9',type:'needs'},
  {name:'Impr√©vus',icon:'‚ö°',color:'#FF5722',type:'needs'},
  {name:'Loisirs',icon:'‚óé',color:'#A97EC8',type:'wants'},
  {name:'V√™tements',icon:'‚óÜ',color:'#C8C87E',type:'wants'},
  {name:'Restaurants',icon:'‚òï',color:'#C87E7E',type:'wants'},
  {name:'Voyage',icon:'‚úà',color:'#00BCD4',type:'wants'},
  {name:'Cadeaux',icon:'‚ô•',color:'#E91E63',type:'wants'},
  {name:'√âpargne',icon:'‚óà',color:'#8EC8C8',type:'savings'},
  {name:'Investissements',icon:'‚ñ≤',color:'#7EC8A9',type:'savings'},
  {name:'Autre',icon:'‚óã',color:'#666',type:'wants'},
];
const GOAL_ICONS=['üèñÔ∏è','üöó','üè†','üì±','üíç','‚úàÔ∏è','üìö','üéì','üèãÔ∏è','üí∞','üÜò','üéÅ','üõãÔ∏è','üé∏','üë∂'];
const GOAL_COLORS=['#C8A97E','#7EC8A9','#7EA9C8','#C87EA9','#A97EC8','#C8C87E'];
const ASSET_CATS=['√âpargne','Investissements','Immobilier','Crypto','Autre actif'];
const DEBT_CATS=['Cr√©dit immobilier','Cr√©dit auto','Cr√©dit conso','Pr√™t √©tudiant','D√©couvert','Autre dette'];
const FREQS=[
  {id:'weekly',l:'Hebdo',s:'sem',days:7},
  {id:'monthly',l:'Mensuel',s:'mois',days:30.44},
  {id:'quarterly',l:'Trimestr.',s:'trim',days:91.3},
  {id:'biannual',l:'Semestr.',s:'6m',days:182.6},
  {id:'yearly',l:'Annuel',s:'an',days:365.25},
];
const SERVICE_BANK=[
  {name:'Netflix',domain:'netflix.com',color:'#E50914'},
  {name:'Disney+',domain:'disneyplus.com',color:'#113CCF'},
  {name:'Max',domain:'max.com',color:'#002BE7'},
  {name:'Prime Video',domain:'primevideo.com',color:'#00A8E1'},
  {name:'Apple TV+',domain:'tv.apple.com',color:'#555'},
  {name:'Canal+',domain:'canalplus.com',color:'#333'},
  {name:'Molotov',domain:'molotov.tv',color:'#FF4040'},
  {name:'Crunchyroll',domain:'crunchyroll.com',color:'#F47521'},
  {name:'YouTube Premium',domain:'youtube.com',color:'#FF0000'},
  {name:'Spotify',domain:'spotify.com',color:'#1DB954'},
  {name:'Deezer',domain:'deezer.com',color:'#FF0092'},
  {name:'Apple Music',domain:'music.apple.com',color:'#FC3C44'},
  {name:'Tidal',domain:'tidal.com',color:'#333'},
  {name:'Xbox Game Pass',domain:'xbox.com',color:'#107C10'},
  {name:'PlayStation+',domain:'playstation.com',color:'#003087'},
  {name:'Nintendo Online',domain:'nintendo.com',color:'#E4000F'},
  {name:'EA Play',domain:'ea.com',color:'#FF4747'},
  {name:'Steam',domain:'store.steampowered.com',color:'#1B2838'},
  {name:'iCloud',domain:'icloud.com',color:'#3478F6'},
  {name:'Google One',domain:'one.google.com',color:'#4285F4'},
  {name:'Dropbox',domain:'dropbox.com',color:'#0061FF'},
  {name:'OneDrive',domain:'onedrive.live.com',color:'#0078D4'},
  {name:'Microsoft 365',domain:'microsoft.com',color:'#D83B01'},
  {name:'Adobe CC',domain:'adobe.com',color:'#FF0000'},
  {name:'Notion',domain:'notion.so',color:'#333'},
  {name:'Figma',domain:'figma.com',color:'#F24E1E'},
  {name:'GitHub',domain:'github.com',color:'#333'},
  {name:'Canva',domain:'canva.com',color:'#00C4CC'},
  {name:'ChatGPT Plus',domain:'openai.com',color:'#10A37F'},
  {name:'Claude Pro',domain:'claude.ai',color:'#D4A27A'},
  {name:'NordVPN',domain:'nordvpn.com',color:'#4687FF'},
  {name:'1Password',domain:'1password.com',color:'#1A8CFF'},
  {name:'Dashlane',domain:'dashlane.com',color:'#004F9F'},
  {name:'Le Monde',domain:'lemonde.fr',color:'#333'},
  {name:'Le Figaro',domain:'lefigaro.fr',color:'#C41A1A'},
  {name:'Mediapart',domain:'mediapart.fr',color:'#00517A'},
  {name:'Kindle',domain:'amazon.fr',color:'#FF9900'},
  {name:'Audible',domain:'audible.fr',color:'#F8991D'},
  {name:'Strava',domain:'strava.com',color:'#FC4C02'},
  {name:'Calm',domain:'calm.com',color:'#3D83E6'},
  {name:'Headspace',domain:'headspace.com',color:'#F47D31'},
  {name:'Duolingo',domain:'duolingo.com',color:'#58CC02'},
  {name:'Amazon Prime',domain:'amazon.fr',color:'#FF9900'},
  {name:'Fnac+',domain:'fnac.com',color:'#E6AF00'},
  {name:'Deliveroo+',domain:'deliveroo.fr',color:'#00CCBC'},
  {name:'Uber One',domain:'uber.com',color:'#333'},
  // ‚îÄ‚îÄ Op√©rateurs t√©l√©com ‚îÄ‚îÄ
  {name:'Orange',domain:'orange.fr',color:'#FF7900'},
  {name:'Free',domain:'free.fr',color:'#CD0000'},
  {name:'SFR',domain:'sfr.fr',color:'#E2001A'},
  {name:'Bouygues Telecom',domain:'bouyguestelecom.fr',color:'#1E88D8'},
  // ‚îÄ‚îÄ √ânergie / Logement ‚îÄ‚îÄ
  {name:'EDF',domain:'edf.fr',color:'#F5A623'},
  {name:'Engie',domain:'engie.fr',color:'#00AAFF'},
  {name:'Veolia',domain:'veolia.com',color:'#009DE0'},
  {name:'TotalEnergies',domain:'totalenergies.fr',color:'#FF6600'},
  // ‚îÄ‚îÄ Transport ‚îÄ‚îÄ
  {name:'SNCF Connect',domain:'sncf-connect.com',color:'#D01C27'},
  {name:'Navigo / RATP',domain:'ratp.fr',color:'#0055A4'},
  {name:'V√©lib',domain:'velib-metropole.fr',color:'#8BC34A'},
  {name:'BlaBlaCar',domain:'blablacar.fr',color:'#00AAFF'},
  {name:'Bolt',domain:'bolt.eu',color:'#34D186'},
  {name:'Heetch',domain:'heetch.com',color:'#FD5F31'},
  // ‚îÄ‚îÄ Sant√© & Administratif ‚îÄ‚îÄ
  {name:'Doctolib',domain:'doctolib.fr',color:'#46BFBF'},
  {name:'Alan',domain:'alan.com',color:'#5B2BF5'},
  {name:'URSSAF',domain:'urssaf.fr',color:'#003F87'},
  {name:'France Travail',domain:'francetravail.fr',color:'#005DA3'},
  // ‚îÄ‚îÄ E-commerce & Services ‚îÄ‚îÄ
  {name:'Amazon',domain:'amazon.fr',color:'#FF9900'},
  {name:'Leboncoin',domain:'leboncoin.fr',color:'#FF6E14'},
  {name:'Vinted',domain:'vinted.fr',color:'#09B1BA'},
  {name:'Shein',domain:'shein.com',color:'#E23744'},
  {name:'Temu',domain:'temu.com',color:'#FF6600'},
  {name:'La Poste',domain:'laposte.fr',color:'#FFCD00'},
  {name:'Cofidis',domain:'cofidis.fr',color:'#004A8F'},
  // ‚îÄ‚îÄ Presse & Culture ‚îÄ‚îÄ
  {name:'Cafeyn',domain:'cafeyn.co',color:'#5A1EFF'},
  {name:'Arte',domain:'arte.tv',color:'#E0423E'},
  {name:'France TV',domain:'france.tv',color:'#003B90'},
];
const CATEGORY_RULES=[
  {cat:'Salaire',kw:['salaire','paye','paie','remuneration','vir employeur','virement employeur','traitement','solde ','prime ','indemnite','allocation','caf ','pole emploi','france travail','pension','retraite','revenu']},
  {cat:'Logement',kw:['loyer','bail','quittance','edf','engie','total energie','eau ','gaz ','fibre','sfr','orange','free ','bouygues','bytel','assurance ','mutuelle ','mma','axa','maif','macif','allianz','cardif','electricite','logt']},
  {cat:'Alimentation',kw:['carrefour','leclerc','lidl','aldi','intermarche','monoprix','franprix','casino ','auchan','picard ','biocoop','naturalia','supermarche','boulangerie','boucherie','primeur','superette','cora','geant','hyper u','spar','drive','fresh','marche ']},
  {cat:'Restaurants',kw:['restaurant','brasserie','bistrot','cafe ','bar ','mcdo','mcdonald','burger king','kfc','subway ','quick ','pizza','domino','uber eat','deliveroo','just eat','doordash','sushi','kebab','tacos','crepe','snack']},
  {cat:'Transport',kw:['sncf','ratp','navigo','velib','blablacar','ouigo','tgv','eurostar','taxi ','uber ','bolt ','heetch','kapten','location voiture','hertz','avis ','europcar','sixt','peage','essence','total ','shell','esso','station ','carburant','parking','vignette']},
  {cat:'Sant√©',kw:['pharmacie','medecin','docteur','hopital','clinique','dentiste','opticien','kin√©','kinesither','osteo','radiologue','labo','cpam','ameli','sante','optical center','afflelou','atol','krys']},
  {cat:'Voyage',kw:['hotel','airbnb','booking.com','vol ','avion','billet avion','agence voyage','location vacances','resort','croisiere','sejour','trip','expedia','kayak','skyscanner']},
  {cat:'Cadeaux',kw:['cadeau','gift','anniversaire','noel','fete','mariage','naissance','bapteme','fleuriste','bijou']},
  {cat:'Impr√©vus',kw:['reparation','depannage','urgence','imprev','panne','plombier','serrurier','accident','amende','contravention','franchise']},
  {cat:'Loisirs',kw:['netflix','spotify','deezer','disney','canal+','fnac ','cultura','steam','playstation','xbox','nintendo','cinema','theatre','concert','festival','musee','amazon prime','youtube premium','apple music','spotify','apple tv','tidal','max ']},
  {cat:'V√™tements',kw:['h&m','zara','primark','uniqlo','mango ','sandro','celio','gap ','levis','nike ','adidas','decathlon','jules ','kiabi','la redoute','asos','zalando','shein','vinted','vetement','chaussure']},
  {cat:'√âpargne',kw:['livret','pel','cel','epargne','capitalisation','assurance vie','per ','pea ','scpi']},
  {cat:'Investissements',kw:['bourse','etf','obligation','crypto','bitcoin','binance','coinbase','trading','degiro','lynx','interactive broker']},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sm=new Date().getMonth(),sy=new Date().getFullYear(),cv='dashboard';
let _importPreview=[];
let _detectedSubs=[];
let _dismissed=JSON.parse(localStorage.getItem('_dismissed')||'[]');
let _balanceChart=null;
let _renewLock={};
let _currentTheme=localStorage.getItem('theme')||'dark';
let _importTab='csv';
let _editingLogoSubId=null;

// KPI visibility prefs
const DEFAULT_KPIS={revenus:true,depenses:true,solde:true,patrimoine:true,resteAVivre:true,remboursements:true,rule5030:true,categories:true,chart6m:true,projection:true,forecast:true,objectifs:true,recentes:true};
function getKpiPrefs(){try{return{...DEFAULT_KPIS,...JSON.parse(localStorage.getItem('kpiPrefs')||'{}')};}catch(e){return{...DEFAULT_KPIS};}}
function saveKpiPrefs(p){localStorage.setItem('kpiPrefs',JSON.stringify(p));}

function loadData(){
  try{const d=JSON.parse(localStorage.getItem('bpro2'));if(d){if(!d.s)d.s=[];if(!d.goals)d.goals=[];if(!d.assets)d.assets=[];if(!d.debts)d.debts=[];return d;}}catch(e){}
  return {t:[],b:{},s:[],goals:[],assets:[],debts:[]};
}
let data=loadData();
function save(){
  try{localStorage.setItem('bpro2',JSON.stringify(data));}
  catch(e){toast('Stockage plein ‚Äî exportez vos donn√©es !','err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CURRENCIES=[
  {code:'EUR',locale:'fr-FR',label:'Euro (‚Ç¨)'},
  {code:'USD',locale:'en-US',label:'Dollar US ($)'},
  {code:'GBP',locale:'en-GB',label:'Livre sterling (¬£)'},
  {code:'CHF',locale:'de-CH',label:'Franc suisse (CHF)'},
  {code:'CAD',locale:'fr-CA',label:'Dollar canadien (CA$)'},
  {code:'XOF',locale:'fr-FR',label:'Franc CFA BCEAO (FCFA)'},
  {code:'MAD',locale:'fr-MA',label:'Dirham marocain (MAD)'},
  {code:'DZD',locale:'fr-DZ',label:'Dinar alg√©rien (DZD)'},
  {code:'TND',locale:'fr-TN',label:'Dinar tunisien (TND)'},
  {code:'JPY',locale:'ja-JP',label:'Yen japonais (¬•)'},
  {code:'BRL',locale:'pt-BR',label:'R√©al br√©silien (R$)'},
];
function getCurrency(){const code=localStorage.getItem('currency')||'EUR';return CURRENCIES.find(c=>c.code===code)||CURRENCIES[0];}
function fmtMoney(n){const cur=getCurrency();try{return new Intl.NumberFormat(cur.locale,{style:'currency',currency:cur.code,maximumFractionDigits:cur.code==='XOF'?0:2}).format(n);}catch(e){return n.toFixed(2)+' '+cur.code;}}
function fmtEur(n){return fmtMoney(n);}
function curSymbol(){const cur=getCurrency();try{const p=new Intl.NumberFormat(cur.locale,{style:'currency',currency:cur.code}).formatToParts(0);const s=p.find(x=>x.type==='currency');return s?s.value:cur.code;}catch(e){return cur.code;}}
function parseInput(s){if(s===null||s===undefined)return NaN;let v=String(s).trim().replace(/\s|\u00a0/g,'');if(!v)return NaN;const ld=v.lastIndexOf('.'),lc=v.lastIndexOf(',');if(ld>-1&&lc>-1){if(lc>ld)v=v.replace(/\./g,'').replace(',','.');else v=v.replace(/,/g,'');}else if(lc>-1)v=v.replace(',','.');v=v.replace(/[^\d.\-]/g,'');return parseFloat(v);}
function gid(){return Math.random().toString(36).slice(2,10);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function toast(msg,type){const e=document.getElementById('toast');e.textContent=msg;e.style.background=type==='err'?'#C85555':'var(--gold)';e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2600);}
function gc(name){return CATS.find(c=>c.name===name)||CATS.find(c=>c.name==='Autre')||CATS[CATS.length-1];}
function daysUntil(ds){const t=new Date();t.setHours(0,0,0,0);const g=new Date(ds);g.setHours(0,0,0,0);return Math.round((g-t)/86400000);}
function freqDays(f){return FREQS.find(x=>x.id===f)?.days||30.44;}
function freqLabel(f,short){return FREQS.find(x=>x.id===f)?.[short?'s':'l']||f;}
function monthlyEquiv(a,f){return a/(freqDays(f)/30.44);}
function advanceNext(ds,f){
  const d=new Date(ds);const origDay=d.getDate();
  if(f==='weekly')d.setDate(d.getDate()+7);
  else if(f==='monthly'){d.setMonth(d.getMonth()+1);if(d.getDate()!==origDay)d.setDate(0);}
  else if(f==='quarterly'){d.setMonth(d.getMonth()+3);if(d.getDate()!==origDay)d.setDate(0);}
  else if(f==='biannual'){d.setMonth(d.getMonth()+6);if(d.getDate()!==origDay)d.setDate(0);}
  else if(f==='yearly'){d.setFullYear(d.getFullYear()+1);if(d.getDate()!==origDay)d.setDate(0);}
  return d.toISOString().slice(0,10);
}
function logoUrl(domain){return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;}
function logoHtml(s,imgCls,fbCls){
  imgCls=imgCls||'sub-logo';fbCls=fbCls||'sub-fb';
  const custom=s&&s.id?localStorage.getItem('logo_'+s.id):null;
  if(custom){
    return `<img class="${imgCls}" src="${custom}" alt=""><div class="${fbCls}" style="display:none;background:${s.color||'#444'};color:#fff">${esc((s.name||'?')[0])}</div>`;
  }
  if(s&&s.domain&&s.domain.trim()!==''){
    return `<img class="${imgCls}" src="${logoUrl(s.domain)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt=""><div class="${fbCls}" style="display:none;background:${s.color||'#444'};color:#fff">${esc((s.name||'?')[0])}</div>`;
  }
  const cat=gc(s&&s.c);return `<div class="${fbCls}" style="background:${cat.color};color:#0A0C0F;font-size:12px">${cat.icon}</div>`;
}
function todayStr(){return new Date().toISOString().slice(0,10);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getProfile(){try{return JSON.parse(localStorage.getItem('user_profile'))||{};}catch(e){return {};}}
function saveProfileData(p){localStorage.setItem('user_profile',JSON.stringify(p));}
function updateHeaderProfile(){
  const p=getProfile(),av=document.getElementById('hdrAvatar'),ey=document.getElementById('hdrEyebrow');
  if(av){
    if(p.photo){
      av.innerHTML=`<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
      av.classList.remove('empty');
    } else if(p.name){
      av.innerHTML='';
      const pts=p.name.split(' ');const ini=(pts[0]?.[0]||'')+(pts[1]?.[0]||pts[0]?.[1]||'');
      av.textContent=ini.toUpperCase()||p.name[0].toUpperCase();av.classList.remove('empty');
    } else {
      av.innerHTML='';av.textContent='?';av.classList.add('empty');
    }
  }
  if(ey){ey.textContent=p.name?'Bonjour, '+p.name.split(' ')[0]:'Finances Personnelles';}
}
function initTheme(){
  document.documentElement.setAttribute('data-theme',_currentTheme);
}
function setTheme(name){
  _currentTheme=name;
  localStorage.setItem('theme',name);
  const html=document.documentElement;
  html.classList.add('theme-fx');
  html.setAttribute('data-theme',name);
  setTimeout(()=>html.classList.remove('theme-fx'),450);
  if(cv==='profile')render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changeMonth(delta){const dt=new Date(sy,sm+delta,1);sm=dt.getMonth();sy=dt.getFullYear();updateHeader();render();}
function updateHeader(){document.getElementById('mLabel').textContent=MSH[sm]+' '+sy;}
function nav(btn){document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');cv=btn.dataset.v;render();}
function navTo(v){const btn=document.querySelector(`.bnav-btn[data-v="${v}"]`);if(btn)nav(btn);}
function mtx(){return data.t.filter(t=>{const d=new Date(t.d);return d.getMonth()===sm&&d.getFullYear()===sy;});}
function mSubsTx(){
  const result=[];
  const viewDate=new Date(sy,sm,1);
  (data.s||[]).filter(s=>s.active!==false).forEach(s=>{
    // Calculate if this sub falls in the viewed month
    // For monthly+: always appears every month from start
    // We check if the sub was active before or during this month
    const nd=new Date(s.next);
    const freq=s.freq||'monthly';
    // Simple: if next date is in this month, show it
    if(nd.getMonth()===sm&&nd.getFullYear()===sy){
      result.push({id:'sub_'+s.id,lb:s.name,a:s.a,c:s._cat||'Loisirs',d:s.next,tp:s._tp||'e',_isSub:true,_sub:s});
      return;
    }
    // Previsional: for the CURRENT month only, auto-inject all active monthly/weekly subs
    // even if their next date hasn't been renewed yet (vision pr√©visionnelle)
    const now=new Date();
    if(sm===now.getMonth()&&sy===now.getFullYear()){
      // Sub is active and recurring ‚Äî inject it for this month
      const fDays=freqDays(freq);
      if(fDays<=31.5){ // weekly or monthly
        const dayInMonth=nd.getDate();
        const synthDate=`${sy}-${String(sm+1).padStart(2,'0')}-${String(Math.min(dayInMonth,new Date(sy,sm+1,0).getDate())).padStart(2,'0')}`;
        // Only if not already a manual transaction matching this sub
        const alreadyManual=data.t.some(t=>{
          const td=new Date(t.d);
          return td.getMonth()===sm&&td.getFullYear()===sy&&t.lb===s.name&&Math.abs(t.a-s.a)<0.5;
        });
        if(!alreadyManual){
          result.push({id:'sub_auto_'+s.id,lb:s.name,a:s.a,c:s._cat||'Loisirs',d:synthDate,tp:s._tp||'e',_isSub:true,_sub:s,_auto:true});
        }
      }
    }
  });
  return result;
}
function mtxAll(){return [...mtx(),...mSubsTx()];}
function getUpcoming(days){return (data.s||[]).filter(s=>s.active!==false).filter(s=>{const d=daysUntil(s.next);return d>=0&&d<=days;}).sort((a,b)=>daysUntil(a.next)-daysUntil(b.next));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const views={dashboard:rDash,add:rAdd,import:rImport,subs:rSubs,goals:rGoals,patrimoine:rPatrimoine,calendar:rCalendar,history:rHistory,settings:rSettings,profile:rProfile};
  const mainEl=document.getElementById('main');
  mainEl.innerHTML=(views[cv]||rDash)();
  mainEl.classList.remove('view-in');
  void mainEl.offsetHeight;
  mainEl.classList.add('view-in');
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.toggle('on',b.dataset.v===cv));
  updateHeaderProfile();
  // Sub badge
  const sl=document.getElementById('tabSubsLbl');
  if(sl){const u=getUpcoming(7);sl.innerHTML=u.length>0?'Abos<span class="dot"></span>':'Abos';document.getElementById('tabSubs').style.color=(u.length>0&&cv!=='subs')?'#ffaa44':'';}
  // Import badge
  const il=document.getElementById('tabImportLbl');
  if(il){const p=_detectedSubs.filter(s=>!_dismissed.includes(s.key)).length;il.innerHTML=p>0?'Import<span class="dot"></span>':'Import';}
  // Charts
  if(cv==='dashboard')setTimeout(()=>{renderBalanceChart(window._lastM6);renderProjectionChart(window._lastProj12);},50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rDash(){
  const kp=getKpiPrefs();
  const txs=mtxAll();
  const inc=txs.filter(t=>t.tp==='i').reduce((s,t)=>s+t.a,0);
  const exp=txs.filter(t=>t.tp==='e').reduce((s,t)=>s+t.a,0);
  const bal=inc-exp;
  const byCat=CATS.map(c=>({...c,total:txs.filter(t=>t.tp==='e'&&t.c===c.name).reduce((s,t)=>s+t.a,0)})).filter(c=>c.total>0);
  // 6 month data
  let m6=[];
  for(let i=5;i>=0;i--){
    const dt=new Date(sy,sm-i,1),mm=dt.getMonth(),yy=dt.getFullYear();
    const ts=data.t.filter(t=>{const d=new Date(t.d);return d.getMonth()===mm&&d.getFullYear()===yy;});
    const subM=(data.s||[]).filter(s=>s.active!==false).filter(s=>{const nd=new Date(s.next);return nd.getMonth()===mm&&nd.getFullYear()===yy;});
    const subInc=subM.filter(s=>s._tp==='i').reduce((s,x)=>s+x.a,0);
    const subExp=subM.filter(s=>s._tp!=='i').reduce((s,x)=>s+x.a,0);
    const ii=ts.filter(t=>t.tp==='i').reduce((s,t)=>s+t.a,0)+subInc;
    const ee=ts.filter(t=>t.tp==='e').reduce((s,t)=>s+t.a,0)+subExp;
    m6.push({l:MSH[mm],i:ii,e:ee});
  }
  window._lastM6=m6;
  // 50/30/20
  const needs=txs.filter(t=>t.tp==='e'&&gc(t.c).type==='needs').reduce((s,t)=>s+t.a,0);
  const wants=txs.filter(t=>t.tp==='e'&&gc(t.c).type==='wants').reduce((s,t)=>s+t.a,0);
  const savgs=txs.filter(t=>t.tp==='e'&&gc(t.c).type==='savings').reduce((s,t)=>s+t.a,0);
  const rule=inc>0&&kp.rule5030?`<div class="card"><div class="card-t">R√®gle 50/30/20</div>${ruleBar('Besoins',needs,inc*.5,inc,'#7EA9C8')}${ruleBar('Envies',wants,inc*.3,inc,'#A97EC8')}${ruleBar('√âpargne',savgs,inc*.2,inc,'#7EC8A9')}<div class="mono xxs" style="color:var(--muted);margin-top:6px;line-height:1.6">Id√©al : 50% besoins ¬∑ 30% envies ¬∑ 20% √©pargne</div></div>`:'';
  // Alerts
  const urgent=getUpcoming(3),soon2=getUpcoming(7).filter(s=>daysUntil(s.next)>3);
  let alerts='';
  if(urgent.length){alerts+=`<div class="alert urg"><div class="alert-t" style="color:#ff7070">‚ö† √âch√©ances imminentes</div>${urgent.map(s=>`<div class="alert-row"><span style="display:flex;align-items:center;gap:7px;font-size:12px;color:#D4CCC0">${s.domain?`<img style="width:16px;height:16px;border-radius:3px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}${esc(s.name)} <span class="mono xs" style="color:#555">‚Äî ${fmtEur(s.a)}</span></span><span class="badge urg">${daysUntil(s.next)===0?"Auj.":daysUntil(s.next)+"j"}</span></div>`).join('')}</div>`;}
  if(soon2.length){alerts+=`<div class="alert soon"><div class="alert-t" style="color:#ffaa44">‚óé Dans 7 jours</div>${soon2.map(s=>`<div class="alert-row"><span style="display:flex;align-items:center;gap:7px;font-size:12px;color:#D4CCC0">${s.domain?`<img style="width:16px;height:16px;border-radius:3px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}${esc(s.name)} <span class="mono xs" style="color:#555">‚Äî ${fmtEur(s.a)}</span></span><span class="badge soon">dans ${daysUntil(s.next)}j</span></div>`).join('')}</div>`;}
  // Goals preview
  const ag=data.goals.filter(g=>g.saved<g.target).slice(0,2);
  const goalsP=ag.length&&kp.objectifs?`<div class="card"><div class="card-t">Objectifs en cours</div>${ag.map(g=>{const p=Math.min(g.saved/g.target*100,100);return`<div style="margin-bottom:10px"><div class="row-between" style="margin-bottom:5px"><span style="font-size:13px;color:#D4CCC0">${esc(g.icon)} ${esc(g.name)}</span><span class="mono xs" style="color:var(--dim)">${fmtEur(g.saved)} / ${fmtEur(g.target)}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${p}%;background:${g.color||'var(--gold)'}"></div></div></div>`;}).join('')}<button style="background:none;border:none;color:var(--gold);font-family:var(--mono);font-size:10px;cursor:pointer;letter-spacing:1px;padding-top:4px" onclick="navTo('goals')">Voir tous les objectifs ‚Üí</button></div>`:'';
  // Net worth
  const totalA=data.assets.reduce((s,a)=>s+a.val,0),totalD=data.debts.reduce((s,d)=>s+d.val,0),nw=totalA-totalD;
  const nwKpi=totalA>0&&kp.patrimoine?`<div class="kpi w3"><div class="kpi-l">Patrimoine net</div><div class="kpi-v" style="color:${nw>=0?'var(--gold)':'var(--red)'}">${fmtEur(nw)}</div></div>`:'';
  // Debt stats ‚Äî Remboursements KPI
  const ds=calcDebtStats();
  const debtKpi=ds.totalMensualite>0&&kp.remboursements?`<div class="kpi"><div class="kpi-l">Remboursements</div><div class="kpi-v p">‚àí${fmtEur(ds.totalMensualite)}<span class="mono xxs" style="color:var(--dim);font-weight:400">/mois</span></div></div><div class="kpi"><div class="kpi-l">Endettement</div><div class="kpi-v" style="color:${ds.tauxEndettement>33?'var(--red)':ds.tauxEndettement>25?'#ffaa44':'var(--green)'}">${ds.tauxEndettement}%</div></div>`:'';
  // Cat bars
  const catBars=byCat.length?byCat.map(c=>{const b=data.b[c.name];const p=b?Math.min(c.total/b*100,100):null;const fc=p&&p>90?'var(--red)':c.color;return`<div style="margin-bottom:9px"><div class="row-between" style="margin-bottom:3px"><span class="mono xs" style="color:${c.color}">${c.icon} ${c.name}</span><span class="mono xs" style="color:#555">${fmtEur(c.total)}${b?' / '+fmtEur(b):''}</span></div>${p!==null?`<div class="bar-bg thin"><div class="bar-fill thin" style="width:${p}%;background:${fc}"></div></div>`:''}</div>`;}).join(''):'<div class="empty">Aucune d√©pense ce mois</div>';
  // Forecast ‚Äî 30 jours
  const fcItems=(data.s||[]).filter(s=>s.active!==false).filter(s=>{const d=daysUntil(s.next);return d>=0&&d<=30;}).sort((a,b)=>a.next.localeCompare(b.next));
  const forecast=fcItems.length&&kp.forecast?`<div class="card"><div class="card-t">Pr√©visionnel 30 jours</div>${fcItems.slice(0,6).map(s=>{const isInc=s._tp==='i';return`<div class="fc-row"><span class="fc-date">${s.next.slice(5)}</span><span class="fc-label">${s.domain?`<img style="width:13px;height:13px;border-radius:3px;vertical-align:middle;margin-right:4px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}${esc(s.name)}</span><span class="mono xs ${isInc?'g':'p'}">${isInc?'+':'‚àí'}${fmtEur(s.a)}</span></div>`;}).join('')}<div style="display:flex;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border);margin-top:4px"><span class="mono xs" style="color:var(--pink)">Charges : ‚àí${fmtEur(fcItems.filter(s=>s._tp!=='i').reduce((s,i)=>s+i.a,0))}</span></div></div>`:'';
  // Projection chart data
  const proj12=calcProjection12();
  window._lastProj12=proj12;
  const projHtml=kp.projection?`<div class="card"><div class="card-t">Projection du solde sur 12 mois</div><canvas id="projChart" style="width:100%;max-height:200px"></canvas><div style="display:flex;justify-content:space-between;margin-top:8px"><span class="mono xxs" style="color:var(--muted)">Mois +1 : ${fmtEur(proj12[1]?.balance||0)}</span><span class="mono xxs" style="color:${(proj12[11]?.balance||0)>=0?'var(--green)':'var(--red)'}">Mois +12 : ${fmtEur(proj12[11]?.balance||0)}</span></div></div>`:'';
  // Reste √† vivre (savings section)
  const rav=calcResteAVivre();
  const ravHtml=rav.income>0&&kp.resteAVivre?`<div class="card savings-card"><div class="card-t">√âpargne ¬∑ Reste √† vivre</div><div class="rav-big" style="color:${rav.reste>=0?'var(--green)':'var(--red)'}">${fmtEur(rav.reste)}<span class="mono xs" style="color:var(--dim);font-weight:400"> /mois</span></div><div style="margin-top:10px"><div class="rav-detail"><span class="mono xs" style="color:var(--dim)">‚Üó Revenus r√©currents</span><span class="mono xs g">+${fmtEur(rav.income)}</span></div><div class="rav-detail"><span class="mono xs" style="color:var(--dim)">‚Üò Charges fixes</span><span class="mono xs p">‚àí${fmtEur(rav.charges)}</span></div><div class="rav-detail"><span class="mono xs" style="color:var(--dim)">Taux d'√©pargne</span><span class="mono xs" style="color:var(--gold)">${rav.income>0?Math.round(rav.reste/rav.income*100):0}%</span></div></div></div>`:'';
  // Recent
  const sortedAll=[...txs].sort((a,b)=>b.d.localeCompare(a.d));
  const recent=sortedAll.slice(0,4).map(t=>txRow(t)).join('');
  const more=txs.length>4?`<button style="background:none;border:none;color:var(--gold);font-family:var(--mono);font-size:10px;cursor:pointer;letter-spacing:1px;padding-top:6px" onclick="navTo('history')">Voir les ${txs.length} transactions ‚Üí</button>`:'';
  // Build KPI grid with visibility
  let kpiHtml='<div class="kpis">';
  if(kp.revenus) kpiHtml+=`<div class="kpi"><div class="kpi-l">Revenus</div><div class="kpi-v"><span class="kpi-s g">‚Üó</span>${fmtEur(inc)}</div></div>`;
  if(kp.depenses) kpiHtml+=`<div class="kpi"><div class="kpi-l">D√©penses</div><div class="kpi-v"><span class="kpi-s p">‚Üò</span>${fmtEur(exp)}</div></div>`;
  if(kp.solde) kpiHtml+=`<div class="kpi w3"><div class="kpi-l">Solde</div><div class="kpi-v" style="color:${bal>=0?'var(--gold)':'var(--red)'}">${fmtEur(bal)}</div></div>`;
  kpiHtml+=nwKpi;
  kpiHtml+=debtKpi;
  kpiHtml+='</div>';
  // Edit KPIs button
  const editKpiBtn=`<div style="text-align:right;margin-bottom:8px"><button onclick="openKpiEditor()" style="background:none;border:1px solid var(--border);color:var(--dim);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:5px 10px;cursor:pointer;border-radius:6px">‚öô √âditer KPIs</button></div>`;
  return `${alerts}${editKpiBtn}${kpiHtml}${ravHtml}${rule}${goalsP}${kp.categories?`<div class="card"><div class="card-t">D√©penses par cat√©gorie</div>${catBars}</div>`:''}${kp.chart6m?`<div class="card"><div class="card-t">6 mois <span style="color:var(--green);font-size:8px">‚ñ†</span> revenus <span style="color:var(--pink);font-size:8px">‚ñ†</span> d√©penses</div><canvas id="balanceChart" style="width:100%;max-height:180px"></canvas></div>`:''}${projHtml}${forecast}${kp.recentes?`<div class="card"><div class="card-t">R√©centes</div>${txs.length===0?'<div class="empty">Aucune transaction ce mois</div>':recent}${more}</div>`:''}`;
}
function renderBalanceChart(m6){
  if(!m6||typeof Chart==='undefined')return;
  const canvas=document.getElementById('balanceChart');if(!canvas)return;
  if(_balanceChart){_balanceChart.destroy();_balanceChart=null;}
  _balanceChart=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels:m6.map(m=>m.l),datasets:[{label:'Revenus',data:m6.map(m=>m.i),backgroundColor:'rgba(126,200,169,.7)',borderRadius:5,borderSkipped:false},{label:'D√©penses',data:m6.map(m=>m.e),backgroundColor:'rgba(200,126,169,.7)',borderRadius:5,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:true,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${fmtMoney(c.raw)}`},backgroundColor:'rgba(10,12,15,.95)',borderColor:'rgba(255,255,255,.1)',borderWidth:1,titleColor:'#D4CCC0',bodyColor:'#888',padding:10,cornerRadius:8}},scales:{x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#555',font:{family:"ui-monospace,monospace",size:10}},border:{display:false}},y:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#555',font:{family:"ui-monospace,monospace",size:10},callback:v=>fmtMoney(v)},border:{display:false}}}}});
}
function ruleBar(label,actual,target,inc,color){const pct=inc>0?Math.round(actual/inc*100):0;const tpct=inc>0?Math.round(target/inc*100):0;const over=actual>target;return `<div class="rule-row"><div class="rule-top"><span style="color:${over?'var(--red)':color}">${label}</span><span style="color:${over?'var(--red)':'var(--dim)'}"><b>${pct}%</b> / cible ${tpct}%</span></div><div class="bar-bg"><div class="bar-fill" style="width:${Math.min(pct,100)}%;background:${over?'var(--red)':color}"></div></div></div>`;}

// ‚îÄ‚îÄ Projection 12 mois ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _projChart=null;
function calcProjection12(){
  const txs=mtxAll();
  const currentInc=txs.filter(t=>t.tp==='i').reduce((s,t)=>s+t.a,0);
  const currentExp=txs.filter(t=>t.tp==='e').reduce((s,t)=>s+t.a,0);
  const currentBalance=currentInc-currentExp;
  const activeSubs=(data.s||[]).filter(s=>s.active!==false);
  const moIncome=activeSubs.filter(s=>s._tp==='i').reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  const moExpense=activeSubs.filter(s=>s._tp!=='i').reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  // Include debt mensualit√©s in projection
  const moDebt=(data.debts||[]).reduce((s,d)=>s+(d.mensualite||0),0);
  const proj=[];
  let bal=currentBalance;
  for(let i=0;i<12;i++){
    const dt=new Date(sy,sm+i,1);
    const label=MSH[dt.getMonth()]+' '+String(dt.getFullYear()).slice(2);
    if(i===0){proj.push({label,balance:bal});}
    else{bal+=moIncome-moExpense-moDebt;proj.push({label,balance:Math.round(bal*100)/100});}
  }
  return proj;
}
function renderProjectionChart(proj){
  if(!proj||typeof Chart==='undefined')return;
  const canvas=document.getElementById('projChart');if(!canvas)return;
  if(_projChart){_projChart.destroy();_projChart=null;}
  const colors=proj.map(p=>p.balance>=0?'rgba(126,200,169,.8)':'rgba(200,85,85,.8)');
  const bgColors=proj.map(p=>p.balance>=0?'rgba(126,200,169,.15)':'rgba(200,85,85,.15)');
  _projChart=new Chart(canvas.getContext('2d'),{type:'line',data:{labels:proj.map(p=>p.label),datasets:[{label:'Solde projet√©',data:proj.map(p=>p.balance),borderColor:'var(--gold)',backgroundColor:'rgba(200,169,126,.1)',fill:true,tension:.3,borderWidth:2,pointRadius:4,pointBackgroundColor:colors,pointBorderColor:colors,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:true,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`Solde : ${fmtMoney(c.raw)}`},backgroundColor:'rgba(10,12,15,.95)',borderColor:'rgba(255,255,255,.1)',borderWidth:1,titleColor:'#D4CCC0',bodyColor:'#888',padding:10,cornerRadius:8}},scales:{x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#555',font:{family:"ui-monospace,monospace",size:9}},border:{display:false}},y:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#555',font:{family:"ui-monospace,monospace",size:10},callback:v=>fmtMoney(v)},border:{display:false}}}}});
}

// ‚îÄ‚îÄ Calcul Reste √† vivre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcResteAVivre(){
  const activeSubs=(data.s||[]).filter(s=>s.active!==false);
  const moIncome=activeSubs.filter(s=>s._tp==='i').reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  const moExpense=activeSubs.filter(s=>s._tp!=='i').reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  // Also count salary from current month transactions
  const txs=mtxAll();
  const txIncome=txs.filter(t=>t.tp==='i').reduce((s,t)=>s+t.a,0);
  const totalIncome=Math.max(moIncome,txIncome);
  return {income:totalIncome,charges:moExpense,reste:totalIncome-moExpense,details:{moIncome,moExpense,txIncome}};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD TRANSACTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rAdd(){
  const opts=CATS.map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join('');
  return `<div class="card"><div class="card-t">Nouvelle transaction</div><div class="fg"><div><div class="fl" style="margin-bottom:6px">Type</div><div class="pill-row"><button class="pill on-p" id="bE" onclick="selType('e')">‚àí D√©pense</button><button class="pill" id="bI" onclick="selType('i')">+ Revenu</button></div><input id="fT" type="hidden" value="e"></div><label class="fl">Libell√©<input id="fL" class="fi" type="text" placeholder="Ex : Loyer, Salaire‚Ä¶"></label><div class="fr2"><label class="fl">Montant (${curSymbol()})<input id="fA" class="fi" type="text" inputmode="decimal" placeholder="0,00"></label><label class="fl">Date<input id="fD" class="fi" type="date" value="${todayStr()}"></label></div><label class="fl">Cat√©gorie<select id="fC" class="fs">${opts}</select></label><div><div class="fl" style="margin-bottom:6px">R√©currence</div><div class="pill-row"><button class="pill on" id="rNone" onclick="selRecur('none')">Unique</button><button class="pill" id="rMonth" onclick="selRecur('monthly')">Mensuel</button><button class="pill" id="rWeek" onclick="selRecur('weekly')">Hebdo</button><button class="pill" id="rYear" onclick="selRecur('yearly')">Annuel</button></div><input id="fRecur" type="hidden" value="none"></div><button class="submit" onclick="submitTx()">Ajouter ‚Üí</button></div></div>`;
}
function selType(tp){document.getElementById('fT').value=tp;document.getElementById('bE').className='pill'+(tp==='e'?' on-p':'');document.getElementById('bI').className='pill'+(tp==='i'?' on-g':'');}
function selRecur(r){document.getElementById('fRecur').value=r;['None','Month','Week','Year'].forEach(k=>{document.getElementById('r'+k).className='pill'+((k==='None'&&r==='none')||(k==='Month'&&r==='monthly')||(k==='Week'&&r==='weekly')||(k==='Year'&&r==='yearly')?' on':'');});}
function nextRecurDate(d,freq){const dt=new Date(d);if(freq==='monthly')dt.setMonth(dt.getMonth()+1);else if(freq==='weekly')dt.setDate(dt.getDate()+7);else if(freq==='yearly')dt.setFullYear(dt.getFullYear()+1);return dt.toISOString().slice(0,10);}
function submitTx(){
  const lb=document.getElementById('fL')?.value?.trim(),a=parseInput(document.getElementById('fA')?.value),c=document.getElementById('fC')?.value,d=document.getElementById('fD')?.value,tp=document.getElementById('fT')?.value,recur=document.getElementById('fRecur')?.value||'none';
  if(!lb||isNaN(a)){toast('Champs manquants !','err');return;}
  if(recur==='none'){data.t.unshift({id:gid(),lb,a:Math.abs(a),c,d,tp});save();toast('Transaction ajout√©e');}
  else{const freq=recur,next=nextRecurDate(d,freq);data.s.push({id:gid(),name:lb,a:Math.abs(a),next,freq,domain:'',color:'',active:true,_fromTx:true,_tp:tp,_cat:c});data.t.unshift({id:gid(),lb,a:Math.abs(a),c,d,tp});const fl={monthly:'mensuel',weekly:'hebdomadaire',yearly:'annuel'}[freq];save();toast(`Ajout√© + r√©currence ${fl}`);}
  navTo('dashboard');
}
function txRow(t,showEdit){
  const cat=gc(t.c),isInc=t.tp==='i',isSub=!!t._isSub;
  const subDomain=isSub&&t._sub?.domain?t._sub.domain:'';
  const logoObj=isSub&&subDomain?{...t,domain:subDomain,color:t._sub.color||cat.color}:{...t,color:cat.color};
  let action;
  if(isSub) action=`<span style="font-family:var(--mono);font-size:9px;color:var(--blue);padding:2px 0 2px 8px;white-space:nowrap;cursor:pointer" onclick="navTo('subs')">‚Ü∫ Abo</span>`;
  else if(showEdit) action=`<button class="tx-del" style="color:var(--blue);font-size:14px" onclick="openEditTx('${t.id}')">‚úé</button><button class="tx-del" onclick="delTx('${t.id}')">√ó</button>`;
  else action=`<button class="tx-del" onclick="delTx('${t.id}')">√ó</button>`;
  return `<div class="tx">${logoHtml(logoObj,'tx-logo','tx-fb')}<div class="tx-inf"><div class="tx-lb">${esc(t.lb)}</div><div class="tx-mt">${t.d} ¬∑ ${t.c}${isSub?' ¬∑ <span style="color:var(--blue)">abonnement</span>':''}</div></div><div class="tx-am ${isInc?'g':'p'}">${isInc?'‚Üó +':'‚Üò ‚àí'}${fmtEur(t.a)}</div>${action}</div>`;
}
function delTx(id){if(!confirm('Supprimer cette transaction ?'))return;data.t=data.t.filter(t=>t.id!==id);save();render();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBSCRIPTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function subCardHtml(s){
  const d=daysUntil(s.next),inact=s.active===false,isInc=s._tp==='i';let dc='#555',dt='';
  if(!inact){if(d<0){dc='#444';dt='pass√©';}else if(d===0){dc='#ff7070';dt="Aujourd'hui";}else if(d<=3){dc='#ff7070';dt=`dans ${d}j`;}else if(d<=7){dc='#ffaa44';dt=`dans ${d}j`;}else{dc='var(--green)';dt=`dans ${d}j`;}}else dt='inactif';
  return `<div class="sub-card" style="${inact?'opacity:.4':''}"><div style="display:flex;flex-shrink:0">${logoHtml(s)}</div><div class="sub-inf" onclick="openEditSub('${s.id}')"><div class="sub-nm">${esc(s.name)}</div><div class="sub-mt">${freqLabel(s.freq,true)} ¬∑ ${s.next}${s._cat?' ¬∑ '+s._cat:''}${isInc?' ¬∑ <span style="color:var(--green)">revenu</span>':''}</div></div><div class="sub-rt"><div class="sub-pr" style="color:${isInc?'var(--green)':'#D4CCC0'}">${isInc?'+':''}${fmtEur(s.a)}</div><div class="sub-due" style="color:${dc}">${dt}</div></div><div class="sub-acts"><button class="sab rn" onclick="renewSub('${s.id}')">‚Ü∫</button><button class="sab ed" onclick="openEditSub('${s.id}')">‚úé</button><button class="sab" onclick="toggleSub('${s.id}')">${inact?'‚ñ∂':'‚è∏'}</button><button class="sab dl" onclick="delSub('${s.id}')">√ó</button></div></div>`;
}
function rSubs(){
  const subs=data.s||[],active=subs.filter(s=>s.active!==false);
  const incomeRec=active.filter(s=>s._tp==='i');
  const expenseRec=active.filter(s=>s._tp!=='i');
  const totalMoExp=expenseRec.reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  const totalMoInc=incomeRec.reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  const pending=_detectedSubs.filter(s=>!_dismissed.includes(s.key));
  const detectedHtml=pending.length?`<div class="card" style="border-color:rgba(126,200,169,.3);background:rgba(8,15,8,.9)"><div class="card-t" style="color:var(--green)">‚ú¶ Abonnements d√©tect√©s dans votre CSV</div><p class="mono xxs" style="color:var(--muted);margin-bottom:10px;line-height:1.6">Ces paiements r√©currents ont √©t√© identifi√©s. Voulez-vous les ajouter ?</p>${pending.map(s=>`<div class="det-sub-card" id="det_${s.key}"><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">${s.domain?`<img style="width:32px;height:32px;border-radius:8px;background:#111" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:'<div style="width:32px;height:32px;border-radius:8px;background:rgba(126,200,169,.2);display:flex;align-items;center;justify-content:center;font-size:14px">‚óé</div>'}<div style="flex:1"><div style="font-size:13px;color:#D4CCC0">${esc(s.name)}</div><div class="mono xs" style="color:var(--muted)">${fmtEur(s.amount)} ¬∑ ${freqLabel(s.freq)} ¬∑ vu ${s.count}√ó dans l'historique</div></div></div><div class="fr2" style="gap:6px"><button onclick="acceptDetectedSub('${s.key}')" style="background:var(--green);border:none;color:var(--bg);font-family:var(--mono);font-size:10px;font-weight:700;padding:9px;cursor:pointer;border-radius:6px">+ Ajouter</button><button onclick="dismissDetectedSub('${s.key}')" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:10px;padding:9px;cursor:pointer;border-radius:6px">Ignorer</button></div></div>`).join('')}</div>`:'';
  // Revenus r√©currents section
  const incCards=incomeRec.length?`<div class="card" style="border-color:rgba(126,200,169,.2)"><div class="card-t" style="color:var(--green)">‚Üó Revenus r√©currents ¬∑ <span style="color:var(--green)">+${fmtEur(totalMoInc)}/mois</span></div>${incomeRec.map(s=>subCardHtml(s)).join('')}</div>`:'';
  const cards=subs.filter(s=>s._tp!=='i').length===0&&incomeRec.length===0?'<div class="empty">Aucun abonnement enregistr√©</div>':[...subs.filter(s=>s._tp!=='i')].sort((a,b)=>daysUntil(a.next)-daysUntil(b.next)).map(s=>subCardHtml(s)).join('');
  const bankGrid=SERVICE_BANK.map((svc,i)=>`<div class="litem" data-name="${esc(svc.name)}" data-idx="${i}" onclick="pickSvc(${i})"><img class="limg" src="${logoUrl(svc.domain)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt=""><div class="lfb" style="display:none;background:${svc.color};color:#fff">${svc.name[0]}</div><span class="llbl">${esc(svc.name)}</span></div>`).join('');
  return `${detectedHtml}${incCards}<div class="card"><div class="card-t">‚Üò Mes abonnements ¬∑ <span style="color:var(--pink)">‚âà ${fmtEur(totalMoExp)}/mois</span></div>${cards}${expenseRec.length?`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid var(--border);margin-top:4px"><span class="mono xs" style="color:var(--muted)">Co√ªt annuel estim√©</span><span class="mono sm" style="color:var(--pink)">‚âà ${fmtEur(totalMoExp*12)}</span></div>`:''}</div><div class="card"><div class="card-t">Ajouter un abonnement / revenu r√©current</div><div class="fg"><div><input class="logo-search" id="lsearch" type="text" placeholder="Rechercher Netflix, Spotify‚Ä¶" oninput="filterSvcBank(this.value)"><div class="logo-grid" id="lgrid">${bankGrid}</div></div><div id="sprev" style="display:none;background:rgba(0,0,0,.3);border:1px solid var(--gold);border-radius:8px;padding:10px;align-items:center;gap:10px"><div id="sprevLogo"></div><div><div style="font-size:13px;color:#D4CCC0" id="sprevName"></div><span class="mono xxs" style="color:var(--muted)">S√©lectionn√©</span></div></div><label class="fl">Nom du service<input id="sName" class="fi" type="text" placeholder="Nom personnalis√©‚Ä¶"></label><div class="fr2"><label class="fl">Montant (${curSymbol()})<input id="sAmt" class="fi" type="text" inputmode="decimal" placeholder="0,00"></label><label class="fl">Prochaine √©ch√©ance<input id="sNext" class="fi" type="date" value="${todayStr()}"></label></div><label class="fl">Cat√©gorie<select id="sCat" class="fs">${CATS.map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join('')}</select></label><div><div class="fl" style="margin-bottom:6px">Type</div><div class="pill-row"><button class="pill on-p" id="stE" onclick="selSubType('e')">‚Üò D√©pense</button><button class="pill" id="stI" onclick="selSubType('i')">‚Üó Revenu</button></div><input type="hidden" id="sType" value="e"></div><div><div class="fl" style="margin-bottom:6px">Fr√©quence</div><div class="pill-row" id="freqPills">${FREQS.map(f=>`<button class="pill${f.id==='monthly'?' on':''}" onclick="selFreq(this,'${f.id}')">${f.l}</button>`).join('')}</div><input type="hidden" id="sFreq" value="monthly"><input type="hidden" id="sDomain" value=""><input type="hidden" id="sColor" value="#888"></div><button class="submit" onclick="addSub()">Ajouter ‚Üí</button></div></div>`;
}
function selFreq(btn,freqId){document.querySelectorAll('#freqPills .pill').forEach(b=>b.className='pill');btn.className='pill on';document.getElementById('sFreq').value=freqId;}
function selSubType(tp){document.getElementById('sType').value=tp;document.getElementById('stE').className='pill'+(tp==='e'?' on-p':'');document.getElementById('stI').className='pill'+(tp==='i'?' on-g':'');}
function pickSvc(i){const s=SERVICE_BANK[i];document.querySelectorAll('.litem').forEach(el=>el.classList.remove('sel'));document.querySelector(`.litem[data-idx="${i}"]`)?.classList.add('sel');document.getElementById('sName').value=s.name;document.getElementById('sDomain').value=s.domain;document.getElementById('sColor').value=s.color;const p=document.getElementById('sprev');if(p)p.style.display='flex';const pn=document.getElementById('sprevName'),pl=document.getElementById('sprevLogo');if(pn)pn.textContent=s.name;if(pl)pl.innerHTML=`<img style="width:32px;height:32px;border-radius:8px;background:#111" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`;}
function filterSvcBank(q){const lq=q.toLowerCase();document.querySelectorAll('.litem').forEach(el=>{const raw=(el.dataset.name||'').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'");el.style.display=(!q||raw.toLowerCase().includes(lq))?'':'none';});}
function addSub(){
  const name=document.getElementById('sName')?.value?.trim(),a=parseInput(document.getElementById('sAmt')?.value),next=document.getElementById('sNext')?.value,freq=document.getElementById('sFreq')?.value||'monthly',domain=document.getElementById('sDomain')?.value||'',color=document.getElementById('sColor')?.value||'#888',cat=document.getElementById('sCat')?.value||'Loisirs',tp=document.getElementById('sType')?.value||'e';
  if(!name||!a||isNaN(a)||!next){toast('Champs manquants !','err');return;}
  data.s.push({id:gid(),name,a:Math.abs(a),next,freq,domain,color,active:true,_cat:cat,_tp:tp});save();toast(tp==='i'?'Revenu r√©current ajout√©':'Abonnement ajout√©');render();
}
function renewSub(id){
  if(_renewLock[id])return;_renewLock[id]=true;setTimeout(()=>delete _renewLock[id],1000);
  const s=data.s.find(x=>x.id===id);if(!s)return;
  data.t.unshift({id:gid(),lb:s.name,a:s.a,c:s._cat||'Loisirs',d:s.next,tp:s._tp||'e',_subId:s.id});
  s.next=advanceNext(s.next,s.freq);save();toast('Renouvel√© & transaction enregistr√©e');render();
}
function toggleSub(id){const s=data.s.find(x=>x.id===id);if(!s)return;s.active=s.active===false;save();render();}
function delSub(id){if(!confirm('Supprimer cet abonnement ?'))return;data.s=data.s.filter(x=>x.id!==id);save();render();}
function acceptDetectedSub(key){const s=_detectedSubs.find(x=>x.key===key);if(!s)return;data.s.push({id:gid(),name:s.name,a:s.amount,next:s.nextDate,freq:s.freq,domain:s.domain||'',color:s.color||'#888',active:true,_cat:'Loisirs',_tp:'e'});save();dismissDetectedSub(key);toast(`${s.name} ajout√© aux abonnements`);render();}
function dismissDetectedSub(key){_dismissed.push(key);localStorage.setItem('_dismissed',JSON.stringify(_dismissed));const el=document.getElementById('det_'+key);if(el)el.style.display='none';render();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rGoals(){
  const goals=data.goals||[];
  const goalCards=goals.length===0?'<div class="empty">Aucun objectif d√©fini</div>':goals.map(g=>{
    const pct=Math.min(g.saved/g.target*100,100),rem=Math.max(g.target-g.saved,0),daysLeft=g.deadline?daysUntil(g.deadline):null,moNeeded=daysLeft&&daysLeft>0?rem/(daysLeft/30.44):null;
    return `<div class="goal-card"><div class="row-between" style="margin-bottom:6px;align-items:flex-start"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:18px">${g.icon||'üí∞'}</span><div><div style="font-size:13px;color:#D4CCC0">${esc(g.name)}</div><div class="mono xxs" style="color:var(--muted)">${g.deadline?'√âch√©ance : '+g.deadline:'Sans date limite'}</div></div></div><div style="display:flex;gap:4px;align-items:center"><span class="mono xs" style="color:var(--dim)">${Math.round(pct)}%</span><button class="sab ed" onclick="openEditGoal('${g.id}')">‚úé</button></div></div><div class="bar-bg" style="margin-bottom:6px"><div class="bar-fill" style="width:${pct}%;background:${g.color||'var(--gold)'}"></div></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span class="mono xs" style="color:var(--dim)">${fmtEur(g.saved)} √©pargn√©</span><span class="mono xs" style="color:var(--muted)">${fmtEur(rem)} restant</span></div>${moNeeded?`<div class="mono xxs" style="color:${moNeeded>500?'var(--pink)':'var(--green)'};margin-bottom:8px">‚Üí ~${fmtEur(moNeeded)}/mois pour tenir l'√©ch√©ance</div>`:''}<div style="display:flex;gap:6px"><input type="text" inputmode="decimal" id="dep_${g.id}" class="fi" style="flex:1;padding:8px" placeholder="Ex: 200,00"><button onclick="addToGoal('${g.id}')" style="background:var(--green);border:none;color:var(--bg);font-family:var(--mono);font-size:10px;font-weight:700;padding:8px 10px;cursor:pointer;border-radius:6px">+ D√©poser</button><button onclick="delGoal('${g.id}')" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:10px;padding:8px;cursor:pointer;border-radius:6px">√ó</button></div></div>`;
  }).join('');
  const iconPicker=GOAL_ICONS.map((ic,idx)=>`<button onclick="selGoalIcon(${idx})" class="pill" id="gi_${idx}" style="font-size:16px;padding:6px 8px">${ic}</button>`).join('');
  const colorPicker=GOAL_COLORS.map(c=>`<button onclick="selGoalColor('${c}')" class="gcp" data-c="${c}" style="width:22px;height:22px;border-radius:50%;background:${c};border:2px solid transparent;cursor:pointer;flex-shrink:0"></button>`).join('');
  return `<div class="card"><div class="card-t">Mes objectifs</div>${goalCards}</div><div class="card"><div class="card-t">Cr√©er un objectif</div><div class="fg"><label class="fl">Nom de l'objectif<input id="gName" class="fi" type="text" placeholder="Vacances, Voiture, Urgence‚Ä¶"></label><div class="fr2"><label class="fl">Montant cible (${curSymbol()})<input id="gTarget" class="fi" type="text" inputmode="decimal" placeholder="Ex: 5 000,00"></label><label class="fl">D√©j√† √©pargn√© (${curSymbol()})<input id="gSaved" class="fi" type="text" inputmode="decimal" placeholder="0"></label></div><label class="fl">√âch√©ance (optionnel)<input id="gDL" class="fi" type="date"></label><div><div class="fl" style="margin-bottom:7px">Ic√¥ne</div><div class="pill-row">${iconPicker}</div><input type="hidden" id="gIcon" value="${GOAL_ICONS[0]}"></div><div><div class="fl" style="margin-bottom:7px">Couleur</div><div style="display:flex;gap:8px;flex-wrap:wrap">${colorPicker}</div><input type="hidden" id="gColor" value="${GOAL_COLORS[0]}"></div><button class="submit" onclick="addGoal()">Cr√©er l'objectif ‚Üí</button></div></div><div class="card"><div class="card-t">Simulateur d'√©pargne</div><div class="fg"><div class="fr2"><label class="fl">√âpargne/mois (${curSymbol()})<input id="simAmt" class="fi" type="text" inputmode="decimal" placeholder="200" oninput="runSim()"></label><label class="fl">Dur√©e (ann√©es)<input id="simYrs" class="fi" type="number" inputmode="decimal" placeholder="5" oninput="runSim()"></label></div><label class="fl">Taux annuel (%)<input id="simRate" class="fi" type="number" inputmode="decimal" placeholder="3" step="0.1" oninput="runSim()"></label></div><div id="simResult"></div></div>`;
}
function selGoalIcon(idx){document.getElementById('gIcon').value=GOAL_ICONS[idx];document.querySelectorAll('[id^="gi_"]').forEach(b=>b.className='pill');document.getElementById('gi_'+idx)?.classList.add('on');}
function selGoalColor(c){document.getElementById('gColor').value=c;document.querySelectorAll('.gcp').forEach(b=>b.style.border=b.dataset.c===c?'2px solid #fff':'2px solid transparent');}
function addGoal(){const name=document.getElementById('gName')?.value?.trim(),target=parseInput(document.getElementById('gTarget')?.value),saved=parseInput(document.getElementById('gSaved')?.value)||0,deadline=document.getElementById('gDL')?.value||null,icon=document.getElementById('gIcon')?.value||'üí∞',color=document.getElementById('gColor')?.value||'var(--gold)';if(!name||!target||isNaN(target)){toast('Nom et montant requis','err');return;}data.goals.push({id:gid(),name,target,saved,deadline,icon,color});save();toast('Objectif cr√©√©');render();}
function addToGoal(id){const inp=document.getElementById('dep_'+id),amt=parseInput(inp?.value);if(!amt||isNaN(amt)||amt<=0){toast('Montant invalide','err');return;}const g=data.goals.find(x=>x.id===id);if(!g)return;g.saved=Math.min(g.saved+amt,g.target);inp.value='';save();g.saved>=g.target?toast('Objectif atteint !'):toast(`+${fmtEur(amt)} ajout√©`);render();}
function delGoal(id){if(!confirm('Supprimer cet objectif ?'))return;data.goals=data.goals.filter(x=>x.id!==id);save();render();}
function runSim(){const amt=parseInput(document.getElementById('simAmt')?.value),yrs=parseInput(document.getElementById('simYrs')?.value),rate=(parseInput(document.getElementById('simRate')?.value)||0)/100/12,el=document.getElementById('simResult');if(!el||!amt||!yrs||isNaN(amt)||isNaN(yrs))return;const n=Math.round(yrs*12),fv=rate>0?amt*((Math.pow(1+rate,n)-1)/rate):amt*n,inv=amt*n;el.innerHTML=`<div class="sim-result"><div class="mono xxs" style="color:var(--muted);margin-bottom:4px">Capital dans ${yrs} an${yrs>1?'s':''}</div><div class="sim-big">${fmtEur(fv)}</div><div style="display:flex;justify-content:space-between;margin-top:10px"><span class="mono xs" style="color:var(--dim)">Vers√© : ${fmtEur(inv)}</span><span class="mono xs" style="color:var(--green)">Int√©r√™ts : +${fmtEur(fv-inv)}</span></div></div>`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATRIMOINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcDebtStats(){
  const debts=data.debts||[];
  const totalRemaining=debts.reduce((s,d)=>s+d.val,0);
  const totalMensualite=debts.reduce((s,d)=>s+(d.mensualite||0),0);
  const totalBorrowed=debts.reduce((s,d)=>s+(d.borrowed||d.val),0);
  const totalPaid=totalBorrowed-totalRemaining;
  const pctPaid=totalBorrowed>0?Math.round(totalPaid/totalBorrowed*100):0;
  // Taux d'endettement = mensualit√©s / revenus r√©currents
  const activeSubs=(data.s||[]).filter(s=>s.active!==false);
  const moIncome=activeSubs.filter(s=>s._tp==='i').reduce((s,x)=>s+monthlyEquiv(x.a,x.freq),0);
  const txInc=data.t.filter(t=>{const d=new Date(t.d);return d.getMonth()===new Date().getMonth()&&d.getFullYear()===new Date().getFullYear()&&t.tp==='i';}).reduce((s,t)=>s+t.a,0);
  const bestIncome=Math.max(moIncome,txInc);
  const tauxEndettement=bestIncome>0?Math.round(totalMensualite/bestIncome*100):0;
  return{totalRemaining,totalMensualite,totalBorrowed,totalPaid,pctPaid,tauxEndettement,bestIncome};
}
function rPatrimoine(){
  const assets=data.assets||[],debts=data.debts||[];
  const totalA=assets.reduce((s,a)=>s+a.val,0),totalD=debts.reduce((s,d)=>s+d.val,0),nw=totalA-totalD;
  const ds=calcDebtStats();
  const assetOpts=ASSET_CATS.map(c=>`<option>${c}</option>`).join(''),debtOpts=DEBT_CATS.map(c=>`<option>${c}</option>`).join('');
  const assetRows=assets.length===0?'<div class="empty">Aucun actif</div>':assets.map(a=>`<div class="asset-row"><div><div class="asset-nm">${esc(a.name)}</div><div class="asset-cat">${a.cat}</div></div><div style="display:flex;align-items:center;gap:6px"><span class="mono sm g">${fmtEur(a.val)}</span><button class="sab ed" onclick="openEditAsset('${a.id}')">‚úé</button><button class="tx-del" onclick="delAsset('${a.id}')">√ó</button></div></div>`).join('');
  const debtRows=debts.length===0?'<div class="empty">Aucune dette</div>':debts.map(d=>{
    const borrowed=d.borrowed||d.val;const paid=borrowed-d.val;const pct=borrowed>0?Math.round(paid/borrowed*100):0;
    const endStr=d.endDate?` ¬∑ fin ${d.endDate}`:'';
    const mensuStr=d.mensualite?` ¬∑ ${fmtEur(d.mensualite)}/mois`:'';
    const remainMo=d.mensualite&&d.mensualite>0?Math.ceil(d.val/d.mensualite):null;
    const pays=d.payments||[];
    const lastPays=pays.slice(-3).reverse();
    const payHistory=lastPays.length?`<div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,.03)">${lastPays.map(p=>`<div style="display:flex;justify-content:space-between;padding:3px 0"><span class="mono xxs" style="color:var(--dim)">${p.d}</span><span class="mono xxs g">‚àí${fmtEur(p.a)}</span></div>`).join('')}${pays.length>3?`<div class="mono xxs" style="color:var(--muted);text-align:center;padding-top:2px">+ ${pays.length-3} paiement${pays.length-3>1?'s':''} ant√©rieur${pays.length-3>1?'s':''}</div>`:''}</div>`:'';
    return`<div style="padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04)"><div class="row-between" style="margin-bottom:4px"><div><div class="asset-nm">${esc(d.name)}</div><div class="asset-cat">${d.cat}${d.rate?` ¬∑ ${d.rate}%/an`:''}${mensuStr}${endStr}</div></div><div style="display:flex;align-items:center;gap:6px"><span class="mono sm r">‚àí${fmtEur(d.val)}</span><button class="sab ed" onclick="openEditDebt('${d.id}')">‚úé</button><button class="tx-del" onclick="delDebt('${d.id}')">√ó</button></div></div><div class="bar-bg" style="margin-bottom:4px"><div class="bar-fill" style="width:${pct}%;background:var(--green)"></div></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span class="mono xxs" style="color:var(--dim)">${fmtEur(paid)} rembours√© (${pct}%)</span><span class="mono xxs" style="color:var(--muted)">${remainMo?`~${remainMo} mois restants`:`${fmtEur(borrowed)} emprunt√©`}</span></div><div style="display:flex;gap:6px;align-items:center"><input type="text" inputmode="decimal" id="pay_${d.id}" class="fi" style="flex:1;padding:8px;font-size:12px" placeholder="Montant rembours√©‚Ä¶"><button onclick="payDebt('${d.id}')" style="background:var(--green);border:none;color:var(--bg);font-family:var(--mono);font-size:10px;font-weight:700;padding:8px 12px;cursor:pointer;border-radius:6px;white-space:nowrap">‚úì Payer</button></div>${payHistory}</div>`;
  }).join('');
  const pieHtml=totalA>0?assets.map(a=>{const p=Math.round(a.val/totalA*100);return`<div style="margin-bottom:7px"><div class="row-between" style="margin-bottom:3px"><span class="mono xs" style="color:var(--dim)">${esc(a.name)}</span><span class="mono xs" style="color:#555">${p}%</span></div><div class="bar-bg thin"><div class="bar-fill thin" style="width:${p}%;background:var(--green)"></div></div></div>`;}).join(''):'';
  // Debt summary KPIs
  const debtKpis=debts.length?`<div class="kpi"><div class="kpi-l">Mensualit√©s</div><div class="kpi-v p">‚àí${fmtEur(ds.totalMensualite)}</div></div><div class="kpi"><div class="kpi-l">Taux endettement</div><div class="kpi-v" style="color:${ds.tauxEndettement>33?'var(--red)':ds.tauxEndettement>25?'#ffaa44':'var(--green)'}">${ds.tauxEndettement}%</div></div>`:'';
  return `<div class="kpis"><div class="kpi"><div class="kpi-l">Total actifs</div><div class="kpi-v g">${fmtEur(totalA)}</div></div><div class="kpi"><div class="kpi-l">Reste √† payer</div><div class="kpi-v r">‚àí${fmtEur(totalD)}</div></div>${debtKpis}<div class="kpi w3"><div class="kpi-l">Patrimoine net</div><div class="kpi-v" style="color:${nw>=0?'var(--gold)':'var(--red)'}">${fmtEur(nw)}</div></div></div><div class="card"><div class="card-t">Actifs</div>${assetRows}${pieHtml}</div><div class="card"><div class="card-t">Dettes & cr√©dits</div>${debtRows}</div><div class="card"><div class="card-t">Ajouter un actif</div><div class="fg"><label class="fl">Nom<input id="aName" class="fi" type="text" placeholder="Livret A, Actions, Appartement‚Ä¶"></label><div class="fr2"><label class="fl">Valeur (${curSymbol()})<input id="aVal" class="fi" type="text" inputmode="decimal" placeholder="0"></label><label class="fl">Cat√©gorie<select id="aCat" class="fs">${assetOpts}</select></label></div><button class="submit" style="background:linear-gradient(135deg,var(--green),#96D8B8)" onclick="addAsset()">Ajouter actif ‚Üí</button></div></div><div class="card"><div class="card-t">Ajouter une dette / cr√©dit</div><div class="fg"><label class="fl">Nom<input id="dName" class="fi" type="text" placeholder="Pr√™t immobilier, Cr√©dit auto‚Ä¶"></label><div class="fr2"><label class="fl">Reste √† payer (${curSymbol()})<input id="dVal" class="fi" type="text" inputmode="decimal" placeholder="0"></label><label class="fl">Montant emprunt√© (${curSymbol()})<input id="dBorrowed" class="fi" type="text" inputmode="decimal" placeholder="Total initial"></label></div><div class="fr3"><label class="fl">Mensualit√© (${curSymbol()})<input id="dMens" class="fi" type="text" inputmode="decimal" placeholder="0"></label><label class="fl">Taux (%/an)<input id="dRate" class="fi" type="number" inputmode="decimal" placeholder="3.5" step="0.1"></label><label class="fl">Date de fin<input id="dEnd" class="fi" type="month" placeholder="YYYY-MM"></label></div><label class="fl">Cat√©gorie<select id="dCat" class="fs">${debtOpts}</select></label><button class="submit" style="background:linear-gradient(135deg,var(--pink),#D896B8)" onclick="addDebt()">Ajouter dette ‚Üí</button></div></div>`;
}
function addAsset(){const name=document.getElementById('aName')?.value?.trim(),val=parseInput(document.getElementById('aVal')?.value),cat=document.getElementById('aCat')?.value;if(!name||!val||isNaN(val)){toast('Champs manquants !','err');return;}data.assets.push({id:gid(),name,val,cat});save();toast('Actif ajout√©');render();}
function addDebt(){
  const name=document.getElementById('dName')?.value?.trim(),val=parseInput(document.getElementById('dVal')?.value),rate=parseInput(document.getElementById('dRate')?.value)||0,cat=document.getElementById('dCat')?.value;
  const borrowed=parseInput(document.getElementById('dBorrowed')?.value)||val;
  const mensualite=parseInput(document.getElementById('dMens')?.value)||0;
  const endDate=document.getElementById('dEnd')?.value||'';
  if(!name||!val||isNaN(val)){toast('Champs manquants !','err');return;}
  data.debts.push({id:gid(),name,val,rate,cat,borrowed,mensualite,endDate});save();toast('Dette ajout√©e');render();
}
function delAsset(id){if(!confirm('Supprimer ?'))return;data.assets=data.assets.filter(x=>x.id!==id);save();render();}
function delDebt(id){if(!confirm('Supprimer ?'))return;data.debts=data.debts.filter(x=>x.id!==id);save();render();}
function payDebt(id){
  const inp=document.getElementById('pay_'+id);
  const amt=parseInput(inp?.value);
  if(!amt||isNaN(amt)||amt<=0){toast('Montant invalide','err');return;}
  const d=data.debts.find(x=>x.id===id);if(!d)return;
  if(amt>d.val){toast('Montant sup√©rieur au reste √† payer','err');return;}
  d.val=Math.round((d.val-amt)*100)/100;
  if(!d.payments)d.payments=[];
  d.payments.push({a:amt,d:todayStr()});
  inp.value='';
  save();
  if(d.val<=0){toast('üéâ Dette sold√©e !');} else {toast(`‚àí${fmtEur(amt)} rembours√©`);}
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rCalendar(){
  const now=new Date();
  const firstDay=new Date(sy,sm,1).getDay();
  const daysInMonth=new Date(sy,sm+1,0).getDate();
  const isCurrentMonth=sm===now.getMonth()&&sy===now.getFullYear();
  const todayDate=now.getDate();

  const evMap={};
  mtx().forEach(t=>{
    const d=parseInt(t.d.split('-')[2]);
    if(!evMap[d])evMap[d]=[];
    evMap[d].push({color:t.tp==='i'?'var(--green)':'var(--pink)',amount:t.a,tp:t.tp,label:t.lb});
  });
  (data.s||[]).filter(s=>s.active!==false).forEach(s=>{
    const nd=new Date(s.next);
    if(nd.getMonth()===sm&&nd.getFullYear()===sy){
      const d=nd.getDate();
      if(!evMap[d])evMap[d]=[];
      evMap[d].push({color:'var(--blue)',amount:s.a,tp:'e',label:s.name,domain:s.domain,type:'sub'});
    }
  });

  const startOffset=(firstDay+6)%7;
  let cells='';
  for(let i=0;i<startOffset;i++) cells+=`<div class="cal-day"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const evs=evMap[d]||[];
    const isToday=isCurrentMonth&&d===todayDate;
    const icons=evs.slice(0,3).map(e=>{
      if(e.type==='sub'&&e.domain){
        return `<img class="cal-icon" src="${logoUrl(e.domain)}" onerror="this.outerHTML='<span class=\\'cal-arrow\\' style=\\'color:var(--blue)\\'>‚Üò</span>'" alt="">`;
      } else if(e.tp==='i'){
        return `<span class="cal-arrow" style="color:var(--green)">‚Üó</span>`;
      } else {
        return `<span class="cal-arrow" style="color:var(--pink)">‚Üò</span>`;
      }
    }).join('');
    const totalExp=evs.filter(e=>e.tp==='e').reduce((s,e)=>s+e.amount,0);
    cells+=`<div class="cal-day${evs.length?' has-event':''}${isToday?' today':''}" onclick="showDay(${d})">
      <div class="cal-day-num">${d}</div>
      <div class="cal-icons-wrap">${icons}</div>
      ${totalExp>0?`<div style="font-size:7px;color:var(--pink);margin-top:1px;font-family:var(--mono)">-${Math.round(totalExp)}${curSymbol()}</div>`:''}
    </div>`;
  }

  return `<div class="card">
    <div class="card-t">${MS[sm]} ${sy}</div>
    <div style="display:flex;gap:12px;margin-bottom:10px">
      <span class="mono xxs" style="color:var(--green)">‚ñ† Revenus</span>
      <span class="mono xxs" style="color:var(--pink)">‚ñ† Depenses</span>
      <span class="mono xxs" style="color:var(--blue)">‚ñ† Abonnements</span>
    </div>
    <div class="cal-grid">
      ${['L','M','M','J','V','S','D'].map(d=>`<div class="cal-day-hdr">${d}</div>`).join('')}
      ${cells}
    </div>
  </div>
  <div id="dayDetail"></div>`;
}
function showDay(d){
  const evs=[];
  mtx().forEach(t=>{ if(parseInt(t.d.split('-')[2])===d) evs.push({label:t.lb,amount:t.a,color:t.tp==='i'?'var(--green)':'var(--pink)',sign:t.tp==='i'?'+':'-'}); });
  (data.s||[]).filter(s=>s.active!==false).forEach(s=>{
    const nd=new Date(s.next);
    if(nd.getDate()===d&&nd.getMonth()===sm&&nd.getFullYear()===sy)
      evs.push({label:s.name,amount:s.a,color:'var(--blue)',sign:'-',domain:s.domain});
  });
  const el=document.getElementById('dayDetail'); if(!el)return;
  if(!evs.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="card">
    <div class="card-t">${d} ${MS[sm]}</div>
    ${evs.map(e=>`<div class="tx">
      <div class="tx-inf">
        <div class="tx-lb">${e.domain?`<img style="width:14px;height:14px;border-radius:3px;vertical-align:middle;margin-right:4px" src="${logoUrl(e.domain)}" onerror="this.style.display='none'">`:''}${esc(e.label)}</div>
      </div>
      <span class="mono xs" style="color:${e.color}">${e.sign}${fmtEur(e.amount)}</span>
    </div>`).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rHistory(){
  const txs=mtxAll();
  const realCount=mtx().length;
  const subCount=txs.length-realCount;
  const subtitle=subCount>0?` (dont ${subCount} abo${subCount>1?'s':''})` :'';
  const sorted=[...txs].sort((a,b)=>b.d.localeCompare(a.d));
  return `<div class="card">
    <div class="card-t">${MS[sm]} ${sy} ‚Äî ${txs.length} transaction${txs.length!==1?'s':''}${subtitle}</div>
    ${sorted.length===0?'<div class="empty">Aucune transaction ce mois</div>':sorted.map(t=>txRow(t,true)).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS (plafonds uniquement)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSettings(){
  const rows=CATS.map(c=>`<label class="fl">${c.icon} ${c.name}
    <input class="fi bi" data-cat="${c.name}" type="text" inputmode="decimal" placeholder="Aucun plafond" value="${data.b[c.name]||''}">
  </label>`).join('');
  const kp=getKpiPrefs();
  const KPI_LABELS={revenus:'‚Üó Revenus',depenses:'‚Üò D√©penses',solde:'‚óé Solde du mois',patrimoine:'‚óÜ Patrimoine net',resteAVivre:'üí∞ Reste √† vivre',remboursements:'üìã Remboursements / Endettement',rule5030:'üìä R√®gle 50/30/20',categories:'üìÅ D√©penses par cat√©gorie',chart6m:'üìà Graphique 6 mois',projection:'üìâ Projection 12 mois',forecast:'üìÖ Pr√©visionnel 30 jours',objectifs:'üéØ Objectifs en cours',recentes:'üïê Transactions r√©centes'};
  const kpiToggles=Object.entries(KPI_LABELS).map(([k,label])=>`<label style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer"><input type="checkbox" class="kpi-chk" data-kpi="${k}" ${kp[k]?'checked':''} style="width:18px;height:18px;accent-color:var(--gold);cursor:pointer"><span class="mono xs" style="color:var(--text)">${label}</span></label>`).join('');
  return `<div class="card">
    <div class="card-t">‚öô Indicateurs du tableau de bord</div>
    <p class="mono xxs" style="color:var(--muted);margin-bottom:12px;line-height:1.5">Cochez les indicateurs que vous souhaitez afficher sur le dashboard.</p>
    ${kpiToggles}
    <button class="submit" style="margin-top:14px" onclick="saveKpiToggles()">Enregistrer les KPIs</button>
  </div>
  <div class="card">
    <div class="card-t">Plafonds mensuels</div>
    <div class="fg">${rows}</div>
    <button class="submit" style="margin-top:16px" onclick="saveBudgets()">Sauvegarder</button>
  </div>`;
}
function saveKpiToggles(){
  const kp=getKpiPrefs();
  document.querySelectorAll('.kpi-chk').forEach(chk=>{
    kp[chk.dataset.kpi]=chk.checked;
  });
  saveKpiPrefs(kp);
  toast('KPIs mis √† jour');
  if(cv==='dashboard') render();
}
function openKpiEditor(){
  const kp=getKpiPrefs();
  const KPI_LABELS={revenus:'‚Üó Revenus',depenses:'‚Üò D√©penses',solde:'‚óé Solde du mois',patrimoine:'‚óÜ Patrimoine net',resteAVivre:'üí∞ Reste √† vivre',remboursements:'üìã Remboursements',rule5030:'üìä R√®gle 50/30/20',categories:'üìÅ Cat√©gories',chart6m:'üìà Graphique 6 mois',projection:'üìâ Projection 12 mois',forecast:'üìÖ Pr√©visionnel 30j',objectifs:'üéØ Objectifs',recentes:'üïê R√©centes'};
  const toggles=Object.entries(KPI_LABELS).map(([k,label])=>`<label style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer"><input type="checkbox" class="kpi-chk-sheet" data-kpi="${k}" ${kp[k]?'checked':''} style="width:18px;height:18px;accent-color:var(--gold);cursor:pointer"><span class="mono xs" style="color:var(--text)">${label}</span></label>`).join('');
  const body=`<p class="mono xxs" style="color:var(--muted);margin-bottom:10px;line-height:1.5">Choisissez les indicateurs visibles sur le tableau de bord.</p>${toggles}`;
  openSheet('√âditer les KPIs', body, ()=>{
    const kp2=getKpiPrefs();
    document.querySelectorAll('.kpi-chk-sheet').forEach(chk=>{kp2[chk.dataset.kpi]=chk.checked;});
    saveKpiPrefs(kp2);
    closeSheet();
    toast('KPIs mis √† jour');
    render();
  });
}
function saveBudgets(){
  document.querySelectorAll('.bi').forEach(inp=>{
    const cat=inp.dataset.cat; const v=parseInput(inp.value);
    if(!isNaN(v)&&v>0) data.b[cat]=v; else delete data.b[cat];
  });
  save(); toast('Budgets sauvegard√©s');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE VIEW (nom, devise, gestion donnees)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rProfile(){
  const p=getProfile();
  const name=p.name||'';
  const parts=name.split(' ');
  const firstName=parts[0]||'';
  const lastName=parts.slice(1).join(' ')||'';
  const initials=(firstName[0]||'')+(lastName[0]||firstName[1]||'');
  const curCode=localStorage.getItem('currency')||'EUR';
  const curOpts=CURRENCIES.map(c=>`<option value="${c.code}"${c.code===curCode?' selected':''}>${c.label}</option>`).join('');
  const themes=[
    {id:'dark', label:'Premium Dark', e:'üåô', colors:['#0A0C0F','#C8A97E','#7EC8A9']},
    {id:'light',label:'Pure Light',   e:'‚òÄÔ∏è', colors:['#F0F4F8','#7C3AED','#059669']},
    {id:'kitty',label:'Hello Kitty',  e:'üéÄ', colors:['#FFF0F5','#FF69B4','#FF85C2']},
  ];
  const cur=_currentTheme||'dark';
  const photoHtml=p.photo
    ?`<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
    :`<span style="font-size:26px;font-weight:700;color:var(--bg)">${esc(initials.toUpperCase()||'?')}</span>`;

  return `<div class="card" style="text-align:center;padding:28px 16px">
    <div class="prof-photo-wrap" onclick="document.getElementById('photoInput').click()" title="Changer la photo">
      <div class="prof-photo-img" style="background:linear-gradient(135deg,var(--gold),#E8C547);display:flex;align-items:center;justify-content:center">${photoHtml}</div>
      <div class="prof-photo-overlay">üì∑</div>
    </div>
    <div style="font-size:16px;font-weight:600;color:var(--text);margin-bottom:4px">${esc(name||'Mon Profil')}</div>
    <div class="mono xxs" style="color:var(--muted)">${data.t.length} transactions ¬∑ ${data.s.length} abos ¬∑ ${data.goals.length} objectifs</div>
  </div>
  <div class="card">
    <div class="card-t">Apparence</div>
    <div class="theme-row">
      ${themes.map(t=>`<button class="theme-btn${cur===t.id?' on':''}" onclick="setTheme('${t.id}')">
        <div class="th-swatches">${t.colors.map(c=>`<span style="background:${c}"></span>`).join('')}</div>
        <div style="font-size:15px;margin-bottom:3px">${t.e}</div>
        <div style="font-size:8px;letter-spacing:1px;text-transform:uppercase;opacity:.8">${t.label}</div>
      </button>`).join('')}
    </div>
  </div>
  <div class="card">
    <div class="card-t">Informations</div>
    <div class="fg">
      <div class="fr2">
        <label class="fl">Prenom<input id="profFirstName" class="fi" type="text" placeholder="Jean" value="${esc(firstName)}"></label>
        <label class="fl">Nom<input id="profLastName" class="fi" type="text" placeholder="Dupont" value="${esc(lastName)}"></label>
      </div>
      <label class="fl">Devise
        <select id="profCurrency" class="fs">${curOpts}</select>
      </label>
      <button class="submit" onclick="saveProfileForm()">Enregistrer</button>
    </div>
  </div>
  <div class="card">
    <div class="card-t">Gestion des donnees</div>
    <div class="fg">
      <button onclick="exportData()" style="background:none;border:1px solid var(--border);color:var(--dim);font-family:var(--mono);font-size:10px;letter-spacing:2px;padding:12px;cursor:pointer;border-radius:8px;text-transform:uppercase;width:100%">Exporter JSON</button>
      <label style="background:none;border:1px solid var(--border);color:var(--dim);font-family:var(--mono);font-size:10px;letter-spacing:2px;padding:12px;cursor:pointer;border-radius:8px;text-transform:uppercase;width:100%;display:block;text-align:center">Importer JSON<input type="file" accept=".json" style="display:none" onchange="importJSON(this)"></label>
      <button onclick="shareApp()" style="background:none;border:1px solid var(--border2);color:var(--gold);font-family:var(--mono);font-size:10px;letter-spacing:2px;padding:12px;cursor:pointer;border-radius:8px;text-transform:uppercase;width:100%">Partager l'app</button>
      <button onclick="confirmDel()" style="background:none;border:1px solid #2a1010;color:var(--red);font-family:var(--mono);font-size:10px;letter-spacing:2px;padding:12px;cursor:pointer;border-radius:8px;text-transform:uppercase;width:100%">Tout effacer</button>
    </div>
  </div>`;
}
function saveProfileForm(){
  const fn=(document.getElementById('profFirstName')?.value||'').trim();
  const ln=(document.getElementById('profLastName')?.value||'').trim();
  const name=[fn,ln].filter(Boolean).join(' ');
  const existing=getProfile();
  saveProfileData({...existing,name}); // preserve photo + other fields
  const cur=document.getElementById('profCurrency')?.value;
  if(cur){localStorage.setItem('currency',cur);}
  updateHeaderProfile();
  toast('Profil enregistre');
  render();
}
function saveProfilePhoto(file){
  if(!file)return;
  if(file.size>2*1024*1024){toast('Image trop grande (max 2 Mo)','err');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    const p=getProfile();
    p.photo=e.target.result;
    saveProfileData(p);
    updateHeaderProfile();
    toast('Photo mise a jour');
    render();
  };
  reader.readAsDataURL(file);
}
function shareApp(){
  let html=document.documentElement.outerHTML;
  // FIX: strip API key from exported HTML
  html=html.replace(/sk-ant-[a-zA-Z0-9_-]{20,}/g,'YOUR_KEY_HERE');
  if(navigator.share&&navigator.canShare){
    const blob=new Blob([html],{type:'text/html'});
    const file=new File([blob],'budget-pro.html',{type:'text/html'});
    if(navigator.canShare({files:[file]})){
      navigator.share({title:'Budget Pro',files:[file]}).catch(()=>shareAppFallback(html));
      return;
    }
  }
  shareAppFallback(html);
}
function shareAppFallback(html){
  const url=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  const a=document.createElement('a');
  a.href=url;a.download='budget-pro.html';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  toast('App telechargee');
}
function exportData(){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='budget_pro.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function importJSON(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(!d.t)throw new Error('Format invalide');
      data=d; save(); toast('Donnees importees'); render();
    }catch(err){ toast('Fichier JSON invalide','err'); }
  };
  reader.readAsText(file);
}
function confirmDel(){
  if(!confirm('Effacer TOUTES les donnees ?'))return;
  data={t:[],b:{},s:[],goals:[],assets:[],debts:[]}; save(); toast('Efface'); render();
}
function saveCurrency(code){
  localStorage.setItem('currency',code);
  toast('Devise mise a jour');
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHEET MODAL ‚Äî open / close
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSheet(title, bodyHtml, onSave){
  document.getElementById('sheetTitle').textContent=title;
  document.getElementById('sheetBody').innerHTML=bodyHtml;
  window._sheetSave=onSave||null;
  document.getElementById('sheet').classList.add('open');
  // Focus first input
  setTimeout(()=>{ const f=document.querySelector('#sheetBox input,#sheetBox select'); if(f)f.focus(); },120);
}
function closeSheet(){
  document.getElementById('sheet').classList.remove('open');
  window._sheetSave=null;
}
function sheetSave(){
  if(typeof window._sheetSave==='function') window._sheetSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Edit Transaction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditTx(id){
  const t=data.t.find(x=>x.id===id); if(!t)return;
  const catOpts=CATS.map(c=>`<option value="${c.name}"${c.name===t.c?' selected':''}>${c.icon} ${c.name}</option>`).join('');
  const body=`<div class="fg">
    <label class="fl">Libelle<input id="etLb" class="fi" type="text" value="${esc(t.lb)}"></label>
    <div class="fr2">
      <label class="fl">Montant (${curSymbol()})<input id="etAmt" class="fi" type="text" inputmode="decimal" value="${t.a.toString().replace('.',',')}"></label>
      <label class="fl">Type
        <select id="etTp" class="fs">
          <option value="e"${t.tp==='e'?' selected':''}>Depense</option>
          <option value="i"${t.tp==='i'?' selected':''}>Revenu</option>
        </select>
      </label>
    </div>
    <label class="fl">Date<input id="etDate" class="fi" type="date" value="${t.d}"></label>
    <label class="fl">Categorie<select id="etCat" class="fs">${catOpts}</select></label>
  </div>`;
  openSheet('Modifier la transaction', body, ()=>saveEditTx(id));
}
function saveEditTx(id){
  const t=data.t.find(x=>x.id===id); if(!t)return;
  const lb=document.getElementById('etLb')?.value?.trim();
  const amt=parseInput(document.getElementById('etAmt')?.value);
  const tp=document.getElementById('etTp')?.value;
  const date=document.getElementById('etDate')?.value;
  const cat=document.getElementById('etCat')?.value;
  if(!lb||!amt||isNaN(amt)||!date){toast('Champs manquants','err');return;}
  t.lb=lb; t.a=Math.abs(amt); t.tp=tp; t.d=date; t.c=cat;
  save(); closeSheet(); toast('Transaction modifiee'); render();
}

// ‚îÄ‚îÄ Edit Subscription ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditSub(id){
  const s=data.s.find(x=>x.id===id); if(!s)return;
  const freqOpts=FREQS.map(f=>`<option value="${f.id}"${s.freq===f.id?' selected':''}>${f.l}</option>`).join('');
  const catOpts=CATS.map(c=>`<option value="${c.name}"${c.name===(s._cat||'Loisirs')?' selected':''}>${c.icon} ${c.name}</option>`).join('');
  const hasCustom=!!localStorage.getItem('logo_'+s.id);
  const body=`<div class="fg">
    <div style="margin-bottom:12px">
      <div class="fl" style="margin-bottom:6px">Logo personnalise</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logo-edit-preview">${logoHtml(s,'sub-logo','sub-fb')}</div>
        <button type="button" onclick="triggerLogoUpload('${s.id}')" style="background:none;border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:8px 12px;cursor:pointer;border-radius:8px;text-transform:uppercase">Importer</button>
        ${hasCustom?`<button type="button" onclick="deleteCustomLogo('${s.id}')" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:8px 12px;cursor:pointer;border-radius:8px;text-transform:uppercase">Reinitialiser</button>`:''}
      </div>
    </div>
    <label class="fl">Nom<input id="esName" class="fi" type="text" value="${esc(s.name)}"></label>
    <div class="fr2">
      <label class="fl">Montant (${curSymbol()})<input id="esAmt" class="fi" type="text" inputmode="decimal" value="${s.a.toString().replace('.',',')}"></label>
      <label class="fl">Frequence<select id="esFreq" class="fs">${freqOpts}</select></label>
    </div>
    <label class="fl">Prochaine echeance<input id="esNext" class="fi" type="date" value="${s.next}"></label>
    <label class="fl">Categorie<select id="esCat" class="fs">${catOpts}</select></label>
    <label class="fl">Type<select id="esTp" class="fs">
      <option value="e"${(s._tp||'e')==='e'?' selected':''}>‚Üò D√©pense (abonnement)</option>
      <option value="i"${s._tp==='i'?' selected':''}>‚Üó Revenu r√©current</option>
    </select></label>
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="esActive" type="checkbox"${s.active!==false?' checked':''}> Actif
    </label>
  </div>`;
  openSheet('Modifier l\'abonnement', body, ()=>saveEditSub(id));
}
function saveEditSub(id){
  const s=data.s.find(x=>x.id===id); if(!s)return;
  const name=document.getElementById('esName')?.value?.trim();
  const amt=parseInput(document.getElementById('esAmt')?.value);
  const freq=document.getElementById('esFreq')?.value;
  const next=document.getElementById('esNext')?.value;
  const cat=document.getElementById('esCat')?.value;
  const tp=document.getElementById('esTp')?.value||'e';
  const active=document.getElementById('esActive')?.checked!==false;
  if(!name||!amt||isNaN(amt)||!next){toast('Champs manquants','err');return;}
  s.name=name; s.a=Math.abs(amt); s.freq=freq; s.next=next; s._cat=cat; s._tp=tp; s.active=active;
  save(); closeSheet(); toast(tp==='i'?'Revenu modifi√©':'Abonnement modifi√©'); render();
}
function triggerLogoUpload(subId){
  _editingLogoSubId=subId;
  document.getElementById('logoInput').click();
}
function saveCustomLogo(file){
  if(!file||!_editingLogoSubId){return;}
  if(file.size>600*1024){toast('Image trop grande (max 600 Ko)','err');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    localStorage.setItem('logo_'+_editingLogoSubId,e.target.result);
    _editingLogoSubId=null;
    toast('Logo mis a jour');render();
  };
  reader.readAsDataURL(file);
}
function deleteCustomLogo(subId){
  localStorage.removeItem('logo_'+subId);
  toast('Logo reinitialise');closeSheet();render();
}

// ‚îÄ‚îÄ Edit Goal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditGoal(id){
  const g=data.goals.find(x=>x.id===id); if(!g)return;
  const iconPicker=GOAL_ICONS.map((ic,idx)=>`<button type="button" onclick="document.getElementById('egIcon').value='${ic}';document.querySelectorAll('.eg-ic').forEach(b=>b.style.opacity='0.4');this.style.opacity='1'" class="eg-ic pill" style="font-size:15px;padding:5px 7px;opacity:${g.icon===ic?'1':'0.4'}">${ic}</button>`).join('');
  const colorPicker=GOAL_COLORS.map(c=>`<button type="button" onclick="document.getElementById('egColor').value='${c}';document.querySelectorAll('.eg-cp').forEach(b=>b.style.border='2px solid transparent');this.style.border='2px solid #fff'" class="eg-cp" style="width:20px;height:20px;border-radius:50%;background:${c};border:${g.color===c?'2px solid #fff':'2px solid transparent'};cursor:pointer;flex-shrink:0"></button>`).join('');
  const body=`<div class="fg">
    <label class="fl">Nom<input id="egName" class="fi" type="text" value="${esc(g.name)}"></label>
    <div class="fr2">
      <label class="fl">Objectif (${curSymbol()})<input id="egTarget" class="fi" type="text" inputmode="decimal" value="${g.target.toString().replace('.',',')}"></label>
      <label class="fl">Deja epargne (${curSymbol()})<input id="egSaved" class="fi" type="text" inputmode="decimal" value="${g.saved.toString().replace('.',',')}"></label>
    </div>
    <label class="fl">Echeance<input id="egDL" class="fi" type="date" value="${g.deadline||''}"></label>
    <div><div class="fl" style="margin-bottom:6px">Icone</div><div class="pill-row">${iconPicker}</div><input type="hidden" id="egIcon" value="${g.icon||'üí∞'}"></div>
    <div><div class="fl" style="margin-bottom:6px">Couleur</div><div style="display:flex;gap:6px;flex-wrap:wrap">${colorPicker}</div><input type="hidden" id="egColor" value="${g.color||GOAL_COLORS[0]}"></div>
  </div>`;
  openSheet('Modifier l\'objectif', body, ()=>saveEditGoal(id));
}
function saveEditGoal(id){
  const g=data.goals.find(x=>x.id===id); if(!g)return;
  const name=document.getElementById('egName')?.value?.trim();
  const target=parseInput(document.getElementById('egTarget')?.value);
  const saved=parseInput(document.getElementById('egSaved')?.value)||0;
  const deadline=document.getElementById('egDL')?.value||null;
  const icon=document.getElementById('egIcon')?.value||'üí∞';
  const color=document.getElementById('egColor')?.value||GOAL_COLORS[0];
  if(!name||!target||isNaN(target)){toast('Champs manquants','err');return;}
  g.name=name; g.target=target; g.saved=saved; g.deadline=deadline; g.icon=icon; g.color=color;
  save(); closeSheet(); toast('Objectif modifie'); render();
}

// ‚îÄ‚îÄ Edit Asset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditAsset(id){
  const a=data.assets.find(x=>x.id===id); if(!a)return;
  const catOpts=ASSET_CATS.map(c=>`<option${c===a.cat?' selected':''}>${c}</option>`).join('');
  const body=`<div class="fg">
    <label class="fl">Nom<input id="eaName" class="fi" type="text" value="${esc(a.name)}"></label>
    <div class="fr2">
      <label class="fl">Valeur (${curSymbol()})<input id="eaVal" class="fi" type="text" inputmode="decimal" value="${a.val.toString().replace('.',',')}"></label>
      <label class="fl">Categorie<select id="eaCat" class="fs">${catOpts}</select></label>
    </div>
  </div>`;
  openSheet('Modifier l\'actif', body, ()=>saveEditAsset(id));
}
function saveEditAsset(id){
  const a=data.assets.find(x=>x.id===id); if(!a)return;
  const name=document.getElementById('eaName')?.value?.trim();
  const val=parseInput(document.getElementById('eaVal')?.value);
  const cat=document.getElementById('eaCat')?.value;
  if(!name||!val||isNaN(val)){toast('Champs manquants','err');return;}
  a.name=name; a.val=val; a.cat=cat;
  save(); closeSheet(); toast('Actif modifie'); render();
}

// ‚îÄ‚îÄ Edit Debt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditDebt(id){
  const d=data.debts.find(x=>x.id===id); if(!d)return;
  const catOpts=DEBT_CATS.map(c=>`<option${c===d.cat?' selected':''}>${c}</option>`).join('');
  const body=`<div class="fg">
    <label class="fl">Nom<input id="edName" class="fi" type="text" value="${esc(d.name)}"></label>
    <div class="fr2">
      <label class="fl">Reste √† payer (${curSymbol()})<input id="edVal" class="fi" type="text" inputmode="decimal" value="${d.val.toString().replace('.',',')}"></label>
      <label class="fl">Montant emprunt√© (${curSymbol()})<input id="edBorrowed" class="fi" type="text" inputmode="decimal" value="${(d.borrowed||d.val).toString().replace('.',',')}"></label>
    </div>
    <div class="fr3">
      <label class="fl">Mensualit√© (${curSymbol()})<input id="edMens" class="fi" type="text" inputmode="decimal" placeholder="0" value="${d.mensualite?d.mensualite.toString().replace('.',','):''}"></label>
      <label class="fl">Taux (%/an)<input id="edRate" class="fi" type="number" inputmode="decimal" placeholder="3.5" step="0.1" value="${d.rate||''}"></label>
      <label class="fl">Date de fin<input id="edEnd" class="fi" type="month" value="${d.endDate||''}"></label>
    </div>
    <label class="fl">Cat√©gorie<select id="edCat" class="fs">${catOpts}</select></label>
  </div>`;
  openSheet('Modifier la dette', body, ()=>saveEditDebt(id));
}
function saveEditDebt(id){
  const d=data.debts.find(x=>x.id===id); if(!d)return;
  const name=document.getElementById('edName')?.value?.trim();
  const val=parseInput(document.getElementById('edVal')?.value);
  const rate=parseInput(document.getElementById('edRate')?.value)||0;
  const cat=document.getElementById('edCat')?.value;
  const borrowed=parseInput(document.getElementById('edBorrowed')?.value)||val;
  const mensualite=parseInput(document.getElementById('edMens')?.value)||0;
  const endDate=document.getElementById('edEnd')?.value||'';
  if(!name||!val||isNaN(val)){toast('Champs manquants','err');return;}
  d.name=name; d.val=val; d.rate=rate; d.cat=cat;
  d.borrowed=borrowed; d.mensualite=mensualite; d.endDate=endDate;
  save(); closeSheet(); toast('Dette modifi√©e'); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT MODULE ‚Äî CSV PARSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CSV helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectCsvSep(headerRow){
  const counts={';':0,',':0,'\t':0};
  for(const c of headerRow){ if(counts[c]!==undefined)counts[c]++; }
  return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0]||';';
}
function csvSplit(row,sep){
  if(!sep)sep=row.includes(';')?';':',';
  const result=[];let cur='',inQ=false;
  for(let i=0;i<row.length;i++){
    const c=row[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===sep&&!inQ){result.push(cur.trim().replace(/^"|"$/g,''));cur='';}
    else cur+=c;
  }
  result.push(cur.trim().replace(/^"|"$/g,''));
  return result;
}
function csvDate(s){
  if(!s)return null;
  s=s.trim().replace(/"/g,'');
  let m=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if(m){const y=m[3].length===2?'20'+m[3]:m[3];return`${y}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;}
  m=s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if(m)return`${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  return null;
}
function csvAmount(s){
  if(s===null||s===undefined)return NaN;
  let v=String(s).trim().replace(/"/g,'').replace(/\s|\u00a0/g,'');
  if(!v)return NaN;
  if(v.startsWith('+'))v=v.slice(1);
  const neg=v.startsWith('-');v=v.replace(/^-/,'');
  if(/^\d{1,3}(\.\d{3})*(,\d{1,2})?$/.test(v)||/^\d{4,}(,\d{1,2})?$/.test(v)){
    v=v.replace(/\./g,'').replace(',','.');
    return(neg?-1:1)*parseFloat(v);
  }
  if(/^\d{1,3}(,\d{3})*(\.\d{1,2})?$/.test(v)||/^\d{4,}(\.\d{1,2})?$/.test(v)){
    v=v.replace(/,/g,'');
    return(neg?-1:1)*parseFloat(v);
  }
  if(/^\d+$/.test(v))return(neg?-1:1)*parseInt(v,10);
  return parseFloat((neg?'-':'')+v.replace(/,/g,''));
}

// ‚îÄ‚îÄ Bank category mapping (Caisse d'Epargne) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ceCatMap(nativeCat){
  if(!nativeCat)return null;
  const n=nativeCat.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(n.includes('salaire')||n.includes('revenu'))return null;
  if(n.includes('logement')||n.includes('internet')||n.includes('telephon')||n.includes('energie')||n.includes('eau'))return 'Logement';
  if(n.includes('alimentation')||n.includes('courses')||n.includes('supermarche')||n.includes('restaurant'))return 'Alimentation';
  if(n.includes('transport')||n.includes('carburant')||n.includes('voiture'))return 'Transport';
  if(n.includes('sante')||n.includes('medical')||n.includes('pharmacie'))return 'Sante';
  if(n.includes('loisir')||n.includes('sport')||n.includes('vacances'))return 'Loisirs';
  if(n.includes('vetement')||n.includes('habillement'))return 'Vetements';
  if(n.includes('epargne')||n.includes('livret')||n.includes('placement'))return 'Epargne';
  return null;
}

// ‚îÄ‚îÄ Bank parsers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PARSERS=[
  {
    id:'ce',name:"Caisse d'Epargne",
    detect:h=>(h.includes('libelle simplifie')||h.includes('libelle operation'))&&(h.includes('debit')&&h.includes('credit'))&&(h.includes('date de comptabilisation')||h.includes('informations complementaires')||h.includes('sous categorie')),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<10)return null;
      const date=csvDate(c[10])||csvDate(c[0]);
      const label=(c[1]||c[2]||'').trim();
      const deb=c[8]?csvAmount(c[8]):0;
      const cred=c[9]?csvAmount(c[9]):0;
      let amount=0;
      if(!isNaN(deb)&&deb!==0)amount=deb;
      else if(!isNaN(cred)&&cred!==0)amount=cred;
      else return null;
      if(!date||!label||isNaN(amount))return null;
      return{date,label,amount,_nativeCat:c[6]||''};
    }).filter(Boolean);}
  },
  {
    id:'boursobank',name:'Boursobank',
    detect:h=>h.includes('dateop')||(h.includes('libelle')&&h.includes('montant')&&h.includes('devise')),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<3)return null;
      let date,label,amount;
      if(c.length>=6&&c[0].match(/\d{2}\/\d{2}\/\d{4}/)){
        date=csvDate(c[0]);label=c[2]||c[1];
        amount=c[4]?-csvAmount(c[4]):csvAmount(c[5]);
      } else{date=csvDate(c[0]);label=c[1];amount=csvAmount(c[2]);}
      return(date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'bnp',name:'BNP Paribas',
    detect:h=>h.includes('libelle simplifie')||h.includes('numero de reference'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<4)return null;
      const date=csvDate(c[0]);const label=c[1]||c[2];
      const amount=csvAmount(c[4]||c[3]);
      return(date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'sg',name:'Societe Generale',
    detect:h=>h.includes('debit')&&h.includes('credit')&&!h.includes('dateop'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<3)return null;
      const date=csvDate(c[0]);const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0;const cred=c[3]?csvAmount(c[3]):0;
      return(date&&label&&!isNaN(deb-cred))?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'ca',name:'Credit Agricole',
    detect:h=>h.includes('dateop')&&h.includes('dateval'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<5)return null;
      const date=csvDate(c[0]);const label=c[2]||c[1];
      const deb=c[4]?csvAmount(c[4]):0;const cred=c[5]?csvAmount(c[5]):0;
      return(date&&label)?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'lcl',name:'LCL',
    detect:h=>h.includes('operation')&&h.includes('valeur'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<3)return null;
      const date=csvDate(c[0]);const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0;const cred=c[3]?csvAmount(c[3]):0;
      return(date&&label)?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'cic',name:'CIC / Credit Mutuel',
    detect:h=>h.includes('libelle')&&h.includes('solde'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<3)return null;
      const date=csvDate(c[0]);const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0;const cred=c[3]?csvAmount(c[3]):0;
      return(date&&label)?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'revolut',name:'Revolut',
    detect:h=>h.includes('completed')&&h.includes('description'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<5)return null;
      const date=csvDate(c[2]||c[0]);const label=c[4]||c[1];
      const amount=csvAmount(c[5]||c[3]);
      return(date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'n26',name:'N26',
    detect:h=>h.includes('account number')||h.includes('payee name'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<3)return null;
      const date=csvDate(c[0]);const label=c[1];
      const amount=csvAmount(c[4]||c[2]);
      return(date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'generic',name:'Format generique',
    detect:()=>true,
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);if(c.length<2)return null;
      const date=c.map(csvDate).find(Boolean);
      const amounts=c.map(csvAmount).filter(v=>!isNaN(v)&&v!==0);
      const label=c.find(x=>x.length>3&&!csvDate(x)&&isNaN(csvAmount(x)));
      if(!date||!label||!amounts.length)return null;
      return{date,label,amount:amounts[0]};
    }).filter(r=>r&&r.date&&r.label);}
  }
];

// ‚îÄ‚îÄ Rule categoriser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ruleCat(label,row){
  if(row&&row._nativeCat){
    const mapped=ceCatMap(row._nativeCat);
    if(mapped&&mapped!=='Autre')return mapped;
  }
  const l=label.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  for(const rule of CATEGORY_RULES){
    if(rule.kw.some(kw=>l.includes(kw)))return rule.cat;
  }
  return 'Autre';
}
// Force income type for Salaire category
function autoFixType(cat,amount){
  if(cat==='Salaire')return 'i';
  if(amount>0)return 'i';
  return 'e';
}

// ‚îÄ‚îÄ AI categoriser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function aiCategorize(rows){
  const apiKey=localStorage.getItem('claudeKey')||'';
  if(!apiKey)return rows.map(r=>({...r,cat:ruleCat(r.label,r),aiCat:false}));
  const BATCH=40;const results=[];
  for(let b=0;b<rows.length;b+=BATCH){
    const batch=rows.slice(b,b+BATCH);
    updateProgress(b,rows.length,batch[0].label);
    const prompt=`Tu es un assistant de categorisation bancaire francaise. Categorise chaque transaction.
Categories valides UNIQUEMENT: ${CATS.map(c=>c.name).join(', ')}.
Reponds UNIQUEMENT avec un tableau JSON, sans texte autour.

Transactions:
${batch.map((r,i)=>`${i}: "${r.label}" ${r.amount>0?'+':''}${r.amount}‚Ç¨`).join('\n')}

Format attendu: [{"i":0,"cat":"Logement"},{"i":1,"cat":"Alimentation"}]`;
    try{
      const resp=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:600,messages:[{role:'user',content:prompt}]})
      });
      if(!resp.ok)throw new Error('HTTP '+resp.status);
      const dat=await resp.json();
      const txt=dat.content[0].text.trim().replace(/```json?|```/g,'').trim();
      const arr=JSON.parse(txt);
      const catMap={};
      arr.forEach(x=>{if(CATS.some(c=>c.name===x.cat))catMap[x.i]=x.cat;});
      batch.forEach((r,i)=>results.push({...r,cat:catMap[i]||ruleCat(r.label,r),aiCat:catMap[i]!=null}));
    }catch(e){
      console.warn('AI batch failed:',e);
      batch.forEach(r=>results.push({...r,cat:ruleCat(r.label,r),aiCat:false}));
    }
  }
  updateProgress(rows.length,rows.length,'');
  return results;
}
function updateProgress(done,total,label){
  const pb=document.getElementById('importProgressBar');if(pb)pb.style.width=`${total?Math.round(done/total*100):100}%`;
  const pl=document.getElementById('importProgressLabel');if(pl)pl.textContent=label?`Analyse : "${label.slice(0,40)}"‚Ä¶`:'Termine';
}

// ‚îÄ‚îÄ Subscription detector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectRecurring(rows){
  const seenKeys=new Set();
  const deduped=rows.filter(r=>{
    const k=`${r.date}|${Math.round(Math.abs(r.amount)*100)}|${(r.label||'').slice(0,30)}`;
    if(seenKeys.has(k))return false;seenKeys.add(k);return true;
  });
  const expenses=deduped.filter(r=>r.amount<0);
  const groups={};
  expenses.forEach(r=>{
    const key=r.label.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\d{4,}/g,'').replace(/\b\d{1,3}\b/g,'').replace(/[\/\-_\.]/g,' ')
      .replace(/\s+/g,' ').trim().slice(0,40);
    if(!groups[key])groups[key]=[];
    groups[key].push({date:r.date,amount:Math.abs(r.amount),rawLabel:r.label});
  });
  const detected=[];
  Object.entries(groups).forEach(([key,items])=>{
    if(items.length<2)return;
    items.sort((a,b)=>a.date.localeCompare(b.date));
    const amounts=items.map(i=>i.amount);
    const avgAmt=amounts.reduce((s,a)=>s+a,0)/amounts.length;
    const consistent=amounts.every(a=>Math.abs(a-avgAmt)/avgAmt<0.05);
    if(!consistent)return;
    const intervals=[];
    for(let i=1;i<items.length;i++){
      const d1=new Date(items[i-1].date),d2=new Date(items[i].date);
      intervals.push((d2-d1)/86400000);
    }
    if(!intervals.length)return;
    const avgInterval=intervals.reduce((s,v)=>s+v,0)/intervals.length;
    let freq=null;
    if(avgInterval>=6&&avgInterval<=8)freq='weekly';
    else if(avgInterval>=26&&avgInterval<=35)freq='monthly';
    else if(avgInterval>=85&&avgInterval<=98)freq='quarterly';
    else if(avgInterval>=170&&avgInterval<=196)freq='biannual';
    else if(avgInterval>=350&&avgInterval<=380)freq='yearly';
    if(!freq)return;
    const nameNorm=items[0].rawLabel.toLowerCase();
    const alreadyExists=data.s.some(s=>s.name.toLowerCase()===nameNorm||(s.a&&Math.abs(s.a-avgAmt)<0.5&&s.freq===freq));
    if(alreadyExists)return;
    const displayName=items.reduce((best,cur)=>cur.rawLabel.length<best.length?cur.rawLabel:best,items[0].rawLabel)
      .replace(/^(prlv sepa |virement |cb |paiement |achat )/i,'')
      .replace(/\s+\d{6,}.*$/,'').trim().split(' ').slice(0,4).join(' ');
    const svcMatch=SERVICE_BANK.find(s=>
      displayName.toLowerCase().includes(s.name.toLowerCase())||
      s.name.toLowerCase().includes(displayName.toLowerCase().split(' ')[0])
    );
    const lastDate=new Date(items[items.length-1].date);
    if(freq==='weekly')lastDate.setDate(lastDate.getDate()+7);
    else if(freq==='monthly')lastDate.setMonth(lastDate.getMonth()+1);
    else if(freq==='quarterly')lastDate.setMonth(lastDate.getMonth()+3);
    else if(freq==='biannual')lastDate.setMonth(lastDate.getMonth()+6);
    else if(freq==='yearly')lastDate.setFullYear(lastDate.getFullYear()+1);
    detected.push({
      key:key.slice(0,20)+'_'+Math.round(avgAmt*100),
      name:svcMatch?.name||displayName||key,
      amount:Math.round(avgAmt*100)/100,
      freq,count:items.length,
      nextDate:lastDate.toISOString().slice(0,10),
      domain:svcMatch?.domain||'',
      color:svcMatch?.color||'#888',
    });
  });
  return detected.sort((a,b)=>b.count-a.count);
}

// ‚îÄ‚îÄ Import View & Handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchImportTab(tab){_importTab=tab;render();}
function rImport(){
  const apiKey=localStorage.getItem('claudeKey')||'';
  const tab=_importTab||'csv';
  const pending=_detectedSubs.filter(s=>!_dismissed.includes(s.key));
  const detTeaser=pending.length?`<div style="background:rgba(0,255,100,0.05);border:1px solid rgba(0,255,100,0.15);border-radius:12px;padding:12px;margin-bottom:10px">
    <div style="font-family:var(--mono);font-size:9px;color:var(--green);letter-spacing:2px;margin-bottom:6px">‚ú¶ ${pending.length} ABONNEMENT${pending.length>1?'S':''} DETECTE${pending.length>1?'S':''}</div>
    <p style="font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.6">Des paiements recurrents identifies. Allez dans <b style="color:var(--text)">Abos</b> pour les valider.</p>
  </div>`:'';
  const isCSV=tab==='csv',isPDF=tab==='pdf',isImage=tab==='image';
  const csvBanks=["Caisse d'Epargne",'Boursobank','BNP','SG','Credit Agricole','LCL','CIC','Revolut','N26'];
  const pdfBanks=["Caisse d'Epargne",'BNP Paribas','Societe Generale','LCL','Credit Agricole','CIC'];
  const imgBanks=['App bancaire','Screenshot','Capture photo','Scan document'];
  const banks=isPDF?pdfBanks:isImage?imgBanks:csvBanks;
  const dropIcon=isPDF?'üìë':isImage?'üì∑':'üìÇ';
  const btnLabel=isPDF?'Choisir un fichier PDF':isImage?'Choisir une capture':'Choisir un fichier CSV';
  const inputId=isPDF?'pdfInput':isImage?'imageOcrInput':'csvInput';
  const descTxt=isPDF
    ?'Selectionnez votre <b style="color:var(--text)">relev√© PDF</b> directement depuis votre banque.'
    :isImage
      ?'Photographiez ou prenez une <b style="color:var(--text)">capture d\'√©cran</b> de votre app bancaire (JPG, PNG, WebP).'
      :'Exportez vos operations au format <b style="color:var(--text)">CSV</b> depuis votre banque, puis selectionnez le fichier.';
  return `<div class="card">
    <div class="card-t">Importer depuis votre banque</div>
    <div class="file-tab-row">
      <button class="file-tab${isCSV?' on':''}" onclick="switchImportTab('csv')">
        <div style="font-size:18px;margin-bottom:4px">üìÑ</div>
        <div style="font-size:10px;font-weight:700;letter-spacing:1px">CSV</div>
        <div style="font-size:8px;opacity:.6;margin-top:2px">Export banque</div>
      </button>
      <button class="file-tab${isPDF?' on':''}" onclick="switchImportTab('pdf')">
        <div style="font-size:18px;margin-bottom:4px">üìë</div>
        <div style="font-size:10px;font-weight:700;letter-spacing:1px">PDF</div>
        <div style="font-size:8px;opacity:.6;margin-top:2px">Relev√© banque</div>
      </button>
      <button class="file-tab${isImage?' on':''}" onclick="switchImportTab('image')">
        <div style="font-size:18px;margin-bottom:4px">üì∑</div>
        <div style="font-size:10px;font-weight:700;letter-spacing:1px">IMAGE</div>
        <div style="font-size:8px;opacity:.6;margin-top:2px">Capture √©cran</div>
      </button>
    </div>
    <p style="font-size:12px;color:var(--dim);margin-bottom:14px;line-height:1.7">${descTxt}</p>
    ${detTeaser}
    <div id="dropZone" style="border:2px dashed var(--border2);border-radius:12px;padding:24px 16px;text-align:center;margin-bottom:4px;transition:border-color .2s"
         ondragover="event.preventDefault();this.style.borderColor='var(--gold)'"
         ondragleave="this.style.borderColor='var(--border2)'"
         ondrop="this.style.borderColor='var(--border2)';event.preventDefault();startImport(event.dataTransfer.files[0])">
      <div style="font-size:28px;margin-bottom:10px">${dropIcon}</div>
      <button onclick="document.getElementById('${inputId}').click()"
              style="background:var(--gold);color:var(--bg);border:none;font-family:var(--mono);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:13px 28px;border-radius:8px;cursor:pointer;display:block;width:100%;margin-bottom:10px">
        ${btnLabel}
      </button>
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted)">${isImage?'Formats : JPG ¬∑ PNG ¬∑ WebP ¬∑ GIF':'ou glisser-deposer ici'}</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:12px;justify-content:center">
        ${banks.map(b=>`<span style="background:var(--bg3);border:1px solid var(--border);font-family:var(--mono);font-size:8px;color:var(--muted);padding:3px 7px;border-radius:10px">${b}</span>`).join('')}
      </div>
    </div>
    <div id="importStatus" style="display:none;padding:12px 0;text-align:center">
      <img id="ocrImgPreview" src="" alt="">
      <div style="font-family:var(--mono);font-size:11px;color:var(--green);margin-bottom:8px" id="importStatusMsg">Lecture en cours...</div>
      <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
        <div id="importProgressBar" style="height:4px;background:var(--green);border-radius:2px;width:0%;transition:width .3s"></div>
      </div>
      <div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:6px" id="importProgressLabel"></div>
    </div>
  </div>
  <div class="card">
    <div style="background:rgba(0,255,100,0.04);border:1px solid rgba(0,255,100,0.12);border-radius:10px;padding:12px;margin-bottom:${apiKey?'0':'10px'}">
      <div style="font-family:var(--mono);font-size:9px;color:var(--green);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px">‚ú¶ Categorisation IA (optionnelle)</div>
      <p style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:8px;line-height:1.6">Cle API Claude pour categoriser intelligemment. Sans cle, les mots-cles fonctionnent tres bien.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="apiKeyInput" class="fi" type="password" placeholder="sk-ant-..." value="${apiKey}" style="flex:1;padding:9px 12px">
        <button onclick="saveApiKey()" style="background:var(--green);border:none;color:var(--bg);font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:1px;padding:10px 14px;cursor:pointer;border-radius:8px;white-space:nowrap">Sauver</button>
      </div>
      ${apiKey?'<div style="font-family:var(--mono);font-size:10px;color:var(--green);margin-top:6px">‚úì IA activee</div>':''}
    </div>
  </div>
  <div class="card">
    <div class="card-t">Comment exporter depuis votre banque</div>
    ${[
      ["Caisse d'Epargne",'Mon compte ‚Üí Telecharger les operations ‚Üí Format CSV (toutes colonnes)'],
      ['Boursobank','Compte ‚Üí Telecharger mes operations ‚Üí CSV'],
      ['BNP Paribas','Mes comptes ‚Üí Releves ‚Üí Telecharger ‚Üí CSV'],
      ['Societe Generale','Mes comptes ‚Üí Telecharger les operations'],
      ['Credit Agricole','Mes comptes ‚Üí Telecharger (CSV / OFX)'],
      ['LCL','Mes comptes ‚Üí Telecharger ‚Üí Format CSV'],
      ['CIC / Credit Mutuel','Mes comptes ‚Üí Telecharger ‚Üí Format CSV'],
      ['Revolut','Profil ‚Üí Declarations ‚Üí Format CSV'],
      ['N26','Compte ‚Üí Exporter les transactions ‚Üí CSV'],
    ].map(([b,t])=>`<div style="display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="font-family:var(--mono);font-size:9px;color:var(--gold);min-width:110px;flex-shrink:0">${b}</span>
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted)">${t}</span>
    </div>`).join('')}
  </div>
  <div id="importPreview"></div>`;
}

// ‚îÄ‚îÄ PDF IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function readPDFFile(file){
  if(typeof pdfjsLib==='undefined'){toast('PDF.js non charge','err');return null;}
  pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const lines=[];
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const tc=await page.getTextContent();
    // Group text items by Y coordinate (rounded to nearest 2px) to reconstruct visual lines
    const rows={};
    tc.items.forEach(item=>{
      if(!item.str||!item.str.trim())return;
      const y=Math.round(item.transform[5]/2)*2;
      if(!rows[y])rows[y]=[];
      rows[y].push({x:item.transform[4],t:item.str});
    });
    // Sort Y descending (top of page first), X ascending within each line
    Object.keys(rows).map(Number).sort((a,b)=>b-a).forEach(y=>{
      const lineText=rows[y].sort((a,b)=>a.x-b.x).map(i=>i.t).join(' ').trim();
      if(lineText)lines.push(lineText);
    });
  }
  return lines;
}
function parsePDFLine(line){
  // Match French date: DD/MM/YYYY or DD/MM/YY or DD-MM-YYYY
  const dateRx=/\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\b/;
  // Match amounts: -1 234,56 or 1234.56 or -1 234.56
  const amtRx=/(-?\s?\d{1,3}(?:[\s\.]\d{3})*[,\.]\d{2})/g;
  const dm=dateRx.exec(line);
  if(!dm)return null;
  const yr=dm[3].length===2?'20'+dm[3]:dm[3];
  const dateStr=`${yr}-${dm[2].padStart(2,'0')}-${dm[1].padStart(2,'0')}`;
  // Parse all numeric amounts found on the line
  const amounts=[...line.matchAll(amtRx)].map(m=>{
    const s=m[1].replace(/\s/g,'');
    // Determine decimal separator: last , or . before 2 digits at end
    const dotIdx=s.lastIndexOf('.');
    const comIdx=s.lastIndexOf(',');
    let clean;
    if(comIdx>dotIdx){clean=s.replace(/\./g,'').replace(',','.');}
    else{clean=s.replace(/,/g,'');}
    return parseFloat(clean);
  }).filter(n=>!isNaN(n)&&Math.abs(n)>=0.01);
  if(!amounts.length)return null;
  const amount=amounts[amounts.length-1];
  // Label: strip date + amounts, collapse spaces
  const label=line.replace(dateRx,'').replace(amtRx,'').replace(/\s+/g,' ').trim().substring(0,80)||'Import PDF';
  return {dateStr,amount,label};
}
async function startImportPDF(file){
  if(cv!=='import'){navTo('import');await new Promise(r=>setTimeout(r,120));}
  const statusEl=document.getElementById('importStatus');
  const msgEl=document.getElementById('importStatusMsg');
  const pbEl=document.getElementById('importProgressBar');
  const setProgress=(w,msg)=>{
    if(statusEl)statusEl.style.display='block';
    if(pbEl)pbEl.style.width=w+'%';
    if(msgEl)msgEl.textContent=msg;
  };
  setProgress(10,'Lecture du PDF...');
  try{
    const lines=await readPDFFile(file);
    if(!lines||!lines.length){toast('Aucune donnee dans ce PDF','err');if(statusEl)statusEl.style.display='none';return;}
    setProgress(45,'Analyse des transactions...');
    const rows=[];
    lines.forEach(line=>{
      const parsed=parsePDFLine(line);
      if(!parsed)return;
      const{dateStr,amount,label}=parsed;
      const isDup=data.t.some(t=>t.d===dateStr&&Math.abs(t.a-Math.abs(amount))<0.01&&t.lb.substring(0,8)===label.substring(0,8));
      rows.push({date:dateStr,label,amount,cat:ruleCat(label),isDup});
    });
    setProgress(80,'Construction de l\'apercu...');
    _importPreview=rows;
    if(rows.length){detectRecurring(rows.map(r=>({date:r.date,label:r.label,amount:r.amount})));}
    setProgress(100,'');
    setTimeout(()=>{if(statusEl)statusEl.style.display='none';},500);
    const previewEl=document.getElementById('importPreview');
    if(previewEl)previewEl.innerHTML=buildPreviewTable();
    if(!rows.length)toast('Aucune transaction detectee dans ce PDF','warn');
    else toast(`${rows.length} lignes extraites du PDF`);
  }catch(e){
    console.error('PDF parse error',e);
    toast('Erreur PDF : '+e.message,'err');
    if(statusEl)statusEl.style.display='none';
  }
}

// ‚îÄ‚îÄ OCR IMAGE IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startImportImage(file){
  if(!file)return;
  if(cv!=='import'){navTo('import');await new Promise(r=>setTimeout(r,120));}
  const statusEl=document.getElementById('importStatus');
  const msgEl=document.getElementById('importStatusMsg');
  const pbEl=document.getElementById('importProgressBar');
  const prev=document.getElementById('ocrImgPreview');
  if(statusEl)statusEl.style.display='block';
  if(prev){prev.src=URL.createObjectURL(file);prev.style.display='block';}
  const sp=(w,m)=>{if(pbEl)pbEl.style.width=w+'%';if(msgEl)msgEl.textContent=m;};
  sp(5,'Chargement moteur OCR\u2026');
  try{
    if(typeof Tesseract==='undefined'){toast('Tesseract.js non charge','err');if(statusEl)statusEl.style.display='none';return;}
    const result=await Tesseract.recognize(file,'fra',{
      logger:m=>{if(m.status==='recognizing text')sp(Math.round(m.progress*75)+10,'OCR : '+Math.round(m.progress*100)+'%');}
    });
    sp(88,'Analyse des transactions\u2026');
    const rows=[];
    result.data.text.split('\n').forEach(line=>{
      const parsed=parsePDFLine(line.trim());
      if(!parsed)return;
      const{dateStr,amount,label}=parsed;
      const isDup=data.t.some(t=>t.d===dateStr&&Math.abs(t.a-Math.abs(amount))<0.01);
      rows.push({date:dateStr,label,amount,cat:ruleCat(label),isDup});
    });
    sp(100,'');
    setTimeout(()=>{if(statusEl)statusEl.style.display='none';if(prev){prev.src='';prev.style.display='none';}},700);
    _importPreview=rows;
    if(rows.length)detectRecurring(rows.map(r=>({date:r.date,label:r.label,amount:r.amount})));
    const pel=document.getElementById('importPreview');
    if(pel)pel.innerHTML=buildPreviewTable();
    if(!rows.length)toast('Aucune transaction detectee \u2014 verifiez l\'image','warn');
    else toast(rows.length+' ligne'+(rows.length>1?'s':'')+' extraite'+(rows.length>1?'s':'')+' de l\'image');
  }catch(e){
    console.error('OCR error',e);
    toast('Erreur OCR : '+e.message,'err');
    if(statusEl)statusEl.style.display='none';
    if(prev){prev.src='';prev.style.display='none';}
  }
}

function startImport(file){
  if(!file){toast('Aucun fichier selectionne','err');return;}
  if(file.name.toLowerCase().endsWith('.pdf')){startImportPDF(file);return;}
  if(/\.(jpe?g|png|gif|webp|bmp)$/i.test(file.name)){startImportImage(file);return;}
  const statusEl=document.getElementById('importStatus');
  const msgEl=document.getElementById('importStatusMsg');
  const pbEl=document.getElementById('importProgressBar');
  if(statusEl)statusEl.style.display='block';
  if(msgEl)msgEl.textContent='Lecture de '+file.name+'...';
  if(pbEl)pbEl.style.width='10%';
  const reader=new FileReader();
  reader.onload=function(ev){if(pbEl)pbEl.style.width='30%';parseAndPreview(ev.target.result,file.name);};
  reader.onerror=function(){toast('Impossible de lire ce fichier','err');};
  reader.readAsText(file,'UTF-8');
}
function saveApiKey(){
  const k=document.getElementById('apiKeyInput')?.value?.trim();
  if(k){localStorage.setItem('claudeKey',k);toast('Cle API sauvegardee');}
  else{localStorage.removeItem('claudeKey');toast('Cle supprimee');}
  render();
}

function buildPreviewTable(){
  const rows=_importPreview;
  const news=rows.filter(r=>!r.isDup).length;
  const dups=rows.filter(r=>r.isDup).length;
  const totalExp=rows.filter(r=>!r.isDup&&r.amount<0).reduce((s,r)=>s+Math.abs(r.amount),0);
  const totalInc=rows.filter(r=>!r.isDup&&r.amount>=0).reduce((s,r)=>s+r.amount,0);
  const iStyle='background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--mono);border-radius:6px;outline:none;padding:3px 5px;';
  return `<div class="card">
    <div class="card-t">Apercu ‚Äî ${rows.length} lignes ¬∑ <span style="color:var(--green)">${news} nouvelles</span> ¬∑ <span style="color:var(--muted)">${dups} doublons ignores</span></div>
    <div class="imp-stats">
      <div class="imp-stat"><div class="imp-stat-v g">${news}</div><div class="imp-stat-l">A importer</div></div>
      <div class="imp-stat"><div class="imp-stat-v p" id="impTotalExp">-${fmtEur(totalExp)}</div><div class="imp-stat-l">Depenses</div></div>
      <div class="imp-stat"><div class="imp-stat-v g" id="impTotalInc">+${fmtEur(totalInc)}</div><div class="imp-stat-l">Revenus</div></div>
    </div>
    <div class="imp-table-wrap">
    <table class="imp-table">
      <thead><tr><th>Date</th><th>Libelle</th><th>Montant</th><th>Categorie</th><th></th></tr></thead>
      <tbody>
        ${rows.map((r,i)=>{
          if(r.isDup)return`<tr class="dup-row">
            <td class="mono xs" style="color:var(--muted);white-space:nowrap">${r.date}</td>
            <td style="font-size:11px;color:var(--muted)">${esc(r.label.length>28?r.label.slice(0,28)+'‚Ä¶':r.label)}</td>
            <td class="mono xs" style="color:var(--muted)">${r.amount>=0?'+':''}${fmtEur(r.amount)}</td>
            <td><span class="mono xxs" style="color:var(--muted)">doublon</span></td>
            <td></td>
          </tr>`;
          const amtColor=r.amount>=0?'var(--green)':'var(--pink)';
          return`<tr>
            <td><input type="date" value="${r.date}" style="${iStyle}font-size:10px;width:110px" onchange="_importPreview[${i}].date=this.value"></td>
            <td>
              ${r.aiCat?'<span class="ai-badge" style="margin-bottom:2px;display:inline-flex">‚ú¶ IA</span>':''}
              <input type="text" value="${esc(r.label)}" style="${iStyle}font-size:11px;width:130px" onchange="_importPreview[${i}].label=this.value" title="${esc(r.label)}">
            </td>
            <td><input type="text" inputmode="decimal" value="${r.amount}" style="${iStyle}font-size:11px;width:80px;color:${amtColor};text-align:right" onchange="updateImportAmount(${i},this.value)"></td>
            <td><select class="cat-sel" onchange="_importPreview[${i}].cat=this.value">
              ${CATS.map(c=>'<option value="'+c.name+'"'+(c.name===r.cat?' selected':'')+'>'+c.name+'</option>').join('')}
            </select></td>
            <td><button onclick="removeImportRow(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px">√ó</button></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
    </div>
    <button class="submit" style="margin-top:14px" onclick="confirmImport()">Importer ${news} transaction${news>1?'s':''} ‚Üí</button>
    <button onclick="_importPreview=[];refreshPreview()" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:10px;width:100%;padding:10px;cursor:pointer;border-radius:8px;margin-top:8px;text-transform:uppercase;letter-spacing:1px">Annuler</button>
  </div>`;
}

function refreshPreview(){
  if(cv!=='import'){navTo('import');setTimeout(()=>refreshPreview(),60);return;}
  const el=document.getElementById('importPreview');
  if(el)el.innerHTML=_importPreview.length?buildPreviewTable():'';
  const s=document.getElementById('importStatus');if(s)s.style.display='none';
}

async function parseAndPreview(text,filename){
  text=text.replace(/^\uFEFF/,'');
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length<2){
    toast('Fichier vide ou non reconnu','err');
    const s=document.getElementById('importStatus');if(s)s.style.display='none';
    return;
  }
  const header=lines[0].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  window._csvSep=detectCsvSep(lines[0]);
  const parser=PARSERS.find(p=>p.detect(header))||PARSERS[PARSERS.length-1];
  toast('Format detecte : '+parser.name);
  const rawRows=parser.parse(lines.slice(1));
  if(!rawRows.length){
    toast('Aucune transaction trouvee ‚Äî verifiez le format','err');
    const s=document.getElementById('importStatus');if(s)s.style.display='none';
    return;
  }
  _detectedSubs=detectRecurring(rawRows);
  // FIX: dedup key includes label prefix to avoid false positives
  const existingSet=new Set(data.t.map(t=>`${t.d}|${Math.round(Math.abs(t.a)*100)}|${(t.lb||'').slice(0,20)}`));
  const enriched=rawRows.map(r=>({
    ...r,
    isDup:existingSet.has(`${r.date}|${Math.round(Math.abs(r.amount)*100)}|${(r.label||'').slice(0,20)}`),
    cat:'Autre',aiCat:false
  }));
  const toProcess=enriched.filter(r=>!r.isDup);
  const pb=document.getElementById('importProgressBar');
  const msg=document.getElementById('importStatusMsg');
  if(pb)pb.style.width='40%';
  if(msg)msg.textContent=`Categorisation de ${toProcess.length} transactions...`;
  const categorized=toProcess.length?await aiCategorize(toProcess):[];
  if(pb)pb.style.width='100%';
  let ci=0;
  _importPreview=enriched.map(r=>{
    if(r.isDup)return r;
    return categorized[ci++]||{...r,cat:ruleCat(r.label,r),aiCat:false};
  });
  setTimeout(()=>refreshPreview(),200);
}

function removeImportRow(i){_importPreview.splice(i,1);refreshPreview();}
function updateImportAmount(i,val){
  const v=parseInput(val);if(isNaN(v))return;
  _importPreview[i].amount=v;
  const inputs=document.querySelectorAll('#importPreview table tbody tr:not(.dup-row) td:nth-child(3) input');
  let idx=0;
  _importPreview.forEach(r=>{
    if(r.isDup)return;
    if(inputs[idx])inputs[idx].style.color=r.amount>=0?'var(--green)':'var(--pink)';
    idx++;
  });
  const rows=_importPreview;
  const totalExp=rows.filter(r=>!r.isDup&&r.amount<0).reduce((s,r)=>s+Math.abs(r.amount),0);
  const totalInc=rows.filter(r=>!r.isDup&&r.amount>=0).reduce((s,r)=>s+r.amount,0);
  const elExp=document.getElementById('impTotalExp');const elInc=document.getElementById('impTotalInc');
  if(elExp)elExp.textContent='-'+fmtEur(totalExp);
  if(elInc)elInc.textContent='+'+fmtEur(totalInc);
}

function confirmImport(){
  const toImport=_importPreview.filter(r=>!r.isDup);
  if(!toImport.length){toast('Rien a importer','err');return;}
  toImport.forEach(r=>{
    const tp=r.cat==='Salaire'?'i':(r.amount>=0?'i':'e');
    data.t.push({id:gid(),lb:r.label,a:Math.abs(r.amount),c:r.cat,d:r.date,tp});
  });
  save();
  _importPreview=[];
  toast(`${toImport.length} transaction${toImport.length>1?'s':''} importees`);
  navTo('history');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initTheme();
updateHeaderProfile();
render();

// Wire up permanent file inputs (survive render())
document.getElementById('csvInput').addEventListener('change',function(){
  const file=this.files[0]; if(!file)return;
  _importTab='csv';
  if(cv!=='import'){navTo('import');setTimeout(()=>startImport(file),80);}
  else startImport(file);
  this.value='';
});
document.getElementById('pdfInput').addEventListener('change',function(){
  const file=this.files[0]; if(!file)return;
  _importTab='pdf';
  if(cv!=='import'){navTo('import');setTimeout(()=>startImportPDF(file),120);}
  else startImportPDF(file);
  this.value='';
});
document.getElementById('photoInput').addEventListener('change',function(){
  const file=this.files[0]; if(!file)return;
  saveProfilePhoto(file);
  this.value='';
});
document.getElementById('logoInput').addEventListener('change',function(){
  const file=this.files[0];if(!file)return;
  saveCustomLogo(file);this.value='';
});
document.getElementById('imageOcrInput').addEventListener('change',function(){
  const file=this.files[0];if(!file)return;
  _importTab='image';
  if(cv!=='import'){navTo('import');setTimeout(()=>startImportImage(file),120);}
  else startImportImage(file);
  this.value='';
});

// Pull-to-dismiss on sheet box (swipe down)
(function(){
  let startY=0;
  const box=document.getElementById('sheetBox');
  box.addEventListener('touchstart',e=>{startY=e.touches[0].clientY;},{passive:true});
  box.addEventListener('touchmove',e=>{
    const dy=e.touches[0].clientY-startY;
    if(dy>0)box.style.transform=`translateY(${dy}px)`;
  },{passive:true});
  box.addEventListener('touchend',e=>{
    const dy=e.changedTouches[0].clientY-startY;
    box.style.transform='';
    if(dy>80)closeSheet();
  });
})();
</script>
</body>
</html>
