<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Unitech â€” Pilotage ActivitÃ©</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#0d1b3e;--navy2:#0f2249;--navy3:#1a3260;
  --cyan:#00d4ff;--cyan2:#0099cc;--cyan-glow:rgba(0,212,255,0.15);
  --bg:#0a0f1e;--surface:#0f1929;--surface2:#162035;--border:#1e2d4a;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#a78bfa;
  --text:#e2e8f0;--muted:#6b7fa3;--radius:12px;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.layout{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:230px;background:var(--navy);border-right:1px solid var(--navy3);
  padding:0 0 24px 0;display:flex;flex-direction:column;gap:2px;
  position:fixed;top:0;bottom:0;left:0;overflow-y:auto;z-index:100}
.logo-zone{padding:20px 16px 16px;border-bottom:1px solid var(--navy3);margin-bottom:8px}
.logo-img{width:140px;height:auto;display:block;margin:0 auto}
.logo-fallback{font-size:20px;font-weight:700;color:var(--cyan);text-align:center;letter-spacing:-.5px}
.logo-fallback span{color:var(--text);font-weight:300}
.logo-sub{font-size:10px;color:var(--muted);text-align:center;margin-top:4px;letter-spacing:1px;text-transform:uppercase}
.nav-section{padding:8px 12px 4px;font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-weight:600}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;
  cursor:pointer;font-size:13px;color:#8899bb;transition:all .18s;
  border:none;background:none;width:100%;text-align:left;position:relative}
.nav-item:hover{background:rgba(0,212,255,0.08);color:var(--text)}
.nav-item.active{background:rgba(0,212,255,0.12);color:var(--cyan)}
.nav-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--cyan);border-radius:0 2px 2px 0}
.nav-item .icon{font-size:16px;min-width:20px}
.sidebar-divider{height:1px;background:var(--navy3);margin:8px 16px}

/* MAIN */
.main{margin-left:230px;flex:1;padding:0}

/* TOP BAR */
.topbar{background:var(--navy);border-bottom:1px solid var(--navy3);
  padding:10px 24px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  position:sticky;top:0;z-index:50}
.topbar-title{font-size:12px;font-weight:600;color:var(--muted);margin-right:4px;white-space:nowrap}
.month-pills{display:flex;gap:4px;flex-wrap:wrap;flex:1}
.month-pill{padding:4px 11px;border-radius:20px;border:1px solid var(--navy3);
  background:none;color:var(--muted);font-size:11px;cursor:pointer;transition:all .15s;font-family:inherit}
.month-pill:hover{border-color:var(--cyan);color:var(--text)}
.month-pill.active{background:var(--cyan);border-color:var(--cyan);color:var(--navy);font-weight:700}
.topbar-actions{display:flex;gap:6px;margin-left:auto}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:8px;
  border:1px solid var(--border);background:none;color:var(--muted);font-size:11.5px;
  cursor:pointer;transition:all .15s;font-family:inherit;white-space:nowrap}
.btn:hover{border-color:var(--cyan);color:var(--text)}
.btn-primary{background:var(--cyan);border-color:var(--cyan);color:var(--navy);font-weight:600}
.btn-primary:hover{background:var(--cyan2);border-color:var(--cyan2);color:#fff}
.btn-green{background:rgba(16,185,129,.12);border-color:var(--green);color:var(--green)}
.btn-green:hover{background:var(--green);color:#fff}
.btn-red{background:rgba(239,68,68,.12);border-color:var(--red);color:var(--red)}
.btn-red:hover{background:var(--red);color:#fff}
.btn-danger{border-color:var(--red);color:var(--red)}
.btn-danger:hover{background:var(--red);color:#fff}

/* CONTENT */
.content{padding:24px}
.page{display:none}.page.active{display:block}
h1{font-size:20px;font-weight:700;margin-bottom:2px;color:var(--text)}
.subtitle{font-size:12.5px;color:var(--muted);margin-bottom:20px}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color .2s}
.card:hover{border-color:var(--navy3)}
.card-label{font-size:10.5px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.card-value{font-size:22px;font-weight:700}
.card-sub{font-size:10.5px;color:var(--muted);margin-top:3px}
.card-value.green{color:var(--green)}.card-value.red{color:var(--red)}
.card-value.orange{color:var(--orange)}.card-value.cyan{color:var(--cyan)}
.card-value.purple{color:var(--purple)}
.card.accent{border-color:var(--cyan);background:var(--cyan-glow)}
.card.success{border-color:var(--green);background:rgba(16,185,129,.06)}
.card.danger{border-color:var(--red);background:rgba(239,68,68,.06)}

/* CHARTS */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.chart-title{font-size:12.5px;font-weight:600;margin-bottom:12px;color:var(--text)}

/* TABLES */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.table-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.table-header-title{font-size:13px;font-weight:600}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{background:var(--surface2);padding:8px 12px;text-align:left;color:var(--muted);
  font-weight:500;font-size:10.5px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
td{padding:9px 12px;border-top:1px solid var(--border);vertical-align:middle}
tr:hover td{background:rgba(0,212,255,.03)}

/* EDITABLE CELLS */
td.editable{cursor:pointer;position:relative}
td.editable:hover{background:rgba(0,212,255,.06)!important}
td.editable:hover::after{content:'âœï¸';position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:9px;opacity:.4}
td.editable input{width:100%;background:var(--surface2);border:1px solid var(--cyan);
  border-radius:4px;color:var(--text);padding:3px 7px;font-size:12px;font-family:inherit;outline:none}
td.editable input:focus{box-shadow:0 0 0 2px rgba(0,212,255,.2)}

/* BADGES */
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10.5px;font-weight:600}
.badge-green{background:rgba(16,185,129,.15);color:var(--green)}
.badge-orange{background:rgba(245,158,11,.15);color:var(--orange)}
.badge-cyan{background:rgba(0,212,255,.15);color:var(--cyan)}
.badge-purple{background:rgba(167,139,250,.15);color:var(--purple)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-navy{background:rgba(13,27,62,.8);color:#8899bb;border:1px solid var(--navy3)}

/* ALERT BADGE */
.alert-fin{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;
  border-radius:20px;font-size:10px;font-weight:700;
  background:rgba(245,158,11,.2);color:var(--orange);border:1px solid var(--orange);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}

/* TOTAL ROW */
.total-row td{font-weight:700;background:rgba(0,212,255,.04);border-top:2px solid var(--border)}

/* TRESO BLOCKS */
.treso-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.treso-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.treso-block-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.treso-block-title{font-size:13px;font-weight:600}
.treso-total-bar{padding:10px 16px;background:var(--surface2);border-top:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;font-size:12.5px;font-weight:700}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;
  display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--surface);border:1px solid var(--navy3);border-radius:16px;
  padding:24px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto}
.modal-title{font-size:15px;font-weight:700;margin-bottom:18px;color:var(--cyan)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group.full{grid-column:1/-1}
label{font-size:11px;color:var(--muted);font-weight:500}
input[type=text],input[type=number],input[type=date],select,textarea{
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:8px 11px;font-size:12.5px;font-family:inherit;outline:none;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,212,255,.15)}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 16px;font-size:12.5px;z-index:2000;
  transform:translateY(80px);opacity:0;transition:all .3s;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--green);color:var(--green)}
.toast.error{border-color:var(--red);color:var(--red)}

/* TABLE ROW ACTIONS */
.row-actions{display:flex;gap:4px;align-items:center}
.icon-btn{background:none;border:none;cursor:pointer;padding:3px;border-radius:4px;
  font-size:13px;transition:all .15s;line-height:1}
.icon-btn:hover{background:rgba(255,255,255,.08)}
.icon-btn.del:hover{background:rgba(239,68,68,.15);color:var(--red)}

/* KPI ALERT STRIP */
.kpi-alerts{background:var(--surface);border:1px solid var(--orange);border-radius:var(--radius);
  padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.kpi-alerts-title{font-size:12px;font-weight:700;color:var(--orange);margin-right:8px}
.alert-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;
  border-radius:20px;font-size:11px;background:rgba(245,158,11,.12);color:var(--orange);
  border:1px solid rgba(245,158,11,.3)}

/* SALAIRES CHARGED STYLE */
.charged-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10.5px;
  font-weight:700;background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

/* SECTION HEADER */
.section-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.section-title-block h1{margin-bottom:2px}

/* POINT MORT CARD */
.card.point-mort{border-color:var(--orange);background:rgba(245,158,11,.06)}

/* COPY MONTH */
.copy-month-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--navy3);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLTIP SYSTÃˆME â€” Design moderne avec animation fade-in
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-tip]{position:relative;cursor:help}

/* Bulle principale */
[data-tip]::after{
  content:attr(data-tip);
  position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%) translateY(4px);
  /* Fond sombre profond #1a1d27 */
  background:#1a1d27;
  border:1px solid rgba(0,212,255,0.45);
  border-radius:10px;
  color:#e2e8f0;
  font-size:11px;font-weight:400;
  white-space:pre-line;
  padding:10px 14px;
  min-width:190px;max-width:300px;
  text-align:left;line-height:1.6;
  pointer-events:none;
  opacity:0;
  /* Animation : fade-in + lÃ©ger slide up */
  transition:opacity .22s ease, transform .22s ease;
  transition-delay:0.25s; /* dÃ©lai d'apparition */
  z-index:9999;
  font-family:'Inter',sans-serif;
  /* Ombre portÃ©e moderne */
  box-shadow:0 8px 32px rgba(0,0,0,.65), 0 0 0 1px rgba(0,212,255,.1);
}

/* FlÃ¨che pointeur */
[data-tip]::before{
  content:'';
  position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%) translateY(4px);
  border:7px solid transparent;
  border-top-color:rgba(0,212,255,.45);
  pointer-events:none;
  opacity:0;
  transition:opacity .22s ease, transform .22s ease;
  transition-delay:0.25s;
  z-index:9999;
}

/* Ã‰tat hover â€” visible */
[data-tip]:hover::after{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
[data-tip]:hover::before{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* Variantes de position */
[data-tip].tip-left::after{left:0;transform:translateY(4px)}
[data-tip].tip-left:hover::after{left:0;transform:translateY(0)}
[data-tip].tip-right::after{left:auto;right:0;transform:translateY(4px)}
[data-tip].tip-right:hover::after{left:auto;right:0;transform:translateY(0)}
[data-tip].tip-left::before{left:12px;transform:translateY(4px)}
[data-tip].tip-left:hover::before{left:12px;transform:translateY(0)}
[data-tip].tip-right::before{left:auto;right:12px;transform:translateY(4px)}
[data-tip].tip-right:hover::before{left:auto;right:12px;transform:translateY(0)}

/* Indicateur Æ’ sur cellules calculÃ©es */
td.calc-cell{position:relative}
td.calc-cell::before{
  content:'Æ’';position:absolute;top:3px;right:5px;
  font-size:8.5px;color:var(--cyan);opacity:.5;
  font-weight:700;font-style:italic;pointer-events:none;
}

/* Formule sous les cards */
.card-formula{
  font-size:9.5px;color:var(--cyan);opacity:.65;margin-top:4px;
  font-style:italic;letter-spacing:.3px;line-height:1.4;
}

/* PARAMS PAGE */
.params-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;margin-bottom:20px}
.param-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.param-block-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.param-block-icon{font-size:18px}
.param-block-title{font-size:13px;font-weight:700;color:var(--text)}
.param-block-desc{font-size:11px;color:var(--muted);margin-top:1px}
.param-rows{padding:4px 0}
.param-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 18px;border-bottom:1px solid var(--border)}
.param-row:last-child{border-bottom:none}
.param-row:hover{background:rgba(0,212,255,.03)}
.param-label{flex:1}
.param-label-text{font-size:12.5px;color:var(--text);font-weight:500}
.param-label-hint{font-size:10.5px;color:var(--muted);margin-top:2px}
.param-formula{font-size:10px;color:var(--cyan);font-style:italic;margin-top:3px;opacity:.8}
.param-control{display:flex;align-items:center;gap:8px;flex-shrink:0}
.param-input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:6px 10px;font-size:13px;font-family:'Inter',sans-serif;
  font-weight:700;text-align:right;outline:none;width:90px;transition:border-color .15s}
.param-input:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,212,255,.15)}
.param-input.wide{width:130px}
.param-unit{font-size:12px;color:var(--muted);min-width:20px}
.param-preview{font-size:11px;color:var(--cyan);font-weight:600;min-width:80px;text-align:right}
/* Toggle switch */
.toggle-wrap{display:flex;align-items:center;gap:8px}
.toggle{position:relative;width:38px;height:20px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:20px;transition:.25s}
.toggle-slider::before{content:'';position:absolute;height:14px;width:14px;left:3px;top:3px;
  background:#fff;border-radius:50%;transition:.25s}
.toggle input:checked + .toggle-slider{background:var(--cyan)}
.toggle input:checked + .toggle-slider::before{transform:translateX(18px)}
.toggle-label{font-size:11.5px;color:var(--muted)}
/* Reset button */
.param-reset-bar{padding:14px 18px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.impact-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;
  font-size:10px;font-weight:600;background:rgba(0,212,255,.1);color:var(--cyan);border:1px solid rgba(0,212,255,.25)}
/* Live preview strip */
.params-preview-bar{background:var(--navy);border:1px solid var(--navy3);border-radius:var(--radius);
  padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:24px;flex-wrap:wrap}
.params-preview-item{display:flex;flex-direction:column;gap:2px}
.params-preview-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.params-preview-value{font-size:16px;font-weight:700}

/* FORMULA EDITOR */
.formula-input{width:100%!important;font-family:'Courier New',monospace!important;font-size:11.5px!important;
  font-weight:400!important;text-align:left!important;color:var(--cyan)!important}
.formula-input:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,212,255,.15)}
.formula-row{padding:10px 18px!important;border-bottom:1px solid var(--border)}
.formula-row:last-child{border-bottom:none}
.formula-row:hover{background:rgba(0,212,255,.03)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR â€” Branding Unitech #1B365D
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{background:linear-gradient(180deg,#1B365D 0%,#0d1b3e 100%)!important}
.logo-zone{
  padding:22px 16px 18px;border-bottom:1px solid rgba(0,212,255,.15);margin-bottom:8px;
  background:rgba(0,0,0,.15);text-align:center;
}
.logo-img{width:150px;height:auto;display:block;margin:0 auto;filter:drop-shadow(0 2px 8px rgba(0,212,255,.25))}
.logo-sub{
  font-size:9px;color:rgba(0,212,255,.7);text-align:center;margin-top:6px;
  letter-spacing:2.5px;text-transform:uppercase;font-weight:600;
}
/* Accent line bleu cyan Ã©lectrique sur nav-item actif */
.nav-item.active{background:rgba(0,212,255,.14);color:#00d4ff}
.nav-item.active::before{width:3px;background:linear-gradient(180deg,#00d4ff,#0099cc)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD â€” Widget System
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Barre de contrÃ´le dashboard */
.dash-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.dash-controls-left{display:flex;align-items:center;gap:8px}
.dash-status-bar{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.dash-status-item{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--muted)}
.dash-status-dot{width:7px;height:7px;border-radius:50%}

/* Grille des widgets */
.widget-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:12px;
  margin-bottom:20px;
  min-height:60px;
}

/* Widget card */
.widget-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px 16px 14px;
  position:relative;
  transition:border-color .2s, box-shadow .2s, transform .15s;
  cursor:default;
  user-select:none;
}
.widget-card:hover{border-color:rgba(0,212,255,.35);box-shadow:0 4px 20px rgba(0,0,0,.2)}
.widget-card.widget-dragging{
  opacity:.5;transform:scale(.97);border:2px dashed var(--cyan);
}
.widget-card.widget-drag-over{
  border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,212,255,.3);transform:scale(1.02);
}
.widget-card.widget-cyan{border-color:var(--cyan);background:rgba(0,212,255,.05)}
.widget-card.widget-green{border-color:var(--green);background:rgba(16,185,129,.05)}
.widget-card.widget-red{border-color:var(--red);background:rgba(239,68,68,.05)}
.widget-card.widget-orange{border-color:var(--orange);background:rgba(245,158,11,.05)}
.widget-card.widget-purple{border-color:var(--purple);background:rgba(167,139,250,.05)}

/* Drag handle */
.widget-drag-handle{
  position:absolute;top:8px;right:32px;
  font-size:12px;color:var(--muted);opacity:0;cursor:grab;
  transition:opacity .15s;line-height:1;padding:2px;
}
.widget-card:hover .widget-drag-handle{opacity:.6}
.widget-drag-handle:hover{opacity:1!important}
.widget-drag-handle:active{cursor:grabbing}

/* Widget visibilitÃ© toggle */
.widget-hide-btn{
  position:absolute;top:8px;right:8px;
  font-size:10px;color:var(--muted);opacity:0;cursor:pointer;
  background:rgba(255,255,255,.06);border:none;border-radius:4px;
  width:18px;height:18px;display:flex;align-items:center;justify-content:center;
  transition:opacity .15s;
}
.widget-card:hover .widget-hide-btn{opacity:.7}
.widget-hide-btn:hover{opacity:1!important;color:var(--red)}

/* Widget content */
.widget-icon{font-size:18px;margin-bottom:8px;display:block}
.widget-label{font-size:10.5px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;font-weight:500}
.widget-value{font-size:24px;font-weight:700;line-height:1.1;margin-bottom:4px}
.widget-sub{font-size:10.5px;color:var(--muted);margin-top:2px}
.widget-formula{font-size:9.5px;color:var(--cyan);opacity:.6;margin-top:4px;font-style:italic}
.widget-trend{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;margin-top:4px}
.widget-trend.up{color:var(--green)}.widget-trend.down{color:var(--red)}.widget-trend.neutral{color:var(--muted)}
.widget-detail{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4}
.widget-detail strong{color:var(--text)}

/* â”€â”€ KPI Manager Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-panel-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1100;
  display:none;align-items:flex-start;justify-content:flex-end;padding:0;
}
.kpi-panel-overlay.open{display:flex}
.kpi-panel{
  background:var(--surface);
  border-left:1px solid var(--navy3);
  width:360px;height:100vh;
  overflow-y:auto;
  padding:0;
  animation:slideInRight .25s ease;
}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.kpi-panel-header{
  padding:20px 20px 16px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  background:var(--navy);
  position:sticky;top:0;z-index:10;
}
.kpi-panel-title{font-size:14px;font-weight:700;color:var(--text)}
.kpi-panel-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px;border-radius:6px;transition:.15s}
.kpi-panel-close:hover{color:var(--red);background:rgba(239,68,68,.1)}
.kpi-panel-section{padding:14px 20px 4px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.kpi-item{
  display:flex;align-items:center;gap:12px;padding:10px 20px;
  border-bottom:1px solid rgba(30,45,74,.5);
  cursor:grab;transition:background .15s;
}
.kpi-item:hover{background:rgba(0,212,255,.04)}
.kpi-item-drag{color:var(--muted);font-size:14px;cursor:grab}
.kpi-item-icon{font-size:16px;min-width:24px;text-align:center}
.kpi-item-info{flex:1}
.kpi-item-name{font-size:12.5px;font-weight:600;color:var(--text)}
.kpi-item-desc{font-size:10px;color:var(--muted);margin-top:1px}
.kpi-item-toggle{margin-left:auto;flex-shrink:0}
.kpi-panel-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:8px}

/* â”€â”€ Graphiques cliquables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
canvas{cursor:default}
canvas.clickable{cursor:pointer}
.chart-box{position:relative}
.chart-click-hint{
  position:absolute;bottom:8px;right:10px;
  font-size:9.5px;color:var(--muted);font-style:italic;opacity:.6;pointer-events:none;
}

/* â”€â”€ Alertes bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dash-alerts .kpi-alerts{
  background:linear-gradient(90deg,rgba(245,158,11,.08),rgba(245,158,11,.03));
  border:1px solid rgba(245,158,11,.35);
  border-radius:12px;padding:10px 16px;
  margin-bottom:14px;
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}

/* â”€â”€ Dashboard section heading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dash-section-title{
  font-size:11px;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.8px;
  margin:20px 0 10px;display:flex;align-items:center;gap:8px;
}
.dash-section-title::after{content:'';flex:1;height:1px;background:var(--border)}

@media(max-width:1100px){.charts-row,.treso-grid{grid-template-columns:1fr}}
@media(max-width:900px){
  .sidebar{width:56px}.sidebar .nav-item span:not(.icon){display:none}
  .logo-zone{padding:12px 8px}.logo-img{width:36px}.logo-sub{display:none}
  .nav-section{display:none}
  .main{margin-left:56px}.form-grid{grid-column:1/-1}
  .kpi-panel{width:100vw}
}
</style>
</head>
<body>
<div class="layout">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo-zone">
    <img src="Logo unitech.jpeg" alt="Unitech" class="logo-img" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block'">
    <div class="logo-fallback" id="logoFallback" style="display:none">Uni<span>tech</span></div>
    <div class="logo-sub">Solutions</div>
  </div>
  <div class="nav-section">Performance</div>
  <button class="nav-item active" onclick="goPage('dashboard',this)"><span class="icon">ğŸ“Š</span><span>Dashboard</span></button>
  <button class="nav-item" onclick="goPage('tresorerie',this)"><span class="icon">ğŸ’°</span><span>TrÃ©sorerie</span></button>
  <div class="sidebar-divider"></div>
  <div class="nav-section">Missions</div>
  <button class="nav-item" onclick="goPage('missions',this)"><span class="icon">ğŸ¯</span><span>Missions Freelance</span></button>
  <button class="nav-item" onclick="goPage('cdi',this)"><span class="icon">ğŸ“„</span><span>Missions CDI</span></button>
  <div class="sidebar-divider"></div>
  <div class="nav-section">RH &amp; Finances</div>
  <button class="nav-item" onclick="goPage('salaries',this)"><span class="icon">ğŸ‘¤</span><span>SalariÃ©s Unitech</span></button>
  <button class="nav-item" onclick="goPage('charges',this)"><span class="icon">ğŸ§¾</span><span>Frais gÃ©nÃ©raux</span></button>
  <button class="nav-item" onclick="goPage('services',this)"><span class="icon">ğŸ”§</span><span>Achats services</span></button>
  <button class="nav-item" onclick="goPage('restaurant',this)"><span class="icon">ğŸ½ï¸</span><span>Restaurant</span></button>
  <div class="sidebar-divider"></div>
  <div class="nav-section">Analyse</div>
  <button class="nav-item" onclick="goPage('marges',this)"><span class="icon">ğŸ“ˆ</span><span>Marges</span></button>
  <button class="nav-item" onclick="goPage('consultants',this)"><span class="icon">ğŸ‘¥</span><span>Consultants</span></button>
  <div class="sidebar-divider"></div>
  <button class="nav-item" onclick="goPage('params',this)" style="margin-top:auto"><span class="icon">âš™ï¸</span><span>ParamÃ¨tres</span></button>
</nav>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <span class="topbar-title">Mois :</span>
    <div class="month-pills" id="monthPills"></div>
    <div class="topbar-actions">
      <button class="btn btn-green" onclick="exportJSON()">â¬‡ Export</button>
      <label class="btn" style="cursor:pointer">â¬† Import<input type="file" accept=".json" onchange="importJSON(event)" style="display:none"></label>
      <button class="btn btn-danger" onclick="resetData()">â†º Reset</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <!-- En-tÃªte dashboard -->
      <div class="dash-controls">
        <div class="dash-controls-left">
          <div>
            <h1 style="margin-bottom:2px">Tableau de bord</h1>
            <p class="subtitle" id="dash-subtitle" style="margin-bottom:0"></p>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="dash-status-bar" id="dash-status-bar"></div>
          <button class="btn btn-primary" onclick="openKpiPanel()" style="gap:6px">
            <span>âš™</span> GÃ©rer les KPIs
          </button>
        </div>
      </div>

      <!-- Alertes missions -->
      <div id="dash-alerts"></div>

      <!-- Widgets grid -->
      <div class="widget-grid" id="widget-grid"></div>

      <!-- Graphiques -->
      <div class="dash-section-title">ğŸ“Š Graphiques analytiques</div>
      <div class="charts-row">
        <div class="chart-box">
          <div class="chart-title">CA Freelance &amp; RÃ©sultat mensuel</div>
          <canvas id="chartCA"></canvas>
        </div>
        <div class="chart-box" style="position:relative">
          <div class="chart-title">RÃ©partition des charges <span style="font-size:10px;color:var(--cyan);font-weight:400">(cliquer pour naviguer)</span></div>
          <canvas id="chartChargesPie" class="clickable"></canvas>
          <div class="chart-click-hint">Cliquez sur un segment â†’ section correspondante</div>
        </div>
      </div>
      <div class="chart-box" style="margin-bottom:16px">
        <div class="chart-title">Ã‰volution marges par consultant</div>
        <canvas id="chartMargesLine"></canvas>
      </div>

      <!-- Table missions actives -->
      <div class="dash-section-title">ğŸ¯ Missions actives</div>
      <div class="table-wrap">
        <div class="table-scroll">
          <table id="dashMissionsTable">
            <thead><tr>
              <th>Consultant</th><th>RÃ´le</th><th>Client</th>
              <th>TJM Client</th><th>CA Mensuel</th><th>Marge/j</th>
              <th>Type</th><th>Fin</th><th>Statut</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- KPI MANAGER PANEL -->
    <div class="kpi-panel-overlay" id="kpiPanelOverlay" onclick="closeKpiPanelIfOutside(event)">
      <div class="kpi-panel" id="kpiPanel">
        <div class="kpi-panel-header">
          <div>
            <div class="kpi-panel-title">âš™ GÃ©rer les KPIs</div>
            <div style="font-size:10.5px;color:var(--muted);margin-top:2px">Afficher/masquer et rÃ©ordonner les indicateurs</div>
          </div>
          <button class="kpi-panel-close" onclick="closeKpiPanel()">âœ•</button>
        </div>
        <div id="kpi-panel-list"></div>
        <div class="kpi-panel-footer">
          <button class="btn btn-primary" onclick="applyKpiConfig();closeKpiPanel()">âœ“ Appliquer</button>
          <button class="btn" onclick="resetKpiConfig()">â†º RÃ©initialiser</button>
          <button class="btn" onclick="closeKpiPanel()">Annuler</button>
        </div>
      </div>
    </div>

    <!-- TRESORERIE -->
    <div class="page" id="page-tresorerie">
      <h1>TrÃ©sorerie</h1>
      <p class="subtitle" id="treso-subtitle"></p>
      <div class="cards" id="treso-cards"></div>
      <div class="treso-grid">
        <div class="treso-block">
          <div class="treso-block-header">
            <span class="treso-block-title">ğŸŸ¢ Encaissements</span>
            <button class="btn btn-primary" onclick="addTresoRow('enc')">+ Ajouter</button>
          </div>
          <div class="table-scroll"><table id="tbl-enc"><thead><tr><th>LibellÃ©</th><th>Montant (â‚¬)</th><th></th></tr></thead><tbody></tbody></table></div>
          <div class="treso-total-bar"><span>Total encaissements</span><span id="total-enc" style="color:var(--green)"></span></div>
        </div>
        <div class="treso-block">
          <div class="treso-block-header">
            <span class="treso-block-title">ğŸ”´ DÃ©caissements</span>
            <button class="btn btn-primary" onclick="addTresoRow('dec')">+ Ajouter</button>
          </div>
          <div class="table-scroll"><table id="tbl-dec"><thead><tr><th>LibellÃ©</th><th>Montant (â‚¬)</th><th></th></tr></thead><tbody></tbody></table></div>
          <div class="treso-total-bar"><span>Total dÃ©caissements</span><span id="total-dec" style="color:var(--red)"></span></div>
        </div>
      </div>
      <div class="chart-box">
        <div class="chart-title">Flux annuels</div>
        <canvas id="chartTreso"></canvas>
      </div>
    </div>

    <!-- MISSIONS -->
    <div class="page" id="page-missions">
      <h1>Missions Freelance</h1>
      <p class="subtitle" id="miss-subtitle"></p>
      <div class="cards" id="miss-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Liste des missions</span>
          <button class="btn btn-primary" onclick="openModal('mission')">+ Nouvelle mission</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-missions">
            <thead><tr>
              <th>Consultant</th><th>RÃ´le</th><th>Client</th>
              <th>TJM Client</th><th>TJM Consultant</th><th>Jours/mois</th><th>CA mensuel</th><th>CoÃ»t Consultant Mensuel</th><th>Marge/j</th><th>Marge Mensuelle</th>
              <th>DÃ©but</th><th>Fin</th><th>Alerte</th><th>Partenaire</th><th>Portage</th><th>Commentaires</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CDI -->
    <div class="page" id="page-cdi">
      <h1>Missions CDI Portage</h1>
      <p class="subtitle" id="cdi-subtitle"></p>
      <div class="cards" id="cdi-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Liste des missions CDI</span>
          <button class="btn btn-primary" onclick="openModal('cdi')">+ Nouvelle mission CDI</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-cdi">
            <thead><tr>
              <th>Consultant</th><th>RÃ´le</th><th>Client</th>
              <th>TJM Client</th><th>Jours/mois</th><th>CA Mensuel</th>
              <th>CoÃ»t ChargÃ© (â‚¬)</th><th>Marge CDI</th>
              <th>DÃ©but</th><th>Fin</th><th>Alerte</th><th>Partenaire</th><th>Commentaires</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SALARIES UNITECH -->
    <div class="page" id="page-salaries">
      <h1>ğŸ‘¤ SalariÃ©s Unitech</h1>
      <p class="subtitle" id="sal-subtitle"></p>
      <div class="cards" id="sal-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Masse salariale interne</span>
          <button class="btn btn-primary" onclick="openModal('salarie')">+ Ajouter salariÃ©</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-salaries">
            <thead><tr>
              <th>Nom</th><th>PrÃ©nom</th><th>Poste</th><th>Contrat</th>
              <th>Salaire Brut (â‚¬)</th><th>Salaire ChargÃ© Ã—1.45 (â‚¬)</th><th>EntrÃ©e</th><th>Sortie</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="chart-box">
        <div class="chart-title">Masse salariale chargÃ©e mensuelle</div>
        <canvas id="chartMasseSal"></canvas>
      </div>
    </div>

    <!-- CHARGES -->
    <div class="page" id="page-charges">
      <h1>Frais GÃ©nÃ©raux</h1>
      <p class="subtitle" id="charges-subtitle"></p>
      <div class="cards" id="charges-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Postes de dÃ©penses</span>
          <button class="btn btn-primary" onclick="openModal('charge')">+ Ajouter un poste</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-charges">
            <thead><tr><th>Poste de dÃ©pense</th><th>Tarif HT (â‚¬)</th><th>QtÃ©</th><th>Total HT (â‚¬)</th><th>Total TTC (â‚¬)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="chart-box"><div class="chart-title">RÃ©partition frais gÃ©nÃ©raux</div><canvas id="chartFrais"></canvas></div>
    </div>

    <!-- SERVICES -->
    <div class="page" id="page-services">
      <h1>Achats de Services</h1>
      <p class="subtitle" id="srv-subtitle"></p>
      <div class="cards" id="srv-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Achats de services</span>
          <button class="btn btn-primary" onclick="openModal('service')">+ Ajouter</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-services">
            <thead><tr><th>SociÃ©tÃ©</th><th>DÃ©signation</th><th>Prix HT (â‚¬)</th><th>Prix TTC (â‚¬)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RESTAURANT -->
    <div class="page" id="page-restaurant">
      <h1>Restaurant &amp; RÃ©ception</h1>
      <p class="subtitle" id="resto-subtitle"></p>
      <div class="cards" id="resto-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Frais de rÃ©ception</span>
          <button class="btn btn-primary" onclick="openModal('resto')">+ Ajouter</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-restaurant">
            <thead><tr><th>SociÃ©tÃ© / Lieu</th><th>DÃ©signation</th><th>Prix HT (â‚¬)</th><th>Prix TTC (â‚¬)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MARGES -->
    <div class="page" id="page-marges">
      <h1>Marges</h1>
      <p class="subtitle" id="marges-subtitle"></p>
      <div class="cards" id="marges-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">Marge mensuelle par consultant</span>
          <button class="btn btn-primary" onclick="openModal('marge')">+ Ajouter</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-marges">
            <thead><tr><th>Consultant</th><th>Marge journaliÃ¨re (â‚¬)</th><th>Jours</th><th>Marge mensuelle (â‚¬)</th><th>Cumul Janv â†’ mois</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="charts-row">
        <div class="chart-box"><div class="chart-title">Marge totale mensuelle</div><canvas id="chartMargeTotale"></canvas></div>
        <div class="chart-box"><div class="chart-title">RÃ©partition marge â€” mois sÃ©lectionnÃ©</div><canvas id="chartMargePie"></canvas></div>
      </div>
    </div>

    <!-- CONSULTANTS (CA portage) -->
    <div class="page" id="page-consultants">
      <h1>Consultants PortÃ©s</h1>
      <p class="subtitle" id="cons-subtitle"></p>
      <div class="cards" id="cons-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-header-title">CA facturÃ© â€” consultants portÃ©s</span>
          <button class="btn btn-primary" onclick="openModal('revenu')">+ Ajouter</button>
        </div>
        <div class="table-scroll">
          <table id="tbl-revenus">
            <thead><tr><th>Consultant</th><th>TJM (â‚¬)</th><th>Jours travaillÃ©s</th><th>CA Mensuel (â‚¬)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PARAMETRES -->
    <div class="page" id="page-params">
      <h1>âš™ï¸ ParamÃ¨tres de calcul</h1>
      <p class="subtitle">Modifiez les rÃ¨gles de calcul utilisÃ©es dans toute l'application â€” les changements sont appliquÃ©s en temps rÃ©el.</p>

      <!-- Barre de prÃ©visualisation live -->
      <div class="params-preview-bar" id="params-preview"></div>

      <div class="params-grid" id="params-content"></div>

      <div class="param-block" style="max-width:400px">
        <div class="param-block-header">
          <span class="param-block-icon">â†º</span>
          <div><div class="param-block-title">RÃ©initialiser</div><div class="param-block-desc">Revenir aux valeurs par dÃ©faut</div></div>
        </div>
        <div class="param-reset-bar">
          <span style="font-size:12px;color:var(--muted)">Toutes les rÃ¨gles seront remises Ã  zÃ©ro</span>
          <button class="btn btn-danger" onclick="resetRules()">â†º RÃ©initialiser les rÃ¨gles</button>
        </div>
      </div>
    </div>

  </div>
</main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalIfOutside(event)" style="display:none">
  <div class="modal">
    <div class="modal-title" id="modalTitle">Ajouter</div>
    <div id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="submitModal()">Enregistrer</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const MONTHS = ['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
const MOIS_SHORT = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
const LS_KEY = 'unitech_pilotage_v3';
const CONTRATS = ['CDI','CDD','Stage','Alternance','Freelance','GÃ©rant'];
const POSTES_COULEUR = {'CDI':'badge-cyan','CDD':'badge-orange','Stage':'badge-purple','Alternance':'badge-purple','Freelance':'badge-green','GÃ©rant':'badge-navy'};

Chart.defaults.color = '#6b7fa3';
Chart.defaults.borderColor = '#1e2d4a';
Chart.defaults.font.family = 'Inter';
Chart.defaults.font.size = 11;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RÃˆGLES DE CALCUL (modifiables)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS_RULES_KEY = 'unitech_rules_v1';

const DEFAULT_RULES = {
  // â”€â”€ Coefficients fixes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  coeffChargesPatronales: 1.45,
  tauxReserveTreso: 0.10,
  tauxTVA: 0.20,
  seuilAlerteMission: 30,
  joursOuvresParMois: 0,
  // â”€â”€ Toggles dÃ©caissements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  inclureConsultantsDansDecaiss: true,
  inclureSalairesDansDecaiss: true,
  inclureFraisDansDecaiss: true,
  inclureServicesDansDecaiss: true,
  inclureRestoDansDecaiss: true,
  inclureConsultantsDansPointMort: true,
  inclureSalairesDansPointMort: true,
  inclureFraisDansPointMort: true,
  // â”€â”€ Formules libres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Variables dispo : CA, MARGE, CHARGES, SALAIRES, FREELANCES,
  //                   FRAIS, SERVICES, RESTO, NB_MISSIONS, BRUT (pour salaire chargÃ© seulement)
  formules: {
    reserve:        'MARGE * 0.1',
    disponibilite:  'MARGE * 0.9',
    resultat:       'CA - CHARGES',
    pointMort:      'SALAIRES + FRAIS + FREELANCES',
    salaireCharge:  'BRUT * 1.45',
  }
};

let RULES = { ...DEFAULT_RULES, formules: { ...DEFAULT_RULES.formules } };

function loadRules() {
  try {
    const stored = localStorage.getItem(LS_RULES_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      RULES = { ...DEFAULT_RULES, ...parsed };
      // Merge nested formules carefully
      RULES.formules = { ...DEFAULT_RULES.formules, ...(parsed.formules || {}) };
    }
  } catch(e) { RULES = { ...DEFAULT_RULES, formules: { ...DEFAULT_RULES.formules } }; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMULA ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰value une formule libre avec un contexte de variables
// Contexte disponible : CA, MARGE, CHARGES, SALAIRES, FREELANCES,
//                       FRAIS, SERVICES, RESTO, NB_MISSIONS, BRUT
function evalFormule(formulaStr, ctx) {
  if (!formulaStr || typeof formulaStr !== 'string') return null;
  try {
    // Remplacement des tokens par leurs valeurs numÃ©riques
    const tokens = {
      CA          : ctx.CA          != null ? ctx.CA          : 0,
      MARGE       : ctx.MARGE       != null ? ctx.MARGE       : 0,
      CHARGES     : ctx.CHARGES     != null ? ctx.CHARGES     : 0,
      SALAIRES    : ctx.SALAIRES    != null ? ctx.SALAIRES    : 0,
      FREELANCES  : ctx.FREELANCES  != null ? ctx.FREELANCES  : 0,
      FRAIS       : ctx.FRAIS       != null ? ctx.FRAIS       : 0,
      SERVICES    : ctx.SERVICES    != null ? ctx.SERVICES    : 0,
      RESTO       : ctx.RESTO       != null ? ctx.RESTO       : 0,
      NB_MISSIONS : ctx.NB_MISSIONS != null ? ctx.NB_MISSIONS : 0,
      BRUT        : ctx.BRUT        != null ? ctx.BRUT        : 0,
    };
    let expr = formulaStr;
    // Remplace chaque token par sa valeur (ordre : long en premier pour Ã©viter les conflits)
    Object.keys(tokens).sort((a,b)=>b.length-a.length).forEach(k => {
      expr = expr.replace(new RegExp('\\b' + k + '\\b', 'g'), tokens[k]);
    });
    // Ã‰valuation sÃ©curisÃ©e : seuls chiffres, opÃ©rateurs math et parenthÃ¨ses autorisÃ©s
    if (!/^[\d\s\+\-\*\/\(\)\.\,]+$/.test(expr)) return null;
    // eslint-disable-next-line no-new-func
    const result = new Function('return (' + expr + ')')();
    if (typeof result !== 'number' || !isFinite(result)) return null;
    return result;
  } catch(e) { return null; }
}

// Construit le contexte de variables pour un mois donnÃ©
function buildFormulaCtx(mois, brutValue) {
  const md = APP.byMonth[mois] || {};
  const ca         = calcCAMois(mois) + calcCACDIMois(mois); // CA total (Freelance + CDI)
  const marge      = calcEncaissementAuto(mois);
  const salaires   = calcMasseSalarialeRaw();   // version sans formule pour Ã©viter la rÃ©cursion
  const freelances = calcCoutConsultantsMois(mois);
  const frais      = (APP.byMonth[mois]||{}).charges ? (APP.byMonth[mois].charges||[]).reduce((s,r)=>s+(parseFloat(r.totalHT)||0),0) : 0;
  const services   = (APP.byMonth[mois]||{}).services ? (APP.byMonth[mois].services||[]).reduce((s,r)=>s+(parseFloat(r.prixHT)||0),0) : 0;
  const resto      = (APP.byMonth[mois]||{}).restaurant ? (APP.byMonth[mois].restaurant||[]).reduce((s,r)=>s+(parseFloat(r.prixHT)||0),0) : 0;
  const nbMissions = (APP.missions||[]).filter(m=>isMissionActive_for(mois,m)).length;
  const dec        = calcDecaissementsAutoRaw(mois, salaires, freelances, frais, services, resto);
  return {
    CA: ca, MARGE: marge, CHARGES: dec, SALAIRES: salaires,
    FREELANCES: freelances, FRAIS: frais, SERVICES: services, RESTO: resto,
    NB_MISSIONS: nbMissions, BRUT: brutValue || 0
  };
}

// Alias pour le moteur de formules
function isMissionActive_for(mois, m) {
  return isMissionActivePourMois(m, mois);
}

// Version "raw" de calcMasseSalariale (coefficient fixe, sans formule) pour Ã©viter la rÃ©cursion
function calcMasseSalarialeRaw() {
  return (APP.salaries||[]).reduce((s,sal) => s + Math.round((sal.salaireB||0) * RULES.coeffChargesPatronales), 0);
}

// Version "raw" de calcDecaissementsAuto sans passer par les formules (pour le contexte)
function calcDecaissementsAutoRaw(mois, salaires, freelances, frais, services, resto) {
  const f  = RULES.inclureFraisDansDecaiss    ? frais    : 0;
  const sv = RULES.inclureServicesDansDecaiss ? services : 0;
  const rs = RULES.inclureRestoDansDecaiss    ? resto    : 0;
  const sl = RULES.inclureSalairesDansDecaiss ? salaires : 0;
  const fc = RULES.inclureConsultantsDansDecaiss ? freelances : 0;
  const cdi = RULES.inclureConsultantsDansDecaiss ? calcCoutCDIMois(mois) : 0;
  return f + sv + rs + sl + fc + cdi;
}

function saveRules() {
  localStorage.setItem(LS_RULES_KEY, JSON.stringify(RULES));
}

function resetRules() {
  if (!confirm('Remettre toutes les rÃ¨gles aux valeurs par dÃ©faut ?')) return;
  RULES = { ...DEFAULT_RULES, formules: { ...DEFAULT_RULES.formules } };
  saveRules();
  // Recalculer tous les salaires chargÃ©s avec les rÃ¨gles rÃ©initialisÃ©es
  (APP.salaries||[]).forEach(s => { s.salaireCharge = calcSalaireCharge(s.salaireB||0); });
  save();
  refreshEngine();
  renderParams();
  toast('RÃ¨gles rÃ©initialisÃ©es âœ“');
}

let APP = {};
let activeMois = '';
let currentPage = 'dashboard';
let modalType = '';
const charts = {};

function uid() { return '_' + Math.random().toString(36).slice(2,10); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFAULT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function defaultData() {
  const byMonth = {};
  MONTHS.forEach(m => {
    byMonth[m] = { tresorerie:{encaissements:[],decaissements:[]}, charges:[], services:[], restaurant:[], marges:[], revenus:[] };
  });

  const mars = byMonth['Mars'];
  mars.charges = [
    {id:uid(),poste:'Google Domain',tarifHT:10,qte:1,totalHT:10,totalTTC:12},
    {id:uid(),poste:'Office 365',tarifHT:11.7,qte:8,totalHT:93.6,totalTTC:112.32},
    {id:uid(),poste:'Domiciliation (Sedomicilier.fr)',tarifHT:27,qte:1,totalHT:27,totalTTC:32.4},
    {id:uid(),poste:'Stop&Work',tarifHT:118.75,qte:1,totalHT:118.75,totalTTC:142.5},
    {id:uid(),poste:'Cabinet Comptable (Koont)',tarifHT:89,qte:1,totalHT:89,totalTTC:106.8},
    {id:uid(),poste:'Banque (Tiime Business)',tarifHT:19.9,qte:1,totalHT:19.9,totalTTC:23.88},
    {id:uid(),poste:'Assurance Pro',tarifHT:21.24,qte:1,totalHT:21.24,totalTTC:21.24}
  ];
  mars.services = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  mars.restaurant = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  mars.marges = [
    {id:uid(),consultant:'Yacine Benhamou',margeJour:39,jours:20.5,margeMois:799.5},
    {id:uid(),consultant:'Aymen IBN ALI',margeJour:1200,jours:22,margeMois:26400},
    {id:uid(),consultant:'Layla OUMRAGH',margeJour:1255,jours:22,margeMois:27610}
  ];
  mars.revenus = [{id:uid(),consultant:'Yacine Benhamou',tjm:39,jours:20.5,caMensuel:799.5}];

  const jan = byMonth['Janvier'];
  jan.charges = cloneArr(mars.charges);
  jan.services = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  jan.restaurant = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  jan.marges = [
    {id:uid(),consultant:'Yacine Benhamou',margeJour:39,jours:20.5,margeMois:799.5},
    {id:uid(),consultant:'Aymen IBN ALI',margeJour:45,jours:22,margeMois:990},
    {id:uid(),consultant:'Layla OUMRAGH',margeJour:45,jours:22,margeMois:990}
  ];
  jan.revenus = [{id:uid(),consultant:'Tarek RHIT',tjm:480,jours:20.5,caMensuel:9840}];

  const fev = byMonth['FÃ©vrier'];
  fev.charges = cloneArr(mars.charges);
  fev.services = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  fev.restaurant = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
  fev.marges = [
    {id:uid(),consultant:'Yacine Benhamou',margeJour:39,jours:20.5,margeMois:799.5},
    {id:uid(),consultant:'Aymen IBN ALI',margeJour:120,jours:22,margeMois:2640},
    {id:uid(),consultant:'Layla OUMRAGH',margeJour:125,jours:22,margeMois:2750}
  ];
  fev.revenus = [{id:uid(),consultant:'Yacine Benhamou',tjm:39,jours:20.5,caMensuel:799.5}];

  ['Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'].forEach(m => {
    byMonth[m].charges = cloneArr(mars.charges);
    byMonth[m].services = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
    byMonth[m].restaurant = [{id:uid(),societe:'xxx',designation:'xx',prixHT:1000,prixTTC:1200}];
    byMonth[m].marges = [
      {id:uid(),consultant:'Yacine Benhamou',margeJour:39,jours:20.5,margeMois:799.5},
      {id:uid(),consultant:'Aymen IBN ALI',margeJour:1200,jours:22,margeMois:26400},
      {id:uid(),consultant:'Layla OUMRAGH',margeJour:1255,jours:22,margeMois:27610}
    ];
    byMonth[m].revenus = [{id:uid(),consultant:'Yacine Benhamou',tjm:39,jours:20.5,caMensuel:799.5}];
  });

  return {
    missions: [
      {id:uid(),consultant:'Abderraouf SALAH',role:'DÃ©veloppeur FS',client:'HubOne',tjmClient:460,tjmConsultant:430,debut:'2024-05-16',fin:'2024-09-10',partenaire:'Fouad Amroune',portage:'',commentaires:"GÃ©rer avec l'ADV Fossuo Patrick"},
      {id:uid(),consultant:'Issam CHARIF',role:'Data Engineer',client:'RATP',tjmClient:460,tjmConsultant:430,debut:'2024-06-13',fin:'',partenaire:'Mohammed Hamza',portage:'Venthone',commentaires:''},
      {id:uid(),consultant:'Layla OUMRAGH',role:'Support Analyst',client:'COFACE',tjmClient:470,tjmConsultant:450,debut:'2024-07-24',fin:'',partenaire:'Pierre Gauthier',portage:'Innoven',commentaires:'RÃ©evaluation TJM en Janvier â†’ min 520'},
      {id:uid(),consultant:'Yacine Benhamou',role:'Lead QA',client:'Mobilize Financial Services',tjmClient:489,tjmConsultant:450,debut:'2024-08-05',fin:'',partenaire:'Antoine Boillot',portage:'Auto-entreprise',commentaires:''},
      {id:uid(),consultant:'Cyril Cuvelette',role:'DÃ©veloppeur VBA',client:'CNP Assurances',tjmClient:500,tjmConsultant:420,debut:'2024-10-28',fin:'',partenaire:'Olivier Corvo / FCOM',portage:'Auto-entreprise',commentaires:''},
      {id:uid(),consultant:'Aymen IBN ALI',role:'Data Engineer',client:'RATP',tjmClient:560,tjmConsultant:500,debut:'2024-11-18',fin:'',partenaire:'Mohammed Hamza',portage:'SIEBEL',commentaires:''},
      {id:uid(),consultant:'Ramy Fakhry',role:'Project Manager E-signature',client:'Mobilize Financial Services',tjmClient:585,tjmConsultant:500,debut:'2024-12-02',fin:'2025-03-15',partenaire:'Antoine Boillot',portage:'Hightekers',commentaires:''}
    ],
    missionsCDI: [
      {id:uid(),consultant:'Mohammed Lourou',role:'Business Analyst Clausebook',client:'COFACE',tjmClient:530,salaire:'55K',debut:'2024-04-02',fin:'2025-01-10',partenaire:'Olivier Corvo / FCOM',commentaires:''},
      {id:uid(),consultant:'Tarek RHIT',role:'DÃ©veloppeur FS',client:'SOFIA.org',tjmClient:480,salaire:'42k â†’ 45K au 1er Avril',debut:'2024-10-01',fin:'',partenaire:'Philippe CHEMAMA',commentaires:'Passe Ã  45K au 1er Avril'}
    ],
    consultants: [
      {id:uid(),nom:'Kessy ALEXIS',poste:'Stagiaire',salaire:1212},
      {id:uid(),nom:'Tarek RHIT',poste:'CDI',salaire:4736},
      {id:uid(),nom:'Mohammed LOUROU',poste:'CDI',salaire:1255}
    ],
    salaries: [
      {id:uid(),nom:'ALEXIS',prenom:'Kessy',poste:'ChargÃ©(e) de recrutement',contrat:'Stage',salaireB:1212,salaireCharge:Math.round(1212*1.45),dateEntree:'2024-09-01',dateSortie:''},
      {id:uid(),nom:'RHIT',prenom:'Tarek',poste:'DÃ©veloppeur Full Stack',contrat:'CDI',salaireB:3270,salaireCharge:Math.round(3270*1.45),dateEntree:'2024-10-01',dateSortie:''},
      {id:uid(),nom:'LOUROU',prenom:'Mohammed',poste:'Business Analyst',contrat:'CDI',salaireB:2935,salaireCharge:Math.round(2935*1.45),dateEntree:'2024-04-02',dateSortie:'2025-01-10'}
    ],
    byMonth
  };
}

function cloneArr(arr) { return arr.map(x=>({...x,id:uid()})); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function save() { localStorage.setItem(LS_KEY,JSON.stringify(APP)); }

function initApp() {
  loadRules();
  const stored = localStorage.getItem(LS_KEY);
  if(stored) { try { APP = JSON.parse(stored); if(!APP.salaries) APP.salaries=[]; } catch(e){ APP=defaultData(); } }
  else { APP = defaultData(); }
  activeMois = MONTHS[new Date().getMonth()];
  if(!APP.byMonth[activeMois]) activeMois='Mars';
  if(!APP.missionsCDI) APP.missionsCDI = [];
  syncMissionsToMarges(); // lien auto Missions â†’ Marges au dÃ©marrage
  loadWidgetConfig();     // charge la config widgets depuis localStorage
  buildMonthPills();
  refreshEngine();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH ENGINE â€” CENTRAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshEngine() {
  renderDashboard();
  renderTresorerie();
  renderMissions();
  renderCDI();
  renderSalaries();
  renderConsultants();
  renderCharges();
  renderServices();
  renderRestaurant();
  renderMarges();
  renderParams();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n,dec=0){ if(n==null||isNaN(n))return'â€”'; return Number(n).toLocaleString('fr-FR',{minimumFractionDigits:dec,maximumFractionDigits:dec})+' â‚¬'; }
function pct(a,b){ return b?Math.round(a/b*100)+' %':'â€”'; }
function sum(arr,key){ return arr.reduce((s,r)=>s+(parseFloat(r[key])||0),0); }
function moisLabel(){ return activeMois+' '+new Date().getFullYear(); }
function getMoisData(key){ return (APP.byMonth[activeMois]||{})[key]||[]; }
function joursDuMois(mois){ const idx=MONTHS.indexOf(mois); return new Date(new Date().getFullYear(),idx+1,0).getDate(); }

function daysUntil(dateStr) {
  if(!dateStr) return null;
  const d = new Date(dateStr);
  const now = new Date();
  now.setHours(0,0,0,0);
  return Math.round((d-now)/(1000*60*60*24));
}

function alerteBadge(m) {
  if(!m.fin) return '';
  const days = daysUntil(m.fin);
  if(days === null) return '';
  if(days < 0) return '<span class="badge badge-red">TerminÃ©e</span>';
  if(days <= RULES.seuilAlerteMission) return '<span class="alert-fin">âš ï¸ J-'+days+'</span>';
  return '';
}

function missionStatut(m) {
  if(!m.fin) return '<span class="badge badge-green">Active</span>';
  const fin = new Date(m.fin);
  const now = new Date();
  if(fin < now) return '<span class="badge badge-red">TerminÃ©e</span>';
  const days = daysUntil(m.fin);
  if(days <= RULES.seuilAlerteMission) return '<span class="alert-fin">âš ï¸ J-'+days+'</span>';
  return '<span class="badge badge-orange">En cours</span>';
}

function isMissionActive(m) {
  return isMissionActivePourMois(m, activeMois);
}

function destroyChart(key){ if(charts[key]){try{charts[key].destroy();}catch(e){}charts[key]=null;} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isMissionActivePourMois(m, mois) {
  const moisIdx = MONTHS.indexOf(mois);
  const year = new Date().getFullYear();
  const moisDate  = new Date(year, moisIdx, 1);
  const moisFinD  = new Date(year, moisIdx+1, 0);
  const debut = new Date(m.debut);
  if (debut > moisFinD) return false;
  if (!m.fin) return true;
  const fin = new Date(m.fin);
  return fin >= moisDate;
}

function calcCAMois(mois) {
  const joursD = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : joursDuMois(mois);
  return APP.missions.filter(m => isMissionActivePourMois(m, mois)).reduce((s,m)=>{
    const j = m.joursMois!=null ? m.joursMois : joursD;
    return s+(m.tjmClient||0)*j;
  },0);
}

function calcCACDIMois(mois) {
  const joursD = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : joursDuMois(mois);
  return (APP.missionsCDI||[]).filter(m => isMissionActivePourMois(m, mois)).reduce((s,m)=>{
    const j = m.joursMois!=null ? m.joursMois : joursD;
    return s+(m.tjmClient||0)*j;
  },0);
}

function calcMargeCDIMois(mois) {
  const joursD = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : joursDuMois(mois);
  return (APP.missionsCDI||[]).filter(m => isMissionActivePourMois(m, mois)).reduce((s,m)=>{
    const j = m.joursMois!=null ? m.joursMois : joursD;
    const ca = (m.tjmClient||0)*j;
    const cout = m.coutMensuel!=null ? m.coutMensuel : (m.coutCharge||0);
    return s + ca - cout;
  },0);
}

function calcMasseSalariale() {
  // Recalcule en live â€” utilise la formule libre si dÃ©finie, sinon le coeff fixe
  return (APP.salaries||[]).reduce((s,sal) => {
    const brut = sal.salaireB || 0;
    const formula = RULES.formules && RULES.formules.salaireCharge;
    const result = formula ? evalFormule(formula, { BRUT: brut, CA:0,MARGE:0,CHARGES:0,SALAIRES:0,FREELANCES:0,FRAIS:0,SERVICES:0,RESTO:0,NB_MISSIONS:0 }) : null;
    const charge = (result !== null) ? Math.round(result) : Math.round(brut * RULES.coeffChargesPatronales);
    return s + charge;
  }, 0);
}

// Calcule le salaire chargÃ© d'un salariÃ© individuel (utilisÃ© pour affichage)
function calcSalaireCharge(brut) {
  const formula = RULES.formules && RULES.formules.salaireCharge;
  const result = formula ? evalFormule(formula, { BRUT: brut, CA:0,MARGE:0,CHARGES:0,SALAIRES:0,FREELANCES:0,FRAIS:0,SERVICES:0,RESTO:0,NB_MISSIONS:0 }) : null;
  return (result !== null) ? Math.round(result) : Math.round(brut * RULES.coeffChargesPatronales);
}

function calcCoutConsultantsMois(mois) {
  const joursD = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : joursDuMois(mois);
  return APP.missions.filter(m => isMissionActivePourMois(m, mois)).reduce((s,m) => {
    const j = m.joursMois != null ? m.joursMois : joursD;
    return s + (m.tjmConsultant||0) * j;
  }, 0);
}

function calcCoutCDIMois(mois) {
  return (APP.missionsCDI||[]).filter(m => isMissionActivePourMois(m, mois))
    .reduce((s,m) => s + (m.coutMensuel||0), 0);
}

function calcDecaissementsAuto(mois) {
  const md = APP.byMonth[mois]||{};
  const frais     = RULES.inclureFraisDansDecaiss     ? sum(md.charges||[],'totalHT')   : 0;
  const services  = RULES.inclureServicesDansDecaiss  ? sum(md.services||[],'prixHT')   : 0;
  const resto     = RULES.inclureRestoDansDecaiss      ? sum(md.restaurant||[],'prixHT') : 0;
  const salaires  = RULES.inclureSalairesDansDecaiss   ? calcMasseSalariale()            : 0;
  const coutConsultants = RULES.inclureConsultantsDansDecaiss ? calcCoutConsultantsMois(mois) : 0;
  const coutCDI   = RULES.inclureConsultantsDansDecaiss ? calcCoutCDIMois(mois) : 0;
  // Garder les vraies valeurs brutes pour affichage mÃªme si exclues
  const fraisBrut    = sum(md.charges||[],'totalHT');
  const servicesBrut = sum(md.services||[],'prixHT');
  const restoBrut    = sum(md.restaurant||[],'prixHT');
  const salairesBrut = calcMasseSalariale();
  const coutConsBrut = calcCoutConsultantsMois(mois);
  const coutCDIBrut  = calcCoutCDIMois(mois);
  return {
    frais, services, resto, salaires, coutConsultants, coutCDI,
    fraisBrut, servicesBrut, restoBrut, salairesBrut, coutConsBrut, coutCDIBrut,
    total: frais+services+resto+salaires+coutConsultants+coutCDI
  };
}

function calcEncaissementAuto(mois) {
  return sum((APP.byMonth[mois]||{}).marges||[],'margeMois');
}

function calcResultatMois(mois) {
  const dec = calcDecaissementsAuto(mois);
  const formula = RULES.formules && RULES.formules.resultat;
  if (formula) {
    const ctx = buildFormulaCtx(mois);
    const result = evalFormule(formula, ctx);
    if (result !== null) return result;
  }
  return (calcCAMois(mois) + calcCACDIMois(mois)) - dec.total;
}

function calcPointMort(mois) {
  const ms       = RULES.inclureSalairesDansPointMort     ? calcMasseSalariale()            : 0;
  const md       = APP.byMonth[mois]||{};
  const fraisFixe= RULES.inclureFraisDansPointMort        ? sum(md.charges||[],'totalHT')   : 0;
  const coutCons = RULES.inclureConsultantsDansPointMort  ? calcCoutConsultantsMois(mois)   : 0;
  const ca = calcCAMois(mois) + calcCACDIMois(mois);
  const formula = RULES.formules && RULES.formules.pointMort;
  let seuil;
  if (formula) {
    const ctx = buildFormulaCtx(mois);
    const result = evalFormule(formula, ctx);
    seuil = (result !== null) ? result : (ms + fraisFixe + coutCons);
  } else {
    seuil = ms + fraisFixe + coutCons;
  }
  if(ca===0) return null;
  return { seuil, ca, atteint: ca>=seuil, taux: Math.round(seuil/ca*100) };
}

function cumulResultatDepuisJanvier(moisCible) {
  const idx = MONTHS.indexOf(moisCible);
  let c=0;
  for(let i=0;i<=idx;i++) c += calcResultatMois(MONTHS[i]);
  return c;
}

function cumulMargePourConsultant(consultant,moisCible) {
  const idx = MONTHS.indexOf(moisCible);
  let c=0;
  for(let i=0;i<=idx;i++){
    const rows=(APP.byMonth[MONTHS[i]]||{}).marges||[];
    const r=rows.find(x=>x.consultant===consultant);
    if(r) c+=(r.margeMois||0);
  }
  return c;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONTH PILLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMonthPills(){
  const c=document.getElementById('monthPills');
  c.innerHTML='';
  MONTHS.forEach(m=>{
    const b=document.createElement('button');
    b.className='month-pill'+(m===activeMois?' active':'');
    b.textContent=m.slice(0,3);
    b.title=m;
    b.onclick=()=>{activeMois=m;buildMonthPills();refreshEngine();};
    c.appendChild(b);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITABLE CELLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeEditable(td,onSave){
  td.classList.add('editable');
  td.addEventListener('click',function(){
    if(td.querySelector('input')) return;
    const current = td.dataset.raw!==undefined ? td.dataset.raw : td.textContent.replace(' â‚¬','').replace(/[\s\u202f]/g,'').replace(',','.');
    const input=document.createElement('input');
    input.type='text'; input.value=current;
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
    const finish=()=>onSave(input.value.trim());
    input.addEventListener('blur',finish);
    input.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();finish();}if(e.key==='Escape')refreshEngine();});
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIDGET SYSTEM â€” KPI Catalog + Drag & Drop + LocalStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LS_WIDGET_KEY = 'unitech_widgets_v2';

// Catalogue complet des KPIs disponibles
const KPI_CATALOG = [
  { id:'ca_total',      icon:'ğŸ’¼', label:'CA mensuel total',       color:'cyan',   group:'CA & Revenus',
    desc:'Freelance + CDI (TJM Ã— jours)' },
  { id:'ca_freelance',  icon:'ğŸ¯', label:'CA Freelance',           color:'cyan',   group:'CA & Revenus',
    desc:'Î£ TJM Client Ã— jours (missions actives)' },
  { id:'ca_cdi',        icon:'ğŸ“„', label:'CA CDI',                 color:'purple', group:'CA & Revenus',
    desc:'Î£ TJM Client Ã— jours (missions CDI actives)' },
  { id:'marge_cdi',     icon:'ğŸ“‹', label:'Marge CDI',              color:'green',  group:'CA & Revenus',
    desc:'CA CDI âˆ’ CoÃ»t CDI' },
  { id:'resultat',      icon:'ğŸ“Š', label:'RÃ©sultat net',           color:'green',  group:'RÃ©sultats',
    desc:'CA total âˆ’ Total dÃ©caissements' },
  { id:'cumul',         icon:'ğŸ“ˆ', label:'Cumul annuel',           color:'cyan',   group:'RÃ©sultats',
    desc:'Î£ rÃ©sultats Jan â†’ mois sÃ©lectionnÃ©' },
  { id:'marge_nette',   icon:'ğŸ’¹', label:'Taux de marge nette',    color:'orange', group:'RÃ©sultats',
    desc:'RÃ©sultat / CA Ã— 100' },
  { id:'cout_cons',     icon:'ğŸ’¸', label:'CoÃ»t consultants',       color:'red',    group:'Charges',
    desc:'Freelance + CDI (coÃ»ts mensuels)' },
  { id:'decaissements', icon:'ğŸ”´', label:'Total dÃ©caissements',    color:'red',    group:'Charges',
    desc:'Consultants + CDI + Frais + Salaires' },
  { id:'salaires',      icon:'ğŸ‘¤', label:'Masse salariale',        color:'red',    group:'Charges',
    desc:'Î£ Salaires chargÃ©s (Brut Ã— coeff)' },
  { id:'frais',         icon:'ğŸ§¾', label:'Frais gÃ©nÃ©raux',         color:'orange', group:'Charges',
    desc:'Total HT des postes du mois' },
  { id:'point_mort',    icon:'ğŸ“', label:'Point mort',             color:'orange', group:'RentabilitÃ©',
    desc:'Seuil de charges fixes / CA Ã— 100' },
  { id:'missions',      icon:'ğŸŒ', label:'Missions actives',       color:'cyan',   group:'ActivitÃ©',
    desc:'Freelance + CDI actives ce mois' },
  { id:'treso_dispo',   icon:'ğŸ¦', label:'TrÃ©sorerie disponible',  color:'green',  group:'TrÃ©sorerie',
    desc:'Encaissements Ã— (1 âˆ’ rÃ©serve)' },
  { id:'marges_total',  icon:'âœ¨', label:'Marges totales',         color:'green',  group:'ActivitÃ©',
    desc:'Î£ marges journaliÃ¨res Ã— jours consultants' },
];

// Configuration par dÃ©faut (ordre + visibilitÃ©)
const DEFAULT_WIDGET_CONFIG = [
  {id:'ca_total',visible:true},{id:'ca_freelance',visible:false},{id:'ca_cdi',visible:false},
  {id:'marge_cdi',visible:true},{id:'resultat',visible:true},{id:'cumul',visible:true},
  {id:'marge_nette',visible:true},{id:'cout_cons',visible:true},{id:'decaissements',visible:true},
  {id:'salaires',visible:true},{id:'frais',visible:false},{id:'point_mort',visible:true},
  {id:'missions',visible:true},{id:'treso_dispo',visible:false},{id:'marges_total',visible:false},
];

let widgetConfig = [];
let dragSrcIdx = null;

function loadWidgetConfig() {
  try {
    const stored = localStorage.getItem(LS_WIDGET_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      const allIds = new Set(parsed.map(w => w.id));
      widgetConfig = parsed.filter(w => KPI_CATALOG.find(k=>k.id===w.id));
      KPI_CATALOG.forEach(k => { if (!allIds.has(k.id)) widgetConfig.push({id:k.id,visible:false}); });
    } else {
      widgetConfig = DEFAULT_WIDGET_CONFIG.map(w => ({...w}));
    }
  } catch(e) { widgetConfig = DEFAULT_WIDGET_CONFIG.map(w => ({...w})); }
}

function saveWidgetConfig() {
  localStorage.setItem(LS_WIDGET_KEY, JSON.stringify(widgetConfig));
}

function resetKpiConfig() {
  if (!confirm('RÃ©initialiser la configuration des KPIs ?')) return;
  widgetConfig = DEFAULT_WIDGET_CONFIG.map(w => ({...w}));
  saveWidgetConfig();
  renderKpiPanel();
  renderWidgetGrid();
  toast('KPIs rÃ©initialisÃ©s âœ“');
}

function applyKpiConfig() {
  document.querySelectorAll('.kpi-item[data-id]').forEach(el => {
    const id = el.dataset.id;
    const tog = el.querySelector('input[type=checkbox]');
    const w = widgetConfig.find(x=>x.id===id);
    if (w && tog) w.visible = tog.checked;
  });
  saveWidgetConfig();
  renderWidgetGrid();
  toast('Configuration sauvegardÃ©e âœ“','success');
}

// â”€â”€â”€ Calcule la valeur d'un KPI pour le mois actif â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getKpiValue(id) {
  const dec = calcDecaissementsAuto(activeMois);
  const ca  = calcCAMois(activeMois);
  const caCDI = calcCACDIMois(activeMois);
  const caTotal = ca + caCDI;
  const resultat = calcResultatMois(activeMois);
  const marge = calcEncaissementAuto(activeMois);
  const enc = marge;
  const pm = calcPointMort(activeMois);
  const moisIdx = MONTHS.indexOf(activeMois);
  const dispo = enc * (1 - RULES.tauxReserveTreso);
  const margeNetteTaux = caTotal > 0 ? Math.round(resultat/caTotal*100) : 0;

  switch(id) {
    case 'ca_total':      return { val: caTotal, sub: `Freelance ${fmt(ca)} + CDI ${fmt(caCDI)}`,
      tip: `Freelance : ${fmt(ca)}\nCDI : ${fmt(caCDI)}\nTotal : ${fmt(caTotal)}`,
      formula: 'Î£ TJMÃ—jours (FL + CDI)' };
    case 'ca_freelance':  return { val: ca, sub: `${APP.missions.filter(isMissionActive).length} mission(s) active(s)`,
      tip: `Î£ (TJM Client Ã— Jours)\npour chaque mission freelance active\ndu mois de ${activeMois}`, formula: 'Î£ TJM_client Ã— jours' };
    case 'ca_cdi':        return { val: caCDI, sub: `${(APP.missionsCDI||[]).filter(isMissionActive).length} CDI actif(s)`,
      tip: `Î£ (TJM Client Ã— Jours)\npour chaque mission CDI active`, formula: 'Î£ TJM_cdi Ã— jours' };
    case 'marge_cdi':     { const mc=calcMargeCDIMois(activeMois); return { val:mc, sub:`CA CDI ${fmt(caCDI)} âˆ’ CoÃ»t ${fmt(dec.coutCDI)}`,
      tip:`CA CDI : ${fmt(caCDI)}\nCoÃ»t CDI : ${fmt(dec.coutCDI)}\nMarge : ${fmt(mc)}`, formula:'CA CDI âˆ’ CoÃ»t CDI' }; }
    case 'resultat':      return { val: resultat, sub: `${margeNetteTaux} % de marge nette`,
      tip: `CA total : ${fmt(caTotal)}\nâˆ’ DÃ©caissements : ${fmt(dec.total)}\n= ${fmt(resultat)}`, formula: 'CA âˆ’ DÃ©caissements' };
    case 'cumul': {
      const c = cumulResultatDepuisJanvier(activeMois);
      return { val: c, sub: `${moisIdx+1} mois cumulÃ©s (Jan â†’ ${activeMois})`,
        tip: `Î£ rÃ©sultats nets\nde Janvier â†’ ${activeMois}\n= ${fmt(c)}`, formula: 'Î£ rÃ©sultats Janâ†’' + MOIS_SHORT[moisIdx] };
    }
    case 'marge_nette':   return { val: margeNetteTaux, sub: `${fmt(resultat)} sur ${fmt(caTotal)}`, isPercent: true,
      tip: `RÃ©sultat net / CA total Ã— 100\n= ${fmt(resultat)} / ${fmt(caTotal)} Ã— 100\n= ${margeNetteTaux} %`, formula: 'RÃ©sultat / CA Ã— 100' };
    case 'cout_cons':     return { val: dec.coutConsultants + dec.coutCDI, sub: `FL ${fmt(dec.coutConsultants)} + CDI ${fmt(dec.coutCDI)}`,
      tip: `CoÃ»t freelance : ${fmt(dec.coutConsultants)}\nCoÃ»t CDI : ${fmt(dec.coutCDI)}\nTotal : ${fmt(dec.coutConsultants+dec.coutCDI)}`, formula: 'Î£ TJM_consul + CoÃ»ts CDI' };
    case 'decaissements': return { val: dec.total, sub: 'Toutes charges confondues',
      tip: `Cons. FL : ${fmt(dec.coutConsultants)}\nCons. CDI : ${fmt(dec.coutCDI)}\nFrais : ${fmt(dec.frais)}\nServices : ${fmt(dec.services)}\nResto : ${fmt(dec.resto)}\nSalaires : ${fmt(dec.salaires)}`, formula: 'Î£ tous dÃ©caissements' };
    case 'salaires':      return { val: dec.salaires, sub: `${(APP.salaries||[]).length} salariÃ©(s)`,
      tip: `Î£ Salaires chargÃ©s\n= Î£ (Brut Ã— ${RULES.coeffChargesPatronales})\n= ${fmt(dec.salaires)}`, formula: 'Î£ (Brut Ã— coeff)' };
    case 'frais':         return { val: dec.frais, sub: `HT Â· TTC ${fmt(dec.frais*(1+RULES.tauxTVA),2)}`,
      tip: `Total frais gÃ©nÃ©raux HT\ndu mois de ${activeMois}`, formula: 'Î£ (Tarif HT Ã— QtÃ©)' };
    case 'point_mort':    return pm ? { val: pm.taux, sub: `Seuil ${fmt(pm.seuil)} â€” ${pm.atteint?'âœ… atteint':'âš ï¸ non atteint'}`,
      isPercent: true, tip: `Seuil = ${fmt(pm.seuil)}\nCA = ${fmt(pm.ca)}\nTaux = ${pm.taux} %\n\n${pm.atteint?'âœ… Rentable':'âš ï¸ Insuffisant'}`, formula: 'Charges fixes / CA Ã— 100' }
      : { val: 0, sub: 'Aucune donnÃ©e CA', isPercent: true, tip:'CA nul ce mois', formula:'' };
    case 'missions':      { const fl=APP.missions.filter(isMissionActive).length, cd=(APP.missionsCDI||[]).filter(isMissionActive).length;
      return { val: fl+cd, sub: `${fl} Freelance + ${cd} CDI`, isCount: true,
        tip: `Missions freelance actives : ${fl}\nMissions CDI actives : ${cd}`, formula: 'Freelance + CDI' }; }
    case 'treso_dispo':   return { val: dispo, sub: `RÃ©serve ${fmt(enc*RULES.tauxReserveTreso)} (${Math.round(RULES.tauxReserveTreso*100)} %)`,
      tip: `Encaissements : ${fmt(enc)}\nÃ— (1 âˆ’ ${RULES.tauxReserveTreso}) = ${fmt(dispo)}`, formula: `Encaissements Ã— ${1-RULES.tauxReserveTreso}` };
    case 'marges_total':  return { val: marge, sub: `Î£ marges consultants`,
      tip: `Î£ (Marge/j Ã— jours)\npour tous les consultants actifs\ndu mois de ${activeMois}`, formula: 'Î£ Marge/j Ã— jours' };
    default: return { val: 0, sub: '', tip: '', formula: '' };
  }
}

// â”€â”€â”€ Render une widget card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWidgetCard(kpi, idx) {
  const data = getKpiValue(kpi.id);
  const colorClass = `widget-${kpi.color}`;
  const valColor = {cyan:'var(--cyan)',green:'var(--green)',red:'var(--red)',orange:'var(--orange)',purple:'var(--purple)'}[kpi.color] || 'var(--cyan)';
  let displayColor = valColor;
  if (['resultat','cumul','marge_cdi'].includes(kpi.id)) {
    displayColor = data.val >= 0 ? 'var(--green)' : 'var(--red)';
  }
  if (kpi.id === 'point_mort') {
    displayColor = (calcPointMort(activeMois)?.atteint) ? 'var(--green)' : 'var(--orange)';
  }
  const displayVal = data.isPercent ? `${data.val} %` : data.isCount ? data.val : fmt(data.val);

  const div = document.createElement('div');
  div.className = `widget-card ${colorClass}`;
  div.draggable = true;
  div.dataset.idx = idx;
  div.dataset.id = kpi.id;

  div.innerHTML = `
    <button class="widget-hide-btn" onclick="hideWidget('${kpi.id}')" title="Masquer">âœ•</button>
    <span class="widget-drag-handle" title="DÃ©placer">â ¿â ¿</span>
    <div class="widget-icon">${kpi.icon}</div>
    <div class="widget-label">${kpi.label}</div>
    <div class="widget-value" style="color:${displayColor}" data-tip="${data.tip}">${displayVal}</div>
    <div class="widget-sub">${data.sub}</div>
    <div class="widget-formula">${data.formula}</div>
  `;

  div.addEventListener('dragstart', e => {
    dragSrcIdx = idx;
    e.dataTransfer.effectAllowed = 'move';
    setTimeout(()=>div.classList.add('widget-dragging'),0);
  });
  div.addEventListener('dragend', () => {
    div.classList.remove('widget-dragging');
    document.querySelectorAll('.widget-card').forEach(c=>c.classList.remove('widget-drag-over'));
  });
  div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('widget-drag-over'); });
  div.addEventListener('dragleave', () => div.classList.remove('widget-drag-over'));
  div.addEventListener('drop', e => {
    e.preventDefault();
    div.classList.remove('widget-drag-over');
    if (dragSrcIdx === null || dragSrcIdx === idx) return;
    const visibles = widgetConfig.filter(w=>w.visible);
    const srcItem = visibles[dragSrcIdx];
    const tgtItem = visibles[idx];
    const srcGlobal = widgetConfig.findIndex(w=>w.id===srcItem.id);
    const tgtGlobal = widgetConfig.findIndex(w=>w.id===tgtItem.id);
    widgetConfig.splice(srcGlobal, 1);
    widgetConfig.splice(tgtGlobal, 0, srcItem);
    saveWidgetConfig();
    renderWidgetGrid();
    dragSrcIdx = null;
  });
  return div;
}

function renderWidgetGrid() {
  const grid = document.getElementById('widget-grid');
  if (!grid) return;
  grid.innerHTML = '';
  const visible = widgetConfig.filter(w => w.visible);
  if (visible.length === 0) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--muted);font-size:13px">
      Aucun KPI visible. <button class="btn btn-primary" style="margin-left:12px" onclick="openKpiPanel()">+ Ajouter des KPIs</button></div>`;
    return;
  }
  visible.forEach((w, idx) => {
    const kpi = KPI_CATALOG.find(k => k.id === w.id);
    if (kpi) grid.appendChild(renderWidgetCard(kpi, idx));
  });
  const sb = document.getElementById('dash-status-bar');
  if (sb) {
    const ca = calcCAMois(activeMois) + calcCACDIMois(activeMois);
    const resultat = calcResultatMois(activeMois);
    sb.innerHTML = `
      <div class="dash-status-item"><div class="dash-status-dot" style="background:var(--cyan)"></div>CA ${fmt(ca)}</div>
      <div class="dash-status-item"><div class="dash-status-dot" style="background:${resultat>=0?'var(--green)':'var(--red)'}"></div>RÃ©sultat ${fmt(resultat)}</div>
    `;
  }
}

function hideWidget(id) {
  const w = widgetConfig.find(x=>x.id===id);
  if (w) { w.visible = false; saveWidgetConfig(); renderWidgetGrid(); toast('KPI masquÃ© â€” gÃ©rez-les via "GÃ©rer les KPIs"'); }
}

// â”€â”€â”€ KPI Manager Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openKpiPanel() {
  renderKpiPanel();
  document.getElementById('kpiPanelOverlay').classList.add('open');
}
function closeKpiPanel() {
  document.getElementById('kpiPanelOverlay').classList.remove('open');
}
function closeKpiPanelIfOutside(e) {
  if (e.target.id === 'kpiPanelOverlay') closeKpiPanel();
}

function renderKpiPanel() {
  const list = document.getElementById('kpi-panel-list');
  if (!list) return;
  const groups = [...new Set(KPI_CATALOG.map(k=>k.group))];
  list.innerHTML = '';
  groups.forEach(group => {
    const sec = document.createElement('div');
    sec.className = 'kpi-panel-section';
    sec.textContent = group;
    list.appendChild(sec);
    KPI_CATALOG.filter(k=>k.group===group).forEach(kpi => {
      const wc = widgetConfig.find(w=>w.id===kpi.id) || {visible:false};
      const item = document.createElement('div');
      item.className = 'kpi-item';
      item.dataset.id = kpi.id;
      const colorHex = {cyan:'#00d4ff',green:'#10b981',red:'#ef4444',orange:'#f59e0b',purple:'#a78bfa'}[kpi.color]||'#00d4ff';
      const kpiData = getKpiValue(kpi.id);
      const kpiDisp = kpiData.isPercent ? kpiData.val+'%' : kpiData.isCount ? kpiData.val : fmt(kpiData.val);
      item.innerHTML = `
        <span class="kpi-item-drag">â ¿</span>
        <span class="kpi-item-icon">${kpi.icon}</span>
        <div class="kpi-item-info">
          <div class="kpi-item-name" style="color:${colorHex}">${kpi.label} <span style="font-size:10px;color:var(--text);font-weight:700">${kpiDisp}</span></div>
          <div class="kpi-item-desc">${kpi.desc}</div>
        </div>
        <label class="kpi-item-toggle toggle" style="flex-shrink:0">
          <input type="checkbox" ${wc.visible?'checked':''}>
          <span class="toggle-slider"></span>
        </label>
      `;
      list.appendChild(item);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  document.getElementById('dash-subtitle').textContent = moisLabel() + ' â€” Vue consolidÃ©e';

  // â”€â”€ Alertes missions finissant bientÃ´t â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const alertMissions = [...APP.missions,...(APP.missionsCDI||[])].filter(m=>{
    if(!m.fin) return false;
    const d = daysUntil(m.fin);
    return d!==null && d>=0 && d <= RULES.seuilAlerteMission;
  });
  const alertEl = document.getElementById('dash-alerts');
  if(alertMissions.length > 0){
    alertEl.innerHTML = '<div class="kpi-alerts"><span style="font-weight:700;font-size:12px;margin-right:8px">âš ï¸ Fin de mission imminente</span>' +
      alertMissions.map(m=>`<span class="alert-chip">âš ï¸ ${m.consultant} â€” J-${daysUntil(m.fin)}</span>`).join('') +
    '</div>';
  } else {
    alertEl.innerHTML = '';
  }

  // â”€â”€ Widget grid (remplace l'ancien bloc dash-cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderWidgetGrid();

  // â”€â”€ Table missions actives â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const active = [
    ...APP.missions.filter(isMissionActive).map(m=>({...m, type:'Freelance'})),
    ...(APP.missionsCDI||[]).filter(isMissionActive).map(m=>({...m, type:'CDI'}))
  ];
  const tbody = document.querySelector('#dashMissionsTable tbody');
  if(tbody){
    tbody.innerHTML = active.length ? active.map(m=>{
      const jours = parseFloat(m.jours)||0;
      const caM = Math.round((parseFloat(m.tjmClient)||0) * jours);
      const margeJ = (parseFloat(m.tjmClient)||0) - (parseFloat(m.tjmConsultant)||0);
      return `<tr>
        <td><strong>${m.consultant||'â€”'}</strong></td>
        <td>${m.role||'â€”'}</td>
        <td>${m.client||'â€”'}</td>
        <td><strong>${fmt(m.tjmClient)}</strong></td>
        <td style="color:var(--cyan);font-weight:600">${fmt(caM)}</td>
        <td><span class="badge badge-orange">+${Math.round(margeJ)} â‚¬/j</span></td>
        <td><span class="badge ${m.type==='CDI'?'badge-purple':'badge-cyan'}">${m.type}</span></td>
        <td style="color:var(--muted)">${m.fin||'â€”'}</td>
        <td>${missionStatut(m)}</td>
      </tr>`;
    }).join('')
    : '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">Aucune mission active ce mois</td></tr>';
  }

  renderDashCharts();
}

function renderDashCharts(){
  destroyChart('ca');
  const caData = MONTHS.map(m=>calcCAMois(m));
  const resData = MONTHS.map(m=>calcResultatMois(m));
  let cumul=0; const cumulData=resData.map(r=>{cumul+=r;return cumul;});
  const ctx1=document.getElementById('chartCA');
  if(ctx1) charts['ca']=new Chart(ctx1,{type:'bar',data:{labels:MOIS_SHORT,datasets:[
    {label:'CA',data:caData,backgroundColor:'rgba(0,212,255,0.5)',borderRadius:4},
    {label:'RÃ©sultat',data:resData,backgroundColor:resData.map(v=>v>=0?'rgba(16,185,129,0.7)':'rgba(239,68,68,0.7)'),borderRadius:4},
    {label:'Cumul',data:cumulData,type:'line',borderColor:'#f59e0b',backgroundColor:'transparent',tension:.4,pointRadius:3,borderWidth:2}
  ]},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>v>=1000?Math.round(v/1000)+'K â‚¬':v+' â‚¬'}}}}});

  destroyChart('chargesPie');
  const dec=calcDecaissementsAuto(activeMois);
  // Mapping segment index â†’ page Ã  ouvrir
  const PIE_PAGES = ['missions','cdi','charges','services','restaurant','salaries'];
  const pieData={labels:['CoÃ»t cons. freelance','CoÃ»t CDI','Frais gÃ©nÃ©raux','Services','Restaurant','Salaires chargÃ©s'],data:[dec.coutConsultants,dec.coutCDI,dec.frais,dec.services,dec.resto,dec.salaires]};
  const ctx2=document.getElementById('chartChargesPie');
  if(ctx2&&pieData.data.some(v=>v>0)) charts['chargesPie']=new Chart(ctx2,{type:'doughnut',data:{labels:pieData.labels,datasets:[{data:pieData.data,backgroundColor:['#00d4ff','#7c3aed','#a78bfa','#f59e0b','#10b981','#ef4444'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,plugins:{legend:{position:'bottom'}},onClick:(evt,els)=>{
    if(els&&els.length>0){
      const idx=els[0].index;
      const page=PIE_PAGES[idx];
      if(page) goPage(page, document.querySelector(`.nav-item[onclick*="'${page}'"]`));
    }
  }}});

  destroyChart('margesLine');
  const consultants=[...new Set(MONTHS.flatMap(m=>(APP.byMonth[m]||{}).marges||[]).map(r=>r.consultant))];
  const colors=['#00d4ff','#10b981','#f59e0b','#ef4444','#a78bfa','#06b6d4'];
  const ctx3=document.getElementById('chartMargesLine');
  if(ctx3) charts['margesLine']=new Chart(ctx3,{type:'line',data:{labels:MOIS_SHORT,datasets:consultants.map((c,i)=>({
    label:c,data:MONTHS.map(m=>{const r=(APP.byMonth[m]||{}).marges||[];const f=r.find(x=>x.consultant===c);return f?f.margeMois:null;}),
    borderColor:colors[i%colors.length],tension:.4,fill:false,spanGaps:true,pointRadius:3
  }))},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>v>=1000?Math.round(v/1000)+'K â‚¬':v+' â‚¬'}}}}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRESORERIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTresorerie(){
  const dec = calcDecaissementsAuto(activeMois);
  const encAuto = calcEncaissementAuto(activeMois);
  const caTotal = calcCAMois(activeMois);
  const resultat = caTotal - dec.total;
  const ctx4treso = buildFormulaCtx(activeMois);
  const dispoFormula    = RULES.formules && RULES.formules.disponibilite;
  const reserveFormula  = RULES.formules && RULES.formules.reserve;
  const dispoResult   = dispoFormula   ? evalFormule(dispoFormula,   { ...ctx4treso, MARGE: encAuto }) : null;
  const reserveResult = reserveFormula ? evalFormule(reserveFormula, { ...ctx4treso, MARGE: encAuto }) : null;
  const dispo   = dispoResult   !== null ? dispoResult   : encAuto * (1 - RULES.tauxReserveTreso);
  const reserve = reserveResult !== null ? reserveResult : encAuto * RULES.tauxReserveTreso;
  const md = APP.byMonth[activeMois]||{};
  const encManuel = md.tresorerie?.encaissements||[];
  const decManuel = md.tresorerie?.decaissements||[];
  const encManuelTotal = sum(encManuel,'montant');
  const decManuelTotal = sum(decManuel,'montant');

  document.getElementById('treso-subtitle').textContent = moisLabel()+' â€” TrÃ©sorerie consolidÃ©e';
  document.getElementById('treso-cards').innerHTML = `
    <div class="card accent" data-tip="Î£ (TJM Client Ã— Jours/mois)\npour toutes les missions\nfreelance actives du mois"><div class="card-label">CA du mois</div><div class="card-value cyan">${fmt(caTotal)}</div><div class="card-sub">TJM Client Ã— jours missions</div><div class="card-formula">Î£ TJM_client Ã— jours</div></div>
    <div class="card success" data-tip="Î£ Marges mensuelles\nde tous les consultants\n= Marge journaliÃ¨re Ã— Jours"><div class="card-label">Encaissements (Marge)</div><div class="card-value green">${fmt(encAuto)}</div><div class="card-sub">Marge brute missions</div><div class="card-formula">Î£ (Marge/j Ã— jours)</div></div>
    <div class="card danger" data-tip="CoÃ»t consultants\n+ Frais gÃ©nÃ©raux HT\n+ Achats de services HT\n+ Restaurant HT\n+ Masse salariale chargÃ©e\n+ Lignes manuelles"><div class="card-label">DÃ©caissements totaux</div><div class="card-value red">${fmt(dec.total)}</div><div class="card-sub">Consultants + Charges + Salaires</div><div class="card-formula">Cons. + Frais + Srv + Resto + Sal.</div></div>
    <div class="card ${resultat>=0?'success':'danger'}" data-tip="CA mensuel\nâˆ’ Total dÃ©caissements\n\n${fmt(caTotal)} âˆ’ ${fmt(dec.total)}"><div class="card-label">RÃ©sultat (CA âˆ’ Charges)</div><div class="card-value ${resultat>=0?'green':'red'}">${fmt(resultat)}</div><div class="card-formula">CA âˆ’ DÃ©caissements</div></div>
    <div class="card" data-tip="Encaissements Ã— 90%\n= TrÃ©sorerie disponible\n\nRÃ©serve = Encaissements Ã— 10%\n(provision charges futures)"><div class="card-label">DisponibilitÃ©s (âˆ’10%)</div><div class="card-value cyan">${fmt(dispo)}</div><div class="card-sub">RÃ©serve : ${fmt(reserve)}</div><div class="card-formula">Encaissements Ã— 0.9</div></div>
  `;

  const decBody=document.querySelector('#tbl-dec tbody');
  if(decBody){
    decBody.innerHTML=`
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ (TJM Consultant Ã— Jours/mois)\npar mission freelance active\n= ${fmt(dec.coutConsultants,2)}">ğŸ”— CoÃ»t consultants freelance <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ TJM_consultant Ã— jours\npour toutes les missions actives" style="font-weight:600;color:var(--red)">${fmt(dec.coutConsultants,2)}</td>
        <td style="color:var(--muted);font-size:10px">â† Missions Freelance</td>
      </tr>
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ CoÃ»ts mensuels chargÃ©s\ndes consultants en CDI portage\n= ${fmt(dec.coutCDI,2)}">ğŸ”— CoÃ»t consultants CDI <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ CoÃ»t mensuel chargÃ© par consultant CDI\n${(APP.missionsCDI||[]).filter(isMissionActive).length} CDI actif(s)" style="font-weight:600;color:var(--red)">${fmt(dec.coutCDI,2)}</td>
        <td style="color:var(--muted);font-size:10px">â† Missions CDI</td>
      </tr>
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ Total HT\nde tous les postes\nde la section Frais gÃ©nÃ©raux">ğŸ”— Frais gÃ©nÃ©raux <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ (Tarif HT Ã— QuantitÃ©)\npar poste de dÃ©pense" style="color:var(--red)">${fmt(dec.frais,2)}</td>
        <td style="color:var(--muted);font-size:10px">â† Frais gÃ©nÃ©raux</td>
      </tr>
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ Prix HT\nde tous les achats\nde la section Achats de services">ğŸ”— Achats de services <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ Prix HT par achat de service" style="color:var(--red)">${fmt(dec.services,2)}</td>
        <td style="color:var(--muted);font-size:10px">â† Achats services</td>
      </tr>
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ Prix HT\nde tous les frais\nde la section Restaurant / RÃ©ception">ğŸ”— Restaurant / RÃ©ception <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ Prix HT par frais de rÃ©ception" style="color:var(--red)">${fmt(dec.resto,2)}</td>
        <td style="color:var(--muted);font-size:10px">â† Restaurant</td>
      </tr>
      <tr>
        <td style="color:var(--muted)" data-tip="Î£ Salaires chargÃ©s\n= Î£ (Salaire Brut Ã— 1.45)\npour tous les salariÃ©s Unitech\n(charges patronales incluses)">ğŸ”— Masse salariale chargÃ©e <span style="font-size:9px;color:var(--cyan)">(auto)</span></td>
        <td class="calc-cell" data-tip="Î£ (Brut Ã— 1.45)\n${(APP.salaries||[]).length} salariÃ©(s)\n= ${fmt(dec.salaires)}" style="color:var(--red)">${fmt(dec.salaires)}</td>
        <td style="color:var(--muted);font-size:10px">â† SalariÃ©s Unitech</td>
      </tr>
    `;
    decManuel.forEach(row=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td></td><td></td><td><div class="row-actions"><button class="icon-btn del" onclick="deleteTresoRow('decaissements','${row.id}')" title="Supprimer">ğŸ—‘ï¸</button></div></td>`;
      tr.cells[0].textContent=row.label; tr.cells[1].textContent=row.montant; tr.cells[1].dataset.raw=row.montant;
      makeEditable(tr.cells[0],val=>{row.label=val;save();renderTresorerie();});
      makeEditable(tr.cells[1],val=>{row.montant=parseFloat(val)||0;save();renderTresorerie();});
      decBody.appendChild(tr);
    });
  }
  document.getElementById('total-dec').textContent=fmt(dec.total+decManuelTotal);

  const encBody=document.querySelector('#tbl-enc tbody');
  if(encBody){
    encBody.innerHTML=`<tr><td style="color:var(--muted)">Marge brute missions (auto)</td><td style="color:var(--green)">${fmt(encAuto)}</td><td></td></tr>`;
    encManuel.forEach(row=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td></td><td></td><td><div class="row-actions"><button class="icon-btn del" onclick="deleteTresoRow('encaissements','${row.id}')" title="Supprimer">ğŸ—‘ï¸</button></div></td>`;
      tr.cells[0].textContent=row.label; tr.cells[1].textContent=row.montant; tr.cells[1].dataset.raw=row.montant;
      makeEditable(tr.cells[0],val=>{row.label=val;save();renderTresorerie();});
      makeEditable(tr.cells[1],val=>{row.montant=parseFloat(val)||0;save();renderTresorerie();});
      encBody.appendChild(tr);
    });
  }
  document.getElementById('total-enc').textContent=fmt(encAuto+encManuelTotal);

  destroyChart('treso');
  const ctx=document.getElementById('chartTreso');
  if(ctx) charts['treso']=new Chart(ctx,{type:'bar',data:{labels:MOIS_SHORT,datasets:[
    {label:'CA',data:MONTHS.map(m=>calcCAMois(m)),backgroundColor:'rgba(0,212,255,0.4)',borderRadius:4},
    {label:'Encaissements',data:MONTHS.map(m=>calcEncaissementAuto(m)),backgroundColor:'rgba(16,185,129,0.6)',borderRadius:4},
    {label:'DÃ©caissements',data:MONTHS.map(m=>calcDecaissementsAuto(m).total),backgroundColor:'rgba(239,68,68,0.6)',borderRadius:4}
  ]},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>v>=1000?Math.round(v/1000)+'K â‚¬':v+' â‚¬'}}}}});
}

function addTresoRow(type){
  const key=type==='enc'?'encaissements':'decaissements';
  const md=APP.byMonth[activeMois]||(APP.byMonth[activeMois]={tresorerie:{encaissements:[],decaissements:[]},charges:[],services:[],restaurant:[],marges:[],revenus:[]});
  if(!md.tresorerie) md.tresorerie={encaissements:[],decaissements:[]};
  if(!md.tresorerie[key]) md.tresorerie[key]=[];
  md.tresorerie[key].push({id:uid(),label:'Nouveau libellÃ©',montant:0});
  save();renderTresorerie();toast('Ligne ajoutÃ©e âœ“');
}

function deleteTresoRow(key,id){
  if(!confirm('Supprimer cette ligne ?')) return;
  const md=APP.byMonth[activeMois];
  if(md&&md.tresorerie&&md.tresorerie[key]) md.tresorerie[key]=md.tresorerie[key].filter(r=>r.id!==id);
  save();renderTresorerie();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMissions(){
  const active=APP.missions.filter(isMissionActive);
  const joursD=joursDuMois(activeMois);
  const caTotal=active.reduce((s,m)=>{const j=m.joursMois!=null?m.joursMois:joursD;return s+(m.tjmClient||0)*j;},0);
  const coutConsTotal=calcCoutConsultantsMois(activeMois);
  const margeTotal=caTotal-coutConsTotal;
  const alertCount=APP.missions.filter(m=>m.fin&&daysUntil(m.fin)>=0&&daysUntil(m.fin)<= RULES.seuilAlerteMission).length;

  document.getElementById('miss-subtitle').textContent=moisLabel()+' â€” '+joursD+' jours ouvrables par dÃ©faut';
  document.getElementById('miss-cards').innerHTML=`
    <div class="card"><div class="card-label">Total missions</div><div class="card-value cyan">${APP.missions.length}</div></div>
    <div class="card"><div class="card-label">Actives ce mois</div><div class="card-value green">${active.length}</div><div class="card-sub">DÃ©but â‰¤ fin de mois ET fin â‰¥ dÃ©but</div></div>
    <div class="card accent"><div class="card-label">CA total ce mois</div><div class="card-value cyan">${fmt(caTotal)}</div><div class="card-sub">TJM Client Ã— jours</div><div class="card-formula">Î£ TJM_client Ã— jours</div></div>
    <div class="card danger"><div class="card-label">CoÃ»t consultants</div><div class="card-value red">${fmt(coutConsTotal)}</div><div class="card-sub">TJM Consultant Ã— jours</div><div class="card-formula">Î£ TJM_consultant Ã— jours</div></div>
    <div class="card success"><div class="card-label">Marge brute totale</div><div class="card-value green">${fmt(margeTotal)}</div><div class="card-sub">CA âˆ’ CoÃ»t consultants</div><div class="card-formula">CA âˆ’ CoÃ»t consultants</div></div>
    <div class="card"><div class="card-label">Taux de marge brute</div><div class="card-value orange">${caTotal>0?Math.round(margeTotal/caTotal*100)+' %':'â€”'}</div><div class="card-formula">Marge / CA Ã— 100</div></div>
    ${alertCount>0?`<div class="card danger"><div class="card-label">âš ï¸ Fins imminentes</div><div class="card-value orange">${alertCount}</div><div class="card-sub">Dans les 30 jours</div></div>`:''}
  `;

  const tbody=document.querySelector('#tbl-missions tbody');
  tbody.innerHTML='';
  APP.missions.forEach(m=>{
    const margeJ=m.tjmClient-m.tjmConsultant;
    const jours=m.joursMois!=null?m.joursMois:joursD;
    const ca=(m.tjmClient||0)*jours;
    const coutCons=(m.tjmConsultant||0)*jours;
    const margeMois=margeJ*jours;
    const actif=isMissionActive(m);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="editable">${m.consultant}</td>
      <td class="editable">${m.role}</td>
      <td class="editable">${m.client}</td>
      <td class="editable" data-raw="${m.tjmClient}">${m.tjmClient} â‚¬</td>
      <td class="editable" data-raw="${m.tjmConsultant}">${m.tjmConsultant} â‚¬</td>
      <td class="editable" data-raw="${jours}">${jours} j</td>
      <td class="calc-cell" style="font-weight:700;color:var(--cyan)">${fmt(ca)}</td>
      <td class="calc-cell" style="font-weight:600;color:var(--red)">${actif?fmt(coutCons):'<span style="color:var(--muted)">â€”</span>'}</td>
      <td><span class="badge badge-${margeJ>=60?'cyan':'orange'}">+${margeJ} â‚¬/j</span></td>
      <td class="calc-cell" style="font-weight:600;color:var(--green)">${actif?fmt(margeMois):'<span style="color:var(--muted)">â€”</span>'}</td>
      <td class="editable">${m.debut}</td>
      <td class="editable">${m.fin||''}</td>
      <td>${alerteBadge(m)}</td>
      <td class="editable">${m.partenaire||''}</td>
      <td class="editable">${m.portage||''}</td>
      <td class="editable" style="max-width:140px;white-space:normal">${m.commentaires||''}</td>
      <td><div class="row-actions"><button class="icon-btn del" onclick="deleteMission('${m.id}')">ğŸ—‘ï¸</button></div></td>
    `;
    const cells=tr.querySelectorAll('td.editable');
    const fields=['consultant','role','client','tjmClient','tjmConsultant','joursMois','debut','fin','partenaire','portage','commentaires'];
    cells.forEach((td,i)=>{
      makeEditable(td,val=>{
        if([3,4,5].includes(i)) m[fields[i]]=parseFloat(val)||0; else m[fields[i]]=val;
        syncMissionsToMarges();
        save();renderMissions();renderDashboard();renderTresorerie();renderMarges();
      });
    });
    tbody.appendChild(tr);
  });

  // Ligne totaux
  const tfoot=document.createElement('tr');
  tfoot.className='total-row';
  tfoot.innerHTML=`
    <td colspan="6"><strong>Total missions actives (${active.length})</strong></td>
    <td style="font-weight:700;color:var(--cyan)">${fmt(caTotal)}</td>
    <td style="font-weight:700;color:var(--red)">${fmt(coutConsTotal)}</td>
    <td></td>
    <td style="font-weight:700;color:var(--green)">${fmt(margeTotal)}</td>
    <td colspan="7"></td>
  `;
  tbody.appendChild(tfoot);
}

function deleteMission(id){
  if(!confirm('Supprimer cette mission ?')) return;
  APP.missions=APP.missions.filter(m=>m.id!==id);
  syncMissionsToMarges();
  save();refreshEngine();toast('Mission supprimÃ©e âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CDI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCDI(){
  const joursD = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : joursDuMois(activeMois);
  const active = APP.missionsCDI.filter(isMissionActive);
  const alertCount = APP.missionsCDI.filter(m=>m.fin&&daysUntil(m.fin)>=0&&daysUntil(m.fin)<= RULES.seuilAlerteMission).length;

  const caTotalCDI = active.reduce((s,m)=>{
    const j = m.joursMois!=null ? m.joursMois : joursD;
    return s + (m.tjmClient||0)*j;
  }, 0);
  const coutTotalCDI = active.reduce((s,m)=>s+(m.coutMensuel||0), 0);
  const margeTotalCDI = caTotalCDI - coutTotalCDI;

  document.getElementById('cdi-subtitle').textContent=moisLabel()+' â€” Missions portage CDI';
  document.getElementById('cdi-cards').innerHTML=`
    <div class="card"><div class="card-label">Total CDI</div><div class="card-value purple">${APP.missionsCDI.length}</div></div>
    <div class="card"><div class="card-label">Actives ce mois</div><div class="card-value green">${active.length}</div></div>
    <div class="card accent"><div class="card-label">CA CDI total</div><div class="card-value cyan">${fmt(caTotalCDI)}</div><div class="card-formula">Î£ TJM Ã— jours</div></div>
    <div class="card danger"><div class="card-label">CoÃ»t CDI total</div><div class="card-value red">${fmt(coutTotalCDI)}</div><div class="card-formula">Î£ CoÃ»t mensuel chargÃ©</div></div>
    <div class="card ${margeTotalCDI>=0?'success':'danger'}"><div class="card-label">Marge CDI totale</div><div class="card-value ${margeTotalCDI>=0?'green':'red'}">${fmt(margeTotalCDI)}</div><div class="card-formula">CA CDI âˆ’ CoÃ»t CDI</div></div>
    ${alertCount>0?`<div class="card danger"><div class="card-label">âš ï¸ Fins imminentes</div><div class="card-value orange">${alertCount}</div></div>`:''}
  `;

  const tbody=document.querySelector('#tbl-cdi tbody');
  tbody.innerHTML='';
  APP.missionsCDI.forEach(m=>{
    const actif = isMissionActive(m);
    const jours = m.joursMois!=null ? m.joursMois : joursD;
    const caMois = actif ? (m.tjmClient||0)*jours : 0;
    const cout   = m.coutMensuel||0;
    const marge  = actif ? caMois - cout : 0;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="editable">${m.consultant}</td>
      <td class="editable">${m.role}</td>
      <td class="editable">${m.client}</td>
      <td class="editable" data-raw="${m.tjmClient}">${m.tjmClient} â‚¬</td>
      <td class="editable" data-raw="${jours}">${jours} j</td>
      <td class="calc-cell" style="font-weight:700;color:var(--cyan)">${actif?fmt(caMois):'<span style="color:var(--muted)">â€”</span>'}</td>
      <td class="editable" data-raw="${cout}">${cout?fmt(cout):'<span style="color:var(--muted)">â€”</span>'}</td>
      <td class="calc-cell" style="font-weight:700;color:${marge>=0?'var(--green)':'var(--red)'}">${actif?fmt(marge):'<span style="color:var(--muted)">â€”</span>'}</td>
      <td class="editable">${m.debut}</td>
      <td class="editable">${m.fin||''}</td>
      <td>${alerteBadge(m)}</td>
      <td class="editable">${m.partenaire||''}</td>
      <td class="editable" style="max-width:140px;white-space:normal">${m.commentaires||''}</td>
      <td><div class="row-actions"><button class="icon-btn del" onclick="deleteCDI('${m.id}')">ğŸ—‘ï¸</button></div></td>
    `;
    const cells=tr.querySelectorAll('td.editable');
    const fields=['consultant','role','client','tjmClient','joursMois','coutMensuel','debut','fin','partenaire','commentaires'];
    cells.forEach((td,i)=>makeEditable(td,val=>{
      if([3,4,5].includes(i)) m[fields[i]]=parseFloat(val)||0; else m[fields[i]]=val;
      save();renderCDI();renderDashboard();
    }));
    tbody.appendChild(tr);
  });

  // Ligne totaux
  if(active.length>0){
    const tfoot=document.createElement('tr');
    tfoot.className='total-row';
    tfoot.innerHTML=`
      <td colspan="5"><strong>Total actives (${active.length})</strong></td>
      <td style="font-weight:700;color:var(--cyan)">${fmt(caTotalCDI)}</td>
      <td style="font-weight:700;color:var(--red)">${fmt(coutTotalCDI)}</td>
      <td style="font-weight:700;color:${margeTotalCDI>=0?'var(--green)':'var(--red)'}">${fmt(margeTotalCDI)}</td>
      <td colspan="6"></td>
    `;
    tbody.appendChild(tfoot);
  }
}

function deleteCDI(id){
  if(!confirm('Supprimer cette mission CDI ?')) return;
  APP.missionsCDI=APP.missionsCDI.filter(m=>m.id!==id);
  save();refreshEngine();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SALARIES UNITECH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSalaries(){
  const sals = APP.salaries||[];
  const masseBrute = sum(sals,'salaireB');
  const masseChargee = sum(sals,'salaireCharge');
  document.getElementById('sal-subtitle').textContent = moisLabel()+' â€” Ressources humaines Unitech';
  document.getElementById('sal-cards').innerHTML=`
    <div class="card"><div class="card-label">Effectif total</div><div class="card-value cyan">${sals.length}</div><div class="card-sub">SalariÃ©s actifs</div></div>
    <div class="card"><div class="card-label">Masse salariale brute</div><div class="card-value orange">${fmt(masseBrute)}</div><div class="card-sub">Salaires bruts cumulÃ©s</div><div class="card-formula">Î£ Salaire_Brut</div></div>
    <div class="card danger"><div class="card-label">Masse salariale chargÃ©e</div><div class="card-value red">${fmt(masseChargee)}</div><div class="card-sub">Brut Ã— 1.45 (charges patronales)</div><div class="card-formula">Î£ (Brut Ã— 1.45)</div></div>
    <div class="card"><div class="card-label">Ratio charges/brut</div><div class="card-value orange">${masseBrute>0?Math.round((masseChargee-masseBrute)/masseBrute*100)+' %':'â€”'}</div><div class="card-sub">Charges patronales</div><div class="card-formula">(ChargÃ© âˆ’ Brut) / Brut Ã— 100</div></div>
  `;
  const tbody=document.querySelector('#tbl-salaries tbody');
  tbody.innerHTML='';
  sals.forEach(s=>{
    const contratColor=POSTES_COULEUR[s.contrat]||'badge-navy';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="editable">${s.nom}</td>
      <td class="editable">${s.prenom}</td>
      <td class="editable">${s.poste}</td>
      <td><span class="badge ${contratColor}" style="cursor:pointer" onclick="cycleContrat('${s.id}')" title="Cliquer pour changer">${s.contrat}</span></td>
      <td class="editable" data-raw="${s.salaireB}">${fmt(s.salaireB)}</td>
      <td><span class="charged-badge">${fmt(s.salaireCharge)}</span></td>
      <td class="editable">${s.dateEntree||''}</td>
      <td class="editable">${s.dateSortie||''}</td>
      <td><div class="row-actions"><button class="icon-btn del" onclick="deleteSalarie('${s.id}')">ğŸ—‘ï¸</button></div></td>
    `;
    const editFields=['nom','prenom','poste','salaireB','dateEntree','dateSortie'];
    const editCells=tr.querySelectorAll('td.editable');
    editCells.forEach((td,i)=>makeEditable(td,val=>{
      if(i===3){s.salaireB=parseFloat(val)||0;s.salaireCharge=calcSalaireCharge(s.salaireB);}
      else s[editFields[i]]=val;
      save();renderSalaries();renderTresorerie();renderDashboard();
    }));
    tbody.appendChild(tr);
  });

  destroyChart('masseSal');
  const ctx=document.getElementById('chartMasseSal');
  if(ctx&&sals.length) charts['masseSal']=new Chart(ctx,{type:'bar',data:{
    labels:sals.map(s=>s.prenom+' '+s.nom),
    datasets:[
      {label:'Salaire Brut',data:sals.map(s=>s.salaireB),backgroundColor:'rgba(0,212,255,0.5)',borderRadius:4},
      {label:'Salaire ChargÃ©',data:sals.map(s=>s.salaireCharge),backgroundColor:'rgba(239,68,68,0.6)',borderRadius:4}
    ]
  },options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>v>=1000?Math.round(v/1000)+'K â‚¬':v+' â‚¬'}}}}});
}

function cycleContrat(id){
  const s=(APP.salaries||[]).find(x=>x.id===id);
  if(!s) return;
  const idx=CONTRATS.indexOf(s.contrat||'CDI');
  s.contrat=CONTRATS[(idx+1)%CONTRATS.length];
  save();renderSalaries();toast('Contrat â†’ '+s.contrat);
}

function deleteSalarie(id){
  if(!confirm('Supprimer ce salariÃ© ?')) return;
  APP.salaries=(APP.salaries||[]).filter(s=>s.id!==id);
  save();renderSalaries();renderTresorerie();renderDashboard();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSULTANTS (CA portage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderConsultants(){
  const md=APP.byMonth[activeMois]||{};
  const revenus=md.revenus||[];
  document.getElementById('cons-subtitle').textContent=moisLabel()+' â€” CA consultants portÃ©s';
  document.getElementById('cons-cards').innerHTML=`
    <div class="card"><div class="card-label">CA facturÃ© portage</div><div class="card-value cyan">${fmt(sum(revenus,'caMensuel'))}</div></div>
    <div class="card"><div class="card-label">Consultants ce mois</div><div class="card-value green">${revenus.length}</div></div>
  `;
  const tbody=document.querySelector('#tbl-revenus tbody');
  tbody.innerHTML='';
  revenus.forEach(r=>{
    const ca=(parseFloat(r.tjm)||0)*(parseFloat(r.jours)||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="editable">${r.consultant}</td><td class="editable" data-raw="${r.tjm}">${r.tjm}</td><td class="editable" data-raw="${r.jours}">${r.jours}</td><td style="font-weight:700;color:var(--cyan)">${fmt(ca)}</td><td><div class="row-actions"><button class="icon-btn del" onclick="deleteRevenu('${r.id}')">ğŸ—‘ï¸</button></div></td>`;
    const fields=['consultant','tjm','jours'];
    tr.querySelectorAll('td.editable').forEach((td,i)=>makeEditable(td,val=>{
      if(i>0) r[fields[i]]=parseFloat(val)||0; else r[fields[i]]=val;
      r.caMensuel=(r.tjm||0)*(r.jours||0);
      save();renderConsultants();
    }));
    tbody.appendChild(tr);
  });
}

function deleteRevenu(id){
  if(!confirm('Supprimer ?')) return;
  APP.byMonth[activeMois].revenus=(APP.byMonth[activeMois].revenus||[]).filter(r=>r.id!==id);
  save();renderConsultants();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharges(){
  const rows=getMoisData('charges');
  const totalHT=sum(rows,'totalHT');
  const totalTTC=sum(rows,'totalTTC');
  document.getElementById('charges-subtitle').textContent=moisLabel();
  document.getElementById('charges-cards').innerHTML=`
    <div class="card"><div class="card-label">Total HT</div><div class="card-value red">${fmt(totalHT,2)}</div><div class="card-formula">Î£ (Tarif HT Ã— QtÃ©)</div></div>
    <div class="card"><div class="card-label">Total TTC</div><div class="card-value orange">${fmt(totalTTC,2)}</div><div class="card-formula">Total HT Ã— 1.20</div></div>
    <div class="card"><div class="card-label">Postes</div><div class="card-value cyan">${rows.length}</div></div>
  `;
  const tbody=document.querySelector('#tbl-charges tbody');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="editable">${r.poste}</td><td class="editable" data-raw="${r.tarifHT}">${r.tarifHT}</td><td class="editable" data-raw="${r.qte}">${r.qte}</td><td class="calc-cell">${fmt((r.tarifHT||0)*(r.qte||0),2)}</td><td class="calc-cell">${fmt(r.totalTTC,2)}</td><td><div class="row-actions"><button class="icon-btn del" onclick="deleteCharge('${r.id}')">ğŸ—‘ï¸</button></div></td>`;
    const fields=['poste','tarifHT','qte'];
    tr.querySelectorAll('td.editable').forEach((td,i)=>makeEditable(td,val=>{
      if(i>0) r[fields[i]]=parseFloat(val)||0; else r[fields[i]]=val;
      r.totalHT=(r.tarifHT||0)*(r.qte||0);r.totalTTC=r.totalHT*(1+RULES.tauxTVA);
      save();renderCharges();renderTresorerie();renderDashboard();
    }));
    tbody.appendChild(tr);
  });
  const totalTr=document.createElement('tr');
  totalTr.className='total-row';
  totalTr.innerHTML=`<td colspan="3"><strong>Total</strong></td><td><strong>${fmt(totalHT,2)}</strong></td><td><strong>${fmt(totalTTC,2)}</strong></td><td></td>`;
  tbody.appendChild(totalTr);
  destroyChart('frais');
  const ctx=document.getElementById('chartFrais');
  if(ctx&&rows.length) charts['frais']=new Chart(ctx,{type:'doughnut',data:{labels:rows.map(r=>r.poste),datasets:[{data:rows.map(r=>r.totalHT),backgroundColor:['#00d4ff','#a78bfa','#10b981','#f59e0b','#ef4444','#0099cc','#6b7fa3'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,plugins:{legend:{position:'right'}}}});
}

function deleteCharge(id){
  if(!confirm('Supprimer ce poste ?')) return;
  APP.byMonth[activeMois].charges=getMoisData('charges').filter(r=>r.id!==id);
  save();renderCharges();renderTresorerie();renderDashboard();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICES & RESTAURANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderServices(){
  const rows=getMoisData('services');
  document.getElementById('srv-subtitle').textContent=moisLabel();
  document.getElementById('srv-cards').innerHTML=`<div class="card"><div class="card-label">Total HT</div><div class="card-value red">${fmt(sum(rows,'prixHT'))}</div></div><div class="card"><div class="card-label">Total TTC</div><div class="card-value orange">${fmt(sum(rows,'prixTTC'))}</div></div>`;
  renderSimpleTable('tbl-services',rows,['societe','designation','prixHT','prixTTC'],'services',()=>{save();renderServices();renderTresorerie();renderDashboard();});
}

function renderRestaurant(){
  const rows=getMoisData('restaurant');
  document.getElementById('resto-subtitle').textContent=moisLabel();
  document.getElementById('resto-cards').innerHTML=`<div class="card"><div class="card-label">Total HT</div><div class="card-value red">${fmt(sum(rows,'prixHT'))}</div></div><div class="card"><div class="card-label">Total TTC</div><div class="card-value orange">${fmt(sum(rows,'prixTTC'))}</div></div>`;
  renderSimpleTable('tbl-restaurant',rows,['societe','designation','prixHT','prixTTC'],'restaurant',()=>{save();renderRestaurant();renderTresorerie();renderDashboard();});
}

function renderSimpleTable(tblId,rows,fields,dataKey,onSave){
  const tbody=document.querySelector('#'+tblId+' tbody');
  tbody.innerHTML='';
  const numFields=['prixHT','prixTTC','tjm','jours','caMensuel'];
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    fields.forEach(f=>{
      const td=document.createElement('td');
      td.textContent=r[f]!=null?r[f]:'';
      if(numFields.includes(f)) td.dataset.raw=r[f];
      makeEditable(td,val=>{r[f]=numFields.includes(f)?(parseFloat(val)||0):val;save();onSave();});
      tr.appendChild(td);
    });
    const tdA=document.createElement('td');
    tdA.innerHTML=`<div class="row-actions"><button class="icon-btn del" onclick="deleteSimpleRow('${dataKey}','${r.id}')">ğŸ—‘ï¸</button></div>`;
    tr.appendChild(tdA);
    tbody.appendChild(tr);
  });
}

function deleteSimpleRow(key,id){
  if(!confirm('Supprimer ?')) return;
  APP.byMonth[activeMois][key]=getMoisData(key).filter(r=>r.id!==id);
  save();refreshEngine();toast('SupprimÃ© âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMarges(){
  const rows=getMoisData('marges');
  const total=sum(rows,'margeMois');
  const moisIdx=MONTHS.indexOf(activeMois);
  const allTotaux=MONTHS.map(m=>sum((APP.byMonth[m]||{}).marges||[],'margeMois'));
  const cumulTotal=allTotaux.slice(0,moisIdx+1).reduce((a,b)=>a+b,0);
  const maxTotal=Math.max(...allTotaux);

  document.getElementById('marges-subtitle').textContent=moisLabel();
  document.getElementById('marges-cards').innerHTML=`
    <div class="card"><div class="card-label">Marge totale â€” ${activeMois}</div><div class="card-value green">${fmt(total)}</div><div class="card-formula">Î£ (Marge/j Ã— jours)</div></div>
    <div class="card success"><div class="card-label">ğŸ“ˆ Cumul Janv â†’ ${activeMois}</div><div class="card-value green">${fmt(cumulTotal)}</div><div class="card-sub">${moisIdx+1} mois</div><div class="card-formula">Î£ marges Jan â†’ ${MOIS_SHORT[moisIdx]}</div></div>
    <div class="card"><div class="card-label">Meilleur mois</div><div class="card-value cyan">${fmt(maxTotal)}</div><div class="card-sub">${MONTHS[allTotaux.indexOf(maxTotal)]}</div></div>
    <div class="card"><div class="card-label">Consultants</div><div class="card-value orange">${rows.length}</div></div>
    <div class="card"><div class="card-label">Marge annuelle proj.</div><div class="card-value green">${fmt(allTotaux.reduce((a,b)=>a+b,0))}</div><div class="card-formula">Î£ marges Jan â†’ DÃ©c</div></div>
  `;

  const tbody=document.querySelector('#tbl-marges tbody');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const mm=(parseFloat(r.margeJour)||0)*(parseFloat(r.jours)||0);
    const cumul=cumulMargePourConsultant(r.consultant,activeMois);
    const tr=document.createElement('tr');
    const syncBadge = r.autoSync ? `<span class="badge badge-cyan" style="font-size:9px;padding:1px 6px;margin-left:4px" title="CalculÃ© depuis Missions Freelance">ğŸ”— auto</span>` : '';
    tr.innerHTML=`
      <td class="editable">${r.consultant}${syncBadge}</td>
      <td class="editable" data-raw="${r.margeJour}" style="${r.autoSync?'color:var(--cyan)':''}">${r.margeJour}</td>
      <td class="editable" data-raw="${r.jours}">${r.jours}</td>
      <td class="calc-cell" style="font-weight:700;color:var(--green)">${fmt(mm)}</td>
      <td class="calc-cell" style="color:var(--cyan);font-weight:600">${fmt(cumul)}</td>
      <td><div class="row-actions">${r.autoSync?`<span style="font-size:10px;color:var(--muted)" title="Sync auto â€” supprimer la mission pour retirer">ğŸ”’</span>`:`<button class="icon-btn del" onclick="deleteMarge('${r.id}')">ğŸ—‘ï¸</button>`}</div></td>
    `;
    const fields=['consultant','margeJour','jours'];
    tr.querySelectorAll('td.editable').forEach((td,i)=>makeEditable(td,val=>{
      if(i>0) r[fields[i]]=parseFloat(val)||0; else r[fields[i]]=val;
      r.margeMois=(r.margeJour||0)*(r.jours||0);
      save();renderMarges();renderDashboard();renderTresorerie();
    }));
    tbody.appendChild(tr);
  });
  const totalTr=document.createElement('tr');
  totalTr.className='total-row';
  totalTr.innerHTML=`<td colspan="3"><strong>Total</strong></td><td><strong>${fmt(total)}</strong></td><td style="color:var(--cyan);font-weight:700">${fmt(cumulTotal)}</td><td></td>`;
  tbody.appendChild(totalTr);

  destroyChart('margeTotale');destroyChart('margePie');
  let cl=0;const clD=allTotaux.map(v=>{cl+=v;return cl;});
  const ctx1=document.getElementById('chartMargeTotale');
  if(ctx1) charts['margeTotale']=new Chart(ctx1,{type:'bar',data:{labels:MOIS_SHORT,datasets:[
    {label:'Marge mensuelle',data:allTotaux,backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4},
    {label:'Cumul annuel',data:clD,type:'line',borderColor:'#f59e0b',backgroundColor:'transparent',tension:.4,pointRadius:3,borderWidth:2}
  ]},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>v>=1000?Math.round(v/1000)+'K â‚¬':v+' â‚¬'}}}}});
  const ctx2=document.getElementById('chartMargePie');
  if(ctx2&&rows.length) charts['margePie']=new Chart(ctx2,{type:'pie',data:{labels:rows.map(r=>r.consultant),datasets:[{data:rows.map(r=>r.margeMois),backgroundColor:['#00d4ff','#10b981','#f59e0b','#ef4444','#a78bfa'],borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

function deleteMarge(id){
  if(!confirm('Supprimer ?')) return;
  const m = getMoisData('marges').find(r=>r.id===id);
  if(m && m.missionId) {
    // Si ligne auto-sync, proposer de supprimer aussi les autres mois
    const linked = APP.missions.find(ms=>ms.id===m.missionId);
    if(!confirm('Cette ligne est liÃ©e Ã  la mission de '+m.consultant+'. Supprimer uniquement ce mois ?')) return;
  }
  APP.byMonth[activeMois].marges=getMoisData('marges').filter(r=>r.id!==id);
  save();renderMarges();renderDashboard();toast('SupprimÃ© âœ“');
}

// â”€â”€â”€ Sync Missions â†’ Marges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Met Ã  jour automatiquement les lignes Marges depuis les Missions Freelance
// RÃ¨gle : marge/j = TJM Client - TJM Consultant, jours = joursMois ou dÃ©faut
// Ne remplace les lignes manuelles QUE si elles ont Ã©tÃ© crÃ©Ã©es par auto-sync (missionId renseignÃ©)
function syncMissionsToMarges() {
  const joursDefault = RULES.joursOuvresParMois > 0 ? RULES.joursOuvresParMois : 0; // 0 = utiliser jours du mois
  MONTHS.forEach(mois => {
    const joursD = joursDefault > 0 ? joursDefault : joursDuMois(mois);
    if (!APP.byMonth[mois]) APP.byMonth[mois] = { tresorerie:{encaissements:[],decaissements:[]}, charges:[], services:[], restaurant:[], marges:[], revenus:[] };
    const marges = APP.byMonth[mois].marges || [];

    APP.missions.forEach(mission => {
      if (!isMissionActivePourMois(mission, mois)) {
        // Mission inactive ce mois â€” supprimer la ligne auto-sync si elle existe
        const idx = marges.findIndex(r => r.missionId === mission.id);
        if (idx !== -1) marges.splice(idx, 1);
        return;
      }
      const margeJ = (mission.tjmClient||0) - (mission.tjmConsultant||0);
      const jours  = mission.joursMois != null ? mission.joursMois : joursD;
      const margeMois = margeJ * jours;
      const existing = marges.find(r => r.missionId === mission.id);
      if (existing) {
        // Mise Ã  jour si auto-sync (ne touche pas aux lignes manuelles)
        existing.consultant = mission.consultant;
        existing.margeJour  = margeJ;
        existing.jours      = jours;
        existing.margeMois  = margeMois;
        existing.autoSync   = true;
      } else {
        // CrÃ©ation d'une nouvelle ligne auto-sync
        marges.push({
          id: uid(), missionId: mission.id, autoSync: true,
          consultant: mission.consultant, margeJour: margeJ, jours, margeMois
        });
      }
    });

    // Nettoyer les lignes orphelines (mission supprimÃ©e)
    const missionIds = APP.missions.map(m => m.id);
    APP.byMonth[mois].marges = marges.filter(r => !r.missionId || missionIds.includes(r.missionId));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODAL_CONFIGS = {
  mission:{title:'Nouvelle mission Freelance',fields:[
    {name:'consultant',label:'Consultant',type:'text',ph:'PrÃ©nom NOM'},{name:'role',label:'RÃ´le',type:'text',ph:'Data Engineer'},
    {name:'client',label:'Client',type:'text',ph:'Nom client'},{name:'tjmClient',label:'TJM Client (â‚¬)',type:'number',ph:'460'},
    {name:'tjmConsultant',label:'TJM Consultant (â‚¬)',type:'number',ph:'430'},
    {name:'debut',label:'Date dÃ©but',type:'date'},{name:'fin',label:'Date fin',type:'date',ph:'(vide si en cours)'},
    {name:'partenaire',label:'Partenaire',type:'text',ph:''},{name:'portage',label:'Portage',type:'text',ph:''},
    {name:'commentaires',label:'Commentaires',type:'text',ph:'',full:true}
  ]},
  cdi:{title:'Nouvelle mission CDI',fields:[
    {name:'consultant',label:'Consultant',type:'text',ph:''},{name:'role',label:'RÃ´le',type:'text',ph:''},
    {name:'client',label:'Client',type:'text',ph:''},{name:'tjmClient',label:'TJM Client (â‚¬)',type:'number',ph:'530'},
    {name:'coutMensuel',label:'CoÃ»t mensuel chargÃ© (â‚¬)',type:'number',ph:'4500'},
    {name:'debut',label:'Date dÃ©but',type:'date'},{name:'fin',label:'Date fin',type:'date'},
    {name:'partenaire',label:'Partenaire',type:'text',ph:''},{name:'commentaires',label:'Commentaires',type:'text',ph:'',full:true}
  ]},
  salarie:{title:'Nouveau salariÃ© Unitech',fields:[
    {name:'nom',label:'Nom',type:'text',ph:'NOM'},{name:'prenom',label:'PrÃ©nom',type:'text',ph:'PrÃ©nom'},
    {name:'poste',label:'IntitulÃ© de poste',type:'text',ph:'DÃ©veloppeur Full Stack',full:true},
    {name:'contrat',label:'Type de contrat',type:'select',ph:'',options:CONTRATS},
    {name:'salaireB',label:'Salaire Brut mensuel (â‚¬)',type:'number',ph:'2000'},
    {name:'dateEntree',label:"Date d'entrÃ©e",type:'date'},{name:'dateSortie',label:'Date de sortie',type:'date',ph:'(vide si actif)'}
  ]},
  revenu:{title:'CA facturÃ© â€” portage',fields:[
    {name:'consultant',label:'Consultant',type:'text',ph:'',full:true},
    {name:'tjm',label:'TJM (â‚¬)',type:'number',ph:'480'},{name:'jours',label:'Jours travaillÃ©s',type:'number',ph:'22'}
  ]},
  charge:{title:'Nouveau poste de dÃ©pense',fields:[
    {name:'poste',label:'Poste de dÃ©pense',type:'text',ph:'Ex: Logiciel CRM',full:true},
    {name:'tarifHT',label:'Tarif HT (â‚¬)',type:'number',ph:'99'},{name:'qte',label:'QuantitÃ©',type:'number',ph:'1'}
  ]},
  service:{title:'Nouvel achat de service',fields:[
    {name:'societe',label:'SociÃ©tÃ©',type:'text',ph:''},{name:'designation',label:'DÃ©signation',type:'text',ph:''},
    {name:'prixHT',label:'Prix HT (â‚¬)',type:'number',ph:'1000'},{name:'prixTTC',label:'Prix TTC (â‚¬)',type:'number',ph:'1200'}
  ]},
  resto:{title:'Nouveau frais de rÃ©ception',fields:[
    {name:'societe',label:'SociÃ©tÃ© / Lieu',type:'text',ph:''},{name:'designation',label:'DÃ©signation',type:'text',ph:''},
    {name:'prixHT',label:'Prix HT (â‚¬)',type:'number',ph:''},{name:'prixTTC',label:'Prix TTC (â‚¬)',type:'number',ph:''}
  ]},
  marge:{title:'Nouvelle marge consultant',fields:[
    {name:'consultant',label:'Consultant',type:'text',ph:'',full:true},
    {name:'margeJour',label:'Marge journaliÃ¨re (â‚¬)',type:'number',ph:'60'},{name:'jours',label:'Jours',type:'number',ph:'22'}
  ]}
};

function openModal(type){
  modalType=type;
  const cfg=MODAL_CONFIGS[type];
  document.getElementById('modalTitle').textContent=cfg.title;
  document.getElementById('modalBody').innerHTML='<div class="form-grid">'+cfg.fields.map(f=>{
    if(f.type==='select') return `<div class="form-group${f.full?' full':''}"><label>${f.label}</label><select name="${f.name}">${(f.options||[]).map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div>`;
    return `<div class="form-group${f.full?' full':''}"><label>${f.label}</label><input type="${f.type}" name="${f.name}" placeholder="${f.ph||''}"></div>`;
  }).join('')+'</div>';
  document.getElementById('modalOverlay').style.display='flex';
}

function closeModal(){ document.getElementById('modalOverlay').style.display='none'; modalType=''; }
function closeModalIfOutside(e){ if(e.target.id==='modalOverlay') closeModal(); }

function submitModal(){
  const inputs=document.querySelectorAll('#modalBody input,#modalBody select');
  const data={id:uid()};
  inputs.forEach(inp=>{data[inp.name]=inp.type==='number'?(parseFloat(inp.value)||0):inp.value;});
  const ensureMonth=()=>{if(!APP.byMonth[activeMois]) APP.byMonth[activeMois]={tresorerie:{encaissements:[],decaissements:[]},charges:[],services:[],restaurant:[],marges:[],revenus:[]};};
  switch(modalType){
    case 'mission': APP.missions.push(data); syncMissionsToMarges(); break;
    case 'cdi': APP.missionsCDI.push(data); break;
    case 'salarie':
      data.salaireCharge=calcSalaireCharge(data.salaireB||0);
      if(!APP.salaries) APP.salaries=[];
      APP.salaries.push(data);
      break;
    case 'revenu': ensureMonth(); data.caMensuel=(data.tjm||0)*(data.jours||0); APP.byMonth[activeMois].revenus=(APP.byMonth[activeMois].revenus||[]); APP.byMonth[activeMois].revenus.push(data); break;
    case 'charge': ensureMonth(); data.totalHT=(data.tarifHT||0)*(data.qte||0); data.totalTTC=data.totalHT*(1+RULES.tauxTVA); APP.byMonth[activeMois].charges=(APP.byMonth[activeMois].charges||[]); APP.byMonth[activeMois].charges.push(data); break;
    case 'service': ensureMonth(); APP.byMonth[activeMois].services=(APP.byMonth[activeMois].services||[]); APP.byMonth[activeMois].services.push(data); break;
    case 'resto': ensureMonth(); APP.byMonth[activeMois].restaurant=(APP.byMonth[activeMois].restaurant||[]); APP.byMonth[activeMois].restaurant.push(data); break;
    case 'marge': ensureMonth(); data.margeMois=(data.margeJour||0)*(data.jours||0); APP.byMonth[activeMois].marges=(APP.byMonth[activeMois].marges||[]); APP.byMonth[activeMois].marges.push(data); break;
  }
  save(); closeModal(); refreshEngine(); toast('EnregistrÃ© âœ“','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETRES DE CALCUL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParams() {
  const ca  = calcCAMois(activeMois);
  const dec = calcDecaissementsAuto(activeMois);
  const ms  = calcMasseSalariale();

  const prev = document.getElementById('params-preview');
  if(prev) prev.innerHTML = `
    <div class="params-preview-item"><div class="params-preview-label">CA calculÃ© (${activeMois})</div><div class="params-preview-value" style="color:var(--cyan)">${fmt(ca)}</div></div>
    <div class="params-preview-item"><div class="params-preview-label">Masse salariale chargÃ©e</div><div class="params-preview-value" style="color:var(--red)">${fmt(ms)}</div></div>
    <div class="params-preview-item"><div class="params-preview-label">Total dÃ©caissements</div><div class="params-preview-value" style="color:var(--red)">${fmt(dec.total)}</div></div>
    <div class="params-preview-item"><div class="params-preview-label">RÃ©sultat net</div><div class="params-preview-value" style="color:${ca-dec.total>=0?'var(--green)':'var(--red)'}">${fmt(ca-dec.total)}</div></div>
    <div class="params-preview-item"><div class="params-preview-label">Jours/mois utilisÃ©s</div><div class="params-preview-value" style="color:var(--orange)">${RULES.joursOuvresParMois>0?RULES.joursOuvresParMois+' j (fixe)':joursDuMois(activeMois)+' j (auto)'}</div></div>
  `;

  const container = document.getElementById('params-content');
  if(!container) return;
  container.innerHTML = `
    <div class="param-block">
      <div class="param-block-header"><span class="param-block-icon">ğŸ‘¤</span>
        <div><div class="param-block-title">Charges salariales</div><div class="param-block-desc">Coefficient salaire brut â†’ chargÃ©</div></div>
      </div>
      <div class="param-rows">
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Coefficient charges patronales</div><div class="param-label-hint">Salaire ChargÃ© = Brut Ã— coeff</div><div class="param-formula">Ex : 1.45 â†’ charges URSSAF ~45%</div></div>
          <div class="param-control">
            <input class="param-input" type="number" min="1" max="3" step="0.01" value="${RULES.coeffChargesPatronales}" onchange="updateRule('coeffChargesPatronales',parseFloat(this.value)||1.45);updateSalairesCharges()">
            <span class="param-unit">Ã—</span>
          </div>
          <div class="param-preview">${fmt(ms)}</div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Inclure dans les dÃ©caissements</div><div class="param-label-hint">Masse salariale â†’ TrÃ©sorerie</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureSalairesDansDecaiss?'checked':''} onchange="updateRule('inclureSalairesDansDecaiss',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureSalairesDansDecaiss?'Incluse':'Exclue'}</span>
          </div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Inclure dans le point mort</div><div class="param-label-hint">Salaires comptent dans le seuil</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureSalairesDansPointMort?'checked':''} onchange="updateRule('inclureSalairesDansPointMort',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureSalairesDansPointMort?'Oui':'Non'}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="param-block">
      <div class="param-block-header"><span class="param-block-icon">ğŸ’°</span>
        <div><div class="param-block-title">TrÃ©sorerie & TVA</div><div class="param-block-desc">RÃ¨gles de calcul des flux financiers</div></div>
      </div>
      <div class="param-rows">
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Taux de rÃ©serve trÃ©sorerie</div><div class="param-label-hint">DisponibilitÃ©s = Encaissements Ã— (1 âˆ’ taux)</div><div class="param-formula">RÃ©serve = Encaissements Ã— taux</div></div>
          <div class="param-control">
            <input class="param-input" type="number" min="0" max="0.99" step="0.01" value="${RULES.tauxReserveTreso}" onchange="updateRule('tauxReserveTreso',parseFloat(this.value)||0.10)">
            <span class="param-unit">Ã—</span>
          </div>
          <div class="param-preview">${Math.round(RULES.tauxReserveTreso*100)} %</div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Taux de TVA</div><div class="param-label-hint">TTC = HT Ã— (1 + taux TVA)</div><div class="param-formula">AppliquÃ© sur les frais gÃ©nÃ©raux</div></div>
          <div class="param-control">
            <input class="param-input" type="number" min="0" max="1" step="0.01" value="${RULES.tauxTVA}" onchange="updateRule('tauxTVA',parseFloat(this.value)||0.20);recalcCharges()">
            <span class="param-unit">Ã—</span>
          </div>
          <div class="param-preview">${Math.round(RULES.tauxTVA*100)} %</div>
        </div>
      </div>
    </div>

    <div class="param-block">
      <div class="param-block-header"><span class="param-block-icon">ğŸ¯</span>
        <div><div class="param-block-title">Missions & CA</div><div class="param-block-desc">Jours de travail et coÃ»t consultants</div></div>
      </div>
      <div class="param-rows">
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Jours ouvrÃ©s par mois</div><div class="param-label-hint">0 = automatique (jours calendaires du mois)</div><div class="param-formula">Actuel : ${RULES.joursOuvresParMois>0?RULES.joursOuvresParMois+' j (fixe)':joursDuMois(activeMois)+' j (auto)'}</div></div>
          <div class="param-control">
            <input class="param-input" type="number" min="0" max="31" step="1" value="${RULES.joursOuvresParMois}" onchange="updateRule('joursOuvresParMois',parseInt(this.value)||0)">
            <span class="param-unit">j</span>
          </div>
          <div class="param-preview">${RULES.joursOuvresParMois>0?RULES.joursOuvresParMois+' j':'auto'}</div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">CoÃ»t consultants â†’ dÃ©caissements</div><div class="param-label-hint">TJM Consultant Ã— jours â†’ TrÃ©sorerie</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureConsultantsDansDecaiss?'checked':''} onchange="updateRule('inclureConsultantsDansDecaiss',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureConsultantsDansDecaiss?'Inclus':'Exclus'}</span>
          </div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">CoÃ»t consultants â†’ point mort</div><div class="param-label-hint">Compte dans le seuil de rentabilitÃ©</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureConsultantsDansPointMort?'checked':''} onchange="updateRule('inclureConsultantsDansPointMort',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureConsultantsDansPointMort?'Oui':'Non'}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="param-block">
      <div class="param-block-header"><span class="param-block-icon">ğŸ§¾</span>
        <div><div class="param-block-title">Charges fixes</div><div class="param-block-desc">Inclusion dans les dÃ©caissements</div></div>
      </div>
      <div class="param-rows">
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Frais gÃ©nÃ©raux</div><div class="param-label-hint">Montant actuel : ${fmt(dec.fraisBrut,2)}</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureFraisDansDecaiss?'checked':''} onchange="updateRule('inclureFraisDansDecaiss',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureFraisDansDecaiss?'Inclus':'Exclus'}</span>
          </div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Frais gÃ©nÃ©raux â†’ point mort</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureFraisDansPointMort?'checked':''} onchange="updateRule('inclureFraisDansPointMort',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureFraisDansPointMort?'Oui':'Non'}</span>
          </div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Achats de services</div><div class="param-label-hint">Montant actuel : ${fmt(dec.servicesBrut,2)}</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureServicesDansDecaiss?'checked':''} onchange="updateRule('inclureServicesDansDecaiss',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureServicesDansDecaiss?'Inclus':'Exclus'}</span>
          </div>
        </div>
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Restaurant / RÃ©ception</div><div class="param-label-hint">Montant actuel : ${fmt(dec.restoBrut,2)}</div></div>
          <div class="param-control toggle-wrap">
            <label class="toggle"><input type="checkbox" ${RULES.inclureRestoDansDecaiss?'checked':''} onchange="updateRule('inclureRestoDansDecaiss',this.checked)"><span class="toggle-slider"></span></label>
            <span class="toggle-label">${RULES.inclureRestoDansDecaiss?'Inclus':'Exclus'}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="param-block">
      <div class="param-block-header"><span class="param-block-icon">âš ï¸</span>
        <div><div class="param-block-title">Alertes missions</div><div class="param-block-desc">Seuil de dÃ©clenchement des alertes de fin</div></div>
      </div>
      <div class="param-rows">
        <div class="param-row">
          <div class="param-label"><div class="param-label-text">Seuil alerte fin de mission</div><div class="param-label-hint">Badge âš ï¸ J-XX affichÃ© si fin dans moins de X jours</div><div class="param-formula">Visible sur Dashboard, Missions, CDI</div></div>
          <div class="param-control">
            <input class="param-input" type="number" min="1" max="365" step="1" value="${RULES.seuilAlerteMission}" onchange="updateRule('seuilAlerteMission',parseInt(this.value)||30)">
            <span class="param-unit">j</span>
          </div>
          <div class="param-preview">${RULES.seuilAlerteMission} jours</div>
        </div>
      </div>
    </div>
  `;

  // â”€â”€ Bloc formules libres (pleine largeur) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const fCtx = buildFormulaCtx(activeMois);
  const formuleDefs = [
    { key:'salaireCharge',  label:'Salaire chargÃ©',      hint:'CoÃ»t total par salariÃ©',    extra:'BRUT disponible ici', icon:'ğŸ‘¤',
      tokenCtx:{ ...fCtx, BRUT:'[Salaire brut individuel]' }, example:'BRUT * 1.45',
      preview: (() => { const r = evalFormule(RULES.formules.salaireCharge, { ...fCtx, BRUT: (APP.salaries&&APP.salaries[0]) ? APP.salaries[0].salaireB : 3000 }); return r!==null ? fmt(r) + ' (ex. brut='+((APP.salaries&&APP.salaries[0])?APP.salaries[0].salaireB:3000)+')' : 'âš ï¸ Erreur'; })() },
    { key:'reserve',        label:'RÃ©serve trÃ©sorerie',   hint:'Provision sur les marges',  icon:'ğŸ¦',
      example:'MARGE * 0.1',
      preview: (() => { const r = evalFormule(RULES.formules.reserve, {...fCtx, MARGE: calcEncaissementAuto(activeMois)}); return r!==null ? fmt(r) : 'âš ï¸ Erreur'; })() },
    { key:'disponibilite',  label:'DisponibilitÃ©s',       hint:'TrÃ©sorerie disponible nette', icon:'ğŸ’µ',
      example:'MARGE * 0.9',
      preview: (() => { const r = evalFormule(RULES.formules.disponibilite, {...fCtx, MARGE: calcEncaissementAuto(activeMois)}); return r!==null ? fmt(r) : 'âš ï¸ Erreur'; })() },
    { key:'resultat',       label:'RÃ©sultat net du mois', hint:'CA moins toutes les charges', icon:'ğŸ“Š',
      example:'CA - CHARGES',
      preview: (() => { const r = evalFormule(RULES.formules.resultat, fCtx); return r!==null ? fmt(r) : 'âš ï¸ Erreur'; })() },
    { key:'pointMort',      label:'Seuil du point mort',  hint:'Charges fixes Ã  couvrir par le CA', icon:'ğŸ“',
      example:'SALAIRES + FRAIS + FREELANCES',
      preview: (() => { const r = evalFormule(RULES.formules.pointMort, fCtx); return r!==null ? fmt(r) : 'âš ï¸ Erreur'; })() },
  ];

  const varTokens = [
    { token:'CA',          desc:'CA du mois (TJM Ã— jours missions)',       val: fmt(fCtx.CA) },
    { token:'MARGE',       desc:'Î£ Marges journaliÃ¨res Ã— jours',           val: fmt(fCtx.MARGE) },
    { token:'CHARGES',     desc:'Total dÃ©caissements auto du mois',         val: fmt(fCtx.CHARGES) },
    { token:'SALAIRES',    desc:'Masse salariale chargÃ©e (Î£ BRUT Ã— coeff)', val: fmt(fCtx.SALAIRES) },
    { token:'FREELANCES',  desc:'CoÃ»t consultants freelance (Î£ TJM_cons Ã— j)', val: fmt(fCtx.FREELANCES) },
    { token:'FRAIS',       desc:'Frais gÃ©nÃ©raux HT du mois',                val: fmt(fCtx.FRAIS) },
    { token:'SERVICES',    desc:'Achats de services HT du mois',            val: fmt(fCtx.SERVICES) },
    { token:'RESTO',       desc:'Restaurant / RÃ©ception HT du mois',       val: fmt(fCtx.RESTO) },
    { token:'NB_MISSIONS', desc:'Nombre de missions actives du mois',      val: fCtx.NB_MISSIONS },
    { token:'BRUT',        desc:'Salaire brut individuel (salaireCharge uniquement)', val: 'â€”' },
  ];

  container.innerHTML += `
    <div class="param-block" style="grid-column:1/-1">
      <div class="param-block-header"><span class="param-block-icon">ğŸ§®</span>
        <div><div class="param-block-title">Formules de calcul libres</div><div class="param-block-desc">Personnalisez les rÃ¨gles de calcul avec des expressions mathÃ©matiques</div></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:0;border-top:1px solid var(--border)">
        <!-- Tableau des formules -->
        <div>
          <div style="padding:10px 18px 4px;background:var(--surface2);display:grid;grid-template-columns:180px 1fr 130px 70px;gap:8px;font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--border)">
            <span>Indicateur</span><span>Formule (Ã©ditable)</span><span>RÃ©sultat actuel</span><span></span>
          </div>
          ${formuleDefs.map(f => `
          <div class="param-row formula-row" style="display:grid;grid-template-columns:180px 1fr 130px 70px;gap:8px;align-items:center">
            <div>
              <div style="font-size:12px;font-weight:600;color:var(--text)">${f.icon} ${f.label}</div>
              <div style="font-size:10px;color:var(--muted)">${f.hint}</div>
            </div>
            <div style="position:relative">
              <input class="param-input formula-input" type="text" style="width:100%;font-family:'Courier New',monospace;font-size:11.5px;font-weight:400;text-align:left;color:var(--cyan)"
                value="${(RULES.formules[f.key]||'').replace(/"/g,'&quot;')}"
                id="formulaInput_${f.key}"
                placeholder="${f.example}"
                onkeydown="if(event.key==='Enter'){event.preventDefault();applyFormule('${f.key}')}"
                oninput="previewFormule('${f.key}',this.value)">
            </div>
            <div id="formulaPreview_${f.key}" style="font-size:11px;font-weight:700;color:var(--cyan);text-align:right;padding-right:4px">${f.preview}</div>
            <div style="display:flex;gap:4px">
              <button class="btn" style="padding:4px 8px;font-size:10px" onclick="testFormule('${f.key}')" title="Tester">ğŸ§ª</button>
              <button class="btn btn-primary" style="padding:4px 8px;font-size:10px" onclick="applyFormule('${f.key}')" title="Appliquer">âœ“</button>
            </div>
          </div>`).join('')}
          <div style="padding:10px 18px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center">
            <button class="btn btn-danger" onclick="resetFormules()" style="font-size:11px">â†º RÃ©initialiser les formules</button>
            <span style="font-size:10.5px;color:var(--muted)">Appuyez sur EntrÃ©e ou âœ“ pour valider â€¢ ğŸ§ª pour tester sans appliquer</span>
          </div>
        </div>

        <!-- Panel variables -->
        <div style="border-left:1px solid var(--border);background:var(--surface2)">
          <div style="padding:10px 14px 8px;border-bottom:1px solid var(--border)">
            <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:2px">ğŸ“– Variables disponibles</div>
            <div style="font-size:10px;color:var(--muted)">Valeurs pour <strong style="color:var(--cyan)">${activeMois}</strong></div>
          </div>
          ${varTokens.map(v => `
          <div style="padding:7px 14px;border-bottom:1px solid rgba(30,45,74,.5);display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <code style="font-size:11px;font-weight:700;color:var(--cyan);font-family:'Courier New',monospace">${v.token}</code>
              <div style="font-size:9.5px;color:var(--muted);margin-top:1px">${v.desc}</div>
            </div>
            <div style="font-size:11px;font-weight:700;color:var(--text);white-space:nowrap;flex-shrink:0">${v.val}</div>
          </div>`).join('')}
          <div style="padding:10px 14px">
            <div style="font-size:10px;color:var(--muted);line-height:1.5">
              OpÃ©rateurs : <code style="color:var(--cyan)">+ - * / ( )</code><br>
              Nombres dÃ©cimaux avec <code style="color:var(--cyan)">.</code><br>
              Ex : <code style="color:var(--orange)">CA * 0.15 + SALAIRES</code>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function updateRule(key, value) {
  RULES[key] = value;
  saveRules();
  refreshEngine();
}

// â”€â”€â”€ Gestion formules libres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFormule(key) {
  const input = document.getElementById('formulaInput_' + key);
  if (!input) return;
  const formulaStr = input.value.trim();
  if (!formulaStr) return;
  // Validation rapide avant d'appliquer
  const ctx = buildFormulaCtx(activeMois);
  if (key === 'salaireCharge') ctx.BRUT = (APP.salaries && APP.salaries[0]) ? APP.salaries[0].salaireB : 3000;
  const testResult = evalFormule(formulaStr, ctx);
  if (testResult === null) {
    toast('âš ï¸ Formule invalide â€” vÃ©rifiez la syntaxe', 'error');
    input.style.borderColor = 'var(--red)';
    return;
  }
  input.style.borderColor = '';
  if (!RULES.formules) RULES.formules = {};
  RULES.formules[key] = formulaStr;
  saveRules();
  if (key === 'salaireCharge') updateSalairesCharges();
  refreshEngine();
  toast('Formule appliquÃ©e âœ“', 'success');
}

function testFormule(key) {
  const input = document.getElementById('formulaInput_' + key);
  if (!input) return;
  const formulaStr = input.value.trim();
  if (!formulaStr) { toast('Saisissez une formule', 'error'); return; }
  const ctx = buildFormulaCtx(activeMois);
  if (key === 'salaireCharge') {
    const bruts = (APP.salaries||[]).map(s => s.salaireB||0).filter(b=>b>0);
    const exemples = bruts.slice(0,3).map(b => {
      const r = evalFormule(formulaStr, { ...ctx, BRUT: b });
      return r !== null ? `BRUT=${b} â†’ ${fmt(r)}` : `BRUT=${b} â†’ âš ï¸ erreur`;
    });
    if (exemples.length > 0) {
      toast('ğŸ§ª Test:\n' + exemples.join('\n'), 'success');
      input.style.borderColor = 'var(--cyan)';
    } else {
      const r = evalFormule(formulaStr, { ...ctx, BRUT: 3000 });
      if (r !== null) { toast('ğŸ§ª BRUT=3000 â†’ ' + fmt(r), 'success'); input.style.borderColor = 'var(--cyan)'; }
      else { toast('âš ï¸ Formule invalide', 'error'); input.style.borderColor = 'var(--red)'; }
    }
  } else {
    const r = evalFormule(formulaStr, ctx);
    if (r !== null) { toast('ğŸ§ª RÃ©sultat : ' + fmt(r), 'success'); input.style.borderColor = 'var(--cyan)'; }
    else { toast('âš ï¸ Formule invalide â€” vÃ©rifiez les tokens et la syntaxe', 'error'); input.style.borderColor = 'var(--red)'; }
  }
}

function previewFormule(key, value) {
  const previewEl = document.getElementById('formulaPreview_' + key);
  if (!previewEl) return;
  const ctx = buildFormulaCtx(activeMois);
  if (key === 'salaireCharge') ctx.BRUT = (APP.salaries && APP.salaries[0]) ? APP.salaries[0].salaireB : 3000;
  if (key === 'reserve' || key === 'disponibilite') ctx.MARGE = calcEncaissementAuto(activeMois);
  const r = evalFormule(value, ctx);
  if (r !== null) {
    previewEl.style.color = 'var(--cyan)';
    previewEl.textContent = fmt(r) + (key === 'salaireCharge' ? ' /sal.' : '');
  } else {
    previewEl.style.color = 'var(--red)';
    previewEl.textContent = 'âš ï¸ Erreur';
  }
}

function resetFormules() {
  if (!confirm('Remettre toutes les formules aux valeurs par dÃ©faut ?')) return;
  RULES.formules = { ...DEFAULT_RULES.formules };
  saveRules();
  updateSalairesCharges();
  refreshEngine();
  toast('Formules rÃ©initialisÃ©es âœ“', 'success');
}

function updateSalairesCharges() {
  (APP.salaries||[]).forEach(s => {
    s.salaireCharge = calcSalaireCharge(s.salaireB||0);
  });
  save();
}

function recalcCharges() {
  MONTHS.forEach(m => {
    ((APP.byMonth[m]||{}).charges||[]).forEach(r => {
      r.totalHT = (r.tarifHT||0) * (r.qte||0);
      r.totalTTC = r.totalHT * (1 + RULES.tauxTVA);
    });
  });
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id,btn){
  currentPage=id;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
  refreshEngine();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON(){
  const blob=new Blob([JSON.stringify(APP,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='unitech-pilotage-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(url);
  toast('Export JSON tÃ©lÃ©chargÃ© âœ“','success');
}

function importJSON(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{try{APP=JSON.parse(e.target.result);if(!APP.salaries)APP.salaries=[];if(!APP.missionsCDI)APP.missionsCDI=[];syncMissionsToMarges();save();refreshEngine();toast('Import rÃ©ussi âœ“','success');}catch(err){toast('Erreur : JSON invalide','error');}};
  reader.readAsText(file);
  event.target.value='';
}

function resetData(){
  if(!confirm('RÃ©initialiser toutes les donnÃ©es ? Cette action est irrÃ©versible.')) return;
  APP=defaultData();save();refreshEngine();toast('DonnÃ©es rÃ©initialisÃ©es âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show '+type;
  setTimeout(()=>{t.className='toast';},3000);
}

window.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>