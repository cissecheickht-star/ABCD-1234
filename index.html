<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Budget Pro">
<meta name="theme-color" content="#0A0C0F">
<title>Budget Pro</title>
<style>
:root{
  --bg:#0A0C0F;--bg2:#0D0F13;--bg3:#111318;--border:#1A1C22;--border2:#252830;
  --text:#E8E0D4;--dim:#888;--muted:#444;
  --gold:#C8A97E;--green:#7EC8A9;--pink:#C87EA9;--blue:#7EA9C8;--red:#C85555;--purple:#A97EC8;
  --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:Georgia,serif;min-height:100vh;overscroll-behavior:none}
.app{display:flex;flex-direction:column;min-height:100vh;padding-top:var(--safe-top)}
.hdr{padding:18px 16px 0;flex-shrink:0}
.hdr-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.eyebrow{font-size:10px;letter-spacing:3px;color:var(--gold);font-family:monospace;text-transform:uppercase;margin-bottom:3px}
.h-title{font-size:24px;font-weight:400;color:#F0E8DC}
.mnav{display:flex;align-items:center;gap:7px}
.mbtn{background:var(--border);border:none;color:var(--dim);width:28px;height:28px;border-radius:4px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mlbl{font-family:monospace;font-size:11px;color:var(--dim);min-width:68px;text-align:center}
/* tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);margin:0 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:10px 10px;cursor:pointer;flex-shrink:0;margin-bottom:-1px;transition:color .2s;white-space:nowrap}
.tab.on{color:var(--gold);border-bottom-color:var(--gold)}
.main{flex:1;padding:14px 14px calc(32px + var(--safe-bottom));overflow-y:auto;-webkit-overflow-scrolling:touch}
/* cards */
.card{background:var(--bg2);border:1px solid var(--border);padding:14px;margin-bottom:10px;border-radius:2px}
.card-t{font-family:monospace;font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:12px}
/* kpis */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-bottom:10px}
.kpi{background:var(--bg2);border:1px solid var(--border);padding:13px}
.kpi.w3{grid-column:1/-1}
.kpi-l{font-family:monospace;font-size:9px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-bottom:5px}
.kpi-v{font-size:18px;letter-spacing:-1px;color:#F0E8DC}
.kpi-s{font-family:monospace;font-size:10px;margin-right:2px}
/* transactions */
.tx{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid #0F1115;gap:8px}
.tx:last-child{border-bottom:none}
.tx-logo{width:30px;height:30px;border-radius:7px;object-fit:contain;background:#111;flex-shrink:0}
.tx-fb{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:monospace;flex-shrink:0}
.tx-inf{flex:1;min-width:0}
.tx-lb{font-size:13px;color:#D0C8BC;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-mt{font-family:monospace;font-size:10px;color:var(--muted);margin-top:1px}
.tx-am{font-family:monospace;font-size:13px;flex-shrink:0}
.tx-del{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 0 2px 8px;line-height:1;flex-shrink:0}
.g{color:var(--green)}.p{color:var(--pink)}.b{color:var(--blue)}.r{color:var(--red)}.gold{color:var(--gold)}
/* forms */
.fg{display:flex;flex-direction:column;gap:12px}
.fl{display:flex;flex-direction:column;gap:5px;font-family:monospace;font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
.fi,.fs{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:11px 12px;font-family:monospace;font-size:14px;border-radius:4px;outline:none;width:100%;-webkit-appearance:none;appearance:none}
.fi:focus,.fs:focus{border-color:var(--gold)}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
/* pills */
.pill-row{display:flex;gap:4px;flex-wrap:wrap}
.pill{background:var(--bg);border:1px solid var(--border);color:var(--muted);font-family:monospace;font-size:9px;letter-spacing:1px;padding:7px 10px;cursor:pointer;text-transform:uppercase;border-radius:20px;transition:all .15s}
.pill.on{border-color:var(--gold);color:var(--gold);background:#1a1408}
.pill.on-g{border-color:var(--green);color:var(--green);background:#0d1a10}
.pill.on-p{border-color:var(--pink);color:var(--pink);background:#1a0d12}
.submit{background:var(--gold);color:var(--bg);border:none;padding:14px;font-family:monospace;font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;cursor:pointer;border-radius:4px;width:100%;margin-top:4px}
/* bars */
.bar-bg{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.bar-fill{height:4px;border-radius:2px;transition:width .6s}
.bar-bg.thin{height:2px}.bar-fill.thin{height:2px}
/* misc */
.empty{font-family:monospace;font-size:11px;color:var(--muted);text-align:center;padding:20px 0}
.row-between{display:flex;justify-content:space-between;align-items:center}
.mono{font-family:monospace}
.sm{font-size:11px}.xs{font-size:10px}.xxs{font-size:9px}
/* toast */
.toast{position:fixed;top:calc(var(--safe-top)+10px);left:50%;transform:translateX(-50%);background:var(--gold);color:var(--bg);padding:9px 20px;border-radius:20px;font-family:monospace;font-size:12px;font-weight:700;letter-spacing:1px;z-index:999;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.6);opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
/* alerts */
.alert{border:1px solid;padding:11px 13px;margin-bottom:10px;border-radius:2px}
.alert.urg{background:#1a0808;border-color:#5a1a1a}
.alert.soon{background:#1a1208;border-color:#5a3a10}
.alert-t{font-family:monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;margin-bottom:7px}
.alert-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.alert-row:last-child{border-bottom:none}
.badge{font-family:monospace;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700}
.badge.urg{background:#5a1a1a;color:#ff7070}
.badge.soon{background:#3a2a10;color:#ffaa44}
.badge.ok{background:#0d1a0d;color:var(--green)}
/* subscriptions */
.sub-card{display:flex;align-items:center;padding:11px 0;border-bottom:1px solid #0F1115;gap:8px}
.sub-card:last-child{border-bottom:none}
.sub-logo{width:32px;height:32px;border-radius:8px;object-fit:contain;background:#111;flex-shrink:0}
.sub-fb{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;font-family:monospace;flex-shrink:0}
.sub-inf{flex:1;min-width:0}
.sub-nm{font-size:13px;color:#D0C8BC;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub-mt{font-family:monospace;font-size:10px;color:var(--muted);margin-top:2px}
.sub-rt{text-align:right;flex-shrink:0}
.sub-pr{font-family:monospace;font-size:12px;color:#D0C8BC}
.sub-due{font-family:monospace;font-size:10px;margin-top:2px}
.sub-acts{display:flex;gap:3px;flex-shrink:0}
.sab{background:none;border:1px solid var(--border);color:var(--muted);font-family:monospace;font-size:9px;padding:4px 6px;cursor:pointer;border-radius:3px}
.sab.rn{border-color:#1E3020;color:var(--green)}
.sab.dl{border-color:#2a1010;color:var(--red)}
/* logo picker */
.logo-search{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:monospace;font-size:13px;border-radius:4px;outline:none;width:100%;margin-bottom:8px}
.logo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;max-height:240px;overflow-y:auto;padding-right:2px}
.logo-grid::-webkit-scrollbar{width:2px}
.logo-grid::-webkit-scrollbar-thumb{background:#333;border-radius:1px}
.litem{display:flex;flex-direction:column;align-items:center;gap:4px;padding:9px 3px;border:1px solid var(--border);border-radius:6px;cursor:pointer;background:var(--bg)}
.litem.sel{border-color:var(--gold);background:#1a1408}
.limg{width:32px;height:32px;border-radius:7px;object-fit:contain;background:#111}
.lfb{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;font-family:monospace}
.llbl{font-family:monospace;font-size:8px;color:var(--muted);text-align:center;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:54px}
/* goals */
.goal-card{padding:12px 0;border-bottom:1px solid #0F1115}
.goal-card:last-child{border-bottom:none}
/* net worth */
.asset-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #0F1115}
.asset-row:last-child{border-bottom:none}
.asset-nm{font-size:13px;color:#D0C8BC}
.asset-cat{font-family:monospace;font-size:9px;color:var(--muted);margin-top:1px}
/* forecast */
.fc-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #0F1115}
.fc-row:last-child{border-bottom:none}
.fc-date{font-family:monospace;font-size:11px;color:var(--dim);flex-shrink:0;min-width:36px}
.fc-label{font-size:12px;color:#D0C8BC;flex:1;margin:0 10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
/* 50/30/20 */
.rule-row{margin-bottom:12px}
.rule-top{display:flex;justify-content:space-between;font-family:monospace;font-size:11px;margin-bottom:5px}
/* mini chart */
.mchart{display:flex;align-items:flex-end;gap:3px;height:72px}
.mcol{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.mbars{display:flex;gap:2px;align-items:flex-end;height:55px;width:100%}
.mbar{flex:1;border-radius:2px 2px 0 0;min-height:2px}
.mmth{font-family:monospace;font-size:8px;color:var(--muted)}
.dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:#ffaa44;margin-left:3px;vertical-align:middle;margin-top:-2px}
/* calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:8px}
.cal-day-hdr{font-family:monospace;font-size:8px;color:var(--muted);text-align:center;padding:4px 0}
.cal-day{min-height:36px;border:1px solid transparent;border-radius:3px;padding:3px;font-family:monospace;font-size:10px;color:var(--muted);cursor:pointer}
.cal-day.has-event{border-color:#2a2520;background:#12100E}
.cal-day.today{border-color:var(--gold)!important;color:var(--gold)}
.cal-day-num{font-size:9px;margin-bottom:2px}
.cal-dot-wrap{display:flex;flex-wrap:wrap;gap:2px}
.cal-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
/* simulator */
.sim-result{background:var(--bg3);border:1px solid var(--border2);padding:14px;border-radius:4px;margin-top:12px}
.sim-big{font-size:28px;letter-spacing:-1px;color:var(--gold)}
/* ‚îÄ‚îÄ import ‚îÄ‚îÄ */
.drop-zone{border:2px dashed var(--border2);border-radius:6px;padding:20px 16px;text-align:center;transition:border-color .2s,background .2s}
.drop-zone.over{border-color:var(--gold);background:#12100e}
.file-btn{display:inline-block;background:var(--gold);color:var(--bg);font-family:monospace;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:13px 24px;border-radius:4px;cursor:pointer;margin-bottom:10px}
.file-btn:hover{opacity:.9}
.drop-icon{font-size:28px;margin-bottom:8px}
.drop-title{font-family:monospace;font-size:12px;color:var(--dim);letter-spacing:1px}
.drop-sub{font-family:monospace;font-size:10px;color:var(--muted);margin-top:5px}
.bank-chips{display:flex;gap:5px;flex-wrap:wrap;margin-top:10px;justify-content:center}
.bank-chip{background:var(--bg3);border:1px solid var(--border);font-family:monospace;font-size:8px;color:var(--muted);padding:3px 7px;border-radius:10px;letter-spacing:1px}
.imp-table{width:100%;border-collapse:collapse;font-size:12px}
.imp-table th{font-family:monospace;font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;padding:6px 4px;border-bottom:1px solid var(--border);text-align:left}
.imp-table td{padding:6px 4px;border-bottom:1px solid #0F1115;vertical-align:middle}
.imp-table tr:last-child td{border-bottom:none}
.imp-table tr.dup-row td{opacity:.35}
.cat-sel{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:monospace;font-size:10px;padding:3px 5px;border-radius:3px;width:100%;-webkit-appearance:none;appearance:none}
.ai-badge{display:inline-flex;align-items:center;gap:3px;background:#0d1a0d;border:1px solid var(--green);color:var(--green);font-family:monospace;font-size:8px;padding:2px 6px;border-radius:8px;vertical-align:middle}
.prog-wrap{height:4px;background:var(--border);border-radius:2px;margin:10px 0;overflow:hidden}
.prog-bar{height:4px;background:var(--green);border-radius:2px;transition:width .3s}
.imp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;margin-bottom:10px}
.imp-stat{background:var(--bg3);border:1px solid var(--border);padding:10px;text-align:center}
.imp-stat-v{font-family:monospace;font-size:15px;font-weight:700;margin-bottom:2px}
.imp-stat-l{font-family:monospace;font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.api-box{background:#0a0f0a;border:1px solid #1E3020;border-radius:4px;padding:12px;margin-bottom:10px}
.api-title{font-family:monospace;font-size:9px;color:var(--green);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.bank-guide-row{display:flex;align-items:flex-start;gap:8px;padding:5px 0;border-bottom:1px solid #111}
.bank-guide-row:last-child{border-bottom:none}
/* detected subs */
.det-sub-card{background:var(--bg3);border:1px solid #1E3020;border-radius:4px;padding:12px;margin-bottom:8px}
.det-sub-card.dismissed{display:none}
/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media (max-width:640px){
  /* Bigger tap targets */
  .mbtn{width:40px;height:40px;font-size:20px}
  .tab{padding:12px 12px;font-size:9px}
  .submit{padding:18px;font-size:13px;letter-spacing:2px}
  .fi,.fs{padding:14px 13px;font-size:16px} /* 16px prevents iOS zoom on focus */
  .sab{padding:8px 10px;font-size:10px}
  .pill{padding:10px 14px;font-size:10px}
  .tx-del{padding:4px 0 4px 12px;font-size:22px}
  /* Slightly more readable text */
  .tx-lb{font-size:14px}
  .tx-am{font-size:14px}
  .kpi-v{font-size:20px}
  .sub-nm{font-size:14px}
  .sub-pr{font-size:13px}
  /* Prevent tiny monospace labels from being unreadable */
  .card-t,.kpi-l,.imp-table th{font-size:9px;letter-spacing:2px}
  /* import table scrollable on small screens */
  .imp-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .imp-table{min-width:520px}
  /* calendar day min touch target */
  .cal-day{min-height:44px}
  /* toast position safe on notch phones */
  .toast{font-size:13px;padding:11px 22px}
  /* KPI grid: 2 cols on mobile is fine, but full-width on very small */
  .kpis{gap:3px}
  /* Section padding slightly tighter */
  .main{padding:12px 12px calc(28px + var(--safe-bottom))}
  .hdr{padding:14px 14px 0}
  /* goals / assets rows easier to tap */
  .goal-card{padding:14px 0}
  .asset-row{padding:12px 0}
  /* fr2/fr3 collapse on tiny screens */
  .fr3{grid-template-columns:1fr 1fr}
  /* drop zone bigger on mobile (easier to tap) */
  .drop-zone{padding:28px 16px}
  .file-btn{padding:16px 28px;font-size:13px}
  /* logo grid 3 cols on mobile */
  .logo-grid{grid-template-columns:repeat(3,1fr)}
  /* Bigger logo items for fat fingers */
  .litem{padding:12px 4px}
  .lfb,.limg{width:36px;height:36px}
}
@media (max-width:380px){
  /* Very small phones (SE, Galaxy A) */
  .fr2,.fr3{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr}
  .kpi.w3{grid-column:auto}
  .h-title{font-size:20px}
}
/* Prevent double-tap zoom on buttons */
button,a,[onclick]{touch-action:manipulation}
/* Smooth scroll on iOS */
.main,.logo-grid{-webkit-overflow-scrolling:touch}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="hdr-row">
      <div>
        <div class="eyebrow">Finances Personnelles</div>
        <div class="h-title">Budget Pro</div>
      </div>
      <div class="mnav">
        <button class="mbtn" onclick="changeMonth(-1)">‚Äπ</button>
        <div class="mlbl" id="mLabel"></div>
        <button class="mbtn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab on" data-v="dashboard" onclick="nav(this)">Bord</button>
    <button class="tab" data-v="add" onclick="nav(this)">Ôºã Ajout</button>
    <button class="tab" data-v="import" onclick="nav(this)" id="tabImport">‚á™ Import</button>
    <button class="tab" data-v="subs" onclick="nav(this)" id="tabSubs">Abos</button>
    <button class="tab" data-v="goals" onclick="nav(this)">Objectifs</button>
    <button class="tab" data-v="patrimoine" onclick="nav(this)">Patrimoine</button>
    <button class="tab" data-v="calendar" onclick="nav(this)">Calendrier</button>
    <button class="tab" data-v="history" onclick="nav(this)">Historique</button>
    <button class="tab" data-v="settings" onclick="nav(this)">Budgets</button>
  </div>
  <div class="main" id="main"></div>
</div>
<div class="toast" id="toast"></div>
<input type="file" id="csvInput" accept=".csv,.txt,.ofx,.qif" style="display:none">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MSH=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

const CATS=[
  {name:'Logement',    icon:'‚åÇ', color:'#C8A97E', type:'needs'},
  {name:'Alimentation',icon:'‚óà', color:'#7EC8A9', type:'needs'},
  {name:'Transport',   icon:'‚óâ', color:'#7EA9C8', type:'needs'},
  {name:'Sant√©',       icon:'‚ú¶', color:'#C87EA9', type:'needs'},
  {name:'Loisirs',     icon:'‚óé', color:'#A97EC8', type:'wants'},
  {name:'V√™tements',   icon:'‚óÜ', color:'#C8C87E', type:'wants'},
  {name:'Restaurants', icon:'‚òï', color:'#C87E7E', type:'wants'},
  {name:'√âpargne',     icon:'‚óà', color:'#8EC8C8', type:'savings'},
  {name:'Investissements',icon:'‚ñ≤',color:'#7EC8A9',type:'savings'},
  {name:'Autre',       icon:'‚óã', color:'#666',    type:'wants'},
];

const GOAL_ICONS=['üèñÔ∏è','üöó','üè†','üì±','üíç','‚úàÔ∏è','üìö','üéì','üèãÔ∏è','üí∞','üÜò','üéÅ','üõãÔ∏è','üé∏','üë∂'];
const ASSET_CATS=['√âpargne','Investissements','Immobilier','Crypto','Autre actif'];
const DEBT_CATS=['Cr√©dit immobilier','Cr√©dit auto','Cr√©dit conso','Pr√™t √©tudiant','D√©couvert','Autre dette'];

const FREQS=[
  {id:'weekly',   l:'Hebdo',      s:'sem', days:7},
  {id:'monthly',  l:'Mensuel',    s:'mois',days:30.44},
  {id:'quarterly',l:'Trimestr.',  s:'trim',days:91.3},
  {id:'biannual', l:'Semestr.',   s:'6m',  days:182.6},
  {id:'yearly',   l:'Annuel',     s:'an',  days:365.25},
];

const SERVICE_BANK=[
  {name:'Netflix',domain:'netflix.com',color:'#E50914'},
  {name:'Disney+',domain:'disneyplus.com',color:'#113CCF'},
  {name:'Max',domain:'max.com',color:'#002BE7'},
  {name:'Prime Video',domain:'primevideo.com',color:'#00A8E1'},
  {name:'Apple TV+',domain:'tv.apple.com',color:'#555'},
  {name:'Canal+',domain:'canalplus.com',color:'#333'},
  {name:'Molotov',domain:'molotov.tv',color:'#FF4040'},
  {name:'Crunchyroll',domain:'crunchyroll.com',color:'#F47521'},
  {name:'YouTube Premium',domain:'youtube.com',color:'#FF0000'},
  {name:'Spotify',domain:'spotify.com',color:'#1DB954'},
  {name:'Deezer',domain:'deezer.com',color:'#FF0092'},
  {name:'Apple Music',domain:'music.apple.com',color:'#FC3C44'},
  {name:'Tidal',domain:'tidal.com',color:'#333'},
  {name:'Xbox Game Pass',domain:'xbox.com',color:'#107C10'},
  {name:'PlayStation+',domain:'playstation.com',color:'#003087'},
  {name:'Nintendo Online',domain:'nintendo.com',color:'#E4000F'},
  {name:'EA Play',domain:'ea.com',color:'#FF4747'},
  {name:'Steam',domain:'store.steampowered.com',color:'#1B2838'},
  {name:'iCloud',domain:'icloud.com',color:'#3478F6'},
  {name:'Google One',domain:'one.google.com',color:'#4285F4'},
  {name:'Dropbox',domain:'dropbox.com',color:'#0061FF'},
  {name:'OneDrive',domain:'onedrive.live.com',color:'#0078D4'},
  {name:'Microsoft 365',domain:'microsoft.com',color:'#D83B01'},
  {name:'Adobe CC',domain:'adobe.com',color:'#FF0000'},
  {name:'Notion',domain:'notion.so',color:'#333'},
  {name:'Figma',domain:'figma.com',color:'#F24E1E'},
  {name:'GitHub',domain:'github.com',color:'#333'},
  {name:'Canva',domain:'canva.com',color:'#00C4CC'},
  {name:'ChatGPT Plus',domain:'openai.com',color:'#10A37F'},
  {name:'Claude Pro',domain:'claude.ai',color:'#D4A27A'},
  {name:'NordVPN',domain:'nordvpn.com',color:'#4687FF'},
  {name:'1Password',domain:'1password.com',color:'#1A8CFF'},
  {name:'Dashlane',domain:'dashlane.com',color:'#004F9F'},
  {name:'Le Monde',domain:'lemonde.fr',color:'#333'},
  {name:'Le Figaro',domain:'lefigaro.fr',color:'#C41A1A'},
  {name:'Mediapart',domain:'mediapart.fr',color:'#00517A'},
  {name:'Kindle',domain:'amazon.fr',color:'#FF9900'},
  {name:'Audible',domain:'audible.fr',color:'#F8991D'},
  {name:'Strava',domain:'strava.com',color:'#FC4C02'},
  {name:'Calm',domain:'calm.com',color:'#3D83E6'},
  {name:'Headspace',domain:'headspace.com',color:'#F47D31'},
  {name:'Duolingo',domain:'duolingo.com',color:'#58CC02'},
  {name:'Amazon Prime',domain:'amazon.fr',color:'#FF9900'},
  {name:'Fnac+',domain:'fnac.com',color:'#E6AF00'},
  {name:'Deliveroo+',domain:'deliveroo.fr',color:'#00CCBC'},
  {name:'Uber One',domain:'uber.com',color:'#333'},
];

const CATEGORY_RULES=[
  {cat:'Logement',kw:['loyer','bail','quittance','edf','engie','total energie','eau ','gaz ','fibre','sfr','orange','free ','bouygues','bytel','assurance ','mutuelle ','mma','axa','maif','macif','allianz','cardif','electricite','logt']},
  {cat:'Alimentation',kw:['carrefour','leclerc','lidl','aldi','intermarche','monoprix','franprix','casino ','auchan','picard ','biocoop','naturalia','supermarche','boulangerie','boucherie','primeur','superette','cora','geant','hyper u','spar','drive','fresh','marche ']},
  {cat:'Restaurants',kw:['restaurant','brasserie','bistrot','cafe ','bar ','mcdo','mcdonald','burger king','kfc','subway ','quick ','pizza','domino','uber eat','deliveroo','just eat','doordash','sushi','kebab','tacos','crepe','snack']},
  {cat:'Transport',kw:['sncf','ratp','navigo','velib','blablacar','ouigo','tgv','eurostar','taxi ','uber ','bolt ','heetch','kapten','location voiture','hertz','avis ','europcar','sixt','peage','essence','total ','shell','esso','station ','carburant','parking','vignette']},
  {cat:'Sant√©',kw:['pharmacie','medecin','docteur','hopital','clinique','dentiste','opticien','kin√©','kinesither','osteo','radiologue','labo','cpam','ameli','sante','optical center','afflelou','atol','krys']},
  {cat:'Loisirs',kw:['netflix','spotify','deezer','disney','canal+','fnac ','cultura','steam','playstation','xbox','nintendo','cinema','theatre','concert','festival','musee','airbnb','booking','hotel ','hostel','camping','amazon prime','youtube premium','apple music','spotify','apple tv','tidal','max ']},
  {cat:'V√™tements',kw:['h&m','zara','primark','uniqlo','mango ','sandro','celio','gap ','levis','nike ','adidas','decathlon','jules ','kiabi','la redoute','asos','zalando','shein','vinted','vetement','chaussure']},
  {cat:'√âpargne',kw:['livret','pel','cel','epargne','capitalisation','assurance vie','per ','pea ','scpi']},
  {cat:'Investissements',kw:['bourse','etf','obligation','crypto','bitcoin','binance','coinbase','trading','degiro','lynx','interactive broker']},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _now = new Date();
let sm = _now.getMonth(), sy = _now.getFullYear(), cv = 'dashboard';
let _importPreview = [];   // rows awaiting user confirmation
let _detectedSubs  = [];   // recurring patterns detected from CSV
let _dismissed     = JSON.parse(localStorage.getItem('_dismissed')||'[]');

function loadData(){
  try{
    const d = JSON.parse(localStorage.getItem('bpro2'));
    if(d){
      if(!d.s)     d.s=[];
      if(!d.goals) d.goals=[];
      if(!d.assets)d.assets=[];
      if(!d.debts) d.debts=[];
      return d;
    }
  }catch(e){}
  return {t:[],b:{},s:[],goals:[],assets:[],debts:[]};
}
let data = loadData();
function save(){ try{ localStorage.setItem('bpro2', JSON.stringify(data)); }catch(e){} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Currency ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CURRENCIES=[
  {code:'EUR',locale:'fr-FR',label:'Euro (‚Ç¨)'},
  {code:'USD',locale:'en-US',label:'Dollar US ($)'},
  {code:'GBP',locale:'en-GB',label:'Livre sterling (¬£)'},
  {code:'CHF',locale:'de-CH',label:'Franc suisse (CHF)'},
  {code:'CAD',locale:'fr-CA',label:'Dollar canadien (CA$)'},
  {code:'XOF',locale:'fr-FR',label:'Franc CFA BCEAO (FCFA)'},
  {code:'MAD',locale:'fr-MA',label:'Dirham marocain (MAD)'},
  {code:'DZD',locale:'fr-DZ',label:'Dinar alg√©rien (DZD)'},
  {code:'TND',locale:'fr-TN',label:'Dinar tunisien (TND)'},
  {code:'JPY',locale:'ja-JP',label:'Yen japonais (¬•)'},
  {code:'BRL',locale:'pt-BR',label:'R√©al br√©silien (R$)'},
];
function getCurrency(){
  const code=localStorage.getItem('currency')||'EUR';
  return CURRENCIES.find(c=>c.code===code)||CURRENCIES[0];
}
function fmtMoney(n){
  const cur=getCurrency();
  try{
    return new Intl.NumberFormat(cur.locale,{style:'currency',currency:cur.code,maximumFractionDigits:cur.code==='XOF'?0:2}).format(n);
  }catch(e){
    return n.toFixed(2)+' '+cur.code;
  }
}
// Keep fmtEur as alias so existing calls still work
function fmtEur(n){ return fmtMoney(n); }
// Returns a short currency symbol/code for use in labels, e.g. "‚Ç¨", "$", "FCFA"
function curSymbol(){
  const cur=getCurrency();
  try{
    const parts=new Intl.NumberFormat(cur.locale,{style:'currency',currency:cur.code}).formatToParts(0);
    const sym=parts.find(p=>p.type==='currency');
    return sym?sym.value:cur.code;
  }catch(e){ return cur.code; }
}

// ‚îÄ‚îÄ Amount input parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Accepts "50,00" or "50.00" or "1 234,56" ‚Äî always returns a JS number
function parseInput(s){
  if(s===null||s===undefined) return NaN;
  let v=String(s).trim().replace(/\s|\u00a0/g,'');
  if(!v) return NaN;
  // If both . and , present, the last one is decimal separator
  const lastDot=v.lastIndexOf('.');
  const lastComma=v.lastIndexOf(',');
  if(lastDot>-1&&lastComma>-1){
    // e.g. "1.234,56" ‚Üí European; "1,234.56" ‚Üí Anglo
    if(lastComma>lastDot){ v=v.replace(/\./g,'').replace(',','.'); }
    else                  { v=v.replace(/,/g,''); }
  } else if(lastComma>-1){
    // Only comma: treat as decimal separator (French style "50,00")
    v=v.replace(',','.');
  }
  // Remove any remaining thousands separators
  v=v.replace(/[^\d.\-]/g,'');
  return parseFloat(v);
}
function gid(){ return Math.random().toString(36).slice(2,10); }
function esc(s){
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function toast(msg, type=''){
  const e = document.getElementById('toast');
  e.textContent = msg;
  e.style.background = type==='err' ? '#C85555' : 'var(--gold)';
  e.classList.add('show');
  setTimeout(()=>e.classList.remove('show'), 2600);
}
function gc(name){ return CATS.find(c=>c.name===name)||CATS[9]; }

function daysUntil(ds){
  const t=new Date(); t.setHours(0,0,0,0);
  const g=new Date(ds); g.setHours(0,0,0,0);
  return Math.round((g-t)/86400000);
}
function freqDays(f){ return FREQS.find(x=>x.id===f)?.days||30.44; }
function freqLabel(f, short=false){ return FREQS.find(x=>x.id===f)?.[short?'s':'l']||f; }
function monthlyEquiv(a,f){ return a/(freqDays(f)/30.44); }

function advanceNext(ds,f){
  const d=new Date(ds);
  if(f==='weekly')    d.setDate(d.getDate()+7);
  else if(f==='monthly')   d.setMonth(d.getMonth()+1);
  else if(f==='quarterly') d.setMonth(d.getMonth()+3);
  else if(f==='biannual')  d.setMonth(d.getMonth()+6);
  else if(f==='yearly')    d.setFullYear(d.getFullYear()+1);
  return d.toISOString().slice(0,10);
}
function logoUrl(domain){ return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`; }
function logoHtml(s, imgCls='sub-logo', fbCls='sub-fb'){
  // FIX: also guard against empty string domain
  if(s && s.domain && s.domain.trim()!==''){
    return `<img class="${imgCls}" src="${logoUrl(s.domain)}" `+
           `onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="">`+
           `<div class="${fbCls}" style="display:none;background:${s.color||'#444'};color:#fff">${esc((s.name||'?')[0])}</div>`;
  }
  const cat=gc(s&&s.c);
  return `<div class="${fbCls}" style="background:${cat.color};color:#0A0C0F;font-size:12px">${cat.icon}</div>`;
}

function changeMonth(delta){
  // FIX: renamed param from 'd' to 'delta' to avoid shadowing date variables
  const dt=new Date(sy,sm+delta,1); sm=dt.getMonth(); sy=dt.getFullYear();
  updateHeader(); render();
}
function updateHeader(){ document.getElementById('mLabel').textContent=MSH[sm]+' '+sy; }
function nav(btn){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); cv=btn.dataset.v; render();
}
function mtx(){
  return data.t.filter(t=>{
    const d=new Date(t.d);
    return d.getMonth()===sm && d.getFullYear()===sy;
  });
}
// Returns subscriptions that fell due in the current viewed month,
// formatted as virtual transaction objects so all views stay consistent.
function mSubsTx(){
  const subs = data.s||[];
  const result = [];
  subs.filter(s=>s.active!==false).forEach(s=>{
    // Check every occurrence of this subscription inside the viewed month.
    // A sub is "due this month" if its next-date falls in sm/sy,
    // OR if a past next-date was in sm/sy (we reconstruct via advanceNext).
    // Simplest reliable check: does s.next fall in this month?
    const nd = new Date(s.next);
    if(nd.getMonth()===sm && nd.getFullYear()===sy){
      result.push({
        id:'sub_'+s.id, lb:s.name, a:s.a, c:'Loisirs',
        d:s.next, tp:'e', _isSub:true, _sub:s
      });
    }
  });
  return result;
}
// All transactions + virtual sub transactions for the viewed month
function mtxAll(){
  return [...mtx(), ...mSubsTx()];
}
function getUpcoming(days){
  return (data.s||[])
    .filter(s=>s.active!==false)
    .filter(s=>{ const d=daysUntil(s.next); return d>=0&&d<=days; })
    .sort((a,b)=>daysUntil(a.next)-daysUntil(b.next));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER DISPATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const views={dashboard:rDash,add:rAdd,import:rImport,subs:rSubs,
               goals:rGoals,patrimoine:rPatrimoine,calendar:rCalendar,
               history:rHistory,settings:rSettings};
  document.getElementById('main').innerHTML = (views[cv]||rDash)();

  // sub badge
  const nb=document.getElementById('tabSubs');
  if(nb){
    const u=getUpcoming(7);
    nb.innerHTML = u.length>0 ? `Abos<span class="dot"></span>` : 'Abos';
    nb.style.color = (u.length>0 && cv!=='subs') ? '#ffaa44' : '';
  }
  // import badge
  const ib=document.getElementById('tabImport');
  if(ib){
    const pending=_detectedSubs.filter(s=>!_dismissed.includes(s.key)).length;
    ib.innerHTML = pending>0 ? `‚á™ Import<span class="dot"></span>` : '‚á™ Import';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rDash(){
  // Use mtxAll() so subscriptions due this month are counted in every KPI
  const txs=mtxAll();
  const inc=txs.filter(t=>t.tp==='i').reduce((sum,t)=>sum+t.a,0);
  const exp=txs.filter(t=>t.tp==='e').reduce((sum,t)=>sum+t.a,0);
  const bal=inc-exp;
  const byCat=CATS.map(c=>({...c,total:txs.filter(t=>t.tp==='e'&&t.c===c.name).reduce((sum,t)=>sum+t.a,0)})).filter(c=>c.total>0);

  // 6-month chart ‚Äî include subscriptions for each past month
  let mx=1, m6=[];
  for(let i=5;i>=0;i--){
    const dt=new Date(sy,sm-i,1); const mm=dt.getMonth(),yy=dt.getFullYear();
    // Real transactions
    const ts=data.t.filter(t=>{const d=new Date(t.d);return d.getMonth()===mm&&d.getFullYear()===yy;});
    // Subscriptions due that month (virtual)
    const subsThatMonth=(data.s||[]).filter(s=>s.active!==false).filter(s=>{
      const nd=new Date(s.next); return nd.getMonth()===mm&&nd.getFullYear()===yy;
    });
    const ii=ts.filter(t=>t.tp==='i').reduce((sum,t)=>sum+t.a,0);
    const ee=ts.filter(t=>t.tp==='e').reduce((sum,t)=>sum+t.a,0)
             +subsThatMonth.reduce((sum,s)=>sum+s.a,0);
    mx=Math.max(mx,ii,ee); m6.push({l:MSH[mm],i:ii,e:ee});
  }
  const chart=m6.map(m=>`<div class="mcol"><div class="mbars">
    <div class="mbar" style="height:${Math.round(m.i/mx*52)}px;background:#7EC8A9"></div>
    <div class="mbar" style="height:${Math.round(m.e/mx*52)}px;background:#C87EA9"></div>
  </div><div class="mmth">${m.l}</div></div>`).join('');

  // 50/30/20 ‚Äî based on all transactions including subs (subs count as 'wants' via Loisirs)
  const needs =txs.filter(t=>t.tp==='e'&&gc(t.c).type==='needs').reduce((sum,t)=>sum+t.a,0);
  const wants =txs.filter(t=>t.tp==='e'&&gc(t.c).type==='wants').reduce((sum,t)=>sum+t.a,0);
  const savgs =txs.filter(t=>t.tp==='e'&&gc(t.c).type==='savings').reduce((sum,t)=>sum+t.a,0);
  const rule=inc>0?`<div class="card">
    <div class="card-t">R√®gle 50/30/20</div>
    ${ruleBar('Besoins',needs,inc*.5,inc,'#7EA9C8')}
    ${ruleBar('Envies',wants,inc*.3,inc,'#A97EC8')}
    ${ruleBar('√âpargne',savgs,inc*.2,inc,'#7EC8A9')}
    <div class="mono xxs" style="color:var(--muted);margin-top:6px;line-height:1.6">Id√©al : 50% besoins ¬∑ 30% envies ¬∑ 20% √©pargne</div>
  </div>`:'';

  // alerts
  const urgent=getUpcoming(3), soon2=getUpcoming(7).filter(s=>daysUntil(s.next)>3);
  let alerts='';
  if(urgent.length){
    const rows=urgent.map(s=>`<div class="alert-row">
      <span style="display:flex;align-items:center;gap:7px;font-size:12px;color:#D0C8BC">
        ${s.domain?`<img style="width:16px;height:16px;border-radius:3px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}
        ${esc(s.name)} <span class="mono xs" style="color:#555">‚Äî ${fmtEur(s.a)}</span>
      </span>
      <span class="badge urg">${daysUntil(s.next)===0?"Auj.":daysUntil(s.next)+"j"}</span>
    </div>`).join('');
    alerts+=`<div class="alert urg"><div class="alert-t" style="color:#ff7070">‚ö† √âch√©ances imminentes</div>${rows}</div>`;
  }
  if(soon2.length){
    const rows=soon2.map(s=>`<div class="alert-row">
      <span style="display:flex;align-items:center;gap:7px;font-size:12px;color:#D0C8BC">
        ${s.domain?`<img style="width:16px;height:16px;border-radius:3px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}
        ${esc(s.name)} <span class="mono xs" style="color:#555">‚Äî ${fmtEur(s.a)}</span>
      </span>
      <span class="badge soon">dans ${daysUntil(s.next)}j</span>
    </div>`).join('');
    alerts+=`<div class="alert soon"><div class="alert-t" style="color:#ffaa44">‚óé Dans 7 jours</div>${rows}</div>`;
  }

  // goals preview
  const ag=data.goals.filter(g=>g.saved<g.target).slice(0,2);
  const goalsP=ag.length?`<div class="card">
    <div class="card-t">Objectifs en cours</div>
    ${ag.map(g=>{const p=Math.min(g.saved/g.target*100,100);return`
      <div style="margin-bottom:10px">
        <div class="row-between" style="margin-bottom:5px">
          <span style="font-size:13px;color:#D0C8BC">${esc(g.icon)} ${esc(g.name)}</span>
          <span class="mono xs" style="color:var(--dim)">${fmtEur(g.saved)} / ${fmtEur(g.target)}</span>
        </div>
        <div class="bar-bg"><div class="bar-fill" style="width:${p}%;background:${g.color||'var(--gold)'}"></div></div>
      </div>`;}).join('')}
    <button style="background:none;border:none;color:var(--gold);font-family:monospace;font-size:10px;cursor:pointer;letter-spacing:1px;padding-top:4px" onclick="document.querySelector('[data-v=goals]').click()">Voir tous les objectifs ‚Üí</button>
  </div>`:'' ;

  // net worth KPI
  const totalA=data.assets.reduce((s,a)=>s+a.val,0);
  const totalD=data.debts.reduce((s,d)=>s+d.val,0);
  const nw=totalA-totalD;
  const nwKpi=totalA>0?`<div class="kpi w3">
    <div class="kpi-l">Patrimoine net</div>
    <div class="kpi-v" style="color:${nw>=0?'var(--gold)':'var(--red)'}">${fmtEur(nw)}</div>
  </div>`:'';

  // cat bars
  const catBars=byCat.length?byCat.map(c=>{
    const b=data.b[c.name]; const p=b?Math.min(c.total/b*100,100):null;
    const fc=p&&p>90?'var(--red)':c.color;
    return `<div style="margin-bottom:9px">
      <div class="row-between" style="margin-bottom:3px">
        <span class="mono xs" style="color:${c.color}">${c.icon} ${c.name}</span>
        <span class="mono xs" style="color:#555">${fmtEur(c.total)}${b?' / '+fmtEur(b):''}</span>
      </div>
      ${p!==null?`<div class="bar-bg thin"><div class="bar-fill thin" style="width:${p}%;background:${fc}"></div></div>`:''}
    </div>`;
  }).join(''):'<div class="empty">Aucune d√©pense ce mois</div>';

  // forecast
  const fcItems=(data.s||[]).filter(s=>s.active!==false).filter(s=>{const d=daysUntil(s.next);return d>=0&&d<=30;}).sort((a,b)=>a.next.localeCompare(b.next));
  const forecast=fcItems.length?`<div class="card">
    <div class="card-t">Pr√©visionnel 30 jours</div>
    ${fcItems.slice(0,6).map(s=>`<div class="fc-row">
      <span class="fc-date">${s.next.slice(5)}</span>
      <span class="fc-label">${s.domain?`<img style="width:13px;height:13px;border-radius:3px;vertical-align:middle;margin-right:4px" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:''}${esc(s.name)}</span>
      <span class="mono xs p">‚àí${fmtEur(s.a)}</span>
    </div>`).join('')}
    <div style="display:flex;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border);margin-top:4px">
      <span class="mono xs" style="color:var(--pink)">Total : ‚àí${fmtEur(fcItems.reduce((s,i)=>s+i.a,0))}</span>
    </div>
  </div>`:'';

  // Sort all (txs + virtual subs) by date desc, show last 4
  const sortedAll=[...txs].sort((a,b)=>b.d.localeCompare(a.d));
  const recent=sortedAll.slice(0,4).map(txRow).join('');
  const more=txs.length>4?`<button style="background:none;border:none;color:var(--gold);font-family:monospace;font-size:10px;cursor:pointer;letter-spacing:1px;padding-top:6px" onclick="document.querySelector('[data-v=history]').click()">Voir les ${txs.length} transactions ‚Üí</button>`:'';

  return `${alerts}
<div class="kpis">
  <div class="kpi"><div class="kpi-l">Revenus</div><div class="kpi-v"><span class="kpi-s g">+</span>${fmtEur(inc)}</div></div>
  <div class="kpi"><div class="kpi-l">D√©penses</div><div class="kpi-v"><span class="kpi-s p">‚àí</span>${fmtEur(exp)}</div></div>
  <div class="kpi w3"><div class="kpi-l">Solde</div><div class="kpi-v" style="color:${bal>=0?'var(--gold)':'var(--red)'}">${fmtEur(bal)}</div></div>
  ${nwKpi}
</div>
${rule}${goalsP}
<div class="card"><div class="card-t">D√©penses par cat√©gorie</div>${catBars}</div>
<div class="card">
  <div class="card-t">6 mois <span style="color:var(--green);font-size:8px">‚ñ†</span> revenus <span style="color:var(--pink);font-size:8px">‚ñ†</span> d√©penses</div>
  <div class="mchart">${chart}</div>
</div>
${forecast}
<div class="card">
  <div class="card-t">R√©centes</div>
  ${txs.length===0?'<div class="empty">Aucune transaction ce mois</div>':recent}${more}
</div>`;
}

function ruleBar(label,actual,target,inc,color){
  const pct=inc>0?Math.round(actual/inc*100):0;
  const tpct=inc>0?Math.round(target/inc*100):0;
  const over=actual>target;
  return `<div class="rule-row">
    <div class="rule-top">
      <span style="color:${over?'var(--red)':color}">${label}</span>
      <span style="color:${over?'var(--red)':'var(--dim)'}"><b>${pct}%</b> / cible ${tpct}%</span>
    </div>
    <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(pct,100)}%;background:${over?'var(--red)':color}"></div></div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD TRANSACTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rAdd(){
  const opts=CATS.map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join('');
  return `<div class="card">
    <div class="card-t">Nouvelle transaction</div>
    <div class="fg">
      <div>
        <div class="fl" style="margin-bottom:6px">Type</div>
        <div class="pill-row">
          <button class="pill on-p" id="bE" onclick="selType('e')">‚àí D√©pense</button>
          <button class="pill"      id="bI" onclick="selType('i')">+ Revenu</button>
        </div>
        <input id="fT" type="hidden" value="e">
      </div>
      <label class="fl">Libell√©<input id="fL" class="fi" type="text" placeholder="Ex : Loyer, Salaire‚Ä¶"></label>
      <div class="fr2">
        <label class="fl">Montant (${curSymbol()})<input id="fA" class="fi" type="text" inputmode="decimal" placeholder="0,00"></label>
        <label class="fl">Date<input id="fD" class="fi" type="date" value="${_now.toISOString().slice(0,10)}"></label>
      </div>
      <label class="fl">Cat√©gorie<select id="fC" class="fs">${opts}</select></label>
      <button class="submit" onclick="submitTx()">Ajouter ‚Üí</button>
    </div>
  </div>`;
}
function selType(tp){
  document.getElementById('fT').value=tp;
  document.getElementById('bE').className='pill'+(tp==='e'?' on-p':'');
  document.getElementById('bI').className='pill'+(tp==='i'?' on-g':'');
}
function submitTx(){
  const lb=document.getElementById('fL')?.value?.trim();
  const a=parseInput(document.getElementById('fA')?.value);
  const c=document.getElementById('fC')?.value;
  const d=document.getElementById('fD')?.value;
  const tp=document.getElementById('fT')?.value;
  if(!lb||!a||isNaN(a)){toast('Champs manquants !','err');return;}
  data.t.unshift({id:gid(),lb,a:Math.abs(a),c,d,tp});
  save(); toast('Transaction ajout√©e ‚úì');
  document.querySelector('[data-v=dashboard]').click();
}
function txRow(t){
  const cat=gc(t.c); const isInc=t.tp==='i';
  // Virtual sub rows: show a "üîÅ Abo" badge and link to the Abos tab instead of delete
  const isSub=!!t._isSub;
  const subDomain=isSub&&t._sub&&t._sub.domain?t._sub.domain:'';
  const logoObj=isSub&&subDomain?{...t,domain:subDomain,color:t._sub.color||cat.color}:{...t,color:cat.color};
  const action=isSub
    ?`<span style="font-family:monospace;font-size:9px;color:var(--blue);padding:2px 0 2px 8px;white-space:nowrap;cursor:pointer" onclick="document.querySelector('[data-v=subs]').click()">‚Ü∫ Abo</span>`
    :`<button class="tx-del" onclick="delTx('${t.id}')">√ó</button>`;
  return `<div class="tx">
    ${logoHtml(logoObj,'tx-logo','tx-fb')}
    <div class="tx-inf">
      <div class="tx-lb">${esc(t.lb)}</div>
      <div class="tx-mt">${t.d} ¬∑ ${t.c}${isSub?' ¬∑ <span style="color:var(--blue)">abonnement</span>':''}</div>
    </div>
    <div class="tx-am ${isInc?'g':'p'}">${isInc?'+':'‚àí'}${fmtEur(t.a)}</div>
    ${action}
  </div>`;
}
function delTx(id){
  if(!confirm('Supprimer cette transaction ?'))return;
  data.t=data.t.filter(t=>t.id!==id); save(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBSCRIPTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSubs(){
  const subs=data.s||[];
  const active=subs.filter(s=>s.active!==false);
  const totalMo=active.reduce((sum,s)=>sum+monthlyEquiv(s.a,s.freq),0);

  // Pending detected subs from CSV analysis
  const pending=_detectedSubs.filter(s=>!_dismissed.includes(s.key));
  const detectedHtml=pending.length?`<div class="card" style="border-color:#1E3020;background:#080f08">
    <div class="card-t" style="color:var(--green)">‚ú¶ Abonnements d√©tect√©s dans votre CSV</div>
    <p class="mono xxs" style="color:var(--muted);margin-bottom:10px;line-height:1.6">Ces paiements r√©currents ont √©t√© identifi√©s. Voulez-vous les ajouter √† vos abonnements&nbsp;?</p>
    ${pending.map(s=>`<div class="det-sub-card" id="det_${s.key}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        ${s.domain?`<img style="width:32px;height:32px;border-radius:8px;background:#111" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`:'<div style="width:32px;height:32px;border-radius:8px;background:#1E3020;display:flex;align-items:center;justify-content:center;font-size:14px">‚óé</div>'}
        <div style="flex:1">
          <div style="font-size:13px;color:#D0C8BC">${esc(s.name)}</div>
          <div class="mono xs" style="color:var(--muted)">${fmtEur(s.amount)} ¬∑ ${freqLabel(s.freq)} ¬∑ vu ${s.count}√ó dans l'historique</div>
        </div>
      </div>
      <div class="fr2" style="gap:6px">
        <button onclick="acceptDetectedSub('${s.key}')" style="background:var(--green);border:none;color:var(--bg);font-family:monospace;font-size:10px;font-weight:700;padding:9px;cursor:pointer;border-radius:4px;letter-spacing:1px">+ Ajouter</button>
        <button onclick="dismissDetectedSub('${s.key}')" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:monospace;font-size:10px;padding:9px;cursor:pointer;border-radius:4px">Ignorer</button>
      </div>
    </div>`).join('')}
  </div>`:'' ;

  const cards=subs.length===0?'<div class="empty">Aucun abonnement enregistr√©</div>':
    [...subs].sort((a,b)=>daysUntil(a.next)-daysUntil(b.next)).map(s=>{
      const d=daysUntil(s.next); const inact=s.active===false;
      let dc='#555',dt='';
      if(!inact){
        if(d<0)       {dc='#444';      dt='pass√©';}
        else if(d===0){dc='#ff7070';   dt="Aujourd'hui";}
        else if(d<=3) {dc='#ff7070';   dt=`dans ${d}j`;}
        else if(d<=7) {dc='#ffaa44';   dt=`dans ${d}j`;}
        else          {dc='var(--green)';dt=`dans ${d}j`;}
      } else dt='inactif';
      return `<div class="sub-card" style="${inact?'opacity:.4':''}">
        <div style="display:flex;flex-shrink:0">${logoHtml(s)}</div>
        <div class="sub-inf">
          <div class="sub-nm">${esc(s.name)}</div>
          <div class="sub-mt">${freqLabel(s.freq,true)} ¬∑ ${s.next}</div>
        </div>
        <div class="sub-rt">
          <div class="sub-pr">${fmtEur(s.a)}</div>
          <div class="sub-due" style="color:${dc}">${dt}</div>
        </div>
        <div class="sub-acts">
          <button class="sab rn" onclick="renewSub('${s.id}')">‚Ü∫</button>
          <button class="sab"    onclick="toggleSub('${s.id}')">${inact?'‚ñ∂':'‚è∏'}</button>
          <button class="sab dl" onclick="delSub('${s.id}')">√ó</button>
        </div>
      </div>`;
    }).join('');

  const bankGrid=SERVICE_BANK.map((svc,i)=>`
    <div class="litem" data-name="${esc(svc.name)}" data-idx="${i}" onclick="pickSvc(${i})">
      <img class="limg" src="${logoUrl(svc.domain)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="">
      <div class="lfb" style="display:none;background:${svc.color};color:#fff">${svc.name[0]}</div>
      <span class="llbl">${esc(svc.name)}</span>
    </div>`).join('');

  return `${detectedHtml}
  <div class="card">
    <div class="card-t">Mes abonnements ¬∑ <span style="color:var(--gold)">‚âà ${fmtEur(totalMo)}/mois</span></div>
    ${cards}
    ${active.length?`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid var(--border);margin-top:4px">
      <span class="mono xs" style="color:var(--muted)">Co√ªt annuel estim√©</span>
      <span class="mono sm" style="color:var(--gold)">‚âà ${fmtEur(totalMo*12)}</span>
    </div>`:''}
  </div>
  <div class="card">
    <div class="card-t">Ajouter un abonnement</div>
    <div class="fg">
      <div>
        <input class="logo-search" id="lsearch" type="text" placeholder="Rechercher Netflix, Spotify‚Ä¶" oninput="filterSvcBank(this.value)">
        <div class="logo-grid" id="lgrid">${bankGrid}</div>
      </div>
      <div id="sprev" style="display:none;background:var(--bg3);border:1px solid var(--gold);border-radius:4px;padding:10px;align-items:center;gap:10px">
        <div id="sprevLogo"></div>
        <div>
          <div style="font-size:13px;color:#D0C8BC" id="sprevName"></div>
          <span class="mono xxs" style="color:var(--muted)">S√©lectionn√© ‚Äî modifiable ci-dessous</span>
        </div>
      </div>
      <label class="fl">Nom du service<input id="sName" class="fi" type="text" placeholder="Nom personnalis√©‚Ä¶"></label>
      <div class="fr2">
        <label class="fl">Montant (${curSymbol()})<input id="sAmt" class="fi" type="text" inputmode="decimal" placeholder="0,00"></label>
        <label class="fl">Prochaine √©ch√©ance<input id="sNext" class="fi" type="date" value="${_now.toISOString().slice(0,10)}"></label>
      </div>
      <div>
        <div class="fl" style="margin-bottom:6px">Fr√©quence</div>
        <div class="pill-row" id="freqPills">
          ${FREQS.map(f=>`<button class="pill${f.id==='monthly'?' on':''}" onclick="selFreq(this,'${f.id}')">${f.l}</button>`).join('')}
        </div>
        <input type="hidden" id="sFreq" value="monthly">
        <input type="hidden" id="sDomain" value="">
        <input type="hidden" id="sColor"  value="#888">
      </div>
      <button class="submit" onclick="addSub()">Ajouter l'abonnement ‚Üí</button>
    </div>
  </div>`;
}

// FIX: selFreq only touches pills inside #freqPills
function selFreq(btn, freqId){
  document.querySelectorAll('#freqPills .pill').forEach(b=>b.className='pill');
  btn.className='pill on';
  document.getElementById('sFreq').value=freqId;
}
function pickSvc(i){
  const s=SERVICE_BANK[i];
  document.querySelectorAll('.litem').forEach(el=>el.classList.remove('sel'));
  document.querySelector(`.litem[data-idx="${i}"]`)?.classList.add('sel');
  document.getElementById('sName').value=s.name;
  document.getElementById('sDomain').value=s.domain;
  document.getElementById('sColor').value=s.color;
  // FIX: use style.display flex (not double display:none issue)
  const p=document.getElementById('sprev');
  if(p){ p.style.display='flex'; }
  const pn=document.getElementById('sprevName');
  const pl=document.getElementById('sprevLogo');
  if(pn) pn.textContent=s.name;
  if(pl) pl.innerHTML=`<img style="width:32px;height:32px;border-radius:8px;background:#111" src="${logoUrl(s.domain)}" onerror="this.style.display='none'">`;
}
function filterSvcBank(q){
  const lq=q.toLowerCase();
  document.querySelectorAll('.litem').forEach(el=>{
    // FIX: decode HTML entities from data-name before comparing (e.g. H&amp;M ‚Üí H&M)
    const raw=el.dataset.name||'';
    const decoded=raw.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"');
    el.style.display=(!q||decoded.toLowerCase().includes(lq))?'':'none';
  });
}
function addSub(){
  const name=document.getElementById('sName')?.value?.trim();
  const a=parseInput(document.getElementById('sAmt')?.value);
  const next=document.getElementById('sNext')?.value;
  const freq=document.getElementById('sFreq')?.value||'monthly';
  const domain=document.getElementById('sDomain')?.value||'';
  const color=document.getElementById('sColor')?.value||'#888';
  if(!name||!a||isNaN(a)||!next){toast('Champs manquants !','err');return;}
  data.s.push({id:gid(),name,a:Math.abs(a),next,freq,domain,color,active:true});
  save(); toast('Abonnement ajout√© ‚úì'); render();
}
function renewSub(id){
  const s=data.s.find(x=>x.id===id); if(!s)return;
  // Record the payment as a real transaction so history/KPIs stay consistent
  const paidDate = s.next; // the date that was due
  data.t.unshift({id:gid(), lb:s.name, a:s.a, c:'Loisirs', d:paidDate, tp:'e', _subId:s.id});
  s.next=advanceNext(s.next,s.freq);
  save(); toast('Renouvel√© & transaction enregistr√©e ‚úì'); render();
}
// FIX: toggle was broken ‚Äî now correctly flips boolean
function toggleSub(id){
  const s=data.s.find(x=>x.id===id); if(!s)return;
  s.active = (s.active===false) ? true : false;
  save(); render();
}
function delSub(id){
  if(!confirm('Supprimer cet abonnement ?'))return;
  data.s=data.s.filter(x=>x.id!==id); save(); render();
}
function acceptDetectedSub(key){
  const s=_detectedSubs.find(x=>x.key===key); if(!s)return;
  data.s.push({id:gid(),name:s.name,a:s.amount,next:s.nextDate,freq:s.freq,domain:s.domain||'',color:s.color||'#888',active:true});
  save(); dismissDetectedSub(key); toast(`${s.name} ajout√© aux abonnements ‚úì`); render();
}
function dismissDetectedSub(key){
  _dismissed.push(key);
  localStorage.setItem('_dismissed',JSON.stringify(_dismissed));
  const el=document.getElementById('det_'+key);
  if(el) el.style.display='none';
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rGoals(){
  const goals=data.goals||[];
  const goalColors=['#C8A97E','#7EC8A9','#7EA9C8','#C87EA9','#A97EC8','#C8C87E'];

  const goalCards=goals.length===0?'<div class="empty">Aucun objectif d√©fini</div>':
    goals.map(g=>{
      const pct=Math.min(g.saved/g.target*100,100);
      const rem=Math.max(g.target-g.saved,0);
      const daysLeft=g.deadline?daysUntil(g.deadline):null;
      const moNeeded=daysLeft&&daysLeft>0?rem/(daysLeft/30.44):null;
      return `<div class="goal-card">
        <div class="row-between" style="margin-bottom:6px;align-items:flex-start">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:18px">${g.icon||'üí∞'}</span>
            <div>
              <div style="font-size:13px;color:#D0C8BC">${esc(g.name)}</div>
              <div class="mono xxs" style="color:var(--muted)">${g.deadline?'√âch√©ance : '+g.deadline:'Sans date limite'}</div>
            </div>
          </div>
          <span class="mono xs" style="color:var(--dim)">${Math.round(pct)}%</span>
        </div>
        <div class="bar-bg" style="margin-bottom:6px"><div class="bar-fill" style="width:${pct}%;background:${g.color||'var(--gold)'}"></div></div>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span class="mono xs" style="color:var(--dim)">${fmtEur(g.saved)} √©pargn√©</span>
          <span class="mono xs" style="color:var(--muted)">${fmtEur(rem)} restant</span>
        </div>
        ${moNeeded?`<div class="mono xxs" style="color:${moNeeded>500?'var(--pink)':'var(--green)'};margin-bottom:8px">‚Üí ~${fmtEur(moNeeded)}/mois pour tenir l'√©ch√©ance</div>`:''}
        <div style="display:flex;gap:6px">
          <input type="text" inputmode="decimal" id="dep_${g.id}" class="fi" style="flex:1;padding:8px" placeholder="Ex: 200,00">
          <button onclick="addToGoal('${g.id}')" style="background:var(--green);border:none;color:var(--bg);font-family:monospace;font-size:10px;font-weight:700;padding:8px 10px;cursor:pointer;border-radius:4px">+ D√©poser</button>
          <button onclick="delGoal('${g.id}')" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:monospace;font-size:10px;padding:8px;cursor:pointer;border-radius:4px">√ó</button>
        </div>
      </div>`;
    }).join('');

  // FIX: use numeric index as id instead of emoji (Unicode normalisation issues)
  const iconPicker=GOAL_ICONS.map((ic,idx)=>`<button onclick="selGoalIcon(${idx})" class="pill" id="gi_${idx}" style="font-size:16px;padding:6px 8px">${ic}</button>`).join('');
  const colorPicker=goalColors.map(c=>`<button onclick="selGoalColor('${c}')" class="gcp" data-c="${c}" style="width:22px;height:22px;border-radius:50%;background:${c};border:2px solid transparent;cursor:pointer;flex-shrink:0"></button>`).join('');

  return `<div class="card"><div class="card-t">Mes objectifs</div>${goalCards}</div>
  <div class="card">
    <div class="card-t">Cr√©er un objectif</div>
    <div class="fg">
      <label class="fl">Nom de l'objectif<input id="gName" class="fi" type="text" placeholder="Vacances, Voiture, Urgence‚Ä¶"></label>
      <div class="fr2">
        <label class="fl">Montant cible (${curSymbol()})<input id="gTarget" class="fi" type="text" inputmode="decimal" placeholder="Ex: 5 000,00"></label>
        <label class="fl">D√©j√† √©pargn√© (${curSymbol()})<input id="gSaved" class="fi" type="text" inputmode="decimal" placeholder="0"></label>
      </div>
      <label class="fl">√âch√©ance (optionnel)<input id="gDL" class="fi" type="date"></label>
      <div><div class="fl" style="margin-bottom:7px">Ic√¥ne</div><div class="pill-row">${iconPicker}</div><input type="hidden" id="gIcon" value="${GOAL_ICONS[0]}"></div>
      <div><div class="fl" style="margin-bottom:7px">Couleur</div><div style="display:flex;gap:8px;flex-wrap:wrap">${colorPicker}</div><input type="hidden" id="gColor" value="${goalColors[0]}"></div>
      <button class="submit" onclick="addGoal()">Cr√©er l'objectif ‚Üí</button>
    </div>
  </div>
  <div class="card">
    <div class="card-t">Simulateur d'√©pargne</div>
    <div class="fg">
      <div class="fr2">
        <label class="fl">√âpargne/mois (${curSymbol()})<input id="simAmt" class="fi" type="text" inputmode="decimal" placeholder="200" oninput="runSim()"></label>
        <label class="fl">Dur√©e (ann√©es)<input id="simYrs" class="fi" type="number" inputmode="decimal" placeholder="5" oninput="runSim()"></label>
      </div>
      <label class="fl">Taux annuel (%)<input id="simRate" class="fi" type="number" inputmode="decimal" placeholder="3" step="0.1" oninput="runSim()"></label>
    </div>
    <div id="simResult"></div>
  </div>`;
}
function selGoalIcon(idx){
  // FIX: use numeric index to find button, store emoji value separately
  const ic=GOAL_ICONS[idx];
  document.getElementById('gIcon').value=ic;
  document.querySelectorAll('[id^="gi_"]').forEach(b=>b.className='pill');
  document.getElementById('gi_'+idx)?.classList.add('on');
}
function selGoalColor(c){
  document.getElementById('gColor').value=c;
  document.querySelectorAll('.gcp').forEach(b=>b.style.border=b.dataset.c===c?'2px solid #fff':'2px solid transparent');
}
function addGoal(){
  const name=document.getElementById('gName')?.value?.trim();
  const target=parseInput(document.getElementById('gTarget')?.value);
  const saved=parseInput(document.getElementById('gSaved')?.value)||0;
  const deadline=document.getElementById('gDL')?.value||null;
  const icon=document.getElementById('gIcon')?.value||'üí∞';
  const color=document.getElementById('gColor')?.value||'var(--gold)';
  if(!name||!target||isNaN(target)){toast('Nom et montant requis','err');return;}
  data.goals.push({id:gid(),name,target,saved,deadline,icon,color});
  save(); toast('Objectif cr√©√© ‚úì'); render();
}
function addToGoal(id){
  const inp=document.getElementById('dep_'+id);
  const amt=parseInput(inp?.value);
  if(!amt||isNaN(amt)||amt<=0){toast('Montant invalide','err');return;}
  const g=data.goals.find(x=>x.id===id); if(!g)return;
  g.saved=Math.min(g.saved+amt,g.target); inp.value='';
  save();
  g.saved>=g.target ? toast('üéâ Objectif atteint !') : toast(`+${fmtEur(amt)} ajout√© ‚úì`);
  render();
}
function delGoal(id){
  if(!confirm('Supprimer cet objectif ?'))return;
  data.goals=data.goals.filter(x=>x.id!==id); save(); render();
}
function runSim(){
  const amt=parseInput(document.getElementById('simAmt')?.value);
  const yrs=parseInput(document.getElementById('simYrs')?.value);
  const rate=(parseInput(document.getElementById('simRate')?.value)||0)/100/12;
  const el=document.getElementById('simResult');
  if(!el||!amt||!yrs||isNaN(amt)||isNaN(yrs))return;
  const n=Math.round(yrs*12);
  const fv=rate>0 ? amt*((Math.pow(1+rate,n)-1)/rate) : amt*n;
  const invested=amt*n;
  el.innerHTML=`<div class="sim-result">
    <div class="mono xxs" style="color:var(--muted);margin-bottom:4px">Capital dans ${yrs} an${yrs>1?'s':''}</div>
    <div class="sim-big">${fmtEur(fv)}</div>
    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <span class="mono xs" style="color:var(--dim)">Vers√© : ${fmtEur(invested)}</span>
      <span class="mono xs" style="color:var(--green)">Int√©r√™ts : +${fmtEur(fv-invested)}</span>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATRIMOINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rPatrimoine(){
  const assets=data.assets||[], debts=data.debts||[];
  const totalA=assets.reduce((s,a)=>s+a.val,0);
  const totalD=debts.reduce((s,d)=>s+d.val,0);
  const nw=totalA-totalD;
  const assetOpts=ASSET_CATS.map(c=>`<option>${c}</option>`).join('');
  const debtOpts=DEBT_CATS.map(c=>`<option>${c}</option>`).join('');

  const assetRows=assets.length===0?'<div class="empty">Aucun actif</div>':
    assets.map(a=>`<div class="asset-row">
      <div><div class="asset-nm">${esc(a.name)}</div><div class="asset-cat">${a.cat}</div></div>
      <div style="display:flex;align-items:center;gap:8px"><span class="mono sm g">${fmtEur(a.val)}</span><button class="tx-del" onclick="delAsset('${a.id}')">√ó</button></div>
    </div>`).join('');

  const debtRows=debts.length===0?'<div class="empty">Aucune dette</div>':
    debts.map(d=>`<div class="asset-row">
      <div><div class="asset-nm">${esc(d.name)}</div><div class="asset-cat">${d.cat}${d.rate?` ¬∑ ${d.rate}% /an`:''}</div></div>
      <div style="display:flex;align-items:center;gap:8px"><span class="mono sm r">‚àí${fmtEur(d.val)}</span><button class="tx-del" onclick="delDebt('${d.id}')">√ó</button></div>
    </div>`).join('');

  const pieHtml=totalA>0?assets.map(a=>{const p=Math.round(a.val/totalA*100);return`
    <div style="margin-bottom:7px">
      <div class="row-between" style="margin-bottom:3px"><span class="mono xs" style="color:var(--dim)">${esc(a.name)}</span><span class="mono xs" style="color:#555">${p}%</span></div>
      <div class="bar-bg thin"><div class="bar-fill thin" style="width:${p}%;background:var(--green)"></div></div>
    </div>`}).join(''):'';

  return `<div class="kpis">
    <div class="kpi"><div class="kpi-l">Total actifs</div><div class="kpi-v g">${fmtEur(totalA)}</div></div>
    <div class="kpi"><div class="kpi-l">Total dettes</div><div class="kpi-v r">‚àí${fmtEur(totalD)}</div></div>
    <div class="kpi w3"><div class="kpi-l">Patrimoine net</div><div class="kpi-v" style="color:${nw>=0?'var(--gold)':'var(--red)'}">${fmtEur(nw)}</div></div>
  </div>
  <div class="card"><div class="card-t">Actifs</div>${assetRows}${pieHtml}</div>
  <div class="card"><div class="card-t">Dettes & cr√©dits</div>${debtRows}</div>
  <div class="card">
    <div class="card-t">Ajouter un actif</div>
    <div class="fg">
      <label class="fl">Nom<input id="aName" class="fi" type="text" placeholder="Livret A, Actions, Appartement‚Ä¶"></label>
      <div class="fr2">
        <label class="fl">Valeur (${curSymbol()})<input id="aVal" class="fi" type="text" inputmode="decimal" placeholder="0"></label>
        <label class="fl">Cat√©gorie<select id="aCat" class="fs">${assetOpts}</select></label>
      </div>
      <button class="submit" style="background:var(--green)" onclick="addAsset()">Ajouter actif ‚Üí</button>
    </div>
  </div>
  <div class="card">
    <div class="card-t">Ajouter une dette</div>
    <div class="fg">
      <label class="fl">Nom<input id="dName" class="fi" type="text" placeholder="Pr√™t immobilier, Cr√©dit auto‚Ä¶"></label>
      <div class="fr3">
        <label class="fl">Solde (${curSymbol()})<input id="dVal" class="fi" type="text" inputmode="decimal" placeholder="0"></label>
        <label class="fl">Taux (%/an)<input id="dRate" class="fi" type="number" inputmode="decimal" placeholder="3.5" step="0.1"></label>
        <label class="fl">Cat√©gorie<select id="dCat" class="fs">${debtOpts}</select></label>
      </div>
      <button class="submit" style="background:var(--pink)" onclick="addDebt()">Ajouter dette ‚Üí</button>
    </div>
  </div>`;
}
function addAsset(){
  const name=document.getElementById('aName')?.value?.trim();
  const val=parseInput(document.getElementById('aVal')?.value);
  const cat=document.getElementById('aCat')?.value;
  if(!name||!val||isNaN(val)){toast('Champs manquants !','err');return;}
  data.assets.push({id:gid(),name,val,cat}); save(); toast('Actif ajout√© ‚úì'); render();
}
function addDebt(){
  const name=document.getElementById('dName')?.value?.trim();
  const val=parseInput(document.getElementById('dVal')?.value);
  const rate=parseInput(document.getElementById('dRate')?.value)||0;
  const cat=document.getElementById('dCat')?.value;
  if(!name||!val||isNaN(val)){toast('Champs manquants !','err');return;}
  data.debts.push({id:gid(),name,val,rate,cat}); save(); toast('Dette ajout√©e ‚úì'); render();
}
function delAsset(id){ if(!confirm('Supprimer ?'))return; data.assets=data.assets.filter(x=>x.id!==id); save(); render(); }
function delDebt(id){  if(!confirm('Supprimer ?'))return; data.debts=data.debts.filter(x=>x.id!==id);  save(); render(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rCalendar(){
  const firstDay=new Date(sy,sm,1).getDay();
  const daysInMonth=new Date(sy,sm+1,0).getDate();
  const isCurrentMonth=sm===_now.getMonth()&&sy===_now.getFullYear();
  const todayDate=_now.getDate();

  const evMap={};
  mtx().forEach(t=>{
    const d=parseInt(t.d.split('-')[2]);
    if(!evMap[d])evMap[d]=[];
    evMap[d].push({color:t.tp==='i'?'var(--green)':'var(--pink)',amount:t.a,tp:t.tp,label:t.lb});
  });
  (data.s||[]).filter(s=>s.active!==false).forEach(s=>{
    const nd=new Date(s.next);
    if(nd.getMonth()===sm&&nd.getFullYear()===sy){
      const d=nd.getDate();
      if(!evMap[d])evMap[d]=[];
      evMap[d].push({color:'var(--blue)',amount:s.a,tp:'e',label:s.name,domain:s.domain,type:'sub'});
    }
  });

  const startOffset=(firstDay+6)%7;
  let cells='';
  for(let i=0;i<startOffset;i++) cells+=`<div class="cal-day"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const evs=evMap[d]||[];
    const isToday=isCurrentMonth&&d===todayDate;
    const dots=evs.slice(0,4).map(e=>`<div class="cal-dot" style="background:${e.color}"></div>`).join('');
    const totalExp=evs.filter(e=>e.tp==='e').reduce((s,e)=>s+e.amount,0);
    cells+=`<div class="cal-day${evs.length?' has-event':''}${isToday?' today':''}" onclick="showDay(${d})">
      <div class="cal-day-num">${d}</div>
      <div class="cal-dot-wrap">${dots}</div>
      ${totalExp>0?`<div style="font-size:7px;color:var(--pink);margin-top:1px;font-family:monospace">‚àí${Math.round(totalExp)}${curSymbol()}</div>`:''}
    </div>`;
  }

  return `<div class="card">
    <div class="card-t">${MS[sm]} ${sy}</div>
    <div style="display:flex;gap:12px;margin-bottom:10px">
      <span class="mono xxs" style="color:var(--green)">‚ñ† Revenus</span>
      <span class="mono xxs" style="color:var(--pink)">‚ñ† D√©penses</span>
      <span class="mono xxs" style="color:var(--blue)">‚ñ† Abonnements</span>
    </div>
    <div class="cal-grid">
      ${['L','M','M','J','V','S','D'].map(d=>`<div class="cal-day-hdr">${d}</div>`).join('')}
      ${cells}
    </div>
  </div>
  <div id="dayDetail"></div>`;
}
function showDay(d){
  const evs=[];
  mtx().forEach(t=>{ if(parseInt(t.d.split('-')[2])===d) evs.push({label:t.lb,amount:t.a,color:t.tp==='i'?'var(--green)':'var(--pink)',sign:t.tp==='i'?'+':'‚àí'}); });
  (data.s||[]).filter(s=>s.active!==false).forEach(s=>{
    const nd=new Date(s.next);
    if(nd.getDate()===d&&nd.getMonth()===sm&&nd.getFullYear()===sy)
      evs.push({label:s.name,amount:s.a,color:'var(--blue)',sign:'‚àí',domain:s.domain});
  });
  const el=document.getElementById('dayDetail'); if(!el)return;
  if(!evs.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="card">
    <div class="card-t">${d} ${MS[sm]}</div>
    ${evs.map(e=>`<div class="tx">
      <div class="tx-inf">
        <div class="tx-lb">${e.domain?`<img style="width:14px;height:14px;border-radius:3px;vertical-align:middle;margin-right:4px" src="${logoUrl(e.domain)}" onerror="this.style.display='none'">`:''}${esc(e.label)}</div>
      </div>
      <span class="mono xs" style="color:${e.color}">${e.sign}${fmtEur(e.amount)}</span>
    </div>`).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rHistory(){
  const txs=mtxAll(); // includes subscriptions due this month
  const realCount=mtx().length;
  const subCount=txs.length-realCount;
  const subtitle=subCount>0?` (dont ${subCount} abo${subCount>1?'s':''})` :'';
  // Sort by date descending
  const sorted=[...txs].sort((a,b)=>b.d.localeCompare(a.d));
  return `<div class="card">
    <div class="card-t">${MS[sm]} ${sy} ‚Äî ${txs.length} transaction${txs.length!==1?'s':''}${subtitle}</div>
    ${sorted.length===0?'<div class="empty">Aucune transaction ce mois</div>':sorted.map(txRow).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSettings(){
  const curCode = localStorage.getItem('currency')||'EUR';
  const curOpts = CURRENCIES.map(c=>`<option value="${c.code}"${c.code===curCode?' selected':''}>${c.label}</option>`).join('');
  const rows=CATS.map(c=>`<label class="fl">${c.icon} ${c.name}
    <input class="fi bi" data-cat="${c.name}" type="text" inputmode="decimal" placeholder="Aucun plafond" value="${data.b[c.name]||''}">
  </label>`).join('');
  return `
  <div class="card">
    <div class="card-t">Devise</div>
    <label class="fl">Devise utilis√©e
      <select id="currencySelect" class="fs" onchange="saveCurrency(this.value)">${curOpts}</select>
    </label>
    <p class="mono xxs" style="color:var(--muted);margin-top:8px;line-height:1.6">Exemple : ${fmtMoney(1234.56)}</p>
  </div>
  <div class="card">
    <div class="card-t">Plafonds mensuels</div>
    <div class="fg">${rows}</div>
    <button class="submit" style="margin-top:16px" onclick="saveBudgets()">Sauvegarder ‚Üí</button>
  </div>
  <div class="card">
    <div class="card-t">Donn√©es</div>
    <p class="mono xs" style="color:var(--muted);margin-bottom:12px">${data.t.length} transactions ¬∑ ${data.s.length} abonnements ¬∑ ${data.goals.length} objectifs</p>
    <button onclick="exportData()" style="background:none;border:1px solid var(--border);color:var(--dim);font-family:monospace;font-size:10px;letter-spacing:2px;padding:10px;cursor:pointer;border-radius:4px;text-transform:uppercase;width:100%;margin-bottom:8px">Exporter JSON ‚Üì</button>
    <label style="background:none;border:1px solid var(--border);color:var(--dim);font-family:monospace;font-size:10px;letter-spacing:2px;padding:10px;cursor:pointer;border-radius:4px;text-transform:uppercase;width:100%;display:block;text-align:center;margin-bottom:8px">Importer JSON ‚Üë<input type="file" accept=".json" style="display:none" onchange="importJSON(this)"></label>
    <button onclick="shareApp()" style="background:none;border:1px solid var(--border2);color:var(--gold);font-family:monospace;font-size:10px;letter-spacing:2px;padding:10px;cursor:pointer;border-radius:4px;text-transform:uppercase;width:100%;margin-bottom:8px">‚¨Ü Partager l'app</button>
    <button onclick="confirmDel()" style="background:none;border:1px solid #2a1010;color:var(--red);font-family:monospace;font-size:10px;letter-spacing:2px;padding:10px;cursor:pointer;border-radius:4px;text-transform:uppercase;width:100%">Tout effacer</button>
  </div>`;
}
function saveBudgets(){
  document.querySelectorAll('.bi').forEach(inp=>{
    const cat=inp.dataset.cat; const v=parseInput(inp.value);
    if(!isNaN(v)&&v>0) data.b[cat]=v; else delete data.b[cat];
  });
  save(); toast('Budgets sauvegard√©s ‚úì');
}
function saveCurrency(code){
  localStorage.setItem('currency', code);
  toast('Devise mise √† jour ‚úì');
  render();
}
function shareApp(){
  const html = document.documentElement.outerHTML;
  if(navigator.share && navigator.canShare){
    const blob = new Blob([html],{type:'text/html'});
    const file = new File([blob],'budget-pro.html',{type:'text/html'});
    if(navigator.canShare({files:[file]})){
      navigator.share({title:'Budget Pro', files:[file]}).catch(()=>shareAppFallback(html));
      return;
    }
  }
  shareAppFallback(html);
}
function shareAppFallback(html){
  const url = URL.createObjectURL(new Blob([html],{type:'text/html'}));
  const a = document.createElement('a');
  a.href=url; a.download='budget-pro.html';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  toast('App t√©l√©charg√©e ‚Äî partagez le fichier budget-pro.html ‚úì');
}
function exportData(){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='budget_pro.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  // FIX: release object URL to prevent memory leak
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function importJSON(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(!d.t)throw new Error('Format invalide');
      data=d; save(); toast('Donn√©es import√©es ‚úì'); render();
    }catch(err){ toast('Fichier JSON invalide','err'); }
  };
  reader.readAsText(file);
}
function confirmDel(){
  if(!confirm('Effacer TOUTES les donn√©es ?'))return;
  data={t:[],b:{},s:[],goals:[],assets:[],debts:[]}; save(); toast('Effac√©'); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT MODULE ‚Äî CSV PARSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CSV helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIX: detect separator once on header row, not per-line
function detectCsvSep(headerRow){
  const counts={';':0,',':0,'\t':0};
  for(const c of headerRow){ if(counts[c]!==undefined) counts[c]++; }
  return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0]||';';
}
function csvSplit(row, sep){
  // sep passed from caller; fallback to auto-detect if omitted
  if(!sep) sep = row.includes(';')?';':',';
  const result=[]; let cur='', inQ=false;
  for(let i=0;i<row.length;i++){
    const c=row[i];
    if(c==='"'){ inQ=!inQ; }
    else if(c===sep && !inQ){ result.push(cur.trim().replace(/^"|"$/g,'')); cur=''; }
    else cur+=c;
  }
  result.push(cur.trim().replace(/^"|"$/g,''));
  return result;
}

function csvDate(s){
  if(!s)return null;
  s=s.trim().replace(/"/g,'');
  // DD/MM/YYYY  or  DD-MM-YYYY  or  DD.MM.YYYY
  let m=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if(m){ const y=m[3].length===2?'20'+m[3]:m[3]; return `${y}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`; }
  // YYYY-MM-DD
  m=s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  return null;
}

// FIX: Complete rewrite of parseAmount ‚Äî handles 1.234,56 and 1,234.56 and -12.50 and 1.234 (EU integer)
// Also handles leading + sign (e.g. Caisse d'√âpargne credit column: "+9,20")
function csvAmount(s){
  if(s===null||s===undefined)return NaN;
  let v=String(s).trim().replace(/"/g,'').replace(/\s|\u00a0/g,'');
  if(!v)return NaN;
  // Strip leading + (e.g. "+9,20" from CE credit column)
  if(v.startsWith('+')) v=v.slice(1);
  const neg=v.startsWith('-'); v=v.replace(/^-/,'');
  // European format: 1.234,56 or 1234,56 or 12345,67 ‚Üí 1234.56
  // Accepts: optional dot-grouped thousands + comma decimal
  if(/^\d{1,3}(\.\d{3})*(,\d{1,2})?$/.test(v)||/^\d{4,}(,\d{1,2})?$/.test(v)){
    v=v.replace(/\./g,'').replace(',','.');
    return (neg?-1:1)*parseFloat(v);
  }
  // Anglo format: 1,234.56 or 1234.56 or 12345.67 ‚Üí 1234.56
  // Accepts: optional comma-grouped thousands + dot decimal
  if(/^\d{1,3}(,\d{3})*(\.\d{1,2})?$/.test(v)||/^\d{4,}(\.\d{1,2})?$/.test(v)){
    v=v.replace(/,/g,'');
    return (neg?-1:1)*parseFloat(v);
  }
  // Plain integer
  if(/^\d+$/.test(v)) return (neg?-1:1)*parseInt(v,10);
  // Fallback
  return parseFloat((neg?'-':'')+v.replace(/,/g,''));
}

// ‚îÄ‚îÄ Bank format parsers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Maps Caisse d'√âpargne native categories to app categories
function ceCatMap(nativeCat){
  if(!nativeCat) return null;
  const n=nativeCat.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(n.includes('salaire')||n.includes('revenu')) return 'Autre'; // handled by tp='i'
  if(n.includes('logement')||n.includes('internet')||n.includes('telephon')||n.includes('energie')||n.includes('eau')) return 'Logement';
  if(n.includes('alimentation')||n.includes('courses')||n.includes('supermarche')||n.includes('restaurant')) return 'Alimentation';
  if(n.includes('transport')||n.includes('carburant')||n.includes('voiture')) return 'Transport';
  if(n.includes('sante')||n.includes('medical')||n.includes('pharmacie')||n.includes('remboursement')) return 'Sant√©';
  if(n.includes('loisir')||n.includes('sport')||n.includes('vacances')||n.includes('gym')) return 'Loisirs';
  if(n.includes('vetement')||n.includes('habillement')) return 'V√™tements';
  if(n.includes('epargne')||n.includes('livret')||n.includes('placement')) return '√âpargne';
  if(n.includes('banque')||n.includes('assurance')||n.includes('frais')) return 'Autre';
  if(n.includes('virement')) return 'Autre';
  return null;
}

const PARSERS=[
  {
    // ‚îÄ‚îÄ Caisse d'√âpargne ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Header: Date de comptabilisation;Libelle simplifie;Libelle operation;Reference;
    //         Informations complementaires;Type operation;Categorie;Sous categorie;
    //         Debit;Credit;Date operation;Date de valeur;Pointage operation
    // Col indices: 0=date_compta, 1=libelle_simple, 2=libelle_op, 6=categorie,
    //              8=debit, 9=credit, 10=date_op
    id:'ce', name:'Caisse d\'√âpargne',
    detect:h=>(h.includes('libelle simplifie')||h.includes('libelle operation'))
             &&(h.includes('debit')&&h.includes('credit'))
             &&(h.includes('date de comptabilisation')||h.includes('informations complementaires')||h.includes('sous categorie')),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep);
      if(c.length<10) return null;
      // Prefer date_op (col 10) over date_compta (col 0)
      const date=csvDate(c[10])||csvDate(c[0]);
      // Prefer libelle_simple (col 1), fallback to libelle_op (col 2)
      const label=(c[1]||c[2]||'').trim();
      // Debit col 8 already negative (e.g. "-50,00"), credit col 9 positive (e.g. "+9,20")
      const deb=c[8]?csvAmount(c[8]):0;
      const cred=c[9]?csvAmount(c[9]):0;
      // Use the non-zero value; if both 0 skip row
      let amount=0;
      if(!isNaN(deb)&&deb!==0)       amount=deb;   // already negative
      else if(!isNaN(cred)&&cred!==0) amount=cred;  // positive
      else return null;
      if(!date||!label||isNaN(amount)) return null;
      // Carry native category hint for ruleCat enrichment
      const nativeCat=c[6]||'';
      return {date, label, amount, _nativeCat:nativeCat};
    }).filter(Boolean);}
  },
  {
    id:'boursobank', name:'Boursobank',
    // FIX: header is already normalized (no accents), compare without accents
    detect:h=>h.includes('dateop')||(h.includes('libelle')&&h.includes('montant')&&h.includes('devise')),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<3)return null;
      let date,label,amount;
      if(c.length>=6&&c[0].match(/\d{2}\/\d{2}\/\d{4}/)){
        date=csvDate(c[0]); label=c[2]||c[1];
        amount=c[4]?-csvAmount(c[4]):csvAmount(c[5]);
      } else { date=csvDate(c[0]); label=c[1]; amount=csvAmount(c[2]); }
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'bnp', name:'BNP Paribas',
    // FIX: header normalized ‚Üí no accents
    detect:h=>h.includes('libelle simplifie')||h.includes('numero de reference'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<4)return null;
      const date=csvDate(c[0]); const label=c[1]||c[2];
      const amount=csvAmount(c[4]||c[3]);
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'sg', name:'Soci√©t√© G√©n√©rale',
    // FIX: header normalized ‚Üí no accents
    detect:h=>h.includes('debit')&&h.includes('credit')&&!h.includes('dateop'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<3)return null;
      const date=csvDate(c[0]); const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0; const cred=c[3]?csvAmount(c[3]):0;
      const amount=cred-deb;
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'ca', name:'Cr√©dit Agricole',
    detect:h=>h.includes('dateop')&&h.includes('dateval'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<5)return null;
      const date=csvDate(c[0]); const label=c[2]||c[1];
      const deb=c[4]?csvAmount(c[4]):0; const cred=c[5]?csvAmount(c[5]):0;
      const amount=cred-deb;
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'lcl', name:'LCL',
    // FIX: header normalized ‚Üí no accents
    detect:h=>h.includes('operation')&&h.includes('valeur'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<3)return null;
      const date=csvDate(c[0]); const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0; const cred=c[3]?csvAmount(c[3]):0;
      return (date&&label)?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'cic', name:'CIC / Cr√©dit Mutuel',
    // FIX: header normalized ‚Üí no accents
    detect:h=>h.includes('libelle')&&h.includes('solde'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<3)return null;
      const date=csvDate(c[0]); const label=c[1];
      const deb=c[2]?csvAmount(c[2]):0; const cred=c[3]?csvAmount(c[3]):0;
      return (date&&label)?{date,label,amount:cred-deb}:null;
    }).filter(Boolean);}
  },
  {
    id:'revolut', name:'Revolut',
    detect:h=>h.includes('completed')&&h.includes('description'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<5)return null;
      const date=csvDate(c[2]||c[0]); const label=c[4]||c[1];
      const amount=csvAmount(c[5]||c[3]);
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'n26', name:'N26',
    detect:h=>h.includes('account number')||h.includes('payee name'),
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<3)return null;
      const date=csvDate(c[0]); const label=c[1];
      const amount=csvAmount(c[4]||c[2]);
      return (date&&label&&!isNaN(amount))?{date,label,amount}:null;
    }).filter(Boolean);}
  },
  {
    id:'generic', name:'Format g√©n√©rique',
    detect:()=>true,
    parse(lines){return lines.map(r=>{
      const c=csvSplit(r,window._csvSep); if(c.length<2)return null;
      const date=c.map(csvDate).find(Boolean);
      const amounts=c.map(csvAmount).filter(v=>!isNaN(v)&&v!==0);
      const label=c.find(x=>x.length>3&&!csvDate(x)&&isNaN(csvAmount(x)));
      if(!date||!label||!amounts.length)return null;
      return {date,label,amount:amounts[0]};
    }).filter(r=>r&&r.date&&r.label);}
  }
];

// ‚îÄ‚îÄ Rule-based categoriser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Accepts optional row object to use bank's native category as a hint
function ruleCat(label, row){
  // 1. Try native category from bank CSV (Caisse d'√âpargne etc.)
  if(row&&row._nativeCat){
    const mapped=ceCatMap(row._nativeCat);
    if(mapped&&mapped!=='Autre') return mapped;
  }
  // 2. Keyword matching on label
  const l=label.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  for(const rule of CATEGORY_RULES){
    if(rule.kw.some(kw=>l.includes(kw))) return rule.cat;
  }
  return 'Autre';
}

// ‚îÄ‚îÄ AI categoriser (Claude API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function aiCategorize(rows){
  const apiKey=localStorage.getItem('claudeKey')||'';
  if(!apiKey) return rows.map(r=>({...r,cat:ruleCat(r.label,r),aiCat:false}));

  const BATCH=40;
  const results=[];
  for(let b=0;b<rows.length;b+=BATCH){
    const batch=rows.slice(b,b+BATCH);
    updateProgress(b,rows.length,batch[0].label);
    const prompt=`Tu es un assistant de cat√©gorisation bancaire fran√ßaise. Cat√©gorise chaque transaction.
Cat√©gories valides UNIQUEMENT: ${CATS.map(c=>c.name).join(', ')}.
R√©ponds UNIQUEMENT avec un tableau JSON, sans texte autour.

Transactions:
${batch.map((r,i)=>`${i}: "${r.label}" ${r.amount>0?'+':''}${r.amount}‚Ç¨`).join('\n')}

Format attendu: [{"i":0,"cat":"Logement"},{"i":1,"cat":"Alimentation"}]`;

    try{
      const resp=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:600,messages:[{role:'user',content:prompt}]})
      });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const dat=await resp.json();
      const txt=dat.content[0].text.trim().replace(/```json?|```/g,'').trim();
      const arr=JSON.parse(txt);
      const catMap={};
      arr.forEach(x=>{ if(CATS.some(c=>c.name===x.cat)) catMap[x.i]=x.cat; });
      batch.forEach((r,i)=>results.push({...r,cat:catMap[i]||ruleCat(r.label,r),aiCat:catMap[i]!=null}));
    }catch(e){
      console.warn('AI batch failed:',e);
      batch.forEach(r=>results.push({...r,cat:ruleCat(r.label,r),aiCat:false}));
    }
  }
  updateProgress(rows.length,rows.length,'');
  return results;
}
function updateProgress(done,total,label){
  const pb=document.getElementById('importProgressBar'); if(pb) pb.style.width=`${total?Math.round(done/total*100):100}%`;
  const pl=document.getElementById('importProgressLabel'); if(pl) pl.textContent=label?`Analyse : "${label.slice(0,40)}"`:'Termin√© ‚úì';
}

// ‚îÄ‚îÄ Subscription detector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectRecurring(rows){
  // FIX: deduplicate rows before analysis to avoid false positives from re-imports
  const seenKeys=new Set();
  const deduped=rows.filter(r=>{
    const k=`${r.date}|${Math.round(Math.abs(r.amount)*100)}|${(r.label||'').slice(0,30)}`;
    if(seenKeys.has(k))return false; seenKeys.add(k); return true;
  });
  // Group expenses by normalised label
  const expenses=deduped.filter(r=>r.amount<0);
  const groups={};
  expenses.forEach(r=>{
    // Normalise: lowercase, remove dates/refs, trim spaces
    const key=r.label.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\d{4,}/g,'')           // remove long numbers
      .replace(/\b\d{1,3}\b/g,'')      // remove short numbers
      .replace(/[\/\-_\.]/g,' ')
      .replace(/\s+/g,' ').trim()
      .slice(0,40);
    if(!groups[key])groups[key]=[];
    groups[key].push({date:r.date,amount:Math.abs(r.amount),rawLabel:r.label});
  });

  const detected=[];
  Object.entries(groups).forEach(([key,items])=>{
    if(items.length<2)return;
    // Sort by date
    items.sort((a,b)=>a.date.localeCompare(b.date));
    // Check if amount is consistent (within 5%)
    const amounts=items.map(i=>i.amount);
    const avgAmt=amounts.reduce((s,a)=>s+a,0)/amounts.length;
    const consistent=amounts.every(a=>Math.abs(a-avgAmt)/avgAmt<0.05);
    if(!consistent)return;

    // Calculate intervals in days
    const intervals=[];
    for(let i=1;i<items.length;i++){
      const d1=new Date(items[i-1].date), d2=new Date(items[i].date);
      intervals.push((d2-d1)/86400000);
    }
    if(!intervals.length)return;
    const avgInterval=intervals.reduce((s,v)=>s+v,0)/intervals.length;

    // Classify frequency
    let freq=null;
    if(avgInterval>=6  &&avgInterval<=8)   freq='weekly';
    else if(avgInterval>=26&&avgInterval<=35) freq='monthly';
    else if(avgInterval>=85&&avgInterval<=98) freq='quarterly';
    else if(avgInterval>=170&&avgInterval<=196)freq='biannual';
    else if(avgInterval>=350&&avgInterval<=380)freq='yearly';
    if(!freq)return;

    // Don't suggest if already in subs list
    const nameNorm=items[0].rawLabel.toLowerCase();
    const alreadyExists=data.s.some(s=>s.name.toLowerCase()===nameNorm||
      (s.a&&Math.abs(s.a-avgAmt)<0.5&&s.freq===freq));
    if(alreadyExists)return;

    // Best display name: shortest rawLabel from items (cleanest)
    const displayName=items.reduce((best,cur)=>cur.rawLabel.length<best.length?cur.rawLabel:best, items[0].rawLabel)
      .replace(/^(prlv sepa |virement |cb |paiement |achat )/i,'')
      .replace(/\s+\d{6,}.*$/,'')
      .trim()
      .split(' ').slice(0,4).join(' ');

    // Try to match to known service
    const svcMatch=SERVICE_BANK.find(s=>
      displayName.toLowerCase().includes(s.name.toLowerCase()) ||
      s.name.toLowerCase().includes(displayName.toLowerCase().split(' ')[0])
    );

    // Next expected date: last occurrence + interval
    const lastDate=new Date(items[items.length-1].date);
    if(freq==='weekly')     lastDate.setDate(lastDate.getDate()+7);
    else if(freq==='monthly')    lastDate.setMonth(lastDate.getMonth()+1);
    else if(freq==='quarterly')  lastDate.setMonth(lastDate.getMonth()+3);
    else if(freq==='biannual')   lastDate.setMonth(lastDate.getMonth()+6);
    else if(freq==='yearly')     lastDate.setFullYear(lastDate.getFullYear()+1);
    const nextDate=lastDate.toISOString().slice(0,10);

    detected.push({
      key: key.slice(0,20)+'_'+Math.round(avgAmt*100),
      name: svcMatch?.name||displayName||key,
      amount: Math.round(avgAmt*100)/100,
      freq,
      count: items.length,
      nextDate,
      domain: svcMatch?.domain||'',
      color:  svcMatch?.color||'#888',
    });
  });

  // Sort: most occurrences first
  return detected.sort((a,b)=>b.count-a.count);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT MODULE ‚Äî VIEW & HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function rImport(){
  const apiKey = localStorage.getItem('claudeKey')||'';
  const pending = _detectedSubs.filter(s=>!_dismissed.includes(s.key));

  const detTeaser = pending.length ? `<div style="background:#080f08;border:1px solid #1E3020;border-radius:4px;padding:12px;margin-bottom:10px">
    <div style="font-family:monospace;font-size:9px;color:var(--green);letter-spacing:2px;margin-bottom:6px">‚ú¶ ${pending.length} ABONNEMENT${pending.length>1?'S':''} D√âTECT√â${pending.length>1?'S':''}</div>
    <p style="font-family:monospace;font-size:10px;color:var(--muted);line-height:1.6">Des paiements r√©currents ont √©t√© identifi√©s. Allez dans <b style="color:var(--text)">Abos</b> pour les valider.</p>
  </div>` : '';

  return `<div class="card">
    <div class="card-t">Importer depuis votre banque</div>
    <p style="font-size:12px;color:var(--dim);margin-bottom:14px;line-height:1.7">
      Exportez vos op√©rations au format <b style="color:var(--text)">CSV</b> depuis votre banque, puis s√©lectionnez le fichier.
    </p>
    ${detTeaser}

    <div id="dropZone" style="border:2px dashed var(--border2);border-radius:6px;padding:24px 16px;text-align:center;margin-bottom:4px;transition:border-color .2s"
         ondragover="event.preventDefault();this.style.borderColor='var(--gold)'"
         ondragleave="this.style.borderColor='var(--border2)'"
         ondrop="this.style.borderColor='var(--border2)';event.preventDefault();startImport(event.dataTransfer.files[0])">
      <div style="font-size:28px;margin-bottom:10px">üìÇ</div>
      <button onclick="document.getElementById('csvInput').click()"
              style="background:var(--gold);color:var(--bg);border:none;font-family:monospace;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:13px 28px;border-radius:4px;cursor:pointer;display:block;width:100%;margin-bottom:10px">
        Choisir un fichier CSV
      </button>
      <div style="font-family:monospace;font-size:10px;color:var(--muted)">ou glisser-d√©poser ici</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:12px;justify-content:center">
        ${["Caisse d'√âpargne",'Boursobank','BNP','SG','Cr√©dit Agricole','LCL','CIC','Revolut','N26'].map(b=>`<span style="background:var(--bg3);border:1px solid var(--border);font-family:monospace;font-size:8px;color:var(--muted);padding:3px 7px;border-radius:10px">${b}</span>`).join('')}
      </div>
    </div>

    <div id="importStatus" style="display:none;padding:12px 0;text-align:center">
      <div style="font-family:monospace;font-size:11px;color:var(--green);margin-bottom:8px" id="importStatusMsg">Lecture en cours‚Ä¶</div>
      <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
        <div id="importProgressBar" style="height:4px;background:var(--green);border-radius:2px;width:0%;transition:width .3s"></div>
      </div>
      <div style="font-family:monospace;font-size:9px;color:var(--muted);margin-top:6px" id="importProgressLabel"></div>
    </div>
  </div>

  <div class="card">
    <div style="background:#0a0f0a;border:1px solid #1E3020;border-radius:4px;padding:12px;margin-bottom:${apiKey?'0':'10px'}">
      <div style="font-family:monospace;font-size:9px;color:var(--green);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px">‚ú¶ Cat√©gorisation IA (optionnelle)</div>
      <p style="font-family:monospace;font-size:10px;color:var(--muted);margin-bottom:8px;line-height:1.6">Cl√© API Claude pour cat√©goriser intelligemment. Sans cl√©, les mots-cl√©s fonctionnent tr√®s bien.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="apiKeyInput" class="fi" type="password" placeholder="sk-ant-..." value="${apiKey}" style="flex:1;padding:9px 12px">
        <button onclick="saveApiKey()" style="background:var(--green);border:none;color:var(--bg);font-family:monospace;font-size:10px;font-weight:700;letter-spacing:1px;padding:10px 14px;cursor:pointer;border-radius:4px;white-space:nowrap">Sauvegarder</button>
      </div>
      ${apiKey?'<div style="font-family:monospace;font-size:10px;color:var(--green);margin-top:6px">‚úì IA activ√©e</div>':''}
    </div>
  </div>

  <div class="card" style="background:#090b09;border-color:#1E2820">
    <div class="card-t" style="color:var(--green)">Comment exporter depuis votre banque</div>
    ${[
      ["Caisse d'√âpargne",'Mon compte ‚Üí T√©l√©charger les op√©rations ‚Üí Format CSV (toutes colonnes)'],
      ['Boursobank','Compte ‚Üí T√©l√©charger mes op√©rations ‚Üí CSV'],
      ['BNP Paribas','Mes comptes ‚Üí Relev√©s ‚Üí T√©l√©charger ‚Üí CSV'],
      ['Soci√©t√© G√©n√©rale','Mes comptes ‚Üí T√©l√©charger les op√©rations'],
      ['Cr√©dit Agricole','Mes comptes ‚Üí T√©l√©charger (CSV / OFX)'],
      ['LCL','Mes comptes ‚Üí T√©l√©charger ‚Üí Format CSV'],
      ['CIC / Cr√©dit Mutuel','Mes comptes ‚Üí T√©l√©charger ‚Üí Format CSV'],
      ['Revolut','Profil ‚Üí D√©clarations ‚Üí Format CSV'],
      ['N26','Compte ‚Üí Exporter les transactions ‚Üí CSV'],
    ].map(([b,t])=>`<div style="display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-bottom:1px solid #111">
      <span style="font-family:monospace;font-size:9px;color:var(--gold);min-width:120px;flex-shrink:0">${b}</span>
      <span style="font-family:monospace;font-size:9px;color:var(--muted)">${t}</span>
    </div>`).join('')}
  </div>

  <div id="importPreview"></div>`;
}

// Called by the permanent #csvInput change event AND drag-drop
function startImport(file){
  if(!file){ toast('Aucun fichier s√©lectionn√©','err'); return; }
  // Show status inside the import view (if visible) or just process
  const statusEl = document.getElementById('importStatus');
  const msgEl    = document.getElementById('importStatusMsg');
  const pbEl     = document.getElementById('importProgressBar');
  if(statusEl){ statusEl.style.display='block'; }
  if(msgEl)   { msgEl.textContent = 'Lecture de '+file.name+'‚Ä¶'; }
  if(pbEl)    { pbEl.style.width='10%'; }

  const reader = new FileReader();
  reader.onload = function(ev){
    if(pbEl) pbEl.style.width='30%';
    parseAndPreview(ev.target.result, file.name);
  };
  reader.onerror = function(){ toast('Impossible de lire ce fichier','err'); };
  reader.readAsText(file, 'UTF-8');
}

function saveApiKey(){
  const k = document.getElementById('apiKeyInput')?.value?.trim();
  if(k){ localStorage.setItem('claudeKey',k); toast('Cl√© API sauvegard√©e ‚úì'); }
  else { localStorage.removeItem('claudeKey'); toast('Cl√© supprim√©e'); }
  render();
}

function buildPreviewTable(){
  const rows = _importPreview;
  const news = rows.filter(r=>!r.isDup).length;
  const dups = rows.filter(r=>r.isDup).length;
  const totalExp = rows.filter(r=>!r.isDup&&r.amount<0).reduce((s,r)=>s+Math.abs(r.amount),0);
  const totalInc = rows.filter(r=>!r.isDup&&r.amount>=0).reduce((s,r)=>s+r.amount,0);

  // Shared inline input style
  const iStyle='background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:monospace;border-radius:3px;outline:none;padding:3px 5px;';

  return `<div class="card">
    <div class="card-t">Aper√ßu ‚Äî ${rows.length} lignes ¬∑ <span style="color:var(--green)">${news} nouvelles</span> ¬∑ <span style="color:var(--muted)">${dups} doublons ignor√©s</span></div>
    <div class="imp-stats">
      <div class="imp-stat"><div class="imp-stat-v g">${news}</div><div class="imp-stat-l">√Ä importer</div></div>
      <div class="imp-stat"><div class="imp-stat-v p" id="impTotalExp">‚àí${fmtEur(totalExp)}</div><div class="imp-stat-l">D√©penses</div></div>
      <div class="imp-stat"><div class="imp-stat-v g" id="impTotalInc">+${fmtEur(totalInc)}</div><div class="imp-stat-l">Revenus</div></div>
    </div>
    <div class="imp-table-wrap">
    <table class="imp-table">
      <thead><tr>
        <th>Date</th>
        <th>Libell√©</th>
        <th>Montant</th>
        <th>Cat√©gorie</th>
        <th></th>
      </tr></thead>
      <tbody>
        ${rows.map((r,i)=>{
          if(r.isDup) return `<tr class="dup-row">
            <td class="mono xs" style="color:var(--muted);white-space:nowrap">${r.date}</td>
            <td style="font-size:11px;color:var(--muted)">${esc(r.label.length>28?r.label.slice(0,28)+'‚Ä¶':r.label)}</td>
            <td class="mono xs" style="color:var(--muted)">${r.amount>=0?'+':''}${fmtEur(r.amount)}</td>
            <td><span class="mono xxs" style="color:var(--muted)">doublon</span></td>
            <td></td>
          </tr>`;
          const amtColor=r.amount>=0?'var(--green)':'var(--pink)';
          return `<tr>
            <td>
              <input type="date" value="${r.date}"
                style="${iStyle}font-size:10px;width:110px"
                onchange="_importPreview[${i}].date=this.value">
            </td>
            <td>
              ${r.aiCat?'<span class="ai-badge" style="margin-bottom:2px;display:inline-flex">‚ú¶ IA</span>':''}
              <input type="text" value="${esc(r.label)}"
                style="${iStyle}font-size:11px;width:130px"
                onchange="_importPreview[${i}].label=this.value"
                title="${esc(r.label)}">
            </td>
            <td>
              <input type="text" inputmode="decimal" value="${r.amount}"
                style="${iStyle}font-size:11px;width:80px;color:${amtColor};text-align:right"
                onchange="updateImportAmount(${i},this.value)">
            </td>
            <td>
              <select class="cat-sel" onchange="_importPreview[${i}].cat=this.value">
                ${CATS.map(c=>'<option value="'+c.name+'"'+(c.name===r.cat?' selected':'')+'>'+c.name+'</option>').join('')}
              </select>
            </td>
            <td>
              <button onclick="removeImportRow(${i})"
                style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px">√ó</button>
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
    </div>
    <button class="submit" style="margin-top:14px" onclick="confirmImport()">Importer ${news} transaction${news>1?'s':''} ‚Üí</button>
    <button onclick="_importPreview=[];refreshPreview()" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:monospace;font-size:10px;width:100%;padding:10px;cursor:pointer;border-radius:4px;margin-top:8px;text-transform:uppercase;letter-spacing:1px">Annuler</button>
  </div>`;
}

// Inject preview without full render() ‚Äî preserves file input state
function refreshPreview(){
  // FIX: if user navigated away during async parse, switch back to import tab first
  if(cv !== 'import'){
    document.querySelector('[data-v=import]').click();
    // Let render() finish, then inject
    setTimeout(()=>refreshPreview(), 60);
    return;
  }
  const el = document.getElementById('importPreview');
  if(el) el.innerHTML = _importPreview.length ? buildPreviewTable() : '';
  // Also hide progress bar
  const s = document.getElementById('importStatus');
  if(s) s.style.display='none';
}

async function parseAndPreview(text, filename){
  // Remove BOM
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

  if(lines.length < 2){
    toast('Fichier vide ou non reconnu','err');
    const s=document.getElementById('importStatus'); if(s)s.style.display='none';
    return;
  }

  const header = lines[0].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  // FIX: detect separator once on header, store globally for parsers
  window._csvSep = detectCsvSep(lines[0]);
  const parser = PARSERS.find(p=>p.detect(header)) || PARSERS[PARSERS.length-1];
  toast('Format d√©tect√© : '+parser.name+' ‚úì');

  const rawRows = parser.parse(lines.slice(1));
  if(!rawRows.length){
    toast('Aucune transaction trouv√©e ‚Äî v√©rifiez le format','err');
    const s=document.getElementById('importStatus'); if(s)s.style.display='none';
    return;
  }

  // Detect recurring subscriptions
  _detectedSubs = detectRecurring(rawRows);

  // Dedup
  const existingSet = new Set(data.t.map(t=>`${t.d}|${Math.round(Math.abs(t.a)*100)}`));
  const enriched = rawRows.map(r=>({
    ...r,
    isDup: existingSet.has(`${r.date}|${Math.round(Math.abs(r.amount)*100)}`),
    cat:'Autre', aiCat:false
  }));

  const toProcess = enriched.filter(r=>!r.isDup);

  const pb = document.getElementById('importProgressBar');
  const msg = document.getElementById('importStatusMsg');
  if(pb) pb.style.width='40%';
  if(msg) msg.textContent=`Cat√©gorisation de ${toProcess.length} transactions‚Ä¶`;
  // Categorize (aiCategorize falls back to rules if no API key)
  const categorized = toProcess.length ? await aiCategorize(toProcess) : [];

  if(pb) pb.style.width='100%';

  // Merge dup rows back ‚Äî FIX: guard against undefined if categorized is shorter
  let ci = 0;
  _importPreview = enriched.map(r=>{
    if(r.isDup) return r;
    return categorized[ci++] || {...r, cat:ruleCat(r.label,r), aiCat:false};
  });

  // Show preview WITHOUT calling render() ‚Äî preserves file input
  setTimeout(()=>refreshPreview(), 200);
}

function removeImportRow(i){
  _importPreview.splice(i,1);
  refreshPreview();
}
// Update amount in preview data and refresh the running totals (no full re-render)
function updateImportAmount(i, val){
  const v = parseInput(val);
  if(isNaN(v)) return;
  _importPreview[i].amount = v;
  // Update input color live
  const inputs = document.querySelectorAll('#importPreview table tbody tr:not(.dup-row) td:nth-child(3) input');
  let idx=0;
  _importPreview.forEach((r,ri)=>{
    if(r.isDup) return;
    if(inputs[idx]) inputs[idx].style.color = r.amount>=0?'var(--green)':'var(--pink)';
    idx++;
  });
  // Recalculate and update totals display without rebuilding the whole table
  const rows = _importPreview;
  const totalExp = rows.filter(r=>!r.isDup&&r.amount<0).reduce((s,r)=>s+Math.abs(r.amount),0);
  const totalInc = rows.filter(r=>!r.isDup&&r.amount>=0).reduce((s,r)=>s+r.amount,0);
  const elExp = document.getElementById('impTotalExp');
  const elInc = document.getElementById('impTotalInc');
  if(elExp) elExp.textContent = '‚àí'+fmtEur(totalExp);
  if(elInc) elInc.textContent = '+'+fmtEur(totalInc);
}

function confirmImport(){
  const toImport = _importPreview.filter(r=>!r.isDup);
  if(!toImport.length){ toast('Rien √† importer','err'); return; }
  toImport.forEach(r=>{
    data.t.push({id:gid(), lb:r.label, a:Math.abs(r.amount), c:r.cat, d:r.date, tp:r.amount>=0?'i':'e'});
  });
  save();
  _importPreview = [];
  toast(`${toImport.length} transaction${toImport.length>1?'s':''} import√©es ‚úì`);
  document.querySelector('[data-v=history]').click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updateHeader();
render();

// Wire up the permanent file input (lives in body, survives render())
document.getElementById('csvInput').addEventListener('change', function(){
  const file = this.files[0];
  if(!file) return;
  // If not on import tab, switch to it first
  if(cv !== 'import'){
    document.querySelector('[data-v=import]').click();
    // Small delay to let render() finish before we show status
    setTimeout(()=>startImport(file), 50);
  } else {
    startImport(file);
  }
  // Reset so same file can be picked again
  this.value = '';
});
</script>
</body>
</html>
